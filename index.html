<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Knight Tycoon V7.0 ‚Äî Full Edition</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:linear-gradient(135deg,#0a0a12 0%,#1a1a2e 50%,#0a0a12 100%);color:#fff;line-height:1.4}
#root{height:100%}

:root{
--gold:#F6C343;--gold-dark:#D4A030;--gold-light:#FFD970;
--bg:#0a0a12;--card:#16162a;--card-hover:#1e1e3a;--card-border:rgba(246,195,67,0.15);
--text:#fff;--text-muted:rgba(255,255,255,0.7);--text-dim:rgba(255,255,255,0.4);
--green:#10B981;--green-bg:rgba(16,185,129,0.15);
--red:#EF4444;--red-bg:rgba(239,68,68,0.15);
--blue:#3B82F6;--blue-bg:rgba(59,130,246,0.15);
--purple:#8B5CF6;--purple-bg:rgba(139,92,246,0.15);
--orange:#F97316;
--shadow:0 4px 24px rgba(0,0,0,0.4);--shadow-gold:0 4px 24px rgba(246,195,67,0.2);
--radius:14px;--radius-sm:8px;
}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--gold-dark);border-radius:4px}

.app{max-width:440px;margin:0 auto;height:100%;display:flex;flex-direction:column;position:relative;overflow:hidden}

/* Top section - fixed, no scroll */
.top-section{flex-shrink:0;padding:8px 12px;display:flex;flex-direction:column;gap:6px}

/* Card section - fixed height */
.card-section{flex-shrink:0;padding:0 12px}

/* Bottom section - scrollable */
.bottom-section{flex:1;overflow-y:auto;padding:8px 12px 20px;-webkit-overflow-scrolling:touch}

.creator-banner{background:linear-gradient(90deg,var(--gold),var(--gold-dark));color:#000;text-align:center;padding:4px;font-size:10px;font-weight:700;letter-spacing:0.5px}

.header{display:flex;justify-content:space-between;align-items:center}
.brand{display:flex;flex-direction:column}
.logo{font-size:16px;font-weight:900;background:linear-gradient(135deg,var(--gold-light),var(--gold-dark));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.5px}
.sub-brand{font-size:9px;color:var(--text-dim);font-weight:600}
.header-right{display:flex;align-items:center;gap:6px}
.header-stat{text-align:right}
.header-stat-value{font-size:14px;font-weight:800}
.header-stat-label{font-size:8px;color:var(--text-dim);text-transform:uppercase}
.icon-btn{width:32px;height:32px;border-radius:var(--radius-sm);background:var(--card);border:1px solid var(--card-border);color:var(--text-muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.icon-btn:hover{background:var(--card-hover);color:var(--gold)}
.icon-btn.active{background:var(--gold);color:#000}

.compact-bar{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--card);border-radius:var(--radius-sm);border:1px solid var(--card-border)}
.compact-char{width:28px;height:36px;border-radius:4px;background:rgba(0,0,0,0.3);border:1px solid var(--gold-dark);display:flex;align-items:center;justify-content:center;overflow:hidden}
.compact-info{flex:1;min-width:0}
.compact-name{font-size:13px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.compact-meta{font-size:10px;color:var(--text-muted);display:flex;gap:6px}
.compact-badges{display:flex;gap:4px}
.mini-badge{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:600}
.mini-badge.green{background:var(--green-bg);color:var(--green)}
.mini-badge.red{background:var(--red-bg);color:var(--red)}
.mini-badge.orange{background:rgba(249,115,22,0.2);color:var(--orange)}
.mini-badge.blue{background:var(--blue-bg);color:var(--blue)}
.mini-badge.purple{background:var(--purple-bg);color:var(--purple)}
.gen-badge{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#000;font-size:10px;font-weight:800;padding:4px 8px;border-radius:6px}

.quick-stats{display:flex;gap:6px}
.quick-stat{flex:1;background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:6px;text-align:center;cursor:pointer;transition:all 0.2s}
.quick-stat:hover{background:var(--card-hover);border-color:var(--gold)}
.quick-stat-value{font-size:13px;font-weight:800}
.quick-stat-value.positive{color:var(--green)}
.quick-stat-value.negative{color:var(--red)}
.quick-stat-label{font-size:8px;color:var(--text-dim);text-transform:uppercase}

.card-area{position:relative;height:240px;margin:4px 0}
.swipe-card{position:absolute;inset:0;background:linear-gradient(145deg,var(--card) 0%,#1a1a35 100%);border:1px solid var(--card-border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;cursor:grab;touch-action:none;transition:transform 0.15s ease,box-shadow 0.15s ease}
.swipe-card:active{cursor:grabbing}
.swipe-card.swipe-left{border-color:var(--red);box-shadow:-4px 0 20px rgba(239,68,68,0.3)}
.swipe-card.swipe-right{border-color:var(--green);box-shadow:4px 0 20px rgba(16,185,129,0.3)}
.swipe-card.business{border-left:3px solid var(--purple)}
.swipe-card.opportunity{border-left:3px solid var(--green)}
.swipe-card.danger{border-left:3px solid var(--red)}
.swipe-card.jail{border-left:3px solid #666;background:linear-gradient(145deg,#1a1a1a,#0a0a0a)}
.swipe-card.tax{border-left:3px solid var(--blue)}
.swipe-card.broke{border-left:3px solid var(--orange)}

.card-header{display:flex;justify-content:space-between;align-items:flex-start}
.card-cat{font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.card-title{font-size:17px;font-weight:900;margin-top:2px;line-height:1.2}
.card-icon{font-size:32px;line-height:1}
.card-desc{font-size:12px;color:var(--text-muted);line-height:1.4;flex:1;margin-top:6px}

.card-choices{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:auto}
.card-choice{padding:10px;background:rgba(255,255,255,0.05);border:1px solid var(--card-border);border-radius:var(--radius-sm)}
.card-choice.left{border-top:2px solid var(--red)}
.card-choice.right{border-top:2px solid var(--green)}
.choice-label{font-size:11px;font-weight:800}
.choice-effect{font-size:9px;color:var(--text-dim);margin-top:2px}

.event-effects{display:flex;flex-wrap:wrap;gap:6px;margin-top:auto}
.effect-tag{font-size:11px;font-weight:700;padding:4px 10px;border-radius:4px}
.effect-tag.positive{background:var(--green-bg);color:var(--green)}
.effect-tag.negative{background:var(--red-bg);color:var(--red)}

.action-buttons{display:flex;gap:12px;justify-content:center;padding:6px 0}
.action-btn{width:56px;height:56px;border-radius:50%;border:none;font-size:22px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center}
.action-btn.no{background:linear-gradient(135deg,#3a1515,#2a0f0f);border:2px solid var(--red);color:var(--red)}
.action-btn.yes{background:linear-gradient(135deg,#153a1a,#0f2a12);border:2px solid var(--green);color:var(--green)}
.action-btn:hover{transform:scale(1.1)}
.action-btn:active{transform:scale(0.95)}

.year-summary{background:linear-gradient(135deg,var(--card),rgba(246,195,67,0.08));border:2px solid var(--gold);border-radius:var(--radius);padding:14px;position:relative}
.year-close{position:absolute;top:10px;right:10px;width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,0.1);border:none;color:var(--text-muted);font-size:14px;cursor:pointer}
.year-close:hover{background:var(--gold);color:#000}
.year-title{font-size:13px;font-weight:800;color:var(--gold);margin-bottom:10px}
.year-row{display:flex;justify-content:space-between;font-size:12px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.year-row:last-child{border-bottom:none}
.year-row.total{font-weight:800;font-size:13px;border-top:2px solid var(--gold);margin-top:8px;padding-top:8px;border-bottom:none}
.year-positive{color:var(--green)}
.year-negative{color:var(--red)}

.section-title{font-size:11px;font-weight:700;color:var(--text-dim);text-transform:uppercase;margin:12px 0 8px;display:flex;align-items:center;gap:6px}

.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.stat-card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:8px 6px;text-align:center;cursor:pointer;transition:all 0.2s}
.stat-card:hover{background:var(--card-hover);border-color:var(--gold)}
.stat-icon{font-size:12px}
.stat-value{font-size:13px;font-weight:800}
.stat-label{font-size:8px;color:var(--text-dim);text-transform:uppercase}
.stat-bar{height:3px;background:rgba(255,255,255,0.1);border-radius:2px;margin-top:4px;overflow:hidden}
.stat-bar-fill{height:100%;border-radius:2px;transition:width 0.3s}

.biz-card{background:var(--card);border:1px solid var(--purple);border-radius:var(--radius-sm);padding:10px;margin-bottom:6px}
.biz-header{font-size:12px;font-weight:700;color:var(--purple);display:flex;align-items:center;gap:6px;margin-bottom:6px}
.biz-stats{display:flex;gap:12px}
.biz-stat{text-align:center}
.biz-stat-value{font-size:12px;font-weight:800}
.biz-stat-label{font-size:8px;color:var(--text-dim)}

.family-grid{display:flex;flex-wrap:wrap;gap:6px}
.family-chip{display:flex;align-items:center;gap:4px;background:var(--card);border:1px solid var(--card-border);padding:6px 10px;border-radius:6px;font-size:10px}
.family-chip .invested{color:var(--gold);font-weight:600}

.btn{padding:12px 20px;border-radius:var(--radius);font-weight:700;font-size:13px;cursor:pointer;transition:all 0.2s;border:none;display:inline-flex;align-items:center;justify-content:center;gap:6px}
.btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#000;box-shadow:var(--shadow-gold)}
.btn-primary:hover{transform:translateY(-2px)}
.btn-secondary{background:transparent;border:2px solid var(--gold);color:var(--gold)}
.btn-ghost{background:var(--card);border:1px solid var(--card-border);color:var(--text-muted)}
.btn-danger{background:var(--red-bg);border:1px solid var(--red);color:var(--red)}
.btn-sm{padding:8px 14px;font-size:11px}
.btn-full{width:100%}
.btn:disabled{opacity:0.4;cursor:not-allowed}

.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:16px;z-index:100}
.modal{width:100%;max-width:400px;max-height:85vh;background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);padding:20px;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.modal-title{font-size:18px;font-weight:800}
.modal-close{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.1);border:none;color:var(--text-muted);font-size:18px;cursor:pointer}
.modal-section{margin-bottom:16px}
.modal-section-title{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;margin-bottom:8px}

.invest-option{background:rgba(255,255,255,0.05);border:1px solid var(--card-border);border-radius:var(--radius-sm);padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s}
.invest-option:hover{border-color:var(--gold);background:rgba(246,195,67,0.05)}
.invest-option-header{display:flex;justify-content:space-between;align-items:center}
.invest-option-name{font-weight:700;font-size:13px}
.invest-option-return{font-size:11px;color:var(--green)}
.invest-option-desc{font-size:10px;color:var(--text-dim);margin-top:4px}
.invest-amounts{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}

.option-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.option{background:var(--card);border:2px solid transparent;border-radius:var(--radius-sm);padding:12px 8px;text-align:center;cursor:pointer;transition:all 0.2s}
.option:hover{background:var(--card-hover)}
.option.selected{border-color:var(--gold);background:rgba(246,195,67,0.1)}
.option-icon{font-size:24px;margin-bottom:4px}
.option-title{font-size:12px;font-weight:700}
.option-desc{font-size:9px;color:rgba(255,255,255,0.7);margin-top:2px;line-height:1.2}

.char-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
.char-option{display:flex;flex-direction:column;align-items:center;padding:8px 4px;background:var(--card);border:2px solid transparent;border-radius:var(--radius-sm);cursor:pointer}
.char-option:hover{background:var(--card-hover)}
.char-option.selected{border-color:var(--gold)}
.char-name{font-size:8px;color:var(--text-muted);margin-top:4px}

.form-group{margin-bottom:14px}
.form-label{font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px;display:block}
.form-input{width:100%;padding:12px;border-radius:var(--radius-sm);border:1px solid var(--card-border);background:rgba(255,255,255,0.05);color:#fff;font-size:14px;outline:none}
.form-input:focus{border-color:var(--gold)}

.setting-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0}
.toggle{width:44px;height:26px;border-radius:13px;background:rgba(255,255,255,0.15);border:none;cursor:pointer;position:relative}
.toggle.on{background:var(--gold)}
.toggle-knob{width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:3px;left:3px;transition:all 0.2s}
.toggle.on .toggle-knob{left:21px}

.title-screen{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;flex:1;text-align:center;padding:20px;padding-top:30px;overflow-y:auto}
.title-crown{font-size:56px;margin-bottom:8px;filter:drop-shadow(0 4px 8px rgba(246,195,67,0.4))}
.title-main{font-size:28px;font-weight:900;background:linear-gradient(135deg,var(--gold-light),var(--gold),var(--gold-dark));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-shadow:0 2px 20px rgba(246,195,67,0.3)}
.title-by{font-size:13px;color:#fff;margin-top:6px;font-weight:700}
.title-sub{font-size:11px;color:rgba(255,255,255,0.8);margin-top:2px}
.mode-select{display:flex;flex-direction:column;gap:10px;width:100%;max-width:300px;margin-top:24px}
.mode-btn{padding:16px;border-radius:var(--radius);border:2px solid var(--card-border);background:var(--card);cursor:pointer;text-align:left;transition:all 0.2s}
.mode-btn:hover{border-color:var(--gold);background:var(--card-hover);transform:translateY(-2px)}
.mode-btn.featured{border-color:var(--gold);background:rgba(246,195,67,0.15)}
.mode-name{font-size:15px;font-weight:800;color:#fff;display:flex;align-items:center;gap:8px}
.mode-desc{font-size:11px;color:rgba(255,255,255,0.85);margin-top:6px;line-height:1.4}

.end-screen{display:flex;flex-direction:column;align-items:center;text-align:center;padding:20px}
.end-icon{font-size:64px;margin-bottom:8px}
.end-title{font-size:24px;font-weight:900;background:linear-gradient(135deg,var(--gold-light),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.end-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;width:100%;max-width:280px;margin:16px 0}
.end-stat{background:var(--card);padding:10px;border-radius:var(--radius-sm);border:1px solid var(--card-border)}
.end-stat-value{font-size:16px;font-weight:800}
.end-stat-label{font-size:9px;color:var(--text-dim);text-transform:uppercase}

.toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--card-border);padding:10px 18px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;box-shadow:var(--shadow);z-index:200}
.toast.positive{border-color:var(--green);color:var(--green)}
.toast.negative{border-color:var(--red);color:var(--red)}

.achievement-popup{position:fixed;top:50px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#000;padding:12px 20px;border-radius:var(--radius-sm);font-weight:700;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow-gold);z-index:200}

.scroll-section{max-height:200px;overflow-y:auto}

@keyframes pulse{0%,100%{opacity:0.4}50%{opacity:0.7}}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ============================================
// HAPPY UPBEAT MUSIC - Silent first click, smooth fade-in
// ============================================
class HappySFX {
  constructor() {
    this.ctx = null;
    this.on = true;
    this.musicOn = true;
    this.loop = null;
    this.started = false;
    this.masterVol = 0;
    this.fadeInterval = null;
    this.firstClick = true; // Skip sound on very first click
  }
  
  init() {
    if (!this.ctx) {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (this.ctx.state === 'suspended') {
      this.ctx.resume();
    }
    // Start music on first interaction
    if (this.musicOn && !this.started) {
      this.startHappy();
    }
  }
  
  tone(freq, dur = 0.1, type = 'sine', vol = 0.05, delay = 0) {
    if (!this.ctx || !this.on) return;
    try {
      const actualVol = vol * this.masterVol;
      if (actualVol < 0.001) return;
      
      const o = this.ctx.createOscillator();
      const g = this.ctx.createGain();
      o.type = type;
      o.frequency.value = freq;
      const t = this.ctx.currentTime + delay;
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(actualVol, t + 0.03);
      g.gain.exponentialRampToValueAtTime(0.001, t + dur);
      o.connect(g);
      g.connect(this.ctx.destination);
      o.start(t);
      o.stop(t + dur + 0.1);
    } catch(e) {}
  }
  
  sfxTone(freq, dur = 0.1, type = 'sine', vol = 0.05, delay = 0) {
    if (!this.ctx || !this.on) return;
    try {
      const o = this.ctx.createOscillator();
      const g = this.ctx.createGain();
      o.type = type;
      o.frequency.value = freq;
      const t = this.ctx.currentTime + delay;
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(vol, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.001, t + dur);
      o.connect(g);
      g.connect(this.ctx.destination);
      o.start(t);
      o.stop(t + dur + 0.1);
    } catch(e) {}
  }
  
  happyChord(notes, dur = 0.3, vol = 0.025) {
    notes.forEach((n, i) => {
      this.tone(n, dur, 'sine', vol, i * 0.02);
      this.tone(n * 2, dur * 0.5, 'sine', vol * 0.12, i * 0.02);
    });
  }
  
  bounceBass(freq, vol = 0.03) {
    this.tone(freq, 0.15, 'triangle', vol);
    this.tone(freq, 0.1, 'triangle', vol * 0.6, 0.2);
  }
  
  // SILENT on first click, then normal after
  click() { 
    this.init(); 
    if (this.firstClick) { this.firstClick = false; return; }
    this.sfxTone(880, 0.03, 'sine', 0.04); 
  }
  yes() { this.init(); this.sfxTone(523, 0.1, 'sine', 0.05); this.sfxTone(659, 0.1, 'sine', 0.05, 0.08); this.sfxTone(784, 0.12, 'sine', 0.04, 0.16); }
  no() { this.init(); this.sfxTone(392, 0.1, 'sine', 0.05); this.sfxTone(330, 0.12, 'sine', 0.05, 0.08); }
  draw() { this.init(); this.sfxTone(660, 0.05, 'sine', 0.03); }
  good() { this.init(); [523, 659, 784, 1047].forEach((f, i) => this.sfxTone(f, 0.12, 'sine', 0.04, i * 0.06)); }
  bad() { this.init(); [392, 330, 294, 262].forEach((f, i) => this.sfxTone(f, 0.15, 'triangle', 0.04, i * 0.08)); }
  money() { this.init(); this.sfxTone(880, 0.06, 'sine', 0.05); this.sfxTone(1109, 0.08, 'sine', 0.04, 0.05); }
  ach() { this.init(); [523, 659, 784, 988, 1319].forEach((f, i) => this.sfxTone(f, 0.15, 'sine', 0.05, i * 0.1)); }
  lvl() { this.init(); [392, 523, 659, 784].forEach((f, i) => this.sfxTone(f, 0.2, 'sine', 0.05, i * 0.15)); }
  
  startHappy() {
    if (!this.ctx || !this.musicOn || this.loop) return;
    this.started = true;
    this.masterVol = 0;
    
    const progressions = [
      { chord: [262, 330, 392], bass: 131 },
      { chord: [294, 392, 494], bass: 147 },
      { chord: [262, 330, 440], bass: 110 },
      { chord: [262, 349, 440], bass: 175 },
      { chord: [262, 330, 392], bass: 131 },
      { chord: [294, 392, 494], bass: 196 },
      { chord: [330, 415, 494], bass: 165 },
      { chord: [262, 330, 392], bass: 131 },
    ];
    
    let beat = 0;
    let subBeat = 0;
    
    // Very slow fade in - starts silent
    if (this.fadeInterval) clearInterval(this.fadeInterval);
    this.fadeInterval = setInterval(() => {
      this.masterVol = Math.min(1, this.masterVol + 0.03);
      if (this.masterVol >= 1) {
        clearInterval(this.fadeInterval);
        this.fadeInterval = null;
      }
    }, 100);
    
    this.loop = setInterval(() => {
      if (!this.musicOn || this.masterVol < 0.05) return; // Don't play until volume is audible but quiet
      
      const prog = progressions[beat % progressions.length];
      
      if (subBeat === 0) {
        this.happyChord(prog.chord, 0.35, 0.02);
        this.bounceBass(prog.bass, 0.025);
      } else if (subBeat === 2) {
        this.bounceBass(prog.bass * 1.5, 0.015);
      }
      
      if (Math.random() < 0.08 && subBeat === 0 && this.masterVol >= 0.8) {
        const melody = [523, 587, 659, 698, 784];
        melody.slice(0, 3).forEach((f, i) => this.tone(f, 0.1, 'sine', 0.018, i * 0.1));
      }
      
      subBeat = (subBeat + 1) % 4;
      if (subBeat === 0) beat++;
    }, 180);
  }
  
  stopHappy() { 
    if (this.fadeInterval) { clearInterval(this.fadeInterval); this.fadeInterval = null; }
    if (this.loop) { clearInterval(this.loop); this.loop = null; }
    this.started = false;
    this.masterVol = 0;
  }
  
  toggleMusic(v) { 
    this.musicOn = v; 
    if (v) {
      if (this.ctx && !this.started) this.startHappy();
    } else {
      this.stopHappy();
    }
  }
  toggleSFX(v) { this.on = v; }
}

const sfx = new HappySFX();

// ============================================
// UTILITIES
// ============================================
const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const pick = arr => arr[Math.floor(Math.random() * arr.length)];
const uid = () => Math.random().toString(36).slice(2, 8);
const fmt = n => {
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  if (abs >= 1e6) return `${sign}$${(abs / 1e6).toFixed(1)}M`;
  if (abs >= 1e3) return `${sign}$${(abs / 1e3).toFixed(1)}K`;
  return `${sign}$${Math.round(abs)}`;
};
const netWorth = st => (st.cash || 0) + (st.invest || 0) + (st.equity || 0) - (st.debt || 0) - (st.mortgage || 0);

// IMPORTANT: Cash never goes negative - excess becomes debt
const adjustCash = (st, amount) => {
  const newCash = (st.cash || 0) + amount;
  if (newCash < 0) {
    return { cash: 0, debt: (st.debt || 0) + Math.abs(newCash) };
  }
  return { cash: newCash, debt: st.debt || 0 };
};

// ============================================
// GAME DATA
// ============================================
const CHAR_STYLES = {
  m: [
    { id: 'm1', name: 'Classic', hair: '#3d2314', skin: '#f5d0c5', shirt: '#3B82F6', pants: '#1e3a5f' },
    { id: 'm2', name: 'Cool', hair: '#1a1a1a', skin: '#e8beac', shirt: '#22C55E', pants: '#1a1a1a' },
    { id: 'm3', name: 'Blonde', hair: '#f4d03f', skin: '#f5d0c5', shirt: '#EF4444', pants: '#2d3748' },
    { id: 'm4', name: 'Auburn', hair: '#c0392b', skin: '#dbb89a', shirt: '#8B5CF6', pants: '#1e3a5f' },
    { id: 'm5', name: 'Silver', hair: '#95a5a6', skin: '#f5d0c5', shirt: '#F6C343', pants: '#2d3748' },
    { id: 'm6', name: 'Brown', hair: '#5d4037', skin: '#c68642', shirt: '#14B8A6', pants: '#1a1a1a' },
    { id: 'm7', name: 'Dark', hair: '#2c1810', skin: '#8d5524', shirt: '#0EA5E9', pants: '#2d3748' },
    { id: 'm8', name: 'Fade', hair: '#1a1a1a', skin: '#a67c52', shirt: '#F97316', pants: '#1e3a5f' },
  ],
  f: [
    { id: 'f1', name: 'Classic', hair: '#3d2314', skin: '#f5d0c5', shirt: '#EC4899', pants: '#1e3a5f' },
    { id: 'f2', name: 'Blonde', hair: '#f4d03f', skin: '#f5d0c5', shirt: '#8B5CF6', pants: '#2d3748' },
    { id: 'f3', name: 'Auburn', hair: '#c0392b', skin: '#e8beac', shirt: '#22C55E', pants: '#1a1a1a' },
    { id: 'f4', name: 'Dark', hair: '#1a1a1a', skin: '#dbb89a', shirt: '#3B82F6', pants: '#1e3a5f' },
    { id: 'f5', name: 'Brown', hair: '#5d4037', skin: '#c68642', shirt: '#F6C343', pants: '#2d3748' },
    { id: 'f6', name: 'Curly', hair: '#2c1810', skin: '#8d5524', shirt: '#EF4444', pants: '#1a1a1a' },
    { id: 'f7', name: 'Silver', hair: '#95a5a6', skin: '#f5d0c5', shirt: '#14B8A6', pants: '#1e3a5f' },
    { id: 'f8', name: 'Long', hair: '#1a1a1a', skin: '#a67c52', shirt: '#F97316', pants: '#2d3748' },
  ],
};

const CAREERS = [
  { id: 'trades', icon: 'üîß', name: 'Trades', salary: 48000, cap: 85000, edu: 15000 },
  { id: 'business', icon: 'üíº', name: 'Business', salary: 42000, cap: 120000, edu: 55000 },
  { id: 'tech', icon: 'üíª', name: 'Tech', salary: 65000, cap: 180000, edu: 70000 },
  { id: 'healthcare', icon: 'üè•', name: 'Healthcare', salary: 52000, cap: 95000, edu: 50000 },
  { id: 'creative', icon: 'üé®', name: 'Creative', salary: 38000, cap: 150000, edu: 45000 },
  { id: 'finance', icon: 'üìä', name: 'Finance', salary: 58000, cap: 200000, edu: 80000 },
];

const BROKE_JOBS = [
  { id: 'none', icon: '‚ùå', name: 'Unemployed', salary: 0 },
  { id: 'gig', icon: 'üì±', name: 'Gig Worker', salary: 18000 },
  { id: 'labor', icon: 'üèóÔ∏è', name: 'Day Labor', salary: 22000 },
  { id: 'retail', icon: 'üè™', name: 'Retail', salary: 26000 },
  { id: 'service', icon: 'üçΩÔ∏è', name: 'Service', salary: 24000 },
];

const BIZ_TYPES = [
  { id: 'service', name: 'Service Biz', icon: 'üõ†Ô∏è', cost: 15000, baseRev: 60000 },
  { id: 'ecom', name: 'E-Commerce', icon: 'üõí', cost: 25000, baseRev: 90000 },
  { id: 'consulting', name: 'Consulting', icon: 'üí°', cost: 10000, baseRev: 50000 },
  { id: 'franchise', name: 'Franchise', icon: 'üçî', cost: 75000, baseRev: 150000 },
  { id: 'saas', name: 'SaaS', icon: '‚òÅÔ∏è', cost: 40000, baseRev: 120000 },
  { id: 'realestate', name: 'Real Estate', icon: 'üèòÔ∏è', cost: 100000, baseRev: 200000 },
];

const SPOUSE_TYPES = [
  { id: 'earner', name: 'High Earner', income: rand(50000, 80000), spending: 0, desc: 'Great income' },
  { id: 'saver', name: 'Saver', income: rand(30000, 45000), spending: -5000, desc: 'Frugal partner' },
  { id: 'spender', name: 'Spender', income: rand(35000, 50000), spending: 15000, desc: 'Loves luxury' },
  { id: 'homemaker', name: 'Homemaker', income: 0, spending: 0, desc: '+10 Happy/yr' },
];

const INVESTMENTS = [
  { id: 'index', name: 'Index Funds', icon: 'üìä', minReturn: 0.05, maxReturn: 0.12, risk: 'Low', desc: 'Diversified market funds' },
  { id: 'growth', name: 'Growth Stocks', icon: 'üìà', minReturn: -0.10, maxReturn: 0.25, risk: 'Medium', desc: 'Higher risk, higher reward' },
  { id: 'bonds', name: 'Bonds', icon: 'üèõÔ∏è', minReturn: 0.03, maxReturn: 0.05, risk: 'Very Low', desc: 'Safe and steady' },
  { id: 'reits', name: 'REITs', icon: 'üè¢', minReturn: 0.04, maxReturn: 0.10, risk: 'Low-Med', desc: 'Real estate trusts' },
  { id: 'crypto', name: 'Crypto', icon: 'ü™ô', minReturn: -0.40, maxReturn: 0.80, risk: 'Very High', desc: 'Extremely volatile' },
];

const ECONOMY = [
  { id: 'boom', name: 'Bull Market', color: 'boom', invMult: 1.12, taxMult: 1.0 },
  { id: 'stable', name: 'Stable', color: 'stable', invMult: 1.06, taxMult: 1.0 },
  { id: 'recession', name: 'Recession', color: 'recession', invMult: 0.90, taxMult: 0.95 },
  { id: 'recovery', name: 'Recovery', color: 'recovery', invMult: 1.08, taxMult: 1.0 },
];

const ACHIEVEMENTS = [
  // WEALTH MILESTONES
  { id: '10k', icon: 'üíµ', title: 'First $10K', desc: 'Save $10,000 cash', check: st => st.cash >= 10000 },
  { id: '50k', icon: 'üí∞', title: '$50K Saved', desc: 'Save $50,000 cash', check: st => st.cash >= 50000 },
  { id: '100k', icon: 'üèÜ', title: '$100K Club', desc: 'Net worth $100,000', check: st => netWorth(st) >= 100000 },
  { id: '500k', icon: 'üíé', title: 'Half Millionaire', desc: 'Net worth $500,000', check: st => netWorth(st) >= 500000 },
  { id: '1m', icon: 'üëë', title: 'Millionaire', desc: 'Net worth $1,000,000', check: st => netWorth(st) >= 1000000 },
  { id: '5m', icon: 'üåü', title: 'Multi-Millionaire', desc: 'Net worth $5,000,000', check: st => netWorth(st) >= 5000000 },
  
  // CREDIT SCORE
  { id: 'credit650', icon: 'üìà', title: 'Fair Credit', desc: 'Reach 650 credit score', check: st => st.credit >= 650 },
  { id: 'credit700', icon: 'üìä', title: 'Good Credit', desc: 'Reach 700 credit score', check: st => st.credit >= 700 },
  { id: 'credit750', icon: '‚≠ê', title: 'Great Credit', desc: 'Reach 750 credit score', check: st => st.credit >= 750 },
  { id: 'credit800', icon: 'üåü', title: 'Excellent Credit', desc: 'Reach 800 credit score', check: st => st.credit >= 800 },
  
  // DEBT & FINANCE
  { id: 'debtfree', icon: 'üéâ', title: 'Debt Free', desc: 'Pay off all debt', check: st => (st.debt || 0) <= 0 && netWorth(st) > 0 },
  { id: 'investor', icon: 'üìà', title: 'Investor', desc: 'Have $25K invested', check: st => (st.invest || 0) >= 25000 },
  { id: 'biginvestor', icon: 'üè¶', title: 'Big Investor', desc: 'Have $100K invested', check: st => (st.invest || 0) >= 100000 },
  
  // FAMILY
  { id: 'married', icon: 'üíí', title: 'Married', desc: 'Get married', check: (st, ch) => ch.rel === 'married' },
  { id: 'parent', icon: 'üë∂', title: 'Parent', desc: 'Have your first child', check: (st, ch) => ch.kids?.length >= 1 },
  { id: 'family', icon: 'üë®‚Äçüë©‚Äçüëß', title: 'Family of Four', desc: 'Have 2+ children', check: (st, ch) => ch.kids?.length >= 2 },
  { id: 'bigfamily', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', title: 'Big Family', desc: 'Have 4+ children', check: (st, ch) => ch.kids?.length >= 4 },
  { id: 'hugefamily', icon: 'üè†', title: 'Full House', desc: 'Have 6 children', check: (st, ch) => ch.kids?.length >= 6 },
  
  // BUSINESS
  { id: 'biz', icon: 'üè¢', title: 'Entrepreneur', desc: 'Start a business', check: (st, ch) => ch.biz !== null },
  { id: 'bizprofit', icon: 'üíµ', title: 'Profitable', desc: 'Business earns $50K+ revenue', check: (st, ch) => ch.biz?.revenue >= 50000 },
  { id: 'bizbig', icon: 'üè≠', title: 'Big Business', desc: 'Business earns $200K+ revenue', check: (st, ch) => ch.biz?.revenue >= 200000 },
  { id: 'multibiz', icon: 'üè∞', title: 'Empire Builder', desc: 'Own 2 businesses', check: (st, ch) => ch.biz && ch.biz2 },
  
  // HOUSING
  { id: 'moveout', icon: 'üö™', title: 'Independence', desc: 'Move out on your own', check: (st, ch) => ch.housing === 'rent' || ch.housing === 'own' },
  { id: 'home', icon: 'üè†', title: 'Homeowner', desc: 'Buy a home', check: (st, ch) => ch.housing === 'own' },
  { id: 'paidhome', icon: 'üè°', title: 'Paid Off Home', desc: 'Own home with no mortgage', check: (st, ch) => ch.housing === 'own' && (st.mortgage || 0) <= 0 },
  
  // DYNASTY
  { id: 'gen2', icon: 'üë∂', title: 'Next Generation', desc: 'Start generation 2', check: (st, ch, gen) => gen >= 2 },
  { id: 'dynasty', icon: 'üëë', title: 'Dynasty', desc: 'Reach generation 3', check: (st, ch, gen) => gen >= 3 },
  { id: 'legacy', icon: 'üèõÔ∏è', title: 'Legacy', desc: 'Reach generation 5', check: (st, ch, gen) => gen >= 5 },
  
  // FROM BROKE MODE
  { id: 'shelter', icon: 'üõèÔ∏è', title: 'Off The Streets', desc: 'Get stable housing from homeless', check: (st, ch) => ch.mode === 'broke' && ch.housing !== 'homeless' },
  { id: 'firstjob', icon: 'üíº', title: 'First Job', desc: 'Get employed from broke', check: (st, ch) => ch.mode === 'broke' && (st.salary || 0) > 0 },
  { id: 'comeback', icon: 'üí™', title: 'Comeback Kid', desc: 'From Broke to $50K net worth', check: (st, ch) => ch.mode === 'broke' && netWorth(st) >= 50000 },
  { id: 'broketobiz', icon: 'üöÄ', title: 'Bootstrap', desc: 'Start business from Broke mode', check: (st, ch) => ch.mode === 'broke' && ch.biz !== null },
  { id: 'selfmade', icon: 'üåü', title: 'Self Made', desc: 'From Broke to Millionaire', check: (st, ch) => ch.mode === 'broke' && netWorth(st) >= 1000000 },
  
  // SILVER SPOON MODE
  { id: 'keepwealth', icon: 'ü•Ñ', title: 'Kept It', desc: 'Maintain $100K+ in Silver Spoon', check: (st, ch) => ch.mode === 'silver' && netWorth(st) >= 100000 },
  { id: 'grewwealth', icon: 'üìà', title: 'Grew It', desc: 'Double starting wealth in Silver Spoon', check: (st, ch) => ch.mode === 'silver' && netWorth(st) >= 150000 },
  
  // CLASSIC MODE
  { id: 'paidstudent', icon: 'üéì', title: 'Loans Paid', desc: 'Pay off student debt in Classic', check: (st, ch) => ch.mode === 'classic' && (st.debt || 0) <= 0 },
  { id: 'classicmil', icon: 'üéØ', title: 'Traditional Path', desc: 'Millionaire in Classic mode', check: (st, ch) => ch.mode === 'classic' && netWorth(st) >= 1000000 },
  
  // LIFESTYLE & HEALTH
  { id: 'healthy', icon: '‚ù§Ô∏è', title: 'Peak Health', desc: 'Reach 100 health', check: st => st.health >= 100 },
  { id: 'happy', icon: 'üòä', title: 'Living Well', desc: 'Reach 100 happiness', check: st => st.happy >= 100 },
  { id: 'balanced', icon: '‚öñÔ∏è', title: 'Balanced Life', desc: 'Health, Happy, Credit all 80+', check: st => st.health >= 80 && st.happy >= 80 && st.credit >= 780 },
  
  // CRIME & MORALITY
  { id: 'cleanrecord', icon: 'üëº', title: 'Clean Record', desc: 'Retire with no criminal record', check: (st, ch) => ch.age >= 65 && (ch.crimeRecord || 0) === 0 },
  { id: 'reformed', icon: 'üôè', title: 'Reformed', desc: 'Had record but rebuilt to $100K', check: (st, ch) => (ch.crimeRecord || 0) > 0 && !ch.inJail && netWorth(st) >= 100000 },
  { id: 'jailbreak', icon: 'üîì', title: 'Second Chance', desc: 'Survive jail and get back on feet', check: (st, ch) => ch.servedTime && st.salary > 0 },
  
  // SPECIAL
  { id: 'survivor', icon: 'üõ°Ô∏è', title: 'Survivor', desc: 'Recover from under $1K cash', check: st => st.cash >= 10000 },
  { id: 'trapwise', icon: 'üß†', title: 'Street Smart', desc: 'Avoid 5 traps', check: () => false },
  { id: 'age50', icon: 'üéÇ', title: 'Golden Years', desc: 'Reach age 50', check: (st, ch) => ch.age >= 50 },
  { id: 'retire', icon: 'üå¥', title: 'Retired', desc: 'Reach age 65', check: (st, ch) => ch.age >= 65 },
  
  // LIFE MILESTONES
  { id: 'anniversary10', icon: 'üíï', title: '10 Years', desc: 'Celebrate 10 year anniversary', check: (st, ch) => (ch.yearsMarried || 0) >= 10 },
  { id: 'anniversary25', icon: 'üíé', title: 'Silver Anniversary', desc: '25 years of marriage', check: (st, ch) => (ch.yearsMarried || 0) >= 25 },
];

const KID_NAMES = { m: ['Marcus', 'Eli', 'Noah', 'Isaiah', 'David', 'Caleb', 'Jordan', 'Sam'], f: ['Mia', 'Ava', 'Naomi', 'Zoe', 'Leah', 'Sarah', 'Hannah', 'Faith'] };

// ============================================
// TAX CALCULATOR
// ============================================
const calcTaxes = (income, ch) => {
  if (income <= 0) return { federal: 0, state: 0, total: 0, effective: 0 };
  
  // Federal brackets (simplified)
  let federal = 0;
  if (income > 170000) federal = 170000 * 0.24 + (income - 170000) * 0.32;
  else if (income > 90000) federal = 90000 * 0.22 + (income - 90000) * 0.24;
  else if (income > 40000) federal = 40000 * 0.12 + (income - 40000) * 0.22;
  else federal = income * 0.12;
  
  // State tax (flat 5%)
  const state = income * 0.05;
  
  // Deductions
  let deductions = 0;
  if (ch.kids) deductions += ch.kids.length * 2000; // Child tax credit
  if (ch.housing === 'own') deductions += 3000; // Mortgage interest
  if (ch.biz) deductions += (ch.biz.revenue || 0) * 0.15; // Business expenses
  
  const totalTax = Math.max(0, federal + state - deductions);
  const effective = income > 0 ? (totalTax / income * 100).toFixed(1) : 0;
  
  return { federal: Math.round(federal), state: Math.round(state), deductions: Math.round(deductions), total: Math.round(totalTax), effective };
};

// ============================================
// CARD GENERATOR
// ============================================
const generateCard = (st, ch, econ, year) => {
  const cards = [];
  const poor = st.cash < 3000;
  const veryPoor = st.cash < 500;
  const broke = ch.mode === 'broke';
  const hasJob = ch.job !== 'none' && st.salary > 0;
  
  // JAIL
  if (ch.inJail && ch.jailTime > 0) {
    return { key: 'jail', cat: '‚õìÔ∏è Jail', icon: 'üîí', title: 'Behind Bars', desc: `${ch.jailTime} year${ch.jailTime > 1 ? 's' : ''} left. No income.`, type: 'jail',
      left: { label: 'Serve', effect: '-1 Year', imp: { happy: -8 }, serveTime: true },
      right: { label: 'Serve', effect: '-1 Year', imp: { happy: -8 }, serveTime: true }
    };
  }
  
  // FROM BROKE MODE - TONS of opportunities!
  if (broke) {
    const brokeCards = [];
    
    // HOUSING OPTIONS
    if (ch.housing === 'homeless') {
      brokeCards.push({ key: 'broke_shelter', cat: 'üè† Housing', icon: 'üõèÔ∏è', title: 'Homeless Shelter', desc: 'Local shelter has a bed available. Safer than the streets.', type: 'broke',
        left: { label: 'Stay Outside', effect: 'Keep freedom', imp: { health: -5 } },
        right: { label: 'Take Bed', effect: '+5 Health, shelter access', imp: { health: 5 }, setShelter: true }
      });
      
      brokeCards.push({ key: 'broke_couch', cat: 'üè† Housing', icon: 'üõãÔ∏è', title: 'Couch Surfing', desc: 'Old friend offers their couch for a while.', type: 'broke',
        left: { label: 'Decline', effect: 'Keep independence', imp: {} },
        right: { label: 'Accept', effect: 'Move to parents equiv', imp: { happy: 10 }, setHousing: 'parents' }
      });
      
      brokeCards.push({ key: 'broke_church', cat: 'üè† Housing', icon: '‚õ™', title: 'Church Program', desc: 'Local church has transitional housing program.', type: 'broke',
        left: { label: 'Not for me', effect: 'No change', imp: {} },
        right: { label: 'Apply', effect: 'Stable housing', imp: { happy: 15, health: 5 }, setHousing: 'parents' }
      });
      
      brokeCards.push({ key: 'broke_roommate', cat: 'üè† Housing', icon: 'üë•', title: 'Roommate Wanted', desc: 'Craigslist ad looking for roommate. $400/month.', type: 'broke',
        left: { label: 'Risky', effect: 'Stay put', imp: {} },
        right: { label: 'Reach Out', effect: 'Shared housing', imp: { happy: 8 }, setHousing: 'parents' }
      });
      
      brokeCards.push({ key: 'broke_family', cat: 'üè† Housing', icon: 'üë®‚Äçüë©‚Äçüëß', title: 'Family Reaches Out', desc: 'Distant relative heard about your situation. Offers a room.', type: 'broke',
        left: { label: 'Too Proud', effect: '-5 Happy', imp: { happy: -5 } },
        right: { label: 'Accept Help', effect: 'Move in with family', imp: { happy: 12, health: 5 }, setHousing: 'parents' }
      });
    }
    
    // JOB HUNTING - LOTS of options
    if (!hasJob) {
      brokeCards.push({ key: 'broke_daylab', cat: 'üíº Work', icon: 'üèóÔ∏è', title: 'Day Labor', desc: 'Construction site needs workers. Cash daily.', type: 'broke',
        left: { label: 'Too Hard', effect: 'No change', imp: {} },
        right: { label: 'Show Up', effect: '+$22K/yr, -5 Health', imp: { salary: 22000, health: -5 }, setJob: 'labor' }
      });
      
      brokeCards.push({ key: 'broke_fast', cat: 'üíº Work', icon: 'üçî', title: 'Fast Food Job', desc: 'Burger joint is hiring. Not glamorous but steady.', type: 'broke',
        left: { label: 'Pass', effect: 'Keep looking', imp: {} },
        right: { label: 'Apply', effect: '+$24K/yr', imp: { salary: 24000 }, setJob: 'service' }
      });
      
      brokeCards.push({ key: 'broke_warehouse', cat: 'üíº Work', icon: 'üì¶', title: 'Warehouse Work', desc: 'Amazon warehouse hiring. Long hours but decent pay.', type: 'broke',
        left: { label: 'Not for me', effect: 'Keep looking', imp: {} },
        right: { label: 'Apply', effect: '+$28K/yr, -8 Health', imp: { salary: 28000, health: -8 }, setJob: 'labor' }
      });
      
      brokeCards.push({ key: 'broke_retail', cat: 'üíº Work', icon: 'üè™', title: 'Retail Position', desc: 'Dollar store needs cashiers.', type: 'broke',
        left: { label: 'Pass', effect: 'Keep looking', imp: {} },
        right: { label: 'Take It', effect: '+$26K/yr', imp: { salary: 26000, happy: 5 }, setJob: 'retail' }
      });
      
      brokeCards.push({ key: 'broke_clean', cat: 'üíº Work', icon: 'üßπ', title: 'Cleaning Job', desc: 'Office cleaning company hiring night shift.', type: 'broke',
        left: { label: 'Not Interested', effect: 'Keep looking', imp: {} },
        right: { label: 'Take It', effect: '+$23K/yr', imp: { salary: 23000 }, setJob: 'service' }
      });
      
      brokeCards.push({ key: 'broke_dish', cat: 'üíº Work', icon: 'üçΩÔ∏è', title: 'Dishwasher Job', desc: 'Restaurant needs dishwasher. Free meal each shift.', type: 'broke',
        left: { label: 'Pass', effect: 'Keep looking', imp: {} },
        right: { label: 'Take It', effect: '+$21K/yr, free food', imp: { salary: 21000, health: 3 }, setJob: 'service' }
      });
      
      brokeCards.push({ key: 'broke_security', cat: 'üíº Work', icon: 'üõ°Ô∏è', title: 'Security Guard', desc: 'Night watchman position. Boring but easy.', type: 'broke',
        left: { label: 'Pass', effect: 'Keep looking', imp: {} },
        right: { label: 'Take It', effect: '+$27K/yr', imp: { salary: 27000 }, setJob: 'service' }
      });
      
      brokeCards.push({ key: 'broke_moving', cat: 'üíº Work', icon: 'üöö', title: 'Moving Company', desc: 'Local movers need help. Physical work.', type: 'broke',
        left: { label: 'Too Physical', effect: 'Keep looking', imp: {} },
        right: { label: 'Apply', effect: '+$25K/yr, -5 Health', imp: { salary: 25000, health: -5 }, setJob: 'labor' }
      });
      
      brokeCards.push({ key: 'broke_landscaping', cat: 'üíº Work', icon: 'üå≥', title: 'Landscaping Crew', desc: 'Lawn care company hiring. Outdoor work.', type: 'broke',
        left: { label: 'Not for me', effect: 'Keep looking', imp: {} },
        right: { label: 'Join Crew', effect: '+$26K/yr, +3 Health', imp: { salary: 26000, health: 3 }, setJob: 'labor' }
      });
      
      brokeCards.push({ key: 'broke_gas', cat: 'üíº Work', icon: '‚õΩ', title: 'Gas Station Clerk', desc: 'Night shift at gas station.', type: 'broke',
        left: { label: 'Too Sketchy', effect: 'Keep looking', imp: {} },
        right: { label: 'Take It', effect: '+$24K/yr', imp: { salary: 24000 }, setJob: 'retail' }
      });
      
      if (ch.hasPhone) {
        brokeCards.push({ key: 'broke_gig', cat: 'üíº Work', icon: 'üì±', title: 'Gig Apps', desc: 'Sign up for DoorDash, Uber, Instacart.', type: 'broke',
          left: { label: 'Not Now', effect: 'Keep looking', imp: {} },
          right: { label: 'Sign Up', effect: '+$20K/yr (flexible)', imp: { salary: 20000, happy: 5 }, setJob: 'gig' }
        });
        
        brokeCards.push({ key: 'broke_taskrab', cat: 'üíº Work', icon: 'üê∞', title: 'TaskRabbit', desc: 'Handyman tasks, furniture assembly, etc.', type: 'broke',
          left: { label: 'Not Handy', effect: 'Keep looking', imp: {} },
          right: { label: 'Sign Up', effect: '+$22K/yr (flexible)', imp: { salary: 22000 }, setJob: 'gig' }
        });
      }
    }
    
    // UPGRADE FROM CURRENT JOB - More paths up
    if (hasJob) {
      if (st.salary < 35000) {
        brokeCards.push({ key: 'broke_better1', cat: 'üíº Upgrade', icon: 'üìà', title: 'Better Job Opening', desc: `Heard about a ${fmt(st.salary + 6000)}/yr position. Worth a shot.`, type: 'broke',
          left: { label: 'Stay Put', effect: 'Job security', imp: { happy: 2 } },
          right: { label: 'Apply', effect: '70% chance +$6K/yr', jobUpgrade: 6000 }
        });
        
        brokeCards.push({ key: 'broke_shift', cat: 'üíº Upgrade', icon: 'üåô', title: 'Shift Lead Opening', desc: 'Supervisor position opened up. More responsibility.', type: 'broke',
          left: { label: 'Not Ready', effect: 'No change', imp: {} },
          right: { label: 'Go For It', effect: '60% get +$4K/yr', jobUpgrade: 4000 }
        });
        
        brokeCards.push({ key: 'broke_fulltime', cat: 'üíº Upgrade', icon: '‚è∞', title: 'Full Time Offer', desc: 'Boss wants to make you full time with benefits.', type: 'broke',
          left: { label: 'Keep Flex', effect: '+5 Happy', imp: { happy: 5 } },
          right: { label: 'Accept', effect: '+$5K/yr, +benefits', imp: { salary: 5000, health: 5 } }
        });
      }
      
      if (st.salary >= 25000 && st.salary < 45000) {
        brokeCards.push({ key: 'broke_office', cat: 'üíº Upgrade', icon: 'üè¢', title: 'Office Job Opening', desc: 'Entry level office position. AC and a desk!', type: 'broke',
          left: { label: 'Not Qualified', effect: 'No change', imp: {} },
          right: { label: 'Apply', effect: '50% get +$8K/yr', jobUpgrade: 8000 }
        });
        
        brokeCards.push({ key: 'broke_trade', cat: 'üíº Upgrade', icon: 'üîß', title: 'Trade Apprenticeship', desc: 'Plumber/electrician apprentice opening. Learn a skill.', type: 'broke',
          left: { label: 'Not Interested', effect: 'No change', imp: {} },
          right: { label: 'Apply', effect: 'Career path +$10K', imp: { salary: 10000, happy: 10 } }
        });
      }
    }
    
    // SIDE HUSTLES - Even with job
    brokeCards.push({ key: 'broke_sideclean', cat: 'üíµ Side Hustle', icon: 'üßπ', title: 'Weekend Cleaning', desc: 'Clean houses on weekends. $200/weekend.', type: 'broke',
      left: { label: 'Need Rest', effect: '+5 Health', imp: { health: 5 } },
      right: { label: 'Hustle', effect: '+$2K/yr, -5 Health', imp: { salary: 2000, health: -5 } }
    });
    
    brokeCards.push({ key: 'broke_tutor', cat: 'üíµ Side Hustle', icon: 'üìö', title: 'Tutoring Kids', desc: 'Neighbor needs homework help for kids. $30/session.', type: 'broke',
      left: { label: 'Not My Thing', effect: 'No change', imp: {} },
      right: { label: 'Help Out', effect: '+$1.5K/yr', imp: { salary: 1500, happy: 5 } }
    });
    
    brokeCards.push({ key: 'broke_dogwalk', cat: 'üíµ Side Hustle', icon: 'üêï', title: 'Dog Walking', desc: 'Neighbors need dog walker. Easy money.', type: 'broke',
      left: { label: 'Allergic', effect: 'No change', imp: {} },
      right: { label: 'Walk Dogs', effect: '+$1.2K/yr, +3 Health', imp: { salary: 1200, health: 3 } }
    });
    
    brokeCards.push({ key: 'broke_babysit', cat: 'üíµ Side Hustle', icon: 'üë∂', title: 'Babysitting', desc: 'Family needs sitter. $15/hour.', type: 'broke',
      left: { label: 'Not Good With Kids', effect: 'No change', imp: {} },
      right: { label: 'Help Out', effect: '+$2K/yr', imp: { salary: 2000 } }
    });
    
    brokeCards.push({ key: 'broke_sell', cat: 'üíµ Side Hustle', icon: 'üì¶', title: 'Sell Old Stuff', desc: 'Facebook Marketplace has buyers. Declutter for cash.', type: 'broke',
      left: { label: 'Nothing to Sell', effect: 'No change', imp: {} },
      right: { label: 'List Items', effect: '+$200', imp: { cash: 200, happy: 3 } }
    });
    
    brokeCards.push({ key: 'broke_scrapper', cat: 'üíµ Side Hustle', icon: 'üî©', title: 'Scrap Metal', desc: 'Old appliances can be scrapped for cash.', type: 'broke',
      left: { label: 'Too Much Work', effect: 'No change', imp: {} },
      right: { label: 'Scrap It', effect: '+$150, -3 Health', imp: { cash: 150, health: -3 } }
    });
    
    // ESSENTIALS
    if (!ch.hasPhone) {
      brokeCards.push({ key: 'broke_phone1', cat: 'üì± Essential', icon: 'üì±', title: 'Prepaid Phone', desc: '$100 for basic smartphone. Need it for job apps.', type: 'broke',
        left: { label: 'Later', effect: 'Limits options', imp: {} },
        right: { label: 'Buy', effect: '-$100, open opportunities', imp: { cash: -100 }, setPhone: true }
      });
      
      brokeCards.push({ key: 'broke_phone2', cat: 'üì± Essential', icon: 'üìû', title: 'Free Phone Program', desc: 'Government Lifeline program offers free phone.', type: 'broke',
        left: { label: 'Skip', effect: 'No change', imp: {} },
        right: { label: 'Apply', effect: 'Free phone!', imp: { happy: 5 }, setPhone: true }
      });
      
      brokeCards.push({ key: 'broke_phone3', cat: 'üì± Essential', icon: 'ü§ù', title: 'Friend\'s Old Phone', desc: 'Friend upgrading, offers old phone for $40.', type: 'broke',
        left: { label: 'Decline', effect: 'No change', imp: {} },
        right: { label: 'Take It', effect: '-$40, get phone', imp: { cash: -40 }, setPhone: true }
      });
    }
    
    if (!ch.hasCar && st.cash >= 500) {
      brokeCards.push({ key: 'broke_car1', cat: 'üöó Transport', icon: 'üöó', title: 'Cheap Beater', desc: `$${Math.min(st.cash, 1000)} for old car. Runs... mostly.`, type: 'broke',
        left: { label: 'Too Risky', effect: 'Stay on bus', imp: {} },
        right: { label: 'Buy It', effect: `-$${Math.min(st.cash, 1000)}, +mobility`, imp: { cash: -Math.min(st.cash, 1000) }, setCar: true }
      });
      
      brokeCards.push({ key: 'broke_car2', cat: 'üöó Transport', icon: 'üõª', title: 'Old Truck', desc: 'Neighbor selling old truck. $800. Good for work.', type: 'broke',
        left: { label: 'Pass', effect: 'No change', imp: {} },
        right: { label: 'Buy', effect: '-$800, get wheels', imp: { cash: -800 }, setCar: true }
      });
    }
    
    if (!ch.hasCar) {
      brokeCards.push({ key: 'broke_bike', cat: 'üöó Transport', icon: 'üö≤', title: 'Used Bike', desc: '$60 for a bike. Better than walking.', type: 'broke',
        left: { label: 'Pass', effect: 'Keep walking', imp: {} },
        right: { label: 'Buy', effect: '-$60, +3 Health', imp: { cash: -60, health: 3 } }
      });
      
      brokeCards.push({ key: 'broke_buspass', cat: 'üöó Transport', icon: 'üöå', title: 'Monthly Bus Pass', desc: '$50/month unlimited rides.', type: 'broke',
        left: { label: 'Walk', effect: '-3 Health', imp: { health: -3 } },
        right: { label: 'Get Pass', effect: '-$50, easier commute', imp: { cash: -50, happy: 3 } }
      });
    }
    
    // ASSISTANCE PROGRAMS - More options
    if (!ch.foodStamps) {
      brokeCards.push({ key: 'broke_snap', cat: 'üçé Assistance', icon: 'üçé', title: 'SNAP Benefits', desc: 'Apply for food stamps. $200/month for groceries.', type: 'broke',
        left: { label: 'Too Proud', effect: 'No change', imp: { happy: -3 } },
        right: { label: 'Apply', effect: 'Reduce food costs', imp: { happy: 5 }, setSnap: true }
      });
    }
    
    brokeCards.push({ key: 'broke_foodbank', cat: 'üçé Assistance', icon: 'ü•´', title: 'Food Bank', desc: 'Local food bank distributing today.', type: 'broke',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Go', effect: '+$100 saved, +3 Health', imp: { cash: 100, health: 3 } }
    });
    
    brokeCards.push({ key: 'broke_pantry', cat: 'üçé Assistance', icon: 'üçû', title: 'Church Pantry', desc: 'Free groceries, no questions asked.', type: 'broke',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Go', effect: '+$80, +2 Health', imp: { cash: 80, health: 2 } }
    });
    
    brokeCards.push({ key: 'broke_clinic', cat: 'üè• Health', icon: 'üè•', title: 'Free Clinic', desc: 'Community health clinic offers free checkup.', type: 'broke',
      left: { label: 'Feeling Fine', effect: 'No change', imp: {} },
      right: { label: 'Get Checkup', effect: '+10 Health', imp: { health: 10 } }
    });
    
    brokeCards.push({ key: 'broke_dental', cat: 'üè• Health', icon: 'ü¶∑', title: 'Free Dental Day', desc: 'Dental school offering free cleanings.', type: 'broke',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Go', effect: '+5 Health', imp: { health: 5 } }
    });
    
    brokeCards.push({ key: 'broke_clothes', cat: 'üëî Assistance', icon: 'üëî', title: 'Free Clothes Closet', desc: 'Nonprofit has interview clothes available.', type: 'broke',
      left: { label: 'Have Clothes', effect: 'No change', imp: {} },
      right: { label: 'Get Outfit', effect: '+5 Happy, better interviews', imp: { happy: 5 } }
    });
    
    // MONEY OPPORTUNITIES - Lots more
    brokeCards.push({ key: 'broke_plasma', cat: 'üíâ Money', icon: 'ü©∏', title: 'Donate Plasma', desc: 'Plasma center pays $50 per donation.', type: 'broke',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Donate', effect: '+$50, -3 Health', imp: { cash: 50, health: -3 } }
    });
    
    brokeCards.push({ key: 'broke_recycle', cat: 'üí∞ Money', icon: '‚ôªÔ∏è', title: 'Can Collecting', desc: 'Spend day collecting recyclables.', type: 'broke',
      left: { label: 'Not Worth It', effect: 'No change', imp: {} },
      right: { label: 'Hustle', effect: '+$30, -5 Health', imp: { cash: 30, health: -5 } }
    });
    
    brokeCards.push({ key: 'broke_odd', cat: 'üí∞ Money', icon: 'üîß', title: 'Odd Jobs', desc: 'Neighbor needs help moving furniture. $75.', type: 'broke',
      left: { label: 'Pass', effect: 'No change', imp: {} },
      right: { label: 'Help Out', effect: '+$75, -3 Health', imp: { cash: 75, health: -3 } }
    });
    
    brokeCards.push({ key: 'broke_yard', cat: 'üí∞ Money', icon: 'üåø', title: 'Yard Work', desc: 'Someone needs lawn mowed and leaves raked. $50.', type: 'broke',
      left: { label: 'Pass', effect: 'No change', imp: {} },
      right: { label: 'Do It', effect: '+$50, +2 Health (exercise)', imp: { cash: 50, health: 2 } }
    });
    
    brokeCards.push({ key: 'broke_shovel', cat: 'üí∞ Money', icon: '‚ùÑÔ∏è', title: 'Snow Shoveling', desc: 'Neighbors need driveways cleared. $40 each.', type: 'broke',
      left: { label: 'Too Cold', effect: 'No change', imp: {} },
      right: { label: 'Bundle Up', effect: '+$80, -3 Health', imp: { cash: 80, health: -3 } }
    });
    
    brokeCards.push({ key: 'broke_carwash', cat: 'üí∞ Money', icon: 'üöø', title: 'Car Wash Hustle', desc: 'Wash cars in parking lot. $10-20 each.', type: 'broke',
      left: { label: 'Pass', effect: 'No change', imp: {} },
      right: { label: 'Hustle', effect: '+$60', imp: { cash: 60 } }
    });
    
    brokeCards.push({ key: 'broke_focus', cat: 'üí∞ Money', icon: 'üß™', title: 'Focus Group', desc: 'Marketing company pays $75 for 2-hour opinion session.', type: 'broke',
      left: { label: 'Waste of Time', effect: 'No change', imp: {} },
      right: { label: 'Attend', effect: '+$75, +free snacks', imp: { cash: 75, health: 2 } }
    });
    
    brokeCards.push({ key: 'broke_study', cat: 'üí∞ Money', icon: 'üî¨', title: 'Research Study', desc: 'University paying $150 for health study participants.', type: 'broke',
      left: { label: 'Sounds Sketchy', effect: 'No change', imp: {} },
      right: { label: 'Sign Up', effect: '+$150', imp: { cash: 150 } }
    });
    
    if (ch.hasPhone) {
      brokeCards.push({ key: 'broke_survey', cat: 'üí∞ Money', icon: 'üìã', title: 'Online Surveys', desc: 'Spend evening doing paid surveys.', type: 'broke',
        left: { label: 'Waste of Time', effect: 'No change', imp: {} },
        right: { label: 'Grind', effect: '+$25', imp: { cash: 25 } }
      });
      
      brokeCards.push({ key: 'broke_mturk', cat: 'üí∞ Money', icon: 'üíª', title: 'Amazon MTurk', desc: 'Small online tasks for pay. Tedious but adds up.', type: 'broke',
        left: { label: 'Skip', effect: 'No change', imp: {} },
        right: { label: 'Grind', effect: '+$40', imp: { cash: 40 } }
      });
      
      brokeCards.push({ key: 'broke_flip', cat: 'üí∞ Money', icon: 'üîÑ', title: 'Thrift Flipping', desc: 'Buy cheap at thrift, sell online for profit.', type: 'broke',
        left: { label: 'No Eye For It', effect: 'No change', imp: {} },
        right: { label: 'Try It', effect: '+$100', imp: { cash: 100, happy: 5 } }
      });
    }
    
    // MICRO BUSINESS - start from nothing
    if (st.cash >= 200 && !ch.biz) {
      brokeCards.push({ key: 'broke_microbiz1', cat: 'üè¢ Micro Biz', icon: 'üßπ', title: 'Start Cleaning Gig', desc: 'Just $200 for supplies. Clean houses for cash.', type: 'broke',
        left: { label: 'Not Ready', effect: 'Keep saving', imp: {} },
        right: { label: 'Start It', effect: '-$200, begin business', imp: { cash: -200 }, startBiz: { id: 'cleaning', name: 'Cleaning Biz', icon: 'üßπ', cost: 200, baseRev: 18000 } }
      });
    }
    
    if (st.cash >= 150 && !ch.biz) {
      brokeCards.push({ key: 'broke_microbiz2', cat: 'üè¢ Micro Biz', icon: 'üåø', title: 'Lawn Care Start', desc: '$150 for basic equipment. Mow lawns for income.', type: 'broke',
        left: { label: 'Too Physical', effect: 'No change', imp: {} },
        right: { label: 'Start It', effect: '-$150, begin business', imp: { cash: -150 }, startBiz: { id: 'lawn', name: 'Lawn Care', icon: 'üåø', cost: 150, baseRev: 15000 } }
      });
    }
    
    if (st.cash >= 100 && !ch.biz && ch.hasPhone) {
      brokeCards.push({ key: 'broke_microbiz3', cat: 'üè¢ Micro Biz', icon: 'üì±', title: 'Social Media Manager', desc: '$100 for some tools. Help small businesses online.', type: 'broke',
        left: { label: 'Not Skilled', effect: 'No change', imp: {} },
        right: { label: 'Try It', effect: '-$100, digital business', imp: { cash: -100 }, startBiz: { id: 'social', name: 'Social Media', icon: 'üì±', cost: 100, baseRev: 12000 } }
      });
    }
    
    if (st.cash >= 300 && !ch.biz) {
      brokeCards.push({ key: 'broke_microbiz4', cat: 'üè¢ Micro Biz', icon: 'üç™', title: 'Baking Business', desc: '$300 for supplies. Sell baked goods locally.', type: 'broke',
        left: { label: 'Can\'t Bake', effect: 'No change', imp: {} },
        right: { label: 'Start Baking', effect: '-$300, tasty income', imp: { cash: -300 }, startBiz: { id: 'baking', name: 'Baked Goods', icon: 'üç™', cost: 300, baseRev: 16000 } }
      });
    }
    
    if (st.cash >= 500 && !ch.biz && ch.hasCar) {
      brokeCards.push({ key: 'broke_microbiz5', cat: 'üè¢ Micro Biz', icon: 'üöö', title: 'Delivery Service', desc: '$500 for insurance. Do local deliveries.', type: 'broke',
        left: { label: 'Too Much Risk', effect: 'No change', imp: {} },
        right: { label: 'Start Delivering', effect: '-$500, mobile business', imp: { cash: -500 }, startBiz: { id: 'delivery', name: 'Delivery Biz', icon: 'üöö', cost: 500, baseRev: 22000 } }
      });
    }
    
    // SELF IMPROVEMENT
    brokeCards.push({ key: 'broke_library', cat: 'üìö Growth', icon: 'üìö', title: 'Library Card', desc: 'Free books, internet, and AC at the library.', type: 'broke',
      left: { label: 'Not Interested', effect: 'No change', imp: {} },
      right: { label: 'Get Card', effect: '+5 Happy, learn skills', imp: { happy: 5 } }
    });
    
    brokeCards.push({ key: 'broke_ged', cat: 'üìö Growth', icon: 'üéì', title: 'GED Program', desc: 'Free GED classes at community center.', type: 'broke',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Enroll', effect: '+10 Happy, better prospects', imp: { happy: 10 }, setGED: true }
    });
    
    brokeCards.push({ key: 'broke_training', cat: 'üìö Growth', icon: 'üíº', title: 'Job Training', desc: 'Workforce center offers free training program.', type: 'broke',
      left: { label: 'No Time', effect: 'No change', imp: {} },
      right: { label: 'Sign Up', effect: '+$5K salary potential', imp: { salary: 5000, happy: 8 } }
    });
    
    brokeCards.push({ key: 'broke_computer', cat: 'üìö Growth', icon: 'üíª', title: 'Free Computer Class', desc: 'Library offers basic computer skills class.', type: 'broke',
      left: { label: 'Know Enough', effect: 'No change', imp: {} },
      right: { label: 'Take Class', effect: '+8 Happy, more job options', imp: { happy: 8 } }
    });
    
    brokeCards.push({ key: 'broke_cdl', cat: 'üìö Growth', icon: 'üöõ', title: 'CDL Training', desc: 'Free truck driving school. 6-week program.', type: 'broke',
      left: { label: 'Not Interested', effect: 'No change', imp: {} },
      right: { label: 'Enroll', effect: '+$15K salary when done', imp: { salary: 15000, happy: 15 } }
    });
    
    brokeCards.push({ key: 'broke_cna', cat: 'üìö Growth', icon: 'üè•', title: 'CNA Certification', desc: 'Free nursing assistant training. 8 weeks.', type: 'broke',
      left: { label: 'Not For Me', effect: 'No change', imp: {} },
      right: { label: 'Enroll', effect: '+$12K salary, healthcare path', imp: { salary: 12000, happy: 10 } }
    });
    
    // CREDIT BUILDING
    if (st.credit < 580) {
      brokeCards.push({ key: 'broke_secured', cat: 'üí≥ Credit', icon: 'üí≥', title: 'Secured Card', desc: '$200 deposit to start building credit.', type: 'broke',
        left: { label: 'Not Now', effect: 'Credit stays low', imp: {} },
        right: { label: 'Apply', effect: '-$200, +15 Credit', imp: { cash: -200, credit: 15 } }
      });
      
      brokeCards.push({ key: 'broke_credit2', cat: 'üí≥ Credit', icon: 'üìä', title: 'Credit Builder Loan', desc: 'Credit union offers small builder loan.', type: 'broke',
        left: { label: 'Skip', effect: 'No change', imp: {} },
        right: { label: 'Apply', effect: '+20 Credit over time', imp: { credit: 20 } }
      });
      
      brokeCards.push({ key: 'broke_report', cat: 'üí≥ Credit', icon: 'üìù', title: 'Dispute Credit Error', desc: 'Found error on credit report. Worth disputing.', type: 'broke',
        left: { label: 'Too Much Work', effect: 'No change', imp: {} },
        right: { label: 'Dispute It', effect: '+25 Credit', imp: { credit: 25, happy: 5 } }
      });
    }
    
    // SOCIAL/COMMUNITY
    brokeCards.push({ key: 'broke_mentor', cat: 'üë• Community', icon: 'ü§ù', title: 'Mentor Program', desc: 'Nonprofit matches you with career mentor.', type: 'broke',
      left: { label: 'Not Interested', effect: 'No change', imp: {} },
      right: { label: 'Sign Up', effect: '+8 Happy, guidance', imp: { happy: 8 } }
    });
    
    brokeCards.push({ key: 'broke_support', cat: 'üë• Community', icon: 'üí™', title: 'Support Group', desc: 'Free support group for people rebuilding.', type: 'broke',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Attend', effect: '+10 Happy', imp: { happy: 10 } }
    });
    
    brokeCards.push({ key: 'broke_network', cat: 'üë• Community', icon: 'ü§ù', title: 'Job Fair', desc: 'Local job fair happening this weekend.', type: 'broke',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Attend', effect: '+job leads, +5 Happy', imp: { happy: 5 } }
    });
    
    brokeCards.push({ key: 'broke_aa', cat: 'üë• Community', icon: '‚òï', title: 'Community Meeting', desc: 'Local community group meeting. Free coffee.', type: 'broke',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Go', effect: '+5 Happy, connections', imp: { happy: 5 } }
    });
    
    // RANDOM POSITIVE EVENTS
    brokeCards.push({ key: 'broke_kind', cat: 'üåü Random', icon: 'üíù', title: 'Stranger\'s Kindness', desc: 'Someone buys you lunch and slips you $20.', type: 'broke',
      left: { label: 'Decline', effect: '+5 Happy (pride)', imp: { happy: 5 } },
      right: { label: 'Accept', effect: '+$20, +5 Happy', imp: { cash: 20, happy: 5 } }
    });
    
    brokeCards.push({ key: 'broke_find', cat: 'üåü Random', icon: 'üíµ', title: 'Found Money', desc: 'Found $20 on the ground.', type: 'broke',
      left: { label: 'Leave It', effect: 'Good karma?', imp: { happy: 2 } },
      right: { label: 'Keep It', effect: '+$20', imp: { cash: 20 } }
    });
    
    brokeCards.push({ key: 'broke_tip', cat: 'üåü Random', icon: 'üí∞', title: 'Generous Tip', desc: 'Someone tips you $50 for small favor.', type: 'broke',
      left: { label: 'Too Much', effect: '+10 Happy', imp: { happy: 10 } },
      right: { label: 'Thank Them', effect: '+$50, +8 Happy', imp: { cash: 50, happy: 8 } }
    });
    
    brokeCards.push({ key: 'broke_win', cat: 'üåü Random', icon: 'üé∞', title: 'Scratch Ticket Win', desc: 'Found scratch ticket on ground. Won $100!', type: 'broke',
      left: { label: 'Return It?', effect: '+5 Happy (honest)', imp: { happy: 5 } },
      right: { label: 'Cash It', effect: '+$100', imp: { cash: 100, happy: 8 } }
    });
    
    brokeCards.push({ key: 'broke_refund', cat: 'üåü Random', icon: 'üì¨', title: 'Unexpected Refund', desc: 'Old utility deposit returned. $75 check arrives.', type: 'broke',
      left: { label: 'Error?', effect: 'No change', imp: {} },
      right: { label: 'Cash It', effect: '+$75', imp: { cash: 75 } }
    });
    
    // Pick random cards - prioritize essentials
    if (brokeCards.length > 0) {
      const priority = brokeCards.filter(c => 
        (!ch.hasPhone && c.key.includes('phone')) ||
        (!hasJob && (c.key.includes('broke_daylab') || c.key.includes('broke_fast') || c.key.includes('broke_warehouse') || c.key.includes('broke_retail') || c.key.includes('broke_gig') || c.key.includes('broke_clean'))) ||
        (ch.housing === 'homeless' && (c.key.includes('shelter') || c.key.includes('couch') || c.key.includes('church') || c.key.includes('roommate') || c.key.includes('family')))
      );
      
      if (priority.length > 0 && Math.random() < 0.5) {
        cards.push(pick(priority));
      } else {
        cards.push(pick(brokeCards));
      }
    }
  }
  
  // BUSINESS CARDS - LOTS of opportunities!
  if (ch.biz) {
    const biz = ch.biz;
    
    if (biz.profit > 5000) {
      cards.push({ key: 'biz_profit', cat: 'üè¢ Business', icon: 'üí∞', title: 'Take Profits?', desc: `${biz.name} has ${fmt(biz.profit)} in profits. Reinvest or cash out?`, type: 'business',
        left: { label: 'Take Cash', effect: `+${fmt(biz.profit)}`, imp: { cash: biz.profit }, bizTakeProfit: true },
        right: { label: 'Reinvest', effect: '+20% growth', bizReinvest: true }
      });
    }
    
    if (Math.random() < 0.2) {
      cards.push({ key: 'biz_hire', cat: 'üè¢ Business', icon: 'üë•', title: 'Hire Staff?', desc: 'More employees = more capacity. $40K/yr payroll.', type: 'business',
        left: { label: 'Stay Lean', effect: '-5 Health', imp: { health: -5 } },
        right: { label: 'Hire', effect: '-$40K/yr, +30% rev', imp: { salary: -40000 }, bizHire: true }
      });
    }
    
    if (Math.random() < 0.18) {
      cards.push({ key: 'biz_market', cat: 'üè¢ Business', icon: 'üì¢', title: 'Marketing Push', desc: 'Big ad campaign could bring in more customers.', type: 'business',
        left: { label: 'Word of Mouth', effect: 'Slow growth', imp: {} },
        right: { label: 'Advertise', effect: '-$8K, +15% rev', imp: { cash: -8000 }, bizMarketing: true }
      });
    }
    
    if (Math.random() < 0.15) {
      cards.push({ key: 'biz_expand', cat: 'üè¢ Business', icon: 'üèóÔ∏è', title: 'Expand Location', desc: 'Open a second location for your business.', type: 'business',
        left: { label: 'Stay Small', effect: 'Less risk', imp: {} },
        right: { label: 'Expand', effect: '-$25K, +40% rev', imp: { cash: -25000 }, bizExpand: true }
      });
    }
    
    if (Math.random() < 0.12) {
      cards.push({ key: 'biz_partner', cat: 'üè¢ Business', icon: 'ü§ù', title: 'Partnership Offer', desc: 'Someone wants to invest. Give up 20% for $30K.', type: 'business',
        left: { label: 'Stay Solo', effect: 'Keep control', imp: {} },
        right: { label: 'Accept', effect: '+$30K, partner helps', imp: { cash: 30000, happy: 5 } }
      });
    }
    
    if (biz.revenue > 80000 && Math.random() < 0.15) {
      cards.push({ key: 'biz_franchise', cat: 'üè¢ Business', icon: 'üè™', title: 'Franchise It?', desc: 'Your business model works. Let others pay to copy it.', type: 'business',
        left: { label: 'Keep Unique', effect: 'Stay special', imp: {} },
        right: { label: 'Franchise', effect: '-$20K setup, +$15K/yr royalties', imp: { cash: -20000, salary: 15000 } }
      });
    }
    
    if (biz.revenue > 100000 && Math.random() < 0.15) {
      const offer = Math.round(biz.revenue * rand(25, 40) / 10);
      cards.push({ key: 'biz_sell', cat: 'üè¢ Business', icon: 'üíé', title: 'Acquisition Offer', desc: `Company wants to buy ${biz.name} for ${fmt(offer)}.`, type: 'business',
        left: { label: 'Keep It', effect: 'Stay independent', imp: {} },
        right: { label: 'Sell', effect: `+${fmt(offer)}`, imp: { cash: offer }, sellBiz: true }
      });
    }
    
    if (Math.random() < 0.1) {
      cards.push({ key: 'biz_crisis', cat: 'üè¢ Crisis', icon: '‚ö†Ô∏è', title: 'Business Emergency', desc: `${biz.name} needs $8K for urgent repairs/legal.`, type: 'danger',
        left: { label: 'Close It', effect: 'Lose business', closeBiz: true, imp: { happy: -15 } },
        right: { label: 'Fix It', effect: '-$8K', imp: { cash: -8000 } }
      });
    }
    
    if (Math.random() < 0.12) {
      cards.push({ key: 'biz_bigclient', cat: 'üè¢ Business', icon: '‚≠ê', title: 'Big Client Interest', desc: 'Major client wants to work with you. Could be huge!', type: 'business',
        left: { label: 'Too Big', effect: 'Play it safe', imp: {} },
        right: { label: 'Pitch Them', effect: '70% chance +25% revenue', bizBigClient: true }
      });
    }
    
    if (Math.random() < 0.1) {
      cards.push({ key: 'biz_online', cat: 'üè¢ Business', icon: 'üåê', title: 'Go Online', desc: 'Add e-commerce to reach more customers.', type: 'business',
        left: { label: 'Stay Local', effect: 'Keep it simple', imp: {} },
        right: { label: 'Build Site', effect: '-$5K, +20% revenue', imp: { cash: -5000 }, bizOnline: true }
      });
    }
  }
  
  // Start business - MORE opportunities, LOWER barriers
  if (!ch.biz && st.cash >= 5000 && st.credit >= 580 && Math.random() < 0.25) {
    const bizType = pick(BIZ_TYPES.filter(b => st.cash >= b.cost * 0.4));
    if (bizType) {
      cards.push({ key: 'biz_start', cat: 'üè¢ Opportunity', icon: bizType.icon, title: `Start ${bizType.name}?`, desc: `${fmt(bizType.cost)} to start. Potential ${fmt(bizType.baseRev)}/yr revenue.`, type: 'business',
        left: { label: 'Too Risky', effect: 'Keep stability', imp: {} },
        right: { label: 'Launch', effect: `-${fmt(bizType.cost)}`, imp: { cash: -bizType.cost }, startBiz: bizType }
      });
    }
  }
  
  // Small business options for lower cash
  if (!ch.biz && st.cash >= 2000 && st.cash < 15000 && Math.random() < 0.2) {
    const smallBiz = [
      { id: 'lawn', name: 'Lawn Care', icon: 'üåø', cost: 2000, baseRev: 25000 },
      { id: 'cleaning', name: 'Cleaning Service', icon: 'üßπ', cost: 1500, baseRev: 22000 },
      { id: 'tutoring', name: 'Tutoring', icon: 'üìö', cost: 500, baseRev: 18000 },
      { id: 'photography', name: 'Photography', icon: 'üì∑', cost: 3000, baseRev: 28000 },
      { id: 'handyman', name: 'Handyman', icon: 'üîß', cost: 2500, baseRev: 30000 },
      { id: 'catering', name: 'Catering', icon: 'üçΩÔ∏è', cost: 4000, baseRev: 35000 },
    ];
    const biz = pick(smallBiz.filter(b => st.cash >= b.cost));
    if (biz) {
      cards.push({ key: 'biz_small', cat: 'üè¢ Small Biz', icon: biz.icon, title: `Start ${biz.name}?`, desc: `Only ${fmt(biz.cost)} to start! Can grow to ${fmt(biz.baseRev)}/yr.`, type: 'business',
        left: { label: 'Not Ready', effect: 'Keep saving', imp: {} },
        right: { label: 'Start It', effect: `-${fmt(biz.cost)}`, imp: { cash: -biz.cost }, startBiz: biz }
      });
    }
  }
  
  // Side business / freelance (even with job)
  if (!ch.biz && st.cash >= 500 && Math.random() < 0.15) {
    cards.push({ key: 'biz_freelance', cat: 'üíº Side Hustle', icon: 'üíª', title: 'Freelance on Side', desc: 'Use your skills for extra income. Flexible hours.', type: 'business',
      left: { label: 'No Time', effect: 'Focus on job', imp: {} },
      right: { label: 'Start', effect: '+$8K/yr side income', imp: { salary: 8000 } }
    });
  }
  
  // Second business
  if (ch.biz && !ch.biz2 && st.cash >= 25000 && Math.random() < 0.12) {
    const bizType = pick(BIZ_TYPES.filter(b => st.cash >= b.cost * 0.5 && b.id !== ch.biz.id));
    if (bizType) {
      cards.push({ key: 'biz_second', cat: 'üè¢ Empire', icon: 'üè∞', title: 'Second Business?', desc: `Start ${bizType.name} while running ${ch.biz.name}?`, type: 'business',
        left: { label: 'Stay Focused', effect: 'One is enough', imp: {} },
        right: { label: 'Expand', effect: `-${fmt(bizType.cost)}`, imp: { cash: -bizType.cost }, startBiz2: bizType }
      });
    }
  }
  
  // Business mentorship/learning
  if (!ch.biz && Math.random() < 0.1) {
    cards.push({ key: 'biz_learn', cat: 'üìö Growth', icon: 'üéì', title: 'Business Course', desc: 'Learn entrepreneurship. $1K course, lifetime skills.', type: 'opportunity',
      left: { label: 'Self-taught', effect: 'Learn by doing', imp: {} },
      right: { label: 'Take Course', effect: '-$1K, better biz outcomes', imp: { cash: -1000, happy: 5 } }
    });
  }
  
  // TRAPS (no warnings)
  if (st.cash > 5000 && Math.random() < 0.15) {
    cards.push({ key: 'trap_ponzi', cat: 'üìà Investment', icon: 'üíé', title: 'Exclusive Investment', desc: '"Friend" has private fund. 30% monthly returns guaranteed!', isTrap: true,
      left: { label: 'Pass', effect: 'Miss out?', imp: {} },
      right: { label: 'Invest', effect: 'Sounds great...', imp: { cash: -Math.min(st.cash * 0.7, 25000) }, trapSprung: true }
    });
  }
  
  if (st.cash > 3000 && Math.random() < 0.12) {
    cards.push({ key: 'trap_crypto', cat: 'üìà Investment', icon: 'üöÄ', title: 'Hot Crypto Tip', desc: 'This coin is going to 100x. Last chance to get in!', isTrap: true,
      left: { label: 'Hard Pass', effect: 'Play safe', imp: {} },
      right: { label: 'YOLO', effect: 'To the moon?', imp: { cash: -Math.min(st.cash * 0.5, 15000) }, trapSprung: true }
    });
  }
  
  if (st.salary > 50000 && Math.random() < 0.15) {
    cards.push({ key: 'trap_car', cat: 'üöó Lifestyle', icon: 'üèéÔ∏è', title: 'Luxury Lease', desc: 'BMW lease only $900/month. You work hard, you deserve it!', isTrap: true,
      left: { label: 'Stay Humble', effect: 'Keep old car', imp: { happy: -2 } },
      right: { label: 'Treat Myself', effect: 'Look successful', imp: { salary: -10800 }, trapSprung: true }
    });
  }
  
  if (poor && Math.random() < 0.2) {
    cards.push({ key: 'trap_payday', cat: 'üí≥ Quick Cash', icon: 'üíµ', title: 'Payday Loan', desc: 'Get $2,000 today! Easy payments of just $50/week.', isTrap: true,
      left: { label: 'Read Terms', effect: 'Walk away', imp: {} },
      right: { label: 'Get Cash', effect: '+$2K now', imp: { cash: 2000, debt: 8000, credit: -40 }, trapSprung: true }
    });
  }
  
  if (Math.random() < 0.1) {
    cards.push({ key: 'trap_mlm', cat: 'üíº Opportunity', icon: 'üéØ', title: 'Be Your Own Boss', desc: 'Join my team! $2K starter kit, unlimited income potential!', isTrap: true,
      left: { label: 'No Thanks', effect: 'Dodge bullet', imp: {} },
      right: { label: 'Sign Up', effect: 'Join the team', imp: { cash: -2000, happy: -10 }, trapSprung: true }
    });
  }
  
  // ========================================
  // CRIME - Tempting but NOT worth it!
  // ========================================
  const hasRecord = (ch.crimeRecord || 0) > 0;
  
  // Petty crime when broke - tempting quick cash
  if (st.cash < 500 && !ch.inJail && Math.random() < 0.15) {
    cards.push({ key: 'crime_shoplift', cat: 'üö® Crime', icon: 'üõí', title: 'Shoplifting', desc: 'You could pocket some groceries. No one is watching...', type: 'danger',
      left: { label: 'Stay Honest', effect: '+5 Happy (integrity)', imp: { happy: 5 } },
      right: { label: 'Take It', effect: '30% caught', crime: { type: 'petty', reward: 100, catchChance: 0.3, penalty: { cash: -500, credit: -30, crimeRecord: 1 } } }
    });
  }
  
  // Drug dealing when desperate
  if (st.cash < 1000 && st.salary < 25000 && !ch.inJail && Math.random() < 0.1) {
    cards.push({ key: 'crime_deal', cat: 'üö® Crime', icon: 'üíä', title: 'Quick Money', desc: 'Someone offers $500 to deliver a package. Don\'t ask questions.', type: 'danger',
      left: { label: 'No Way', effect: 'Stay clean', imp: { happy: 3 } },
      right: { label: 'Do It', effect: '40% caught', crime: { type: 'dealing', reward: 500, catchChance: 0.4, penalty: { cash: -2000, credit: -50, crimeRecord: 2, jailTime: 2 } } }
    });
  }
  
  // Fraud when you have a job
  if (st.salary > 40000 && !ch.inJail && Math.random() < 0.08) {
    cards.push({ key: 'crime_fraud', cat: 'üö® Crime', icon: 'üí≥', title: 'Expense Fraud', desc: 'You could inflate expense reports. Company won\'t notice a few thousand...', type: 'danger',
      left: { label: 'Not Worth It', effect: 'Keep integrity', imp: { happy: 5 } },
      right: { label: 'Skim It', effect: '35% caught', crime: { type: 'fraud', reward: 3000, catchChance: 0.35, penalty: { salary: -st.salary, cash: -5000, credit: -80, crimeRecord: 2, fired: true } } }
    });
  }
  
  // Insurance fraud with house/car
  if (ch.housing === 'own' && !ch.inJail && Math.random() < 0.06) {
    cards.push({ key: 'crime_insurance', cat: 'üö® Crime', icon: 'üè†', title: 'Insurance Scam', desc: 'Friend knows how to stage a break-in. Split the $15K payout?', type: 'danger',
      left: { label: 'Absolutely Not', effect: 'Stay clean', imp: { happy: 3 } },
      right: { label: 'Stage It', effect: '45% investigated', crime: { type: 'insurance', reward: 7500, catchChance: 0.45, penalty: { cash: -20000, credit: -100, crimeRecord: 3, jailTime: 3 } } }
    });
  }
  
  // Tax evasion when earning well
  if (st.salary > 80000 && !ch.inJail && Math.random() < 0.07) {
    const evadeAmount = Math.round(st.salary * 0.15);
    cards.push({ key: 'crime_taxes', cat: 'üö® Crime', icon: 'üèõÔ∏è', title: 'Hide Income', desc: `Accountant offers to hide ${fmt(evadeAmount)} from taxes. Offshore accounts...`, type: 'danger',
      left: { label: 'Pay My Taxes', effect: 'Sleep well', imp: { happy: 3 } },
      right: { label: 'Evade', effect: '50% audited', crime: { type: 'tax_evasion', reward: evadeAmount, catchChance: 0.5, penalty: { cash: -evadeAmount * 3, credit: -60, crimeRecord: 2 } } }
    });
  }
  
  // Robbery when desperate - worst option
  if (st.cash < 200 && ch.housing === 'homeless' && !ch.inJail && Math.random() < 0.08) {
    cards.push({ key: 'crime_rob', cat: 'üö® Crime', icon: 'üî´', title: 'Rob a Store', desc: 'You\'re desperate. The corner store has cash...', type: 'danger',
      left: { label: 'Never', effect: '+10 Happy (kept soul)', imp: { happy: 10 } },
      right: { label: 'Do It', effect: '60% caught', crime: { type: 'robbery', reward: 800, catchChance: 0.6, penalty: { credit: -100, crimeRecord: 5, jailTime: 5 } } }
    });
  }
  
  // White collar crime with business
  if (ch.biz && ch.biz.revenue > 100000 && !ch.inJail && Math.random() < 0.06) {
    cards.push({ key: 'crime_embezzle', cat: 'üö® Crime', icon: 'üè¢', title: 'Cook the Books', desc: 'Skim $20K from business accounts. Who would know?', type: 'danger',
      left: { label: 'Run It Clean', effect: '+5 Happy', imp: { happy: 5 } },
      right: { label: 'Embezzle', effect: '40% caught', crime: { type: 'embezzle', reward: 20000, catchChance: 0.4, penalty: { cash: -50000, credit: -100, crimeRecord: 4, jailTime: 4, loseBiz: true } } }
    });
  }
  
  // Someone offers to buy stolen goods
  if (!ch.inJail && Math.random() < 0.08) {
    cards.push({ key: 'crime_fence', cat: 'üö® Crime', icon: 'üì¶', title: 'Stolen Goods', desc: 'Friend selling "hot" electronics cheap. iPhone for $100?', type: 'danger',
      left: { label: 'Pass', effect: 'Stay legal', imp: {} },
      right: { label: 'Buy It', effect: '20% caught', crime: { type: 'fence', reward: 0, catchChance: 0.2, penalty: { cash: -100, credit: -20, crimeRecord: 1 }, cost: 100 } }
    });
  }
  
  // Consequences of having a record
  if (hasRecord && Math.random() < 0.15) {
    cards.push({ key: 'record_consequence', cat: 'üìã Record', icon: 'üö´', title: 'Background Check', desc: 'Employer ran check. Your record came up...', type: 'danger',
      left: { label: 'Explain', effect: '50% fired anyway', recordCheck: true },
      right: { label: 'Quit First', effect: 'Keep dignity', imp: { salary: 0, happy: -10 }, setJob: 'none' }
    });
  }
  
  // Getting out of jail
  if (ch.inJail && ch.jailTime > 0) {
    return { key: 'jail_time', cat: '‚õìÔ∏è Prison', icon: 'üîí', title: `Year ${ch.jailServed || 1} in Prison`, desc: `${ch.jailTime - (ch.jailServed || 0)} years left. Time passes slowly.`, isEvent: true, noYear: false,
      left: { label: 'Serve Time', effect: 'Another year', imp: { happy: -20, health: -10 }, jailYear: true },
      right: { label: 'Serve Time', effect: 'Another year', imp: { happy: -20, health: -10 }, jailYear: true }
    };
  }
  
  // TAX CARDS
  if (Math.random() < 0.12) {
    const taxes = calcTaxes(st.salary + (ch.biz?.profit || 0), ch);
    if (taxes.total > 0) {
      cards.push({ key: 'tax_irs', cat: 'üèõÔ∏è IRS', icon: 'üìã', title: 'IRS Audit', desc: `Your return flagged. May owe ${fmt(taxes.total * 0.2)} in back taxes + penalties.`, type: 'tax',
        left: { label: 'Fight It', effect: '50% chance win', irsAudit: true },
        right: { label: 'Pay Up', effect: `-${fmt(taxes.total * 0.2)}`, imp: { cash: -Math.round(taxes.total * 0.2) } }
      });
    }
  }
  
  // CAREER VARIETY - many different scenarios
  if (!broke && !ch.inJail) {
    const careerCards = [];
    const currentCap = CAREERS.find(c => c.id === ch.career)?.cap || 100000;
    
    if (st.salary < currentCap) {
      careerCards.push({ key: 'career_raise', cat: 'üíº Career', icon: 'üìà', title: 'Promotion Offer', desc: `Boss noticed your work. ${fmt(rand(4000, 12000))}/yr raise.`,
        left: { label: 'Decline', effect: '+5 Happy', imp: { happy: 5 } },
        right: { label: 'Accept', effect: `+salary`, imp: { salary: rand(4000, 12000), happy: 8 } }
      });
      
      careerCards.push({ key: 'career_review', cat: 'üíº Career', icon: '‚≠ê', title: 'Performance Review', desc: 'Annual review coming up. Prepare or wing it?',
        left: { label: 'Wing It', effect: '50% small raise', reviewWing: true },
        right: { label: 'Prepare', effect: '-5 Health, 80% good raise', imp: { health: -5 }, reviewPrepare: true }
      });
      
      careerCards.push({ key: 'career_project', cat: 'üíº Career', icon: 'üéØ', title: 'Lead Big Project', desc: 'Chance to lead major initiative. High visibility.',
        left: { label: 'Pass', effect: 'Stay comfortable', imp: { happy: 3 } },
        right: { label: 'Take Lead', effect: '-10 Health, potential raise', imp: { health: -10 }, leadProject: true }
      });
    }
    
    careerCards.push({ key: 'career_conference', cat: 'üíº Career', icon: 'üé§', title: 'Industry Conference', desc: 'Company offers to send you. Great networking.',
      left: { label: 'Skip', effect: 'Save energy', imp: { health: 5 } },
      right: { label: 'Attend', effect: '+connections, -$500', imp: { cash: -500, happy: 8 } }
    });
    
    careerCards.push({ key: 'career_cert', cat: 'üíº Career', icon: 'üìú', title: 'Get Certified', desc: 'Professional certification could boost career. $2K cost.',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Get Certified', effect: '-$2K, +$5K salary', imp: { cash: -2000, salary: 5000 } }
    });
    
    careerCards.push({ key: 'career_mentor', cat: 'üíº Career', icon: 'üßë‚Äçüè´', title: 'Mentor Junior Staff', desc: 'Asked to mentor new hires. Time commitment but rewarding.',
      left: { label: 'Too Busy', effect: 'No change', imp: {} },
      right: { label: 'Mentor', effect: '+10 Happy, noticed by leadership', imp: { happy: 10 } }
    });
    
    careerCards.push({ key: 'career_lateral', cat: 'üíº Career', icon: '‚ÜîÔ∏è', title: 'Lateral Move', desc: 'Different department wants you. Same pay, new skills.',
      left: { label: 'Stay Put', effect: 'Comfort zone', imp: { happy: 2 } },
      right: { label: 'Switch', effect: 'New opportunities', imp: { happy: 5 } }
    });
    
    careerCards.push({ key: 'career_remote', cat: 'üíº Career', icon: 'üè†', title: 'Remote Work Option', desc: 'Can work from home but might miss office politics.',
      left: { label: 'Stay Office', effect: 'Better visibility', imp: {} },
      right: { label: 'Go Remote', effect: '+8 Happy, +5 Health', imp: { happy: 8, health: 5 } }
    });
    
    careerCards.push({ key: 'career_overtime', cat: 'üíº Career', icon: '‚è∞', title: 'Overtime Available', desc: 'Extra hours available. Time and a half pay.',
      left: { label: 'Work-Life Balance', effect: '+5 Happy', imp: { happy: 5 } },
      right: { label: 'Take Hours', effect: '+$3K, -8 Health', imp: { cash: 3000, health: -8 } }
    });
    
    careerCards.push({ key: 'career_poach', cat: 'üíº Career', icon: 'üìû', title: 'Recruiter Call', desc: 'Headhunter has opportunity. 15% salary bump.',
      left: { label: 'Loyal', effect: '+5 Happy', imp: { happy: 5 } },
      right: { label: 'Interview', effect: '60% get offer', recruitOffer: true }
    });
    
    if (careerCards.length > 0 && Math.random() < 0.25) {
      cards.push(pick(careerCards));
    }
  }
  
  // ========================================
  // PROGRESSION MILESTONES - Story moments!
  // ========================================
  const prog = ch.progression || {};
  
  // After moving out - furniture, lifestyle
  if (prog.movedOut && ch.housing === 'rent' && !prog.boughtHome && Math.random() < 0.2) {
    cards.push({ key: 'prog_furniture', cat: 'üè† Life', icon: 'üõãÔ∏è', title: 'Furnish Your Place', desc: 'Empty apartment needs furniture. IKEA run?',
      left: { label: 'Thrift Store', effect: '-$500, basic', imp: { cash: -500, happy: 3 } },
      right: { label: 'Nice Stuff', effect: '-$3K, +10 Happy', imp: { cash: -3000, happy: 10 } }
    });
  }
  
  // After buying home - renovations
  if (prog.boughtHome && Math.random() < 0.15) {
    cards.push({ key: 'prog_renovate', cat: 'üè† Home', icon: 'üî®', title: 'Home Renovation', desc: 'Kitchen is dated. Renovate for equity?',
      left: { label: 'It\'s Fine', effect: 'Save money', imp: {} },
      right: { label: 'Renovate', effect: '-$15K, +$20K equity', imp: { cash: -15000, equity: 20000, happy: 8 } }
    });
  }
  
  // First time investing milestone
  if (st.invest > 0 && st.invest < 10000 && Math.random() < 0.2) {
    cards.push({ key: 'prog_invest_learn', cat: 'üìà Learning', icon: 'üìö', title: 'Investment Course', desc: 'Learn about index funds, diversification. $500 course.',
      left: { label: 'YouTube Free', effect: '+3 Happy', imp: { happy: 3 } },
      right: { label: 'Take Course', effect: '-$500, better returns', imp: { cash: -500, happy: 8 }, setProgression: 'startedInvesting' }
    });
  }
  
  // Big investor milestone
  if (st.invest >= 50000 && Math.random() < 0.15) {
    cards.push({ key: 'prog_advisor', cat: 'üìà Wealth', icon: 'üé©', title: 'Financial Advisor', desc: 'Your portfolio is growing. Hire professional management?',
      left: { label: 'DIY', effect: 'Keep control', imp: {} },
      right: { label: 'Hire Advisor', effect: '-$2K/yr, peace of mind', imp: { salary: -2000, happy: 10 } }
    });
  }
  
  // After first kid - parenting milestones
  if (ch.kids?.length === 1 && ch.kids[0].age <= 2 && Math.random() < 0.25) {
    const kid = ch.kids[0];
    cards.push({ key: 'prog_firstkid', cat: 'üë∂ Parenting', icon: 'üçº', title: `${kid.name}'s First Steps`, desc: 'Amazing milestone! Your baby is walking!',
      left: { label: 'Document It', effect: '+10 Happy', imp: { happy: 10 } },
      right: { label: 'Baby-Proof House', effect: '-$500, +12 Happy', imp: { cash: -500, happy: 12 } }
    });
  }
  
  // After marriage - honeymoon
  if (ch.rel === 'married' && (ch.yearsMarried || 0) === 0 && Math.random() < 0.5) {
    cards.push({ key: 'prog_honeymoon', cat: 'üíí Marriage', icon: '‚úàÔ∏è', title: 'Honeymoon Time!', desc: 'Where to go for your honeymoon?',
      left: { label: 'Staycation', effect: '+5 Happy, save money', imp: { happy: 5 } },
      right: { label: 'Dream Trip', effect: '-$8K, +20 Happy', imp: { cash: -8000, happy: 20, health: 5 } }
    });
  }
  
  // Anniversary cards
  if (ch.rel === 'married' && (ch.yearsMarried || 0) % 5 === 0 && (ch.yearsMarried || 0) > 0 && Math.random() < 0.4) {
    const years = ch.yearsMarried;
    cards.push({ key: 'prog_anniversary', cat: 'üíí Marriage', icon: 'üíç', title: `${years} Year Anniversary!`, desc: `Celebrate ${years} years of marriage!`,
      left: { label: 'Quiet Dinner', effect: '+5 Happy', imp: { happy: 5 } },
      right: { label: 'Big Celebration', effect: '-$2K, +15 Happy', imp: { cash: -2000, happy: 15 } }
    });
  }
  
  // After starting business - growth stages
  if (ch.biz && ch.biz.revenue < 50000 && Math.random() < 0.2) {
    cards.push({ key: 'prog_biz_early', cat: 'üè¢ Business', icon: 'üå±', title: 'Early Days', desc: `${ch.biz.name} is finding its footing. Hustle harder?`,
      left: { label: 'Steady Pace', effect: 'Sustainable', imp: { happy: 3 } },
      right: { label: 'All In', effect: '-10 Health, +20% revenue', imp: { health: -10 }, bizGrowth: 1.2 }
    });
  }
  
  // Business milestone - first $100K
  if (ch.biz && ch.biz.revenue >= 100000 && ch.biz.revenue < 150000 && Math.random() < 0.3) {
    cards.push({ key: 'prog_biz_100k', cat: 'üè¢ Milestone', icon: 'üéâ', title: '$100K Revenue!', desc: `${ch.biz.name} hit six figures! Celebrate with team?`, type: 'positive',
      left: { label: 'Stay Focused', effect: '+5 Happy', imp: { happy: 5 } },
      right: { label: 'Team Party', effect: '-$3K, +15 Happy, team morale', imp: { cash: -3000, happy: 15 } }
    });
  }
  
  // Debt payoff celebration
  if ((st.debt || 0) === 0 && st.cash > 10000 && Math.random() < 0.15) {
    cards.push({ key: 'prog_debtfree', cat: 'üí∞ Milestone', icon: 'üéä', title: 'Debt Free!', desc: 'You did it! No more debt. What now?',
      left: { label: 'Start Saving', effect: '+10 Happy', imp: { happy: 10 } },
      right: { label: 'Treat Yourself', effect: '-$1K, +15 Happy', imp: { cash: -1000, happy: 15 } }
    });
  }
  
  // LIFE VARIETY
  const lifeCards = [];
  
  lifeCards.push({ key: 'life_gym', cat: 'üèÉ Lifestyle', icon: 'üí™', title: 'Gym Membership', desc: '$50/month for health. Worth it?',
    left: { label: 'Home Workout', effect: '+3 Health (free)', imp: { health: 3 } },
    right: { label: 'Join Gym', effect: '-$600/yr, +10 Health', imp: { cash: -600, health: 10 } }
  });
  
  lifeCards.push({ key: 'life_hobby', cat: 'üé® Lifestyle', icon: 'üé∏', title: 'New Hobby', desc: 'Thinking about picking up something creative.',
    left: { label: 'Too Busy', effect: 'No change', imp: {} },
    right: { label: 'Start Hobby', effect: '-$300, +12 Happy', imp: { cash: -300, happy: 12 } }
  });
  
  lifeCards.push({ key: 'life_vacation', cat: '‚úàÔ∏è Lifestyle', icon: 'üèñÔ∏è', title: 'Take Vacation', desc: 'You need a break. A week away would help.',
    left: { label: 'Save Money', effect: '+$0, -5 Happy', imp: { happy: -5 } },
    right: { label: 'Go Trip', effect: '-$3K, +15 Happy, +10 Health', imp: { cash: -3000, happy: 15, health: 10 } }
  });
  
  lifeCards.push({ key: 'life_pet', cat: 'üêï Lifestyle', icon: 'üêï', title: 'Adopt a Pet', desc: 'Shelter dog needs a home. $500/yr for care.',
    left: { label: 'Not Now', effect: 'No change', imp: {} },
    right: { label: 'Adopt', effect: '-$500/yr, +15 Happy', imp: { salary: -500, happy: 15 } }
  });
  
  lifeCards.push({ key: 'life_volunteer', cat: '‚ù§Ô∏è Lifestyle', icon: 'ü§ù', title: 'Volunteer Work', desc: 'Local nonprofit needs weekend help.',
    left: { label: 'No Time', effect: 'No change', imp: {} },
    right: { label: 'Help Out', effect: '+10 Happy, -3 Health', imp: { happy: 10, health: -3 } }
  });
  
  lifeCards.push({ key: 'life_friend', cat: 'üë• Social', icon: 'üçª', title: 'Old Friend Visit', desc: 'College buddy in town. Go out or stay in?',
    left: { label: 'Rain Check', effect: '-3 Happy', imp: { happy: -3 } },
    right: { label: 'Go Out', effect: '-$150, +10 Happy', imp: { cash: -150, happy: 10 } }
  });
  
  lifeCards.push({ key: 'life_class', cat: 'üìö Growth', icon: 'üìö', title: 'Evening Class', desc: 'Community college has interesting night course.',
    left: { label: 'Skip', effect: 'No change', imp: {} },
    right: { label: 'Enroll', effect: '-$800, +skills', imp: { cash: -800, happy: 5 } }
  });
  
  lifeCards.push({ key: 'life_therapy', cat: 'üß† Health', icon: 'üß†', title: 'Try Therapy', desc: 'Mental health is health. $150/session.',
    left: { label: 'I\'m Fine', effect: 'No change', imp: {} },
    right: { label: 'Start', effect: '-$1.8K/yr, +15 Happy', imp: { cash: -1800, happy: 15 } }
  });
  
  lifeCards.push({ key: 'life_checkup', cat: 'üè• Health', icon: 'ü©∫', title: 'Annual Checkup', desc: 'Haven\'t been to doctor in a while.',
    left: { label: 'Feel Fine', effect: '-5 Health (undetected)', imp: { health: -5 } },
    right: { label: 'Go', effect: '-$200, +8 Health', imp: { cash: -200, health: 8 } }
  });
  
  lifeCards.push({ key: 'life_sleep', cat: 'üò¥ Health', icon: 'üò¥', title: 'Sleep Habits', desc: 'You\'ve been staying up too late.',
    left: { label: 'One More Episode', effect: '-5 Health', imp: { health: -5 } },
    right: { label: 'Sleep Early', effect: '+8 Health, +3 Happy', imp: { health: 8, happy: 3 } }
  });
  
  if (lifeCards.length > 0 && Math.random() < 0.2) {
    cards.push(pick(lifeCards));
  }
  
  // RELATIONSHIPS - Important life events!
  if (ch.rel === 'single' && ch.age >= 21 && ch.age <= 50 && !ch.inJail && Math.random() < 0.25) {
    cards.push({ key: 'rel_meet', cat: 'üíï Love', icon: 'üíç', title: 'Someone Special', desc: 'Made a real connection. Ready to commit?',
      left: { label: 'Not Ready', effect: '+3 Happy', imp: { happy: 3 } },
      right: { label: 'Get Engaged', effect: '-$4K ring', imp: { cash: -4000, happy: 15 }, setRel: 'engaged' }
    });
  }
  
  if (ch.rel === 'engaged' && Math.random() < 0.45) {
    const spouse = pick(SPOUSE_TYPES);
    cards.push({ key: 'rel_wedding', cat: 'üíï Love', icon: 'üíí', title: 'Wedding Time', desc: `Your partner: ${spouse.name} (${spouse.desc}). ${fmt(spouse.income)}/yr income.`,
      left: { label: 'Wait', effect: '-10 Happy', imp: { happy: -10 } },
      right: { label: 'Get Married', effect: `-$25K, +${fmt(spouse.income)}/yr`, imp: { cash: -25000, salary: spouse.income - spouse.spending, happy: 20 }, setRel: 'married', setSpouse: spouse }
    });
  }
  
  if (ch.rel === 'married' && st.happy < 35 && Math.random() < 0.2) {
    cards.push({ key: 'rel_trouble', cat: 'üíï Marriage', icon: 'üíî', title: 'Trouble in Paradise', desc: 'Marriage struggling. Counseling or risk divorce?', type: 'danger',
      left: { label: 'Ignore', effect: '60% divorce risk', divorceRisk: 0.6, imp: { happy: -10 } },
      right: { label: 'Counseling', effect: '-$6K, save marriage', imp: { cash: -6000, happy: 15 } }
    });
  }
  
  // KIDS - Come frequently after marriage, especially in younger years
  if (ch.rel === 'married' && ch.age <= 45 && (!ch.kids || ch.kids.length < 6)) {
    const kidCount = ch.kids?.length || 0;
    const yearsMarried = ch.yearsMarried || 0;
    
    // Higher chance for kids based on: years married, age, existing kids
    let kidChance = 0;
    if (yearsMarried >= 1 && yearsMarried <= 3 && kidCount === 0) kidChance = 0.5; // High chance for first kid early
    else if (yearsMarried >= 2 && kidCount < 2 && ch.age <= 35) kidChance = 0.35; // Good chance for 2nd kid
    else if (ch.age <= 32 && kidCount < 4) kidChance = 0.25; // Younger = more kids
    else if (ch.age <= 38 && kidCount < 4) kidChance = 0.18;
    else if (ch.age <= 42) kidChance = 0.12;
    else kidChance = 0.08;
    
    if (Math.random() < kidChance) {
      const bonusText = kidCount >= 1 ? ` Big families get bonuses!` : '';
      const titles = kidCount === 0 ? ['Start a Family?', 'Baby on the Way?', 'Ready for Kids?'] : ['Another Child?', 'Growing the Family?', 'One More?'];
      cards.push({ key: 'family_baby', cat: 'üë∂ Family', icon: 'üë∂', title: pick(titles), desc: `Kids cost ~$4K/yr but bring joy, help when older, and boost your heir!${bonusText}`,
        left: { label: 'Not Now', effect: '-3 Happy', imp: { happy: -3 } },
        right: { label: 'Have Baby', effect: '+child, +happiness', imp: { happy: 15 }, spawnKid: true, setProgression: 'firstKid' }
      });
    }
  }
  
  // More family cards
  if (ch.kids?.length > 0 && Math.random() < 0.15) {
    const kid = pick(ch.kids.filter(k => k.age >= 5 && k.age < 18));
    if (kid) {
      cards.push({ key: 'family_activity', cat: 'üë®‚Äçüë©‚Äçüëß Family', icon: '‚öΩ', title: `${kid.name}'s Activity`, desc: `${kid.name} wants to join sports/music. $500/year but great for them.`,
        left: { label: 'Too Expensive', effect: '-5 Happy', imp: { happy: -5 } },
        right: { label: 'Sign Up', effect: '-$500, +8 Happy', imp: { cash: -500, happy: 8 } }
      });
    }
  }
  
  if (ch.kids?.length >= 2 && Math.random() < 0.12) {
    cards.push({ key: 'family_vacation', cat: 'üë®‚Äçüë©‚Äçüëß Family', icon: 'üèñÔ∏è', title: 'Family Vacation', desc: 'Kids are asking about a trip. Great bonding opportunity!',
      left: { label: 'Staycation', effect: '+3 Happy', imp: { happy: 3 } },
      right: { label: 'Take Trip', effect: '-$3K, +15 Happy, memories', imp: { cash: -3000, happy: 15, health: 5 } }
    });
  }
  
  // Kid turns 18
  if (ch.kids?.some(k => k.age === 18) && Math.random() < 0.4) {
    const kid = ch.kids.find(k => k.age === 18);
    const outcomes = [
      { title: `${kid.name} Got Scholarship!`, desc: 'Full ride to university!', effect: '+20 Happy', imp: { happy: 20 } },
      { title: `${kid.name} Needs College`, desc: 'Wants to go to university. $60K tuition.', left: { label: 'Sorry', effect: '-15 Happy', imp: { happy: -15 } }, right: { label: 'Pay', effect: '-$60K', imp: { cash: -60000, happy: 10 } } },
      { title: `${kid.name} Starting Career`, desc: 'Going straight to work. Proud moment!', effect: '+10 Happy, -$6K/yr costs', imp: { happy: 10, salary: 6000 } },
      { title: `${kid.name} Starting Business`, desc: 'Wants to be entrepreneur. Asks for $15K seed money.', left: { label: 'Decline', effect: '-10 Happy', imp: { happy: -10 } }, right: { label: 'Invest', effect: '-$15K, potential return', imp: { cash: -15000 }, kidBiz: kid.id } },
    ];
    const outcome = pick(outcomes);
    if (!outcome.left) {
      return { key: 'kid_18_' + uid(), cat: 'üë∂ Milestone', icon: 'üéì', isEvent: true, noYear: true, positive: true, ...outcome };
    } else {
      cards.push({ key: 'kid_18_' + uid(), cat: 'üë∂ Milestone', icon: 'üéì', title: outcome.title, desc: outcome.desc, ...outcome });
    }
  }
  
  // HOUSING PROGRESSION
  // Step 1: Living with parents -> Move out to rent
  if (ch.housing === 'parents' && ch.age >= 22 && Math.random() < 0.25) {
    cards.push({ key: 'house_move', cat: 'üè† Housing', icon: 'üè¢', title: 'Move Out?', desc: 'Time to leave the nest? Rent ~$18K/year.',
      left: { label: 'Stay', effect: '-8 Happy', imp: { happy: -8 } },
      right: { label: 'Move Out', effect: 'Independence!', imp: { happy: 12 }, setHousing: 'rent', setProgression: 'movedOut' }
    });
  }
  
  // Step 2: Renting -> Buy home (progression from moving out)
  if (ch.housing === 'rent' && st.credit >= 650 && st.cash >= 30000 && Math.random() < 0.2) {
    const downPayment = Math.min(st.cash - 5000, 50000);
    cards.push({ key: 'house_buy', cat: 'üè† Housing', icon: 'üè†', title: 'Ready to Buy?', desc: `You've been renting. Time to build equity? ${fmt(downPayment)} down.`, type: 'opportunity',
      left: { label: 'Keep Renting', effect: 'Stay flexible', imp: {} },
      right: { label: 'Buy Home', effect: `${fmt(-downPayment)}, start equity`, imp: { cash: -downPayment, mortgage: 250000, equity: downPayment, happy: 20 }, setHousing: 'own', setProgression: 'boughtHome' }
    });
  }
  
  // Step 3: Own home -> Upgrade home
  if (ch.housing === 'own' && st.equity >= 100000 && st.cash >= 80000 && Math.random() < 0.1) {
    cards.push({ key: 'house_upgrade', cat: 'üè† Housing', icon: 'üè∞', title: 'Upgrade Home?', desc: 'You can afford a bigger place. Sell and upgrade?',
      left: { label: 'Stay Put', effect: 'Home is fine', imp: { happy: 3 } },
      right: { label: 'Upgrade', effect: '-$80K, bigger home', imp: { cash: -80000, equity: 50000, happy: 15 } }
    });
  }
  
  // HEALTH
  if (st.health < 45 && Math.random() < 0.35) {
    cards.push({ key: 'health_crisis', cat: '‚ù§Ô∏è Health', icon: 'üè•', title: 'Health Crisis', desc: 'Your body is breaking down. Get help now.', type: 'danger',
      left: { label: 'Ignore', effect: '-25 Health!', imp: { health: -25 } },
      right: { label: 'Treatment', effect: '-$10K, +30 Health', imp: { cash: -10000, health: 30 } }
    });
  }
  
  // CRIME
  if (poor && Math.random() < 0.1) {
    cards.push({ key: 'crime', cat: '‚ö†Ô∏è Risk', icon: 'üí∞', title: 'Easy Money', desc: 'Quick cash opportunity. You know it\'s not legal.', type: 'danger',
      left: { label: 'Walk Away', effect: '+5 Happy', imp: { happy: 5 } },
      right: { label: 'Do It', effect: '+$5K (35% caught)', crime: { reward: 5000, risk: 0.35, jail: 2 } }
    });
  }
  
  // EVENTS (no year advance)
  if (Math.random() < 0.1) {
    const events = [
      { icon: 'üéâ', title: 'Bonus!', desc: 'Great performance!', imp: { cash: rand(2000, 8000) }, positive: true },
      { icon: 'üí∞', title: 'Tax Refund', desc: 'Bigger than expected!', imp: { cash: rand(1000, 4000) }, positive: true },
      { icon: 'ü§í', title: 'Medical Bill', desc: 'Unexpected expense.', imp: { cash: -rand(2000, 6000), health: -5 }, positive: false },
      { icon: 'üöó', title: 'Car Trouble', desc: 'Repairs needed.', imp: { cash: -rand(1000, 3000) }, positive: false },
    ];
    const evt = pick(events);
    return { key: 'event_' + uid(), cat: 'üåü Life Event', isEvent: true, noYear: true, ...evt };
  }
  
  // DEFAULT
  if (cards.length === 0) {
    cards.push({ key: 'life_quiet', cat: 'üåü Life', icon: '‚òÄÔ∏è', title: 'Quiet Year', desc: 'Nothing major. Rest or work?',
      left: { label: 'Rest', effect: '+8 Health, +5 Happy', imp: { health: 8, happy: 5 } },
      right: { label: 'Hustle', effect: '+$4K, -5 Health', imp: { cash: 4000, health: -5 } }
    });
  }
  
  return pick(cards);
};

// ============================================
// PIXEL CHARACTER
// ============================================
const PixelChar = ({ style, gender, size = 'sm' }) => {
  const s = style || (CHAR_STYLES[gender] || CHAR_STYLES.m)[0];
  const scale = size === 'sm' ? 1.8 : size === 'md' ? 2.5 : 3.5;
  const isMale = gender === 'm';
  return (
    <svg width={scale * 10} height={scale * 14} viewBox="0 0 10 14" style={{ imageRendering: 'pixelated' }}>
      <rect x="2" y="0" width="6" height="3" fill={s.hair} />
      <rect x="1" y="1" width="1" height="2" fill={s.hair} />
      <rect x="8" y="1" width="1" height="2" fill={s.hair} />
      {!isMale && <><rect x="0" y="2" width="1" height="4" fill={s.hair} /><rect x="9" y="2" width="1" height="4" fill={s.hair} /></>}
      <rect x="2" y="2" width="6" height="5" fill={s.skin} />
      <rect x="3" y="4" width="1" height="1" fill="#1a1a1a" />
      <rect x="6" y="4" width="1" height="1" fill="#1a1a1a" />
      <rect x="2" y="7" width="6" height="4" fill={s.shirt} />
      <rect x="1" y="8" width="1" height="2" fill={s.shirt} />
      <rect x="8" y="8" width="1" height="2" fill={s.shirt} />
      <rect x="2" y="11" width="3" height="3" fill={s.pants} />
      <rect x="5" y="11" width="3" height="3" fill={s.pants} />
    </svg>
  );
};

// ============================================
// SAVE
// ============================================
const SAVE_KEY = 'kt_v7_save';
const saveGame = (state) => { try { localStorage.setItem(SAVE_KEY, JSON.stringify(state)); } catch {} };
const loadGame = () => { try { const d = localStorage.getItem(SAVE_KEY); return d ? JSON.parse(d) : null; } catch { return null; } };
const clearSave = () => { try { localStorage.removeItem(SAVE_KEY); } catch {} };

// ============================================
// MAIN GAME
// ============================================
function Game() {
  const [screen, setScreen] = useState('title');
  const [modal, setModal] = useState(null);
  const [toast, setToast] = useState(null);
  const [achievement, setAchievement] = useState(null);
  
  // Setup
  const [gameMode, setGameMode] = useState('classic');
  const [setupStep, setSetupStep] = useState(0);
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');
  const [gender, setGender] = useState('m');
  const [charStyle, setCharStyle] = useState(null);
  const [career, setCareer] = useState(null);
  
  // Game
  const [char, setChar] = useState(null);
  const [st, setSt] = useState(null);
  const [econ, setEcon] = useState(ECONOMY[1]);
  const [econTimer, setEconTimer] = useState(0);
  const [gen, setGen] = useState(1);
  const [achs, setAchs] = useState([]);
  const [year, setYear] = useState(0);
  
  const [card, setCard] = useState(null);
  const [cardOffset, setCardOffset] = useState(0);
  const [dragging, setDragging] = useState(false);
  const [yearSummary, setYearSummary] = useState(null);
  
  const [musicOn, setMusicOn] = useState(true);
  const [sfxOn, setSfxOn] = useState(true);
  
  // Heir
  const [heirName, setHeirName] = useState('');
  const [heirGender, setHeirGender] = useState('m');
  const [heirStyle, setHeirStyle] = useState(null);
  const [heirCareer, setHeirCareer] = useState(null);
  const [heirMode, setHeirMode] = useState('inherit'); // 'inherit' or 'broke'
  
  const startX = useRef(0);
  
  useEffect(() => { sfx.init(); if (musicOn) sfx.startHappy(); return () => sfx.stopHappy(); }, []);
  useEffect(() => { sfx.toggleMusic(musicOn); }, [musicOn]);
  useEffect(() => { sfx.toggleSFX(sfxOn); }, [sfxOn]);
  useEffect(() => { if (screen === 'game' && char && st) saveGame({ char, st, econ, econTimer, gen, achs, lastName, year, gameMode, card }); }, [char, st, econ, gen, year, achs]);
  useEffect(() => { if (toast) { const t = setTimeout(() => setToast(null), 2500); return () => clearTimeout(t); } }, [toast]);
  useEffect(() => { if (achievement) { const t = setTimeout(() => setAchievement(null), 3500); return () => clearTimeout(t); } }, [achievement]);
  
  const checkAchievements = useCallback((newSt, newChar, newGen) => {
    ACHIEVEMENTS.forEach(a => {
      if (!achs.includes(a.id) && a.check(newSt, newChar, newGen)) {
        setAchs(p => [...p, a.id]);
        setAchievement(a);
        sfx.ach();
      }
    });
  }, [achs]);
  
  const calcYearlyFinances = (currentSt, currentChar, currentEcon) => {
    let income = Math.max(0, currentSt.salary || 0);
    let bizIncome = 0;
    if (currentChar.biz) bizIncome += currentChar.biz.profit || 0;
    if (currentChar.biz2) bizIncome += currentChar.biz2.profit || 0;
    income += bizIncome;
    
    // Housing costs - homeless is FREE but has penalties applied in processYear
    const housing = currentChar.housing === 'own' ? 24000 : currentChar.housing === 'rent' ? 18000 : currentChar.housing === 'parents' ? 3600 : 0;
    
    // Living costs scale with situation
    let living = currentChar.housing === 'homeless' ? 3000 : currentChar.housing === 'parents' ? 10000 : 18000;
    
    // If no income, bare minimum survival mode
    if (income <= 0 && currentChar.housing === 'homeless') living = 1500;
    
    // Kids - cost varies by age, teens can contribute!
    let kidsCost = 0;
    if (currentChar.kids) {
      currentChar.kids.forEach(k => {
        if (k.age < 5) kidsCost += 4000;        // Daycare age
        else if (k.age < 13) kidsCost += 3000;  // School age - lower cost
        else if (k.age < 18) kidsCost += 2000;  // Teen - they help around house
        // Kids 16+ can work part-time
        if (k.age >= 16 && k.age < 18) income += 4000;
      });
    }
    
    let totalExp = housing + living + kidsCost;
    
    // Benefits reduce costs
    if (currentChar.foodStamps) totalExp -= 4000;
    if (currentChar.shelterAccess) totalExp -= 2000;
    totalExp = Math.max(0, totalExp);
    
    const taxes = calcTaxes(income, currentChar);
    const debtInt = Math.round((currentSt.debt || 0) * 0.15);
    const mortPay = currentSt.mortgage > 0 ? Math.min(22000, currentSt.mortgage * 0.06) : 0;
    
    const netCash = income - totalExp - taxes.total - debtInt - mortPay;
    
    return { income, bizIncome, housing, living, kids: kidsCost, totalExp, taxes, debtInt, mortPay, netCash };
  };
  
  const drawCard = useCallback((s, c, e, y) => { sfx.draw(); setCard(generateCard(s, c, e, y)); setCardOffset(0); }, []);
  
  const startGame = () => {
    if (!firstName || !lastName || !charStyle) return;
    if (gameMode !== 'broke' && !career) return;
    sfx.click(); sfx.init();
    
    let newChar, newSt;
    
    if (gameMode === 'broke') {
      newChar = { name: firstName, gender, style: CHAR_STYLES[gender].find(s => s.id === charStyle), age: 22, career: null, job: 'none', rel: 'single', kids: [], housing: 'homeless', mode: 'broke', hasCar: false, hasPhone: false, biz: null, biz2: null, shelterAccess: false, yearsMarried: 0, crimeRecord: 0, progression: { gotShelter: false, gotJob: false, gotPhone: false, gotCar: false, movedOut: false, firstKid: false } };
      newSt = { cash: 50, salary: 0, debt: 800, invest: 0, credit: 480, health: 75, happy: 35, equity: 0, mortgage: 0 };
    } else if (gameMode === 'silver') {
      const c = CAREERS.find(x => x.id === career);
      newChar = { name: firstName, gender, style: CHAR_STYLES[gender].find(s => s.id === charStyle), age: 22, career, job: career, rel: 'single', kids: [], housing: 'rent', mode: 'silver', hasCar: true, hasPhone: true, biz: null, biz2: null, yearsMarried: 0, crimeRecord: 0, progression: { boughtHome: false, startedBusiness: false, startedInvesting: false, firstKid: false } };
      newSt = { cash: 50000, salary: c.salary, debt: 0, invest: 25000, credit: 720, health: 100, happy: 80, equity: 0, mortgage: 0 };
    } else {
      const c = CAREERS.find(x => x.id === career);
      newChar = { name: firstName, gender, style: CHAR_STYLES[gender].find(s => s.id === charStyle), age: 18 + 4, career, job: career, rel: 'single', kids: [], housing: 'parents', mode: 'classic', hasCar: true, hasPhone: true, biz: null, biz2: null, yearsMarried: 0, crimeRecord: 0, progression: { movedOut: false, boughtHome: false, gotPromotion: false, startedInvesting: false, firstKid: false } };
      newSt = { cash: 3000, salary: c.salary, debt: c.edu, invest: 0, credit: 620, health: 100, happy: 70, equity: 0, mortgage: 0 };
    }
    
    setChar(newChar); setSt(newSt); setGen(1); setAchs([]); setEcon(ECONOMY[1]); setEconTimer(0); setYear(0); setYearSummary(null); setScreen('game');
    setTimeout(() => drawCard(newSt, newChar, ECONOMY[1], 0), 200);
  };
  
  const continueGame = () => {
    const saved = loadGame();
    if (saved) {
      setChar(saved.char); setSt(saved.st); setEcon(saved.econ || ECONOMY[1]); setEconTimer(saved.econTimer || 0); setGen(saved.gen || 1); setAchs(saved.achs || []); setLastName(saved.lastName || ''); setYear(saved.year || 0); setGameMode(saved.gameMode || 'classic'); 
      setScreen('game');
      sfx.init();
      // Restore card or draw new one
      if (saved.card) {
        setCard(saved.card);
      } else {
        setTimeout(() => drawCard(saved.st, saved.char, saved.econ || ECONOMY[1], saved.year || 0), 200);
      }
    }
  };
  
  const processYear = (newSt, newChar, newEcon) => {
    const fin = calcYearlyFinances(newSt, newChar, newEcon);
    
    // Apply net cash - if negative, goes to debt
    if (fin.netCash >= 0) {
      newSt.cash += fin.netCash;
    } else {
      // Negative cash flow
      if (newSt.cash >= Math.abs(fin.netCash)) {
        newSt.cash += fin.netCash; // Can cover it
      } else {
        // Can't cover - rest goes to debt
        const shortfall = Math.abs(fin.netCash) - newSt.cash;
        newSt.cash = 0;
        newSt.debt = (newSt.debt || 0) + shortfall;
        newSt.credit = clamp(newSt.credit - 25, 300, 850); // Credit hit
      }
    }
    
    // Debt interest accumulates
    newSt.debt = Math.max(0, (newSt.debt || 0) + fin.debtInt - Math.min(3000, (newSt.debt || 0) * 0.08));
    
    if (newSt.mortgage > 0) {
      newSt.mortgage = Math.max(0, newSt.mortgage - fin.mortPay * 0.4);
      newSt.equity = (newSt.equity || 0) + fin.mortPay * 0.4;
    }
    
    newSt.invest = Math.round((newSt.invest || 0) * newEcon.invMult);
    if (newChar.housing === 'own') newSt.equity = Math.round((newSt.equity || 0) * (1 + (newEcon.id === 'boom' ? 0.06 : newEcon.id === 'recession' ? -0.02 : 0.03)));
    
    // Homeless penalties
    if (newChar.housing === 'homeless') {
      newSt.health = clamp(newSt.health - 8, 0, 100);
      newSt.happy = clamp(newSt.happy - 10, 0, 100);
    }
    
    // Jail penalties - no income, health/happy decay
    if (newChar.inJail) {
      newSt.salary = 0;
      newSt.health = clamp(newSt.health - 5, 0, 100);
      newSt.happy = clamp(newSt.happy - 15, 0, 100);
    }
    
    // Criminal record makes jobs harder - random salary cut
    if ((newChar.crimeRecord || 0) >= 2 && !newChar.inJail && newSt.salary > 0 && Math.random() < 0.15) {
      newSt.salary = Math.round(newSt.salary * 0.9); // 10% cut from discrimination
    }
    
    // FAMILY BOOST - kids bring happiness!
    if (newChar.kids && newChar.kids.length > 0) {
      let familyBoost = 0;
      newChar.kids.forEach(k => {
        if (k.age >= 5 && k.age < 10) familyBoost += 3;    // Young kids - joy
        else if (k.age >= 10 && k.age < 15) familyBoost += 4; // Sweet spot
        else if (k.age >= 15 && k.age < 18) familyBoost += 2; // Teens - some drama but still family
      });
      // Bonus for multiple kids - family synergy
      if (newChar.kids.length >= 2) familyBoost += 3;
      if (newChar.kids.length >= 3) familyBoost += 4;
      if (newChar.kids.length >= 4) familyBoost += 5;
      
      newSt.happy = clamp(newSt.happy + familyBoost, 0, 100);
    }
    
    // Credit improvement for being financially responsible
    if ((newSt.debt || 0) < 5000 && newSt.cash > 5000) {
      newSt.credit = clamp(newSt.credit + 8, 300, 850);
    }
    
    newChar.age += 1;
    if (newChar.rel === 'married') newChar.yearsMarried = (newChar.yearsMarried || 0) + 1;
    if (newChar.kids) newChar.kids = newChar.kids.map(k => ({ ...k, age: k.age + 1 }));
    
    if (newChar.biz) { newChar.biz.profit = Math.round(newChar.biz.revenue * rand(8, 22) / 100); newChar.biz.revenue = Math.round(newChar.biz.revenue * (1 + rand(-2, 8) / 100)); }
    if (newChar.biz2) { newChar.biz2.profit = Math.round(newChar.biz2.revenue * rand(6, 18) / 100); newChar.biz2.revenue = Math.round(newChar.biz2.revenue * (1 + rand(-3, 6) / 100)); }
    
    // Spouse homemaker bonus
    if (newChar.spouse?.id === 'homemaker') newSt.happy = clamp(newSt.happy + 10, 0, 100);
    
    return { newSt, newChar, fin };
  };
  
  const dismissSummary = () => { setYearSummary(null); drawCard(st, char, econ, year); };
  
  const swipe = (dir) => {
    if (!card) return;
    const choice = dir === 'right' ? card.right : card.left;
    
    if (card.isTrap && dir === 'right') { sfx.bad(); setToast({ text: 'üò± You got scammed!', type: 'negative' }); }
    else if (dir === 'right') sfx.yes(); else sfx.no();
    
    let newSt = { ...st }, newChar = { ...char }, newEcon = econ, newEconTimer = econTimer, newYear = year;
    let advanceYear = !card.noYear && !card.isEvent;
    
    if (card.isEvent) {
      if (card.imp) Object.entries(card.imp).forEach(([k, v]) => { if (k in newSt) newSt[k] = newSt[k] + v; });
      if (card.positive) sfx.good(); else sfx.bad();
      setSt(newSt);
      setTimeout(() => drawCard(newSt, newChar, newEcon, newYear), 600);
      return;
    }
    
    if (choice) {
      if (choice.imp) {
        Object.entries(choice.imp).forEach(([k, v]) => { 
          if (k === 'salary') {
            newSt.salary = Math.max(0, (newSt.salary || 0) + v);
          } else if (k === 'cash') {
            // Cash changes: if would go negative, excess becomes debt
            const result = adjustCash(newSt, v);
            newSt.cash = result.cash;
            newSt.debt = result.debt;
            if (v < 0 && result.debt > (newSt.debt || 0)) {
              newSt.credit = clamp(newSt.credit - 15, 300, 850); // Credit hit for going into debt
            }
          } else if (k === 'credit') {
            newSt[k] = clamp((newSt[k] || 0) + v, 300, 850);
          } else if (k in newSt) {
            newSt[k] = (newSt[k] || 0) + v;
          }
        });
      }
      
      if (choice.setRel) { newChar.rel = choice.setRel; if (choice.setRel === 'married') sfx.lvl(); }
      if (choice.setSpouse) newChar.spouse = choice.setSpouse;
      if (choice.setHousing) newChar.housing = choice.setHousing;
      if (choice.setJob) { newChar.job = choice.setJob; const j = BROKE_JOBS.find(x => x.id === choice.setJob); if (j && !choice.imp?.salary) newSt.salary = j.salary; }
      if (choice.setCar) newChar.hasCar = true;
      if (choice.setPhone) newChar.hasPhone = true;
      if (choice.setShelter) newChar.shelterAccess = true;
      if (choice.setSnap) newChar.foodStamps = true;
      if (choice.setGED) newChar.hasGED = true;
      if (choice.jobUpgrade) {
        if (Math.random() < 0.7) {
          newSt.salary = (newSt.salary || 0) + choice.jobUpgrade;
          setToast({ text: `üéâ Got the job! +${fmt(choice.jobUpgrade)}/yr`, type: 'positive' });
          sfx.good();
        } else {
          setToast({ text: 'üòî Didn\'t get it. Keep trying!', type: 'negative' });
        }
      }
      
      if (choice.reviewWing) {
        if (Math.random() < 0.5) {
          const raise = rand(2000, 5000);
          newSt.salary += raise;
          setToast({ text: `Got small raise: +${fmt(raise)}/yr`, type: 'positive' });
        } else {
          setToast({ text: 'No raise this year', type: 'negative' });
        }
      }
      
      if (choice.reviewPrepare) {
        if (Math.random() < 0.8) {
          const raise = rand(5000, 12000);
          newSt.salary += raise;
          setToast({ text: `Great review! +${fmt(raise)}/yr`, type: 'positive' });
          sfx.good();
        } else {
          setToast({ text: 'Decent review, small raise', type: 'positive' });
          newSt.salary += rand(1000, 3000);
        }
      }
      
      if (choice.leadProject) {
        if (Math.random() < 0.7) {
          const raise = rand(8000, 15000);
          newSt.salary += raise;
          setToast({ text: `Project success! +${fmt(raise)}/yr`, type: 'positive' });
          sfx.good();
        } else {
          setToast({ text: 'Project struggled, but you learned', type: 'negative' });
          newSt.happy = clamp(newSt.happy - 5, 0, 100);
        }
      }
      
      if (choice.recruitOffer) {
        if (Math.random() < 0.6) {
          const raise = Math.round(newSt.salary * 0.15);
          newSt.salary += raise;
          setToast({ text: `New job! +${fmt(raise)}/yr`, type: 'positive' });
          sfx.good();
        } else {
          setToast({ text: 'Didn\'t get the offer', type: 'negative' });
        }
      }
      
      if (choice.divorceRisk && Math.random() < choice.divorceRisk) {
        newChar.rel = 'single'; newChar.spouse = null;
        newSt.cash = Math.round(newSt.cash * 0.5);
        newSt.salary = Math.max((newSt.salary || 0) - 30000, CAREERS.find(c => c.id === newChar.career)?.salary || 30000);
        setToast({ text: 'üíî Divorced...', type: 'negative' }); sfx.bad();
      }
      
      if (choice.spawnKid) {
        const kg = Math.random() < 0.5 ? 'm' : 'f';
        newChar.kids = [...(newChar.kids || []), { id: uid(), name: pick(KID_NAMES[kg]), gender: kg, age: 0, invested: 0 }];
        sfx.good();
      }
      
      if (choice.startBiz) { newChar.biz = { ...choice.startBiz, revenue: choice.startBiz.baseRev, profit: 0, employees: 0 }; sfx.good(); }
      if (choice.startBiz2) { newChar.biz2 = { ...choice.startBiz2, revenue: choice.startBiz2.baseRev, profit: 0, employees: 0 }; sfx.good(); }
      if (choice.bizTakeProfit && newChar.biz) newChar.biz.profit = 0;
      if (choice.bizReinvest && newChar.biz) { newChar.biz.revenue = Math.round(newChar.biz.revenue * 1.20); newChar.biz.profit = 0; }
      if (choice.bizHire && newChar.biz) { newChar.biz.employees = (newChar.biz.employees || 0) + 1; newChar.biz.revenue = Math.round(newChar.biz.revenue * 1.30); }
      if (choice.bizMarketing && newChar.biz) { newChar.biz.revenue = Math.round(newChar.biz.revenue * 1.15); }
      if (choice.bizExpand && newChar.biz) { newChar.biz.revenue = Math.round(newChar.biz.revenue * 1.40); }
      if (choice.bizOnline && newChar.biz) { newChar.biz.revenue = Math.round(newChar.biz.revenue * 1.20); }
      if (choice.bizBigClient && newChar.biz) {
        if (Math.random() < 0.7) {
          newChar.biz.revenue = Math.round(newChar.biz.revenue * 1.25);
          setToast({ text: 'üéâ Big client signed!', type: 'positive' });
          sfx.good();
        } else {
          setToast({ text: 'Client went with competitor', type: 'negative' });
        }
      }
      if (choice.bizGrowth && newChar.biz) {
        newChar.biz.revenue = Math.round(newChar.biz.revenue * choice.bizGrowth);
      }
      if (choice.closeBiz) newChar.biz = null;
      if (choice.sellBiz) newChar.biz = null;
      
      if (choice.irsAudit) {
        if (Math.random() < 0.5) { setToast({ text: '‚úÖ IRS audit cleared!', type: 'positive' }); sfx.good(); }
        else { const penalty = Math.round(calcTaxes(newSt.salary, newChar).total * 0.3); newSt.cash -= penalty; setToast({ text: `‚ùå Lost audit! -${fmt(penalty)}`, type: 'negative' }); sfx.bad(); }
      }
      
      // CRIME HANDLER - consequences!
      if (choice.crime) {
        const c = choice.crime;
        const caught = Math.random() < c.catchChance;
        
        if (c.cost) newSt.cash -= c.cost; // Cost for buying stolen goods etc
        
        if (caught) {
          sfx.bad();
          // Apply penalties
          if (c.penalty.cash) newSt.cash = Math.max(0, newSt.cash + c.penalty.cash);
          if (c.penalty.credit) newSt.credit = clamp(newSt.credit + c.penalty.credit, 300, 850);
          if (c.penalty.crimeRecord) newChar.crimeRecord = (newChar.crimeRecord || 0) + c.penalty.crimeRecord;
          if (c.penalty.jailTime) {
            newChar.inJail = true;
            newChar.jailTime = c.penalty.jailTime;
            newChar.jailServed = 0;
            newSt.salary = 0; // Lose job
          }
          if (c.penalty.fired) {
            newSt.salary = 0;
            newChar.job = 'none';
          }
          if (c.penalty.loseBiz) {
            newChar.biz = null;
          }
          setToast({ text: 'üöî CAUGHT! Crime doesn\'t pay!', type: 'negative' });
        } else {
          // Got away - but guilt and risk
          newSt.cash += c.reward;
          newChar.crimeRecord = (newChar.crimeRecord || 0) + 0.5; // Even if not caught, small record increase for doing crimes
          newSt.happy = clamp(newSt.happy - 5, 0, 100); // Guilt
          sfx.money();
          setToast({ text: 'üí∞ Got away... this time', type: 'warning' });
        }
      }
      
      // Jail time progression
      if (choice.jailYear && newChar.inJail) {
        newChar.jailServed = (newChar.jailServed || 0) + 1;
        if (newChar.jailServed >= newChar.jailTime) {
          newChar.inJail = false;
          newChar.jailTime = 0;
          newChar.jailServed = 0;
          newChar.servedTime = true; // For achievement
          sfx.good();
          setToast({ text: 'üéâ Released from prison!', type: 'positive' });
        }
      }
      
      // Record check outcome
      if (choice.recordCheck) {
        if (Math.random() < 0.5) {
          newSt.salary = 0;
          newChar.job = 'none';
          sfx.bad();
          setToast({ text: '‚ùå Fired due to record', type: 'negative' });
        } else {
          sfx.good();
          setToast({ text: '‚úÖ They gave you a chance', type: 'positive' });
        }
      }
      
      // PROGRESSION TRACKING
      if (choice.setProgression && newChar.progression) {
        newChar.progression[choice.setProgression] = true;
      }
      
      if (choice.trapSprung) setToast({ text: 'üí∏ Expensive lesson...', type: 'negative' });
    }
    
    if (advanceYear) {
      newEconTimer += 1;
      if (newEconTimer >= rand(4, 7)) { const idx = ECONOMY.findIndex(e => e.id === newEcon.id); newEcon = ECONOMY[(idx + 1) % ECONOMY.length]; newEconTimer = 0; }
      
      const res = processYear(newSt, newChar, newEcon);
      newSt = res.newSt; newChar = res.newChar; newYear += 1;
      
      setSt(newSt); setChar(newChar); setEcon(newEcon); setEconTimer(newEconTimer); setYear(newYear);
      setYearSummary(res.fin);
      checkAchievements(newSt, newChar, gen);
      
      if (newChar.age >= 65) { endGame('retire'); return; }
      if (newSt.health <= 0) { endGame('health'); return; }
      if (netWorth(newSt) < -50000) { sfx.bad(); endGame('bankrupt'); return; }
    } else {
      setSt(newSt); setChar(newChar);
      checkAchievements(newSt, newChar, gen);
      setTimeout(() => drawCard(newSt, newChar, newEcon, newYear), 300);
    }
  };
  
  const makeInvestment = (type, amount) => {
    if (st.cash < amount) return;
    const inv = INVESTMENTS.find(i => i.id === type);
    if (!inv) return;
    setSt(p => ({ ...p, cash: p.cash - amount, invest: (p.invest || 0) + amount }));
    sfx.money();
    setToast({ text: `Invested ${fmt(amount)} in ${inv.name}`, type: 'positive' });
    setModal(null);
  };
  
  const payDebt = (amt) => {
    if (st.cash < amt || (st.debt || 0) <= 0) return;
    const pay = Math.min(amt, st.debt);
    setSt(p => ({ ...p, cash: p.cash - pay, debt: Math.max(0, p.debt - pay), credit: clamp(p.credit + Math.floor(pay / 500), p.credit, 850) }));
    sfx.money();
    setToast({ text: `Paid ${fmt(pay)}!`, type: 'positive' });
    setModal(null);
  };
  
  const endGame = (reason) => { if (reason === 'retire') sfx.lvl(); else sfx.bad(); setScreen('transition'); };
  
  const nextGen = () => {
    if (!heirName || !heirStyle) return;
    if (heirMode === 'inherit' && !heirCareer) return;
    sfx.lvl();
    
    let newChar, newSt;
    
    // Calculate sibling bonus (more siblings = better start)
    const numSiblings = Math.max(0, (char.kids?.length || 1) - 1);
    const siblingBonus = numSiblings * 5000; // $5K per sibling
    const siblingHappyBonus = numSiblings * 5; // +5 happy per sibling
    const siblingCreditBonus = numSiblings * 10; // +10 credit per sibling (family reputation)
    
    if (heirMode === 'broke') {
      // Start from nothing - no inheritance, but still get some sibling support
      newChar = { name: heirName, gender: heirGender, style: CHAR_STYLES[heirGender].find(s => s.id === heirStyle), age: 22, career: null, job: 'none', rel: 'single', kids: [], housing: numSiblings >= 2 ? 'parents' : 'homeless', mode: 'broke', hasCar: false, hasPhone: numSiblings >= 1, biz: null, biz2: null, shelterAccess: false, siblings: numSiblings };
      newSt = { cash: 50 + (numSiblings * 200), salary: 0, debt: 500, invest: 0, credit: 500 + siblingCreditBonus, health: 80, happy: 40 + siblingHappyBonus, equity: 0, mortgage: 0 };
    } else {
      // Normal inheritance - siblings help!
      const nw = netWorth(st);
      const kidInv = (char.kids || []).reduce((a, k) => a + (k.invested || 0), 0);
      const inherit = Math.round(nw * 0.6) + Math.round(kidInv * 0.5) + siblingBonus;
      
      const c = CAREERS.find(x => x.id === heirCareer);
      newChar = { name: heirName, gender: heirGender, style: CHAR_STYLES[heirGender].find(s => s.id === heirStyle), age: 22, career: heirCareer, job: heirCareer, rel: 'single', kids: [], housing: 'parents', mode: 'classic', hasCar: true, hasPhone: true, biz: null, biz2: null, siblings: numSiblings };
      newSt = { 
        cash: Math.max(0, inherit) + 3000, 
        salary: c.salary + (numSiblings * 3000), // Siblings help with connections = better starting salary
        debt: c.edu + (inherit < 0 ? Math.abs(inherit) * 0.25 : 0), 
        invest: 0, 
        credit: clamp(620 + Math.round((st.credit - 600) / 4) + siblingCreditBonus, 300, 850), 
        health: 100, 
        happy: 70 + siblingHappyBonus, 
        equity: 0, 
        mortgage: 0 
      };
    }
    
    setChar(newChar); setSt(newSt); setGen(p => p + 1); setEcon(ECONOMY[1]); setEconTimer(0); setYear(0); setYearSummary(null);
    setHeirName(''); setHeirGender('m'); setHeirStyle(null); setHeirCareer(null); setHeirMode('inherit');
    setScreen('game');
    setTimeout(() => drawCard(newSt, newChar, ECONOMY[1], 0), 200);
  };
  
  const handleDragStart = (x) => { startX.current = x; setDragging(true); };
  const handleDragMove = (x) => { if (dragging) setCardOffset(x - startX.current); };
  const handleDragEnd = () => { setDragging(false); if (Math.abs(cardOffset) > 80) swipe(cardOffset > 0 ? 'right' : 'left'); setCardOffset(0); };
  
  const hasSave = loadGame() !== null;
  
  // ========== RENDER ==========
  return (
    <div className="app">
      <div className="creator-banner">Created by Raheem Sanders</div>
      
      {/* TITLE */}
      {screen === 'title' && (
        <div className="title-screen">
          <div className="title-crown">üëë</div>
          <div className="title-main">KNIGHT TYCOON</div>
          <div className="title-by">by Knight Financial</div>
          <div className="title-sub">Build Your Dynasty</div>
          
          <div className="mode-select">
            {hasSave && (() => {
              const saved = loadGame();
              return (
                <button className="mode-btn featured" onClick={continueGame}>
                  <div className="mode-name">‚ñ∂Ô∏è Continue</div>
                  <div className="mode-desc">
                    {saved?.char?.name} {saved?.lastName} ‚Ä¢ Age {saved?.char?.age} ‚Ä¢ Gen {saved?.gen || 1} ‚Ä¢ {fmt(netWorth(saved?.st || {}))} net worth
                  </div>
                </button>
              );
            })()}
            <button className="mode-btn" onClick={() => { sfx.click(); setGameMode('classic'); setScreen('setup'); setSetupStep(0); }}>
              <div className="mode-name">üéÆ Classic Mode</div>
              <div className="mode-desc">Start with education debt, build your career and wealth the traditional way</div>
            </button>
            <button className="mode-btn" onClick={() => { sfx.click(); setGameMode('broke'); setScreen('setup'); setSetupStep(0); }}>
              <div className="mode-name">üí™ From Broke</div>
              <div className="mode-desc">$50, homeless, 480 credit. The ultimate challenge - build from nothing</div>
            </button>
            <button className="mode-btn" onClick={() => { sfx.click(); setGameMode('silver'); setScreen('setup'); setSetupStep(0); }}>
              <div className="mode-name">ü•Ñ Silver Spoon</div>
              <div className="mode-desc">$50K cash, 720 credit, no debt. See how far you can grow your advantage</div>
            </button>
          </div>
          
          <div style={{ marginTop: 20, fontSize: 11, color: 'rgba(255,255,255,0.5)' }}>
            {ACHIEVEMENTS.length} achievements to unlock
          </div>
          
          <div style={{ marginTop: 16, maxWidth: 300, textAlign: 'left' }}>
            <div style={{ fontSize: 10, color: 'rgba(255,255,255,0.4)', marginBottom: 6 }}>HOW TO PLAY:</div>
            <div style={{ fontSize: 10, color: 'rgba(255,255,255,0.6)', lineHeight: 1.5 }}>
              ‚Ä¢ Swipe cards left/right or tap ‚úï/‚úì<br/>
              ‚Ä¢ Tap üí∞ Cash to invest<br/>
              ‚Ä¢ Tap üí≥ Debt to pay it off<br/>
              ‚Ä¢ Build wealth, start businesses, raise a family<br/>
              ‚Ä¢ Pass your legacy to the next generation
            </div>
          </div>
        </div>
      )}
      
      {/* SETUP */}
      {screen === 'setup' && (
        <div style={{ flex: 1, overflow: 'auto', padding: 12 }}>
          <div className="header" style={{ marginBottom: 12 }}>
            <button className="icon-btn" onClick={() => setupStep > 0 ? setSetupStep(setupStep - 1) : setScreen('title')}>‚Üê</button>
            <div className="brand"><div className="logo">Create Character</div></div>
            <div style={{ fontSize: 11, color: 'var(--text-dim)' }}>{setupStep + 1}/{gameMode === 'broke' ? 1 : 2}</div>
          </div>
          
          {setupStep === 0 && (
            <div className="card">
              <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 4 }}>{gameMode === 'broke' ? 'üí™ From Broke' : gameMode === 'silver' ? 'ü•Ñ Silver Spoon' : 'üéÆ Classic'}</div>
              <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 16 }}>
                {gameMode === 'broke' ? 'Homeless with $50. Build from nothing.' : gameMode === 'silver' ? 'Head start in life.' : 'Standard journey.'}
              </div>
              <div className="form-group"><label className="form-label">First Name</label><input className="form-input" value={firstName} onChange={e => setFirstName(e.target.value)} placeholder="Name" maxLength={12} /></div>
              <div className="form-group"><label className="form-label">Dynasty Name</label><input className="form-input" value={lastName} onChange={e => setLastName(e.target.value)} placeholder="Family name" maxLength={12} /></div>
              <div className="form-group"><label className="form-label">Gender</label>
                <div className="option-grid">
                  <div className={`option ${gender === 'm' ? 'selected' : ''}`} onClick={() => { sfx.click(); setGender('m'); setCharStyle(null); }}><div className="option-icon">üë®</div><div className="option-title">Male</div></div>
                  <div className={`option ${gender === 'f' ? 'selected' : ''}`} onClick={() => { sfx.click(); setGender('f'); setCharStyle(null); }}><div className="option-icon">üë©</div><div className="option-title">Female</div></div>
                </div>
              </div>
              <div className="form-group"><label className="form-label">Style</label>
                <div className="char-grid">{CHAR_STYLES[gender].map(s => (
                  <div key={s.id} className={`char-option ${charStyle === s.id ? 'selected' : ''}`} onClick={() => { sfx.click(); setCharStyle(s.id); }}>
                    <PixelChar style={s} gender={gender} size="sm" /><div className="char-name">{s.name}</div>
                  </div>
                ))}</div>
              </div>
              {gameMode === 'broke' ? (
                <button className="btn btn-primary btn-full" onClick={startGame} disabled={!firstName || !lastName || !charStyle}>Start From Nothing ‚Üí</button>
              ) : (
                <button className="btn btn-primary btn-full" onClick={() => { sfx.click(); setSetupStep(1); }} disabled={!firstName || !lastName || !charStyle}>Next ‚Üí</button>
              )}
            </div>
          )}
          
          {setupStep === 1 && gameMode !== 'broke' && (
            <div className="card">
              <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 4 }}>Career Path</div>
              <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 16 }}>Choose your profession</div>
              <div className="option-grid">{CAREERS.map(c => (
                <div key={c.id} className={`option ${career === c.id ? 'selected' : ''}`} onClick={() => { sfx.click(); setCareer(c.id); }}>
                  <div className="option-icon">{c.icon}</div>
                  <div className="option-title">{c.name}</div>
                  <div style={{ fontSize: 10, color: 'var(--gold)', marginTop: 2 }}>{fmt(c.salary)}/yr</div>
                  {gameMode !== 'silver' && <div style={{ fontSize: 9, color: 'var(--red)' }}>{fmt(c.edu)} debt</div>}
                </div>
              ))}</div>
              <button className="btn btn-primary btn-full" style={{ marginTop: 16 }} onClick={startGame} disabled={!career}>Start Journey ‚Üí</button>
            </div>
          )}
        </div>
      )}
      
      {/* GAME */}
      {screen === 'game' && char && st && (
        <>
          <div className="top-section">
            <div className="header">
              <div className="brand">
                <div className="logo">Knight Tycoon</div>
                <div className="sub-brand">by Knight Financial</div>
              </div>
              <div className="header-right">
                <div className="header-stat">
                  <div className="header-stat-value" style={{ color: netWorth(st) >= 0 ? 'var(--green)' : 'var(--red)' }}>{fmt(netWorth(st))}</div>
                  <div className="header-stat-label">Net Worth</div>
                </div>
                <button className="icon-btn" onClick={() => setModal('achievements')} title="Achievements">üèÜ</button>
                <button className={`icon-btn ${musicOn ? 'active' : ''}`} onClick={() => setMusicOn(!musicOn)}>üéµ</button>
                <button className="icon-btn" onClick={() => setModal('settings')}>‚öôÔ∏è</button>
              </div>
            </div>
            
            <div className="compact-bar">
              <div className="compact-char"><PixelChar style={char.style} gender={char.gender} size="sm" /></div>
              <div className="compact-info">
                <div className="compact-name">{char.name} {lastName}</div>
                <div className="compact-meta">
                  <span>Age {char.age}</span>
                  <span>Year {year}</span>
                  <span>Gen {gen}</span>
                </div>
              </div>
              <div className="compact-badges">
                {char.biz && <span className="mini-badge purple">üè¢</span>}
                {char.rel === 'married' && <span className="mini-badge blue">üíç</span>}
                {char.kids?.length > 0 && <span className="mini-badge blue">üë∂{char.kids.length}</span>}
                {char.inJail && <span className="mini-badge red">‚õìÔ∏è</span>}
                {char.housing === 'homeless' && <span className="mini-badge red">üèöÔ∏è</span>}
                {char.inJail && <span className="mini-badge red">‚õìÔ∏è</span>}
                {(char.crimeRecord || 0) >= 2 && !char.inJail && <span className="mini-badge orange">üìã</span>}
                {char.foodStamps && <span className="mini-badge green">üçé</span>}
              </div>
            </div>
            
            <div className="quick-stats">
              <div className="quick-stat" onClick={() => setModal('invest')} style={{ cursor: 'pointer' }}>
                <div className="quick-stat-value">{fmt(st.cash)}</div>
                <div className="quick-stat-label">üí∞ Cash</div>
              </div>
              <div className="quick-stat" onClick={() => setModal('invest')} style={{ cursor: 'pointer' }}>
                <div className="quick-stat-value positive">{fmt(st.invest || 0)}</div>
                <div className="quick-stat-label">üìà Invested</div>
              </div>
              <div className="quick-stat" onClick={() => (st.debt || 0) > 0 ? setModal('debt') : null} style={{ cursor: (st.debt || 0) > 0 ? 'pointer' : 'default' }}>
                <div className={`quick-stat-value ${(st.debt || 0) > 0 ? 'negative' : ''}`}>{fmt(st.debt || 0)}</div>
                <div className="quick-stat-label">{(st.debt || 0) > 0 ? 'üí≥ Pay Debt' : 'üí≥ Debt'}</div>
              </div>
              <div className="quick-stat">
                <div className="quick-stat-value">{fmt(st.salary)}</div>
                <div className="quick-stat-label">üíµ Income/yr</div>
              </div>
            </div>
          </div>
          
          <div className="card-section">
            {yearSummary ? (
              <div className="year-summary">
                <button className="year-close" onClick={dismissSummary}>√ó</button>
                <div className="year-title">üìä Year {year} Summary</div>
                <div className="year-row"><span>Gross Income</span><span className="year-positive">+{fmt(yearSummary.income)}</span></div>
                <div className="year-row"><span>Housing</span><span className="year-negative">-{fmt(yearSummary.housing)}</span></div>
                <div className="year-row"><span>Living</span><span className="year-negative">-{fmt(yearSummary.living)}</span></div>
                {yearSummary.kids > 0 && <div className="year-row"><span>Kids</span><span className="year-negative">-{fmt(yearSummary.kids)}</span></div>}
                <div className="year-row"><span>Federal Tax</span><span className="year-negative">-{fmt(yearSummary.taxes.federal)}</span></div>
                <div className="year-row"><span>State Tax</span><span className="year-negative">-{fmt(yearSummary.taxes.state)}</span></div>
                {yearSummary.taxes.deductions > 0 && <div className="year-row"><span>Tax Deductions</span><span className="year-positive">+{fmt(yearSummary.taxes.deductions)}</span></div>}
                {char.foodStamps && <div className="year-row"><span>SNAP Benefits</span><span className="year-positive">+$4K saved</span></div>}
                {char.shelterAccess && <div className="year-row"><span>Shelter Access</span><span className="year-positive">+$2K saved</span></div>}
                {yearSummary.debtInt > 0 && <div className="year-row"><span>Debt Interest</span><span className="year-negative">-{fmt(yearSummary.debtInt)}</span></div>}
                {char.housing === 'homeless' && <div className="year-row"><span>Homeless Penalty</span><span className="year-negative">-8 HP, -10 üòä</span></div>}
                {char.inJail && <div className="year-row"><span>‚õìÔ∏è In Prison ({char.jailServed || 0}/{char.jailTime} yrs)</span><span className="year-negative">No income</span></div>}
                {(char.crimeRecord || 0) >= 2 && !char.inJail && <div className="year-row"><span>üìã Criminal Record</span><span className="year-negative">Harder to get jobs</span></div>}
                {char.kids?.length > 0 && char.kids.some(k => k.age >= 5) && <div className="year-row"><span>Family Happiness</span><span className="year-positive">+{Math.min(25, char.kids.filter(k => k.age >= 5).length * 3 + (char.kids.length >= 2 ? 3 : 0) + (char.kids.length >= 3 ? 4 : 0) + (char.kids.length >= 4 ? 5 : 0))} üòä</span></div>}
                {char.kids?.some(k => k.age >= 16 && k.age < 18) && <div className="year-row"><span>Teen Jobs</span><span className="year-positive">+{fmt(char.kids.filter(k => k.age >= 16 && k.age < 18).length * 4000)}</span></div>}
                <div className={`year-row total ${yearSummary.netCash >= 0 ? 'year-positive' : 'year-negative'}`}>
                  <span>Net Change</span><span>{yearSummary.netCash >= 0 ? '+' : ''}{fmt(yearSummary.netCash)}</span>
                </div>
              </div>
            ) : (
              <>
                <div className="card-area">
                  {card && (
                    <div className={`swipe-card ${card.type || ''} ${cardOffset < -20 ? 'swipe-left' : ''} ${cardOffset > 20 ? 'swipe-right' : ''}`}
                      style={{ transform: `translateX(${cardOffset}px) rotate(${cardOffset * 0.03}deg)`, transition: dragging ? 'none' : 'transform 0.2s' }}
                      onMouseDown={e => handleDragStart(e.clientX)} onMouseMove={e => handleDragMove(e.clientX)} onMouseUp={handleDragEnd} onMouseLeave={() => dragging && handleDragEnd()}
                      onTouchStart={e => handleDragStart(e.touches[0].clientX)} onTouchMove={e => handleDragMove(e.touches[0].clientX)} onTouchEnd={handleDragEnd}
                    >
                      <div className="card-header">
                        <div><div className="card-cat">{card.cat}</div><div className="card-title">{card.title}</div></div>
                        <div className="card-icon">{card.icon}</div>
                      </div>
                      <div className="card-desc">{card.desc}</div>
                      {card.isEvent ? (
                        <div className="event-effects">
                          {Object.entries(card.imp || {}).map(([k, v]) => (
                            <span key={k} className={`effect-tag ${v > 0 ? 'positive' : 'negative'}`}>
                              {k === 'cash' && `${v > 0 ? '+' : ''}${fmt(v)}`}
                              {k === 'health' && `${v > 0 ? '+' : ''}${v} HP`}
                              {k === 'happy' && `${v > 0 ? '+' : ''}${v} üòä`}
                            </span>
                          ))}
                        </div>
                      ) : (
                        <div className="card-choices">
                          <div className="card-choice left"><div className="choice-label">‚Üê {card.left?.label}</div><div className="choice-effect">{card.left?.effect}</div></div>
                          <div className="card-choice right"><div className="choice-label">{card.right?.label} ‚Üí</div><div className="choice-effect">{card.right?.effect}</div></div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
                {card && !card.isEvent && (
                  <div className="action-buttons">
                    <button className="action-btn no" onClick={() => swipe('left')}>‚úï</button>
                    <button className="action-btn yes" onClick={() => swipe('right')}>‚úì</button>
                  </div>
                )}
                {card?.isEvent && (
                  <div style={{ display: 'flex', justifyContent: 'center', padding: 6 }}>
                    <button className="btn btn-primary btn-sm" onClick={() => swipe('right')}>Continue</button>
                  </div>
                )}
              </>
            )}
          </div>
          
          <div className="bottom-section">
            <div className="section-title">üìä Stats</div>
            <div className="stats-grid">
              <div className="stat-card"><div className="stat-icon">üìä</div><div className="stat-value">{st.credit}</div><div className="stat-label">Credit</div><div className="stat-bar"><div className="stat-bar-fill" style={{ width: `${((st.credit - 300) / 550) * 100}%`, background: 'linear-gradient(90deg, var(--red), var(--gold), var(--green))' }}></div></div></div>
              <div className="stat-card"><div className="stat-icon">‚ù§Ô∏è</div><div className={`stat-value ${st.health < 30 ? 'negative' : ''}`}>{st.health}%</div><div className="stat-label">Health</div><div className="stat-bar"><div className="stat-bar-fill" style={{ width: `${st.health}%`, background: st.health > 50 ? 'var(--green)' : 'var(--red)' }}></div></div></div>
              <div className="stat-card"><div className="stat-icon">üòä</div><div className="stat-value">{st.happy}%</div><div className="stat-label">Happy</div><div className="stat-bar"><div className="stat-bar-fill" style={{ width: `${st.happy}%`, background: st.happy > 50 ? 'var(--blue)' : 'var(--red)' }}></div></div></div>
            </div>
            
            {char.biz && (
              <>
                <div className="section-title">üè¢ Business</div>
                <div className="biz-card">
                  <div className="biz-header">{char.biz.icon} {char.biz.name}</div>
                  <div className="biz-stats">
                    <div className="biz-stat"><div className="biz-stat-value">{fmt(char.biz.revenue)}</div><div className="biz-stat-label">Revenue</div></div>
                    <div className="biz-stat"><div className="biz-stat-value">{fmt(char.biz.profit || 0)}</div><div className="biz-stat-label">Profit</div></div>
                    <div className="biz-stat"><div className="biz-stat-value">{char.biz.employees || 0}</div><div className="biz-stat-label">Staff</div></div>
                  </div>
                </div>
                {char.biz2 && (
                  <div className="biz-card">
                    <div className="biz-header">{char.biz2.icon} {char.biz2.name}</div>
                    <div className="biz-stats">
                      <div className="biz-stat"><div className="biz-stat-value">{fmt(char.biz2.revenue)}</div><div className="biz-stat-label">Revenue</div></div>
                      <div className="biz-stat"><div className="biz-stat-value">{fmt(char.biz2.profit || 0)}</div><div className="biz-stat-label">Profit</div></div>
                      <div className="biz-stat"><div className="biz-stat-value">{char.biz2.employees || 0}</div><div className="biz-stat-label">Staff</div></div>
                    </div>
                  </div>
                )}
              </>
            )}
            
            {char.kids?.length > 0 && (
              <>
                <div className="section-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family {char.kids.length >= 2 ? `(+${3 + (char.kids.length >= 3 ? 4 : 0) + (char.kids.length >= 4 ? 5 : 0)} bonus!)` : ''}</div>
                <div className="family-grid">
                  {char.spouse && <div className="family-chip">üíç {char.spouse.name}</div>}
                  {char.kids.map(k => (
                    <div key={k.id} className="family-chip">
                      {k.gender === 'm' ? 'üë¶' : 'üëß'} {k.name}, {k.age}
                      {k.age >= 16 && k.age < 18 && <span className="invested"> üíº</span>}
                      {k.age >= 5 && k.age < 16 && <span className="invested"> üòä</span>}
                    </div>
                  ))}
                </div>
              </>
            )}
          </div>
        </>
      )}
      
      {/* TRANSITION */}
      {screen === 'transition' && char && (
        <div style={{ flex: 1, overflow: 'auto', padding: 12 }}>
          <div className="end-screen" style={{ paddingTop: 20 }}>
            <div className="end-icon">{char.age >= 65 ? 'üåÖ' : st.health <= 0 ? 'üíî' : 'üìâ'}</div>
            <div className="end-title">{char.age >= 65 ? 'Retired!' : st.health <= 0 ? 'Health Failed' : 'Bankrupt'}</div>
            <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>{char.name} {lastName} ‚Ä¢ Age {char.age} ‚Ä¢ Generation {gen}</div>
            
            <div className="end-stats">
              <div className="end-stat"><div className={`end-stat-value ${netWorth(st) >= 0 ? '' : 'negative'}`}>{fmt(netWorth(st))}</div><div className="end-stat-label">Net Worth</div></div>
              <div className="end-stat"><div className="end-stat-value">{st.credit}</div><div className="end-stat-label">Credit Score</div></div>
              <div className="end-stat"><div className="end-stat-value">{char.kids?.length || 0}</div><div className="end-stat-label">Children</div></div>
              <div className="end-stat"><div className="end-stat-value">{achs.length}/{ACHIEVEMENTS.length}</div><div className="end-stat-label">Achievements</div></div>
            </div>
            
            {achs.length > 0 && (
              <div style={{ marginTop: 12, padding: 12, background: 'var(--card)', borderRadius: 8, border: '1px solid var(--gold)' }}>
                <div style={{ fontSize: 11, fontWeight: 700, color: 'var(--gold)', marginBottom: 8 }}>üèÜ Achievements This Life</div>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6 }}>
                  {achs.slice(-8).map(id => {
                    const ach = ACHIEVEMENTS.find(a => a.id === id);
                    return ach ? <span key={id} style={{ fontSize: 11, background: 'rgba(246,195,67,0.2)', padding: '4px 8px', borderRadius: 4 }}>{ach.icon} {ach.title}</span> : null;
                  })}
                </div>
              </div>
            )}
            
            {char.age >= 65 && netWorth(st) >= 100000 && (
              <div style={{ marginTop: 12, padding: 10, background: 'rgba(16,185,129,0.1)', borderRadius: 8, border: '1px solid var(--green)' }}>
                <div style={{ fontSize: 12, color: 'var(--green)', fontWeight: 700 }}>üéâ Successful Retirement!</div>
                <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>You built a legacy worth {fmt(netWorth(st))}</div>
              </div>
            )}
          </div>
          
          <div className="card" style={{ marginTop: 16 }}>
            <div style={{ fontSize: 16, fontWeight: 800, marginBottom: 12 }}>Create Heir</div>
            
            <div className="form-group">
              <label className="form-label">Heir's Path</label>
              <div className="option-grid">
                <div className={`option ${heirMode === 'inherit' ? 'selected' : ''}`} onClick={() => { sfx.click(); setHeirMode('inherit'); }}>
                  <div className="option-icon">üëë</div>
                  <div className="option-title">Inherit</div>
                  <div className="option-desc">Get {fmt(Math.max(0, Math.round(netWorth(st) * 0.6) + ((char.kids?.length || 1) - 1) * 5000))}</div>
                </div>
                <div className={`option ${heirMode === 'broke' ? 'selected' : ''}`} onClick={() => { sfx.click(); setHeirMode('broke'); setHeirCareer(null); }}>
                  <div className="option-icon">üí™</div>
                  <div className="option-title">From Broke</div>
                  <div className="option-desc">Start with nothing</div>
                </div>
              </div>
            </div>
            
            {(char.kids?.length || 0) > 1 && (
              <div style={{ background: 'rgba(16,185,129,0.1)', border: '1px solid var(--green)', borderRadius: 8, padding: 10, marginBottom: 12 }}>
                <div style={{ fontSize: 11, fontWeight: 700, color: 'var(--green)' }}>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Sibling Bonus! ({(char.kids?.length || 1) - 1} siblings)</div>
                <div style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 4 }}>
                  +{fmt(((char.kids?.length || 1) - 1) * 5000)} inheritance ‚Ä¢ +{((char.kids?.length || 1) - 1) * 5} Happy ‚Ä¢ +{((char.kids?.length || 1) - 1) * 3}K salary ‚Ä¢ +{((char.kids?.length || 1) - 1) * 10} credit
                </div>
              </div>
            )}
            
            <div className="form-group"><label className="form-label">Name</label><input className="form-input" value={heirName} onChange={e => setHeirName(e.target.value)} placeholder="Heir name" maxLength={12} /></div>
            <div className="form-group"><label className="form-label">Gender</label>
              <div className="option-grid">
                <div className={`option ${heirGender === 'm' ? 'selected' : ''}`} onClick={() => { sfx.click(); setHeirGender('m'); setHeirStyle(null); }}><div className="option-icon">üë®</div><div className="option-title">Male</div></div>
                <div className={`option ${heirGender === 'f' ? 'selected' : ''}`} onClick={() => { sfx.click(); setHeirGender('f'); setHeirStyle(null); }}><div className="option-icon">üë©</div><div className="option-title">Female</div></div>
              </div>
            </div>
            <div className="form-group"><label className="form-label">Style</label>
              <div className="char-grid">{CHAR_STYLES[heirGender].map(s => (
                <div key={s.id} className={`char-option ${heirStyle === s.id ? 'selected' : ''}`} onClick={() => { sfx.click(); setHeirStyle(s.id); }}>
                  <PixelChar style={s} gender={heirGender} size="sm" /><div className="char-name">{s.name}</div>
                </div>
              ))}</div>
            </div>
            
            {heirMode === 'inherit' && (
              <div className="form-group"><label className="form-label">Career</label>
                <div className="option-grid">{CAREERS.map(c => (
                  <div key={c.id} className={`option ${heirCareer === c.id ? 'selected' : ''}`} onClick={() => { sfx.click(); setHeirCareer(c.id); }}>
                    <div className="option-icon">{c.icon}</div><div className="option-title">{c.name}</div>
                  </div>
                ))}</div>
              </div>
            )}
            
            {heirMode === 'broke' && (
              <div style={{ background: 'rgba(249,115,22,0.1)', border: '1px solid var(--orange)', borderRadius: 8, padding: 12, marginBottom: 12 }}>
                <div style={{ fontSize: 12, fontWeight: 700, color: 'var(--orange)', marginBottom: 4 }}>üí™ From Broke Mode</div>
                <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>Starting: $50, homeless, no job, 500 credit. Your heir rejects the family wealth to prove themselves.</div>
              </div>
            )}
            
            <button className="btn btn-primary btn-full" onClick={nextGen} disabled={!heirName || !heirStyle || (heirMode === 'inherit' && !heirCareer)}>
              {heirMode === 'broke' ? 'Start From Nothing ‚Üí' : 'Next Generation ‚Üí'}
            </button>
          </div>
        </div>
      )}
      
      {/* MODALS */}
      {modal === 'achievements' && (
        <div className="modal-backdrop" onClick={() => setModal(null)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <div className="modal-title">üèÜ Achievements ({achs.length}/{ACHIEVEMENTS.length})</div>
              <button className="modal-close" onClick={() => setModal(null)}>√ó</button>
            </div>
            <div className="scroll-section" style={{ maxHeight: '60vh' }}>
              {ACHIEVEMENTS.map(a => {
                const unlocked = achs.includes(a.id);
                return (
                  <div key={a.id} style={{ 
                    display: 'flex', alignItems: 'center', gap: 12, padding: '10px 0',
                    borderBottom: '1px solid var(--card-border)',
                    opacity: unlocked ? 1 : 0.4
                  }}>
                    <div style={{ fontSize: 24 }}>{unlocked ? a.icon : 'üîí'}</div>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 13, fontWeight: 700, color: unlocked ? 'var(--gold)' : 'var(--text-muted)' }}>{a.title}</div>
                      <div style={{ fontSize: 10, color: 'var(--text-dim)' }}>{a.desc || ''}</div>
                    </div>
                    {unlocked && <div style={{ color: 'var(--green)', fontSize: 12 }}>‚úì</div>}
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}
      
      {modal === 'settings' && (
        <div className="modal-backdrop" onClick={() => setModal(null)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">Settings</div><button className="modal-close" onClick={() => setModal(null)}>√ó</button></div>
            <div className="setting-row"><span>üéµ Music</span><button className={`toggle ${musicOn ? 'on' : ''}`} onClick={() => setMusicOn(!musicOn)}><div className="toggle-knob"></div></button></div>
            <div className="setting-row"><span>üîä Sound</span><button className={`toggle ${sfxOn ? 'on' : ''}`} onClick={() => setSfxOn(!sfxOn)}><div className="toggle-knob"></div></button></div>
            <div style={{ borderTop: '1px solid var(--card-border)', paddingTop: 16, marginTop: 16 }}>
              <button className="btn btn-danger btn-full" onClick={() => { clearSave(); setModal(null); setScreen('title'); }}>Reset Game</button>
            </div>
          </div>
        </div>
      )}
      
      {modal === 'invest' && st && (
        <div className="modal-backdrop" onClick={() => setModal(null)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">üí∞ Investments</div><button className="modal-close" onClick={() => setModal(null)}>√ó</button></div>
            <div style={{ textAlign: 'center', marginBottom: 16 }}>
              <div style={{ display: 'flex', justifyContent: 'space-around', marginBottom: 12 }}>
                <div>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>Cash</div>
                  <div style={{ fontSize: 20, fontWeight: 800 }}>{fmt(st.cash)}</div>
                </div>
                <div>
                  <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>Invested</div>
                  <div style={{ fontSize: 20, fontWeight: 800, color: 'var(--green)' }}>{fmt(st.invest || 0)}</div>
                </div>
              </div>
              <div style={{ background: 'rgba(16,185,129,0.1)', border: '1px solid var(--green)', borderRadius: 8, padding: 10 }}>
                <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>üí° Investments grow automatically each year based on market conditions!</div>
              </div>
            </div>
            <div className="modal-section">
              <div className="modal-section-title">Investment Options</div>
              {INVESTMENTS.map(inv => (
                <div key={inv.id} className="invest-option">
                  <div className="invest-option-header">
                    <div className="invest-option-name">{inv.icon} {inv.name}</div>
                    <div className="invest-option-return" style={{ color: inv.minReturn < 0 ? 'var(--orange)' : 'var(--green)' }}>
                      {Math.round(inv.minReturn * 100)}% to {Math.round(inv.maxReturn * 100)}%
                    </div>
                  </div>
                  <div className="invest-option-desc">{inv.desc} ‚Ä¢ Risk: <span style={{ fontWeight: 600 }}>{inv.risk}</span></div>
                  <div className="invest-amounts">
                    {[500, 1000, 5000, 10000, 25000].filter(a => st.cash >= a).map(amt => (
                      <button key={amt} className="btn btn-ghost btn-sm" onClick={() => makeInvestment(inv.id, amt)}>{fmt(amt)}</button>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
      
      {modal === 'debt' && st && (
        <div className="modal-backdrop" onClick={() => setModal(null)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">üí≥ Pay Off Debt</div><button className="modal-close" onClick={() => setModal(null)}>√ó</button></div>
            <div style={{ textAlign: 'center', marginBottom: 16 }}>
              <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>Total Debt (15% APR)</div>
              <div style={{ fontSize: 32, fontWeight: 800, color: 'var(--red)' }}>{fmt(st.debt || 0)}</div>
              <div style={{ fontSize: 11, color: 'var(--text-dim)', marginTop: 4 }}>Yearly interest: {fmt(Math.round((st.debt || 0) * 0.15))}</div>
              <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 8 }}>Available Cash: <span style={{ color: 'var(--green)', fontWeight: 700 }}>{fmt(st.cash)}</span></div>
            </div>
            <div style={{ background: 'rgba(239,68,68,0.1)', border: '1px solid var(--red)', borderRadius: 8, padding: 10, marginBottom: 16 }}>
              <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>üí° Tip: Paying off debt improves your credit score and stops interest from accumulating!</div>
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 8 }}>
              {[1000, 5000, 10000, 25000, 50000].filter(a => st.cash >= a && (st.debt || 0) >= a * 0.5).map(amt => (
                <button key={amt} className="btn btn-ghost" onClick={() => payDebt(amt)}>{fmt(amt)}</button>
              ))}
              <button className="btn btn-primary" onClick={() => payDebt(Math.min(st.cash, st.debt || 0))} disabled={st.cash <= 0 || (st.debt || 0) <= 0}>
                Pay All ({fmt(Math.min(st.cash, st.debt || 0))})
              </button>
            </div>
          </div>
        </div>
      )}
      
      {toast && <div className={`toast ${toast.type || ''}`}>{toast.text}</div>}
      {achievement && <div className="achievement-popup">üèÜ {achievement.icon} {achievement.title}</div>}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<Game />);
</script>
</body>
</html>
