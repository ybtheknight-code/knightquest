<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Knight Tycoon 3.2</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--gold:#D4AF37;--bg:#0a0a0f;--card:#12121a;--card2:#1a1a25;--text:#FFF;--text2:#888;--green:#22C55E;--red:#EF4444;--blue:#3B82F6;--purple:#A855F7;--pink:#EC4899}
    html,body{height:100%;overflow:hidden}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text)}
    #root{height:100%}
    .app{max-width:430px;margin:0 auto;padding:8px 12px;height:100%;display:flex;flex-direction:column}
    .scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:20px}

    /* Header */
    .hdr{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(212,175,55,0.12);margin-bottom:6px}
    .logo{font-family:'Playfair Display',serif;font-size:17px;color:var(--gold)}
    .hdr-r{display:flex;gap:5px;align-items:center}
    .ver{font-size:8px;color:var(--text2);background:var(--card);padding:3px 6px;border-radius:4px}
    .ibtn{width:32px;height:32px;border-radius:8px;background:var(--card);border:1px solid rgba(255,255,255,0.06);color:var(--text2);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .ibtn.on{background:var(--gold);color:var(--bg)}

    /* PIXEL CHARACTER */
    .pix{image-rendering:pixelated;position:relative}
    .pix-wrap{display:flex;align-items:center;justify-content:center}
    .pix-char{position:relative}
    
    /* Pixel art using box-shadow technique */
    .pixel-avatar{
      width:4px;height:4px;
      background:transparent;
      transform-origin:top left;
    }
    .pixel-avatar.sm{transform:scale(3)}
    .pixel-avatar.md{transform:scale(5)}
    .pixel-avatar.lg{transform:scale(8)}
    .pixel-avatar.xl{transform:scale(10)}

    /* Character container */
    .char-pix{
      width:48px;height:64px;
      display:flex;align-items:center;justify-content:center;
      border-radius:8px;
      background:var(--card);
      border:2px solid var(--gold);
      overflow:hidden;
      position:relative;
    }
    .char-pix.sm{width:32px;height:42px;border-width:1px}
    .char-pix.lg{width:72px;height:96px;border-width:3px}
    .char-pix.xl{width:96px;height:128px;border-width:3px}

    /* Pixel sprite container */
    .sprite{
      image-rendering:pixelated;
      image-rendering:crisp-edges;
    }

    /* Character Bar */
    .cbar{display:flex;align-items:center;gap:8px;background:var(--card);padding:8px 10px;border-radius:10px;margin-bottom:5px}
    .cinfo{flex:1;min-width:0}
    .cname{font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .cmeta{font-size:10px;color:var(--text2);display:flex;gap:6px;flex-wrap:wrap}
    .cmeta span{display:flex;align-items:center;gap:2px}
    .gbadge{background:var(--gold);color:var(--bg);font-size:9px;font-weight:700;padding:4px 8px;border-radius:5px}

    /* Stats Grid */
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-bottom:4px}
    .stat{background:var(--card);padding:6px 4px;border-radius:6px;text-align:center;cursor:pointer;transition:all 0.15s}
    .stat:hover{background:var(--card2)}
    .stat-i{font-size:11px}
    .stat-v{font-size:13px;font-weight:700}
    .stat-v.g{color:var(--green)}
    .stat-v.r{color:var(--red)}
    .stat-l{font-size:7px;color:var(--text2);text-transform:uppercase}
    .stat-bar{height:3px;background:rgba(255,255,255,0.1);border-radius:2px;margin-top:2px;overflow:hidden}
    .stat-fill{height:100%;border-radius:2px}

    /* Benefits Banner */
    .benefits{display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap}
    .benefit{font-size:8px;padding:3px 6px;border-radius:4px;display:flex;align-items:center;gap:3px}
    .benefit.food{background:rgba(34,197,94,0.15);color:var(--green);border:1px solid rgba(34,197,94,0.3)}
    .benefit.s8{background:rgba(59,130,246,0.15);color:var(--blue);border:1px solid rgba(59,130,246,0.3)}
    .benefit.married{background:rgba(236,72,153,0.15);color:var(--pink);border:1px solid rgba(236,72,153,0.3)}
    .benefit.kids{background:rgba(168,85,247,0.15);color:var(--purple);border:1px solid rgba(168,85,247,0.3)}

    /* Family Bar */
    .fambar{background:var(--card);border-radius:6px;padding:6px 8px;margin-bottom:4px}
    .fambar-h{font-size:8px;color:var(--text2);text-transform:uppercase;margin-bottom:4px}
    .fambar-kids{display:flex;gap:4px;flex-wrap:wrap}
    .kid-chip{display:flex;align-items:center;gap:3px;background:var(--card2);padding:3px 6px;border-radius:4px;font-size:9px}
    .kid-invested{color:var(--gold);font-size:8px}

    /* Economy Banner */
    .econ{background:var(--card);border-radius:6px;padding:6px 10px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;font-size:10px}
    .econ-phase{display:flex;align-items:center;gap:4px}
    .econ-dot{width:8px;height:8px;border-radius:50%}
    .econ-dot.boom{background:var(--green)}
    .econ-dot.recession{background:var(--red)}
    .econ-dot.recovery{background:var(--gold)}
    .econ-dot.stable{background:var(--blue)}

    /* Card Area */
    .card-area{flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-height:170px;overflow:hidden}
    .scard{position:absolute;width:calc(100% - 8px);max-width:360px;background:var(--card);border:1px solid rgba(255,255,255,0.05);border-radius:14px;padding:14px 12px;cursor:grab;user-select:none}
    .scard:active{cursor:grabbing}
    .scard.sl{border-color:var(--red);box-shadow:-6px 0 18px rgba(239,68,68,0.15)}
    .scard.sr{border-color:var(--green);box-shadow:6px 0 18px rgba(34,197,94,0.15)}
    .scard.evt{border-color:rgba(212,175,55,0.25);background:linear-gradient(145deg,#1a1610,#111)}
    .scard.kid{border-color:rgba(168,85,247,0.3);background:linear-gradient(145deg,#1a1020,#111)}
    .scard.pov{border-color:rgba(59,130,246,0.3);background:linear-gradient(145deg,#101520,#111)}
    .scard.crime{border-color:rgba(239,68,68,0.4);background:linear-gradient(145deg,#201010,#111)}
    .scard.jail{border-color:rgba(100,100,100,0.5);background:linear-gradient(145deg,#151515,#0a0a0a)}
    .scard.caught{border-color:rgba(239,68,68,0.6);background:linear-gradient(145deg,#2a1515,#111);animation:shake 0.3s}
    .card-cat{font-size:8px;text-transform:uppercase;letter-spacing:1px;color:var(--text2);text-align:center;margin-bottom:4px}
    .card-icon{font-size:36px;text-align:center;margin-bottom:6px}
    .card-title{font-family:'Playfair Display',serif;font-size:16px;text-align:center;margin-bottom:5px}
    .card-desc{font-size:11px;color:var(--text2);text-align:center;line-height:1.4;margin-bottom:10px}

    .choices{display:flex;gap:6px}
    .choice{flex:1;padding:8px 6px;border-radius:8px;text-align:center;font-size:10px;font-weight:500;line-height:1.3}
    .choice.l{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.15);color:var(--red)}
    .choice.r{background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.15);color:var(--green)}
    .ch-arr{display:block;font-size:12px;margin-bottom:2px}
    .ch-fx{font-size:8px;margin-top:4px;opacity:0.85}

    .evt-fx{display:flex;justify-content:center;gap:5px;flex-wrap:wrap}
    .fx{font-size:9px;padding:4px 8px;border-radius:10px}
    .fx.g{background:rgba(34,197,94,0.1);color:var(--green)}
    .fx.r{background:rgba(239,68,68,0.1);color:var(--red)}

    /* Actions */
    .acts{display:flex;justify-content:center;gap:14px;padding:8px 0}
    .abtn{width:52px;height:52px;border-radius:50%;border:2px solid;background:transparent;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.12s}
    .abtn.no{border-color:var(--red);color:var(--red)}
    .abtn.no:active{background:var(--red);color:#fff;transform:scale(1.1)}
    .abtn.yes{border-color:var(--green);color:var(--green)}
    .abtn.yes:active{background:var(--green);color:#fff;transform:scale(1.1)}

    /* Dynasty Tree */
    .tree{background:var(--card);border-radius:6px;padding:5px 8px;margin-bottom:4px}
    .tree-h{display:flex;justify-content:space-between;font-size:8px;color:var(--text2);text-transform:uppercase;margin-bottom:3px}
    .tree-v{color:var(--gold);font-weight:600}
    .tree-r{display:flex;align-items:center;gap:2px}
    .tree-ln{width:6px;height:1px;background:rgba(212,175,55,0.2)}
    .tree-m{opacity:0.35}
    .tree-m.now{opacity:1}

    /* Screens */
    .scr{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;padding:16px;z-index:100;overflow-y:auto}
    .scr-i{font-size:48px;margin:10px 0;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}
    .scr-t{font-family:'Playfair Display',serif;font-size:22px;color:var(--gold);margin-bottom:6px;text-align:center}
    .scr-s{font-size:11px;color:var(--text2);margin-bottom:14px;text-align:center}

    /* Forms */
    .fgrp{margin-bottom:12px;width:100%;max-width:320px}
    .flbl{font-size:9px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;display:block}
    .inp{width:100%;background:var(--card);border:1px solid rgba(212,175,55,0.15);padding:11px 12px;font-size:14px;color:var(--text);border-radius:8px;font-family:'Inter',sans-serif}
    .inp:focus{outline:none;border-color:var(--gold)}
    .inp::placeholder{color:#555}

    .opts{display:grid;gap:6px}
    .opts.g2{grid-template-columns:repeat(2,1fr)}
    .opts.g3{grid-template-columns:repeat(3,1fr)}
    .opt{padding:10px 6px;background:var(--card);border:1px solid rgba(255,255,255,0.05);border-radius:8px;text-align:center;cursor:pointer;transition:all 0.15s}
    .opt:hover{border-color:rgba(212,175,55,0.3)}
    .opt.sel{border-color:var(--gold);background:rgba(212,175,55,0.08)}
    .opt-i{font-size:18px;margin-bottom:2px}
    .opt-t{font-size:10px;font-weight:600}
    .opt-d{font-size:8px;color:var(--text2);margin-top:2px}

    /* Character Selection */
    .char-select{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .char-opt{padding:8px;background:var(--card);border:2px solid rgba(255,255,255,0.05);border-radius:10px;cursor:pointer;display:flex;flex-direction:column;align-items:center;transition:all 0.15s}
    .char-opt:hover{border-color:rgba(212,175,55,0.3);transform:translateY(-2px)}
    .char-opt.sel{border-color:var(--gold);background:rgba(212,175,55,0.1)}

    .preview{background:var(--card);border-radius:12px;padding:16px;text-align:center;border:1px solid rgba(212,175,55,0.1);margin:14px 0;width:100%;max-width:320px}
    .prev-n{font-family:'Playfair Display',serif;font-size:15px;color:var(--gold);margin-top:8px}
    .prev-s{font-size:10px;color:var(--text2)}

    /* Buttons */
    .btn{background:linear-gradient(135deg,var(--gold),#A68B28);color:var(--bg);border:none;padding:12px 28px;font-size:13px;font-weight:600;border-radius:8px;cursor:pointer;font-family:'Inter',sans-serif;transition:all 0.12s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(212,175,55,0.3)}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .btn.sec{background:transparent;border:1px solid var(--gold);color:var(--gold)}
    .btn.full{width:100%;max-width:320px}
    .btn.sm{padding:8px 16px;font-size:11px}

    /* Title */
    .title{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;flex:1;padding:16px}
    .t-crown{font-size:48px;margin-bottom:8px;animation:float 3s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .t-logo{font-family:'Press Start 2P',cursive;font-size:18px;color:var(--gold);text-shadow:2px 2px 0 #000}
    .t-sub{font-size:10px;color:var(--gold);margin-top:4px;font-family:'Press Start 2P',cursive}
    .t-tag{color:var(--text2);margin:12px 0 20px;font-size:11px}

    .howto{background:var(--card);border-radius:10px;padding:14px;margin-bottom:18px;text-align:left;max-width:300px}
    .howto h3{font-size:9px;color:var(--gold);margin-bottom:8px;text-transform:uppercase}
    .howto-i{display:flex;gap:8px;margin-bottom:6px;font-size:10px;color:var(--text2)}
    .howto-ic{font-size:14px;width:22px}

    /* Login */
    .login-box{background:var(--card);border-radius:12px;padding:16px;width:100%;max-width:300px;margin-bottom:16px}
    .login-box h3{font-size:11px;color:var(--gold);margin-bottom:10px;text-align:center}
    .save-code{background:var(--bg);border:1px dashed var(--gold);border-radius:8px;padding:12px;text-align:center;margin:10px 0}
    .save-code span{font-family:'Press Start 2P',cursive;font-size:14px;color:var(--gold);letter-spacing:2px}
    .save-code small{display:block;font-size:8px;color:var(--text2);margin-top:6px}

    /* Boxes */
    .box{background:var(--card);border-radius:10px;padding:12px;width:100%;max-width:320px;margin-bottom:12px}
    .box-t{font-size:9px;text-transform:uppercase;color:var(--text2);margin-bottom:8px;text-align:center;letter-spacing:1px}
    .box-r{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:11px}
    .box-r:last-child{border:none}
    .box-r.hl{color:var(--gold);font-weight:600}

    /* Dynasty Summary */
    .dsum{background:var(--card);border-radius:10px;padding:12px;width:100%;max-width:340px}
    .dmem{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)}
    .dmem:last-child{border:none}
    .dmem-i{flex:1}
    .dmem-n{font-size:11px;font-weight:500}
    .dmem-m{font-size:9px;color:var(--text2)}
    .dmem-w{font-size:11px;font-weight:600}
    .dtot{display:flex;justify-content:space-between;padding:10px 0 0;margin-top:6px;border-top:2px solid var(--gold)}
    .dtot-l{font-size:11px;color:var(--gold);font-weight:600}
    .dtot-v{font-size:14px;color:var(--gold);font-weight:700}

    .promo{background:linear-gradient(135deg,#1a1510,#0a0a0a);border:1px solid rgba(212,175,55,0.15);border-radius:10px;padding:12px;margin-top:12px;text-align:center;max-width:320px;width:100%}
    .promo-b{background:var(--gold);color:var(--bg);font-size:7px;font-weight:700;padding:3px 8px;border-radius:10px;display:inline-block;margin-bottom:5px}
    .promo-t{font-family:'Playfair Display',serif;font-size:13px;margin-bottom:3px}
    .promo-d{font-size:9px;color:var(--text2)}

    /* Toast */
    .toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);border-radius:10px;padding:16px 24px;text-align:center;z-index:150;border:2px solid;animation:pop 0.2s}
    .toast.g{border-color:var(--green)}
    .toast.r{border-color:var(--red)}
    .toast-i{font-size:24px;margin-bottom:4px}
    .toast-t{font-size:12px;font-weight:500}
    @keyframes pop{from{opacity:0;transform:translate(-50%,-50%) scale(0.85)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}

    /* Jail Status */
    .jail-bar{background:rgba(100,100,100,0.2);border:1px solid rgba(100,100,100,0.4);border-radius:6px;padding:6px 10px;margin-bottom:4px;display:flex;align-items:center;gap:8px}
    .jail-icon{font-size:18px}
    .jail-info{flex:1;font-size:10px;color:var(--text2)}
    .jail-time{font-size:12px;font-weight:600;color:var(--red)}

    /* Achievement */
    .ach{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid var(--gold);border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:8px;z-index:200;animation:slideD 0.3s,fadeO 0.3s 2.7s forwards}
    @keyframes slideD{from{transform:translateX(-50%) translateY(-50px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
    @keyframes fadeO{to{opacity:0}}
    .ach-i{font-size:22px}
    .ach-t{font-size:11px;font-weight:600;color:var(--gold)}
    .ach-d{font-size:9px;color:var(--text2)}

    /* Modal */
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:300;padding:16px}
    .modal{background:var(--card);border-radius:12px;padding:16px;max-width:340px;width:100%;max-height:80vh;overflow-y:auto}
    .modal-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .modal-t{font-family:'Playfair Display',serif;font-size:16px;color:var(--gold)}
    .modal-x{width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,0.06);border:none;color:var(--text2);font-size:13px;cursor:pointer}
    .set-r{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:12px}
    .tog{width:40px;height:22px;background:rgba(255,255,255,0.08);border-radius:11px;cursor:pointer;position:relative}
    .tog.on{background:var(--green)}
    .tog-k{width:16px;height:16px;background:#fff;border-radius:50%;position:absolute;top:3px;left:3px;transition:transform 0.2s}
    .tog.on .tog-k{transform:translateX(18px)}

    /* Payoff */
    .payoff{display:flex;flex-direction:column;gap:8px}
    .payoff-opt{display:flex;justify-content:space-between;align-items:center;background:var(--card2);padding:10px;border-radius:8px;cursor:pointer;border:1px solid transparent}
    .payoff-opt:hover{border-color:var(--gold)}
    .payoff-opt.dis{opacity:0.4;cursor:not-allowed}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const {useState,useEffect,useRef,useCallback} = React;

    // ==================== SOUND SYSTEM ====================
    class SFX {
      constructor(){this.ctx=null;this.on=true;this.music=true;this.loop=null}
      init(){if(!this.ctx)this.ctx=new(window.AudioContext||window.webkitAudioContext)()}
      t(f,d,ty='sine',g=0.18,dl=0){
        if(!this.ctx||!this.on)return;
        const o=this.ctx.createOscillator(),gn=this.ctx.createGain();
        o.type=ty;o.frequency.value=f;
        const st=this.ctx.currentTime+dl;
        gn.gain.setValueAtTime(0,st);gn.gain.linearRampToValueAtTime(g,st+0.01);gn.gain.exponentialRampToValueAtTime(0.001,st+d);
        o.connect(gn);gn.connect(this.ctx.destination);o.start(st);o.stop(st+d);
      }
      // Core sounds
      yes(){this.t(349,0.06);this.t(440,0.06,'sine',0.18,0.03);this.t(523,0.08,'sine',0.18,0.06)}
      no(){this.t(392,0.06);this.t(349,0.06,'sine',0.18,0.03);this.t(294,0.08,'sine',0.14,0.06)}
      draw(){this.t(800,0.02,'sine',0.08)}
      good(){[262,330,392,523].forEach((n,i)=>this.t(n,0.08,'sine',0.14,i*0.03))}
      bad(){this.t(330,0.08,'triangle',0.1);this.t(294,0.1,'triangle',0.1,0.06)}
      ach(){[262,330,392,523,659].forEach((n,i)=>this.t(n,0.08,'sine',0.1,i*0.04))}
      lvl(){this.t(262,0.15);this.t(330,0.15,'sine',0.15,0.12);this.t(392,0.2,'sine',0.15,0.24)}
      end(){this.t(392,0.2);this.t(349,0.2,'sine',0.1,0.15);this.t(294,0.25,'sine',0.08,0.3)}
      click(){this.t(600,0.015,'sine',0.05)}
      // New sounds
      marry(){this.t(523,0.12);this.t(659,0.12,'sine',0.12,0.08);this.t(784,0.15,'sine',0.12,0.16);this.t(1047,0.2,'sine',0.1,0.24)}
      baby(){this.t(784,0.1);this.t(880,0.1,'sine',0.1,0.05);this.t(1047,0.15,'sine',0.12,0.1)}
      money(){this.t(440,0.05);this.t(554,0.05,'sine',0.1,0.03);this.t(659,0.08,'sine',0.1,0.06)}
      debt(){this.t(220,0.15,'triangle',0.08);this.t(196,0.2,'triangle',0.06,0.1)}
      alert(){this.t(880,0.08);this.t(660,0.08,'square',0.06,0.06);this.t(880,0.08,'square',0.06,0.12)}
      whoosh(){for(let i=0;i<5;i++)this.t(200+i*100,0.03,'sine',0.02,i*0.01)}
      pop(){this.t(1200,0.03,'sine',0.06);this.t(800,0.02,'sine',0.04,0.02)}
      coin(){this.t(1318,0.05);this.t(1568,0.08,'sine',0.1,0.04)}
      sad(){this.t(294,0.2,'triangle',0.08);this.t(262,0.25,'triangle',0.06,0.15)}
      // Crime sounds
      crime(){this.t(200,0.1,'sawtooth',0.06);this.t(180,0.15,'sawtooth',0.05,0.08)}
      caught(){this.t(150,0.3,'square',0.1);this.t(100,0.4,'square',0.08,0.15);this.t(80,0.5,'square',0.06,0.3)}
      free(){this.t(262,0.1);this.t(330,0.1,'sine',0.12,0.08);this.t(392,0.12,'sine',0.12,0.16);this.t(523,0.15,'sine',0.1,0.24)}
      startM(){
        if(!this.ctx||!this.music||this.loop)return;
        const ch=[[131,165,196],[147,185,220],[165,208,247],[175,220,262]];
        const bs=[65,73,82,87,98];
        let ci=0,b=0;
        const tick=()=>{
          if(!this.music)return;
          this.t(bs[(b+ci)%bs.length],0.25,'triangle',0.03);
          if(b%2===1)ch[ci%ch.length].forEach(f=>this.t(f,0.15,'sine',0.02));
          b++;if(b>=8){b=0;ci=(ci+1)%ch.length}
        };
        tick();this.loop=setInterval(tick,200);
      }
      stopM(){if(this.loop){clearInterval(this.loop);this.loop=null}}
      togM(v){this.music=v;v?this.startM():this.stopM()}
      togS(v){this.on=v}
    }
    const sfx=new SFX();

    // ==================== PIXEL CHARACTERS ====================
    // Male and Female pixel art characters with different styles
    const CHAR_STYLES = {
      male: [
        {id:'m1',name:'Classic',hair:'#3d2314',skin:'#f5d0c5',shirt:'#3B82F6',pants:'#1e3a5f'},
        {id:'m2',name:'Cool',hair:'#1a1a1a',skin:'#e8beac',shirt:'#22C55E',pants:'#1a1a1a'},
        {id:'m3',name:'Blonde',hair:'#f4d03f',skin:'#f5d0c5',shirt:'#EF4444',pants:'#2d3748'},
        {id:'m4',name:'Red',hair:'#c0392b',skin:'#dbb89a',shirt:'#A855F7',pants:'#1e3a5f'},
        {id:'m5',name:'Silver',hair:'#95a5a6',skin:'#f5d0c5',shirt:'#D4AF37',pants:'#2d3748'},
        {id:'m6',name:'Brown',hair:'#5d4037',skin:'#c68642',shirt:'#14B8A6',pants:'#1a1a1a'},
        {id:'m7',name:'Dark',hair:'#2c1810',skin:'#8d5524',shirt:'#EC4899',pants:'#2d3748'},
        {id:'m8',name:'Fade',hair:'#1a1a1a',skin:'#a67c52',shirt:'#F97316',pants:'#1e3a5f'},
      ],
      female: [
        {id:'f1',name:'Classic',hair:'#3d2314',skin:'#f5d0c5',shirt:'#EC4899',pants:'#1e3a5f'},
        {id:'f2',name:'Blonde',hair:'#f4d03f',skin:'#f5d0c5',shirt:'#A855F7',pants:'#2d3748'},
        {id:'f3',name:'Red',hair:'#c0392b',skin:'#e8beac',shirt:'#22C55E',pants:'#1a1a1a'},
        {id:'f4',name:'Dark',hair:'#1a1a1a',skin:'#dbb89a',shirt:'#3B82F6',pants:'#1e3a5f'},
        {id:'f5',name:'Brown',hair:'#5d4037',skin:'#c68642',shirt:'#D4AF37',pants:'#2d3748'},
        {id:'f6',name:'Curly',hair:'#2c1810',skin:'#8d5524',shirt:'#EF4444',pants:'#1a1a1a'},
        {id:'f7',name:'Silver',hair:'#95a5a6',skin:'#f5d0c5',shirt:'#14B8A6',pants:'#1e3a5f'},
        {id:'f8',name:'Long',hair:'#1a1a1a',skin:'#a67c52',shirt:'#F97316',pants:'#2d3748'},
      ]
    };

    // Pixel Character Component using CSS
    const PixelChar = ({style, gender, size='md'}) => {
      const s = style || (gender === 'f' ? CHAR_STYLES.female[0] : CHAR_STYLES.male[0]);
      const scale = size === 'sm' ? 2 : size === 'md' ? 3 : size === 'lg' ? 5 : 7;
      
      // Simplified pixel art
      const isMale = gender === 'm';
      
      return (
        <div style={{
          width: scale * 12,
          height: scale * 16,
          background: 'var(--card2)',
          borderRadius: 4,
          border: '2px solid var(--gold)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          overflow: 'hidden',
          position: 'relative'
        }}>
          <svg width={scale * 10} height={scale * 14} viewBox="0 0 10 14" style={{imageRendering:'pixelated'}}>
            {/* Hair */}
            {isMale ? (
              <>
                <rect x="2" y="0" width="6" height="3" fill={s.hair}/>
                <rect x="1" y="1" width="1" height="2" fill={s.hair}/>
                <rect x="8" y="1" width="1" height="2" fill={s.hair}/>
              </>
            ) : (
              <>
                <rect x="2" y="0" width="6" height="3" fill={s.hair}/>
                <rect x="1" y="0" width="1" height="5" fill={s.hair}/>
                <rect x="8" y="0" width="1" height="5" fill={s.hair}/>
                <rect x="0" y="3" width="1" height="4" fill={s.hair}/>
                <rect x="9" y="3" width="1" height="4" fill={s.hair}/>
              </>
            )}
            {/* Face */}
            <rect x="2" y="2" width="6" height="5" fill={s.skin}/>
            {/* Eyes */}
            <rect x="3" y="4" width="1" height="1" fill="#1a1a1a"/>
            <rect x="6" y="4" width="1" height="1" fill="#1a1a1a"/>
            {/* Shirt */}
            <rect x="2" y="7" width="6" height="4" fill={s.shirt}/>
            <rect x="1" y="8" width="1" height="2" fill={s.shirt}/>
            <rect x="8" y="8" width="1" height="2" fill={s.shirt}/>
            {/* Pants */}
            <rect x="2" y="11" width="3" height="3" fill={s.pants}/>
            <rect x="5" y="11" width="3" height="3" fill={s.pants}/>
          </svg>
        </div>
      );
    };

    // Kid pixel character
    const PixelKid = ({gender, age}) => {
      const isBaby = age < 3;
      const isToddler = age >= 3 && age < 6;
      
      return (
        <div style={{
          width: 18,
          height: 24,
          background: 'var(--card2)',
          borderRadius: 3,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          overflow: 'hidden'
        }}>
          <svg width="14" height="18" viewBox="0 0 7 9" style={{imageRendering:'pixelated'}}>
            {isBaby ? (
              <>
                <rect x="1" y="1" width="5" height="4" fill="#f5d0c5"/>
                <rect x="2" y="2" width="1" height="1" fill="#1a1a1a"/>
                <rect x="4" y="2" width="1" height="1" fill="#1a1a1a"/>
                <rect x="1" y="5" width="5" height="3" fill="#fff"/>
              </>
            ) : (
              <>
                <rect x="1" y="0" width="5" height="2" fill={gender==='f'?'#5d4037':'#3d2314'}/>
                <rect x="1" y="1" width="5" height="3" fill="#f5d0c5"/>
                <rect x="2" y="2" width="1" height="1" fill="#1a1a1a"/>
                <rect x="4" y="2" width="1" height="1" fill="#1a1a1a"/>
                <rect x="1" y="4" width="5" height="3" fill={gender==='f'?'#EC4899':'#3B82F6'}/>
                <rect x="1" y="7" width="2" height="2" fill="#2d3748"/>
                <rect x="4" y="7" width="2" height="2" fill="#2d3748"/>
              </>
            )}
          </svg>
        </div>
      );
    };

    // ==================== CONSTANTS ====================
    const CAREERS=[
      {id:'trade',i:'üîß',n:'Trades',d:'Electrician, Plumber',startInc:3200,maxInc:7500,eduCost:12000,eduTime:2},
      {id:'biz',i:'üíº',n:'Business',d:'Sales, Management',startInc:3000,maxInc:12000,eduCost:50000,eduTime:4},
      {id:'tech',i:'üíª',n:'Tech',d:'Software, IT',startInc:4500,maxInc:15000,eduCost:60000,eduTime:4},
      {id:'health',i:'üè•',n:'Healthcare',d:'Nursing, Therapy',startInc:3800,maxInc:9000,eduCost:45000,eduTime:4},
      {id:'creative',i:'üé®',n:'Creative',d:'Design, Media',startInc:2500,maxInc:20000,eduCost:40000,eduTime:4},
      {id:'finance',i:'üìä',n:'Finance',d:'Banking, Investing',startInc:4000,maxInc:18000,eduCost:70000,eduTime:4},
    ];

    const ECON_PHASES=[
      {id:'boom',n:'Bull Market',col:'boom',invMult:1.015,jobRisk:0.02},
      {id:'stable',n:'Stable',col:'stable',invMult:1.005,jobRisk:0.05},
      {id:'recession',n:'Recession',col:'recession',invMult:0.985,jobRisk:0.12},
      {id:'recovery',n:'Recovery',col:'recovery',invMult:1.008,jobRisk:0.07},
    ];

    // ==================== DYNAMIC CARDS ====================
    const getCard = (st, char, econ) => {
      const cards = [];
      const {age, rel, kids, housing, foodStamps, section8, inJail, jailTime} = char;
      const poor = st.cash < 500 && st.income < 2500;
      const veryPoor = st.cash < 100 && st.income < 2000;

      // ===== JAIL CHECK - Skip normal cards if in jail =====
      if(inJail && jailTime > 0) {
        return {cat:'‚õìÔ∏è Jail',i:'üîí',t:'Behind Bars',d:`${jailTime} years remaining. Serve your time.`,jail:true,
          L:{t:'Serve Time',f:'-1 Year, -10 Happy',imp:{happy:-10},serveTime:true},
          R:{t:'Serve Time',f:'-1 Year, -10 Happy',imp:{happy:-10},serveTime:true}};
      }

      // ===== POVERTY CARDS =====
      if(veryPoor && !foodStamps) {
        cards.push({cat:'üèõÔ∏è Benefits',i:'üçé',t:'Food Stamps',d:'You qualify for SNAP benefits.',pov:true,
          L:{t:'Pride',f:'-10 Happy, -$200/mo food',imp:{happy:-10}},
          R:{t:'Apply',f:'+$300/mo saved, +5 Happy',imp:{income:300,happy:5},setFoodStamps:true}});
      }
      if(poor && housing === 'rent' && !section8) {
        cards.push({cat:'üèõÔ∏è Benefits',i:'üè†',t:'Section 8 Housing',d:'Housing assistance available.',pov:true,
          L:{t:'Decline',f:'No change',imp:{}},
          R:{t:'Apply',f:'+$600/mo saved',imp:{income:600},setSection8:true}});
      }
      if(veryPoor && Math.random() < 0.3) {
        cards.push({cat:'üí∞ Money',i:'üò∞',t:'Can\'t Make Rent',d:'Money is really tight this month.',pov:true,
          L:{t:'Ask Family',f:'+$500, -10 Happy',imp:{cash:500,happy:-10}},
          R:{t:'Payday Loan',f:'+$400 Cash, +$600 Debt',imp:{cash:400,debt:600}}});
      }

      // ===== JOB FAIR & TEMP STAFFING (Poverty) =====
      if(poor && st.income < 3000 && Math.random() < 0.2) {
        cards.push({cat:'üíº Work',i:'üé™',t:'Job Fair',d:'Free job fair at community center. Could find better work.',pov:true,
          L:{t:'Skip It',f:'No change',imp:{}},
          R:{t:'Attend',f:'+$300/mo, +8 Happy',imp:{income:300,happy:8}}});
      }
      if(poor && Math.random() < 0.18) {
        cards.push({cat:'üíº Work',i:'üè≠',t:'Temp Staffing Agency',d:'Labor Ready has immediate work. Long hours, cash today.',pov:true,
          L:{t:'Pass',f:'No change',imp:{}},
          R:{t:'Sign Up',f:'+$200/mo, -5 Health',imp:{income:200,health:-5}}});
      }
      if(veryPoor && Math.random() < 0.15) {
        cards.push({cat:'üíº Work',i:'üì¶',t:'Day Labor',d:'Moving company needs help. Cash under table.',pov:true,
          L:{t:'Too Tired',f:'-3 Happy',imp:{happy:-3}},
          R:{t:'Work',f:'+$150 Cash, -8 Health',imp:{cash:150,health:-8}}});
      }
      if(poor && Math.random() < 0.12) {
        cards.push({cat:'üíº Work',i:'üöö',t:'Warehouse Job',d:'Amazon warehouse hiring. Tough work but steady.',pov:true,
          L:{t:'Decline',f:'No change',imp:{}},
          R:{t:'Apply',f:'+$400/mo, -8 Health',imp:{income:400,health:-8}}});
      }

      // ===== CRIME OPPORTUNITIES (Risk/Reward) =====
      if(poor && Math.random() < 0.1) {
        cards.push({cat:'‚ö†Ô∏è Risk',i:'üí∞',t:'Quick Money',d:'Friend offers easy cash. Selling "stuff". Risky...',crime:true,
          L:{t:'Stay Clean',f:'+5 Happy',imp:{happy:5}},
          R:{t:'Do It',f:'Risk: +$800 or Jail',imp:{},doCrime:{reward:800,risk:0.25,time:2}}});
      }
      if(veryPoor && Math.random() < 0.12) {
        cards.push({cat:'‚ö†Ô∏è Risk',i:'üè™',t:'Desperate Times',d:'You could take from the register... No one would know.',crime:true,
          L:{t:'Stay Honest',f:'+3 Happy',imp:{happy:3}},
          R:{t:'Take It',f:'Risk: +$300 or Jail',imp:{},doCrime:{reward:300,risk:0.35,time:1}}});
      }
      if(st.debt > 20000 && Math.random() < 0.08) {
        cards.push({cat:'‚ö†Ô∏è Risk',i:'üí≥',t:'Fraud Scheme',d:'Someone offers to wipe your debt... illegally.',crime:true,
          L:{t:'Refuse',f:'No change',imp:{}},
          R:{t:'Do It',f:'Risk: -$15K Debt or Jail',imp:{},doCrime:{debtClear:15000,risk:0.4,time:3}}});
      }
      if(Math.random() < 0.05) {
        cards.push({cat:'‚ö†Ô∏è Risk',i:'üé∞',t:'Big Score',d:'Cousin has a "sure thing". High risk, high reward.',crime:true,
          L:{t:'Walk Away',f:'+3 Happy',imp:{happy:3}},
          R:{t:'All In',f:'Risk: +$5K or Jail',imp:{},doCrime:{reward:5000,risk:0.45,time:4}}});
      }

      // ===== CAREER =====
      if(Math.random() < 0.2 && !char.record) {
        cards.push({cat:'üíº Career',i:'üìà',t:'Promotion',d:'Management position available.',
          L:{t:'Stay Put',f:'+5 Happy',imp:{happy:5}},
          R:{t:'Take It',f:'+$500/mo, -5 Health',imp:{income:500,health:-5}}});
      }
      if(char.record && Math.random() < 0.15) {
        cards.push({cat:'üíº Career',i:'üìã',t:'Background Check',d:'New job requires background check. Your record...',
          L:{t:'Withdraw',f:'-8 Happy',imp:{happy:-8}},
          R:{t:'Be Honest',f:'50/50 chance',imp:{},bgCheck:true}});
      }
      if(st.income < 4000 && Math.random() < 0.25) {
        cards.push({cat:'üíº Career',i:'üåô',t:'Side Hustle',d:'Extra income opportunity.',
          L:{t:'Rest',f:'+5 Health',imp:{health:5}},
          R:{t:'Hustle',f:'+$400/mo, -8 Health',imp:{income:400,health:-8}}});
      }

      // ===== CREDIT =====
      if(st.credit < 680 && Math.random() < 0.2) {
        cards.push({cat:'üìä Credit',i:'üí≥',t:'Secured Card',d:'Build credit with deposit.',
          L:{t:'Decline',f:'No change',imp:{}},
          R:{t:'Get Card',f:'-$300, +25 Credit',imp:{cash:-300,credit:25}}});
      }
      if(Math.random() < 0.12) {
        cards.push({cat:'üìä Credit',i:'‚ö†Ô∏è',t:'Credit Error',d:'Found mistake on report.',
          L:{t:'Ignore',f:'-15 Credit',imp:{credit:-15}},
          R:{t:'Dispute',f:'+35 Credit',imp:{credit:35}}});
      }

      // ===== DEBT =====
      if(st.debt > 5000 && Math.random() < 0.2) {
        cards.push({cat:'üí≥ Debt',i:'üìâ',t:'Extra Payment',d:`Debt: ${fmt(st.debt)}. Pay extra?`,
          L:{t:'Minimum',f:'-5 Credit',imp:{credit:-5}},
          R:{t:'Pay $1,000',f:'-$1K, -$1K Debt, +15 Credit',imp:{cash:-1000,debt:-1000,credit:15}}});
      }

      // ===== INVESTMENTS =====
      if(st.cash > 2000 && Math.random() < 0.2) {
        cards.push({cat:'üìà Invest',i:'üìä',t:'Index Funds',d:'Diversified investment.',
          L:{t:'Keep Cash',f:'No change',imp:{}},
          R:{t:'Invest $1.5K',f:'-$1.5K, +$1.5K Invested',imp:{cash:-1500,invest:1500}}});
      }

      // ===== HEALTH =====
      if(st.health < 60 && Math.random() < 0.3) {
        cards.push({cat:'‚ù§Ô∏è Health',i:'üè•',t:'Doctor Visit',d:'You really should go.',
          L:{t:'Skip',f:'-15 Health',imp:{health:-15}},
          R:{t:'Go',f:'-$250, +20 Health',imp:{cash:-250,health:20}}});
      }
      if(st.happy < 50 && Math.random() < 0.25) {
        cards.push({cat:'‚ù§Ô∏è Health',i:'üß†',t:'Therapy',d:'Mental health matters.',
          L:{t:'Handle It',f:'-10 Happy',imp:{happy:-10}},
          R:{t:'Get Help',f:'-$200, +25 Happy',imp:{cash:-200,happy:25}}});
      }

      // ===== RELATIONSHIP =====
      if(rel === 'single' && age >= 21 && age <= 45 && Math.random() < 0.15) {
        cards.push({cat:'üíï Love',i:'üíç',t:'Someone Special',d:'You\'ve met someone amazing.',
          L:{t:'Stay Single',f:'+3 Happy',imp:{happy:3}},
          R:{t:'Get Engaged',f:'-$2K, +15 Happy',imp:{cash:-2000,happy:15},setRel:'engaged'}});
      }
      if(rel === 'engaged' && Math.random() < 0.4) {
        cards.push({cat:'üíï Love',i:'üíí',t:'Wedding Day',d:'Time to get married!',
          L:{t:'Wait',f:'-8 Happy',imp:{happy:-8}},
          R:{t:'Get Married',f:'-$12K, +30 Happy, +$1K/mo',imp:{cash:-12000,happy:30,income:1000},setRel:'married'}});
      }

      // ===== KIDS (MAJOR SYSTEM) =====
      if(rel === 'married' && kids.length < 5 && age >= 23 && age <= 42 && Math.random() < 0.12) {
        cards.push({cat:'üë∂ Family',i:'üë∂',t:'Have a Baby?',d:'Your family could grow.',kid:true,
          L:{t:'Not Now',f:'No change',imp:{}},
          R:{t:'Have Baby',f:'-$500, +25 Happy',imp:{cash:-500,happy:25},addKid:true}});
      }

      // Kid-specific events
      if(kids.length > 0) {
        const kidEvents = [];
        kids.forEach((k, i) => {
          if(k.age >= 5 && k.age <= 18 && !k.school && Math.random() < 0.2) {
            kidEvents.push({cat:'üë∂ Kids',i:'üéí',t:`${k.name}'s School`,d:`${k.name} is starting school.`,kid:true,
              L:{t:'Public',f:'+$0',imp:{},setKidSchool:{idx:i,type:'public'}},
              R:{t:'Private',f:'-$800/mo, +Investment',imp:{income:-800},setKidSchool:{idx:i,type:'private'}}});
          }
          if(k.age >= 6 && k.age <= 16 && Math.random() < 0.15) {
            kidEvents.push({cat:'üë∂ Kids',i:'‚öΩ',t:`${k.name}'s Activities`,d:`${k.name} wants to join activities.`,kid:true,
              L:{t:'Skip',f:'-5 Happy',imp:{happy:-5}},
              R:{t:'Sign Up',f:'-$200, +Kid Investment',imp:{cash:-200},investKid:{idx:i,amt:500}}});
          }
          if(k.age >= 14 && k.age <= 17 && Math.random() < 0.12) {
            kidEvents.push({cat:'üë∂ Kids',i:'üìö',t:`${k.name}'s Tutoring`,d:`${k.name} needs help with school.`,kid:true,
              L:{t:'DIY Help',f:'-3 Health',imp:{health:-3},investKid:{idx:i,amt:200}},
              R:{t:'Hire Tutor',f:'-$400, +Kid Investment',imp:{cash:-400},investKid:{idx:i,amt:1000}}});
          }
          if(k.age === 18 && !k.college && Math.random() < 0.5) {
            kidEvents.push({cat:'üë∂ Kids',i:'üéì',t:`${k.name}'s College`,d:`${k.name} got accepted!`,kid:true,
              L:{t:'They Pay',f:'-10 Happy',imp:{happy:-10},setKidCollege:{idx:i,paid:false}},
              R:{t:'You Pay',f:'-$40K, +20 Happy, +Major Investment',imp:{cash:-40000,happy:20},setKidCollege:{idx:i,paid:true},investKid:{idx:i,amt:20000}}});
          }
        });
        if(kidEvents.length > 0) cards.push(...kidEvents);
      }

      // ===== HOUSING =====
      if(housing === 'parents' && age >= 21 && Math.random() < 0.15) {
        cards.push({cat:'üè† Housing',i:'üè¢',t:'Move Out?',d:'Time for your own place?',
          L:{t:'Stay Home',f:'-5 Happy',imp:{happy:-5}},
          R:{t:'Get Apartment',f:'-$1,200/mo, +12 Happy',imp:{income:-1200,happy:12},setHousing:'rent'}});
      }
      if(housing === 'rent' && st.credit >= 660 && st.cash >= 25000 && Math.random() < 0.12) {
        cards.push({cat:'üè† Housing',i:'üè†',t:'Buy Home?',d:'You qualify for a mortgage!',
          L:{t:'Keep Renting',f:'No change',imp:{}},
          R:{t:'Buy',f:'-$25K, +$200K Debt, +$25K Equity',imp:{cash:-25000,debt:200000,invest:25000,happy:15},setHousing:'own'}});
      }

      // ===== LIFESTYLE =====
      if(st.happy < 50 && Math.random() < 0.2) {
        cards.push({cat:'üåü Life',i:'‚úàÔ∏è',t:'Vacation',d:'You need a break.',
          L:{t:'Staycation',f:'+8 Happy',imp:{happy:8}},
          R:{t:'Travel',f:'-$1.5K, +22 Happy',imp:{cash:-1500,happy:22}}});
      }

      // Default card
      if(cards.length === 0) {
        cards.push({cat:'üåü Life',i:'‚òÄÔ∏è',t:'Normal Day',d:'Nothing special today.',
          L:{t:'Relax',f:'+3 Happy',imp:{happy:3}},
          R:{t:'Work Extra',f:'+$100',imp:{cash:100}}});
      }

      return cards[Math.floor(Math.random() * cards.length)];
    };

    // ===== EVENTS =====
    const EVENTS = [
      {i:'üéâ',t:'Work Bonus!',d:'Great performance!',imp:{cash:2000},pos:true},
      {i:'üèÜ',t:'Promotion!',d:'Moving up!',imp:{income:350,happy:12},pos:true},
      {i:'üìà',t:'Market Up',d:'Investments grew!',imp:{invest:1500},pos:true},
      {i:'üí≥',t:'Cashback',d:'Rewards payout!',imp:{cash:250},pos:true},
      {i:'üéÅ',t:'Inheritance',d:'Family money.',imp:{cash:6000},pos:true},
      {i:'üè†',t:'Home Value Up',d:'Property appreciated!',imp:{invest:4000},pos:true},
      {i:'üò∑',t:'Got Sick',d:'Medical bills.',imp:{cash:-600,health:-12},pos:false},
      {i:'üöó',t:'Car Trouble',d:'Major repair.',imp:{cash:-900},pos:false},
      {i:'üìâ',t:'Market Crash',d:'Investments down.',imp:{invest:-2000},pos:false},
      {i:'üíî',t:'Family Emergency',d:'Need to help.',imp:{cash:-1500,happy:-8},pos:false},
      {i:'‚ö°',t:'Appliance Broke',d:'Replacement needed.',imp:{cash:-500},pos:false},
      {i:'üìû',t:'Debt Collector',d:'Stressful calls.',imp:{happy:-12,credit:-8},pos:false},
      {i:'üîì',t:'ID Theft',d:'Fraud on account.',imp:{cash:-400,credit:-20},pos:false},
    ];

    // Kid-specific events
    const KID_EVENTS = [
      {i:'üèÜ',t:'Kid Won Award!',d:'Your child excelled!',imp:{happy:15},pos:true},
      {i:'üì±',t:'Kid Needs Phone',d:'Everyone else has one.',imp:{cash:-300},pos:false},
      {i:'ü¶∑',t:'Kid Braces',d:'Orthodontist visit.',imp:{cash:-2000},pos:false},
      {i:'‚öΩ',t:'Kid Made Team!',d:'Athletic achievement!',imp:{happy:10,cash:-200},pos:true},
      {i:'üé®',t:'Kid\'s Talent',d:'Natural abilities showing!',imp:{happy:8},pos:true},
    ];

    // ===== ACHIEVEMENTS =====
    const ACHS = [
      {id:'10k',i:'üíµ',t:'$10K Saved',d:'Emergency fund!',ck:s=>s.cash>=10000},
      {id:'100k',i:'üí∞',t:'$100K Club',d:'Net worth milestone',ck:s=>nw(s)>=100000},
      {id:'1m',i:'üëë',t:'Millionaire',d:'You made it!',ck:s=>nw(s)>=1000000},
      {id:'cr750',i:'üìä',t:'Great Credit',d:'750+ score',ck:s=>s.credit>=750},
      {id:'df',i:'üéâ',t:'Debt Free',d:'Zero debt!',ck:s=>s.debt===0&&nw(s)>0},
      {id:'married',i:'üíí',t:'Married',d:'Found your partner',ck:(s,c)=>c.rel==='married'},
      {id:'parent',i:'üë∂',t:'Parent',d:'First child!',ck:(s,c)=>c.kids.length>=1},
      {id:'bigfam',i:'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',t:'Big Family',d:'3+ kids!',ck:(s,c)=>c.kids.length>=3},
      {id:'home',i:'üè†',t:'Homeowner',d:'Bought a home',ck:(s,c)=>c.housing==='own'},
      {id:'g3',i:'üè∞',t:'Dynasty',d:'Generation 3',ck:(s,c,g)=>g>=3},
    ];

    const fmt = n => {const a=Math.abs(n),s=n<0?'-':'';return a>=1e6?`${s}$${(a/1e6).toFixed(1)}M`:a>=1e3?`${s}$${(a/1e3).toFixed(1)}K`:`${s}$${Math.round(a)}`};
    const nw = s => s.cash + s.invest - s.debt;
    const clamp = (v, mn, mx) => Math.min(mx, Math.max(mn, v));

    // ==================== SAVE SYSTEM (ENHANCED) ====================
    const AUTOSAVE_KEY = 'kt_autosave';
    
    const generateCode = () => {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      return Array(8).fill().map(() => chars[Math.floor(Math.random() * chars.length)]).join('');
    };

    const saveGame = (data, isAuto = false) => {
      const code = data.saveCode || generateCode();
      const saveData = {...data, saveCode: code, savedAt: Date.now()};
      localStorage.setItem('kt_save_' + code, JSON.stringify(saveData));
      localStorage.setItem('kt_last_code', code);
      // Also save to autosave slot
      localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(saveData));
      return code;
    };

    const loadGame = (code) => {
      const data = localStorage.getItem('kt_save_' + code);
      return data ? JSON.parse(data) : null;
    };

    const loadAutosave = () => {
      const data = localStorage.getItem(AUTOSAVE_KEY);
      return data ? JSON.parse(data) : null;
    };

    const hasAutosave = () => {
      return localStorage.getItem(AUTOSAVE_KEY) !== null;
    };

    const getLastCode = () => localStorage.getItem('kt_last_code');
    
    const clearAutosave = () => {
      localStorage.removeItem(AUTOSAVE_KEY);
    };

    // ==================== MAIN GAME ====================
    function Game() {
      const [scr, setScr] = useState('title');
      const [step, setStep] = useState(0);
      const [firstName, setFirstName] = useState('');
      const [famName, setFamName] = useState('');
      const [gender, setGender] = useState('m');
      const [charStyle, setCharStyle] = useState(null);
      const [career, setCareer] = useState(null);
      const [loadCode, setLoadCode] = useState('');

      const [char, setChar] = useState(null);
      const [st, setSt] = useState(null);
      const [econ, setEcon] = useState(ECON_PHASES[1]);
      const [gen, setGen] = useState(1);
      const [hist, setHist] = useState([]);
      const [dynW, setDynW] = useState(0);
      const [achs, setAchs] = useState([]);
      const [saveCode, setSaveCode] = useState(null);
      const [hasAuto, setHasAuto] = useState(false);

      const [card, setCard] = useState(null);
      const [off, setOff] = useState(0);
      const [drag, setDrag] = useState(false);
      const [toast, setToast] = useState(null);
      const [ach, setAch] = useState(null);

      const [musicOn, setMusicOn] = useState(true);
      const [sfxOn, setSfxOn] = useState(true);
      const [modal, setModal] = useState(null);
      const [heirN, setHeirN] = useState('');
      const [heirG, setHeirG] = useState('m');
      const [heirStyle, setHeirStyle] = useState(null);
      const [heirC, setHeirC] = useState(null);

      const sx = useRef(0);
      const econTimer = useRef(0);

      useEffect(() => {
        const last = getLastCode();
        if(last) setLoadCode(last);
        // Check for autosave
        setHasAuto(hasAutosave());
      }, []);

      const init = useCallback(() => {
        sfx.init();
        if(musicOn) sfx.startM();
      }, [musicOn]);

      const checkAch = useCallback((state, character, g) => {
        ACHS.forEach(a => {
          if(!achs.includes(a.id) && a.ck(state, character, g)) {
            setAchs(p => [...p, a.id]);
            setAch(a);
            sfx.ach();
            setTimeout(() => setAch(null), 3000);
          }
        });
      }, [achs]);

      const doSave = () => {
        const code = saveGame({char, st, econ, gen, hist, dynW, achs, famName, saveCode});
        setSaveCode(code);
        sfx.coin();
        setToast({txt: 'Game Saved!', pos: true});
        setTimeout(() => setToast(null), 1500);
      };

      // Auto-save (called after each turn)
      const autoSave = () => {
        if(char && st) {
          saveGame({char, st, econ, gen, hist, dynW, achs, famName, saveCode}, true);
        }
      };

      // Draw card function - MUST be defined before functions that use it
      const drawCard = (currentSt, currentChar, currentEcon) => {
        sfx.draw();
        // Events
        if(Math.random() < 0.12) {
          // Kid events if has kids
          if(currentChar.kids && currentChar.kids.length > 0 && Math.random() < 0.3) {
            const evt = KID_EVENTS[Math.floor(Math.random() * KID_EVENTS.length)];
            setCard({...evt, ev: true, kid: true});
          } else {
            const evt = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            setCard({...evt, ev: true});
          }
        } else {
          setCard(getCard(currentSt, currentChar, currentEcon));
        }
        setOff(0);
      };

      const draw = () => {
        drawCard(st, char, econ);
      };

      // Quick continue from autosave
      const quickContinue = () => {
        const data = loadAutosave();
        if(data) {
          setChar(data.char);
          setSt(data.st);
          setEcon(data.econ || ECON_PHASES[1]);
          setGen(data.gen);
          setHist(data.hist);
          setDynW(data.dynW);
          setAchs(data.achs || []);
          setFamName(data.famName);
          setSaveCode(data.saveCode);
          init();
          setScr('game');
          setTimeout(() => drawCard(data.st, data.char, data.econ || ECON_PHASES[1]), 200);
          sfx.lvl();
        }
      };

      const doLoad = (code) => {
        const data = loadGame(code || loadCode);
        if(data) {
          setChar(data.char);
          setSt(data.st);
          setEcon(data.econ || ECON_PHASES[1]);
          setGen(data.gen);
          setHist(data.hist);
          setDynW(data.dynW);
          setAchs(data.achs || []);
          setFamName(data.famName);
          setSaveCode(data.saveCode);
          init();
          setScr('game');
          setTimeout(() => drawCard(data.st, data.char, data.econ || ECON_PHASES[1]), 200);
          sfx.lvl();
        } else {
          alert('Save not found!');
        }
      };

      const startGame = () => {
        if(!firstName || !famName || !career || !charStyle) return;
        init();
        sfx.click();

        const c = CAREERS.find(x => x.id === career);
        const style = CHAR_STYLES[gender].find(s => s.id === charStyle);
        
        setChar({
          name: firstName,
          gender,
          style,
          age: 18 + c.eduTime,
          career: c.id,
          rel: 'single',
          kids: [],
          housing: 'parents',
          foodStamps: false,
          section8: false,
          inJail: false,
          jailTime: 0,
          record: false,
        });
        setSt({
          cash: 500,
          income: c.startInc,
          debt: c.eduCost,
          invest: 0,
          credit: 620,
          health: 100,
          happy: 70,
        });
        setGen(1);
        setHist([]);
        setDynW(0);
        setAchs([]);
        setEcon(ECON_PHASES[1]);
        econTimer.current = 0;
        setSaveCode(null);
        setScr('game');
        
        // Draw first card with the new state values directly
        const newChar = {
          name: firstName,
          gender,
          style,
          age: 18 + c.eduTime,
          career: c.id,
          rel: 'single',
          kids: [],
          housing: 'parents',
          foodStamps: false,
          section8: false,
          inJail: false,
          jailTime: 0,
          record: false,
        };
        const newSt = {
          cash: 500,
          income: c.startInc,
          debt: c.eduCost,
          invest: 0,
          credit: 620,
          health: 100,
          happy: 70,
        };
        setTimeout(() => drawCard(newSt, newChar, ECON_PHASES[1]), 200);
      };

      const apply = (imp, extra = {}) => {
        setSt(p => {
          let nc = p.cash + (imp.cash || 0);
          let nd = Math.max(0, p.debt + (imp.debt || 0));
          let ni = p.income + (imp.income || 0);
          let nv = Math.max(0, p.invest + (imp.invest || 0));
          let ncr = p.credit + (imp.credit || 0);
          let nh = p.health + (imp.health || 0);
          let nhp = p.happy + (imp.happy || 0);

          if(nc < 0) { nd += Math.abs(nc); nc = 0; }
          if(nd > 10000) ncr -= 2;
          if(nd > 50000) ncr -= 3;
          if(nd > ni * 12) nhp -= 2;

          return {
            ...p,
            cash: nc,
            income: Math.max(0, ni),
            debt: nd,
            invest: nv,
            credit: clamp(ncr, 300, 850),
            health: clamp(nh, 0, 100),
            happy: clamp(nhp, 0, 100),
          };
        });

        // Character changes
        setChar(p => {
          let updated = {...p};
          if(extra.setRel) updated.rel = extra.setRel;
          if(extra.setHousing) updated.housing = extra.setHousing;
          if(extra.setFoodStamps) updated.foodStamps = true;
          if(extra.setSection8) updated.section8 = true;
          if(extra.goToJail) {
            updated.inJail = true;
            updated.jailTime = extra.goToJail;
            updated.record = true;
          }
          if(extra.serveTime) {
            updated.jailTime = Math.max(0, p.jailTime - 1);
            if(updated.jailTime <= 0) {
              updated.inJail = false;
            }
          }
          if(extra.addKid) {
            const names = ['Alex','Jordan','Taylor','Morgan','Casey','Riley','Quinn','Avery'];
            updated.kids = [...p.kids, {
              name: names[Math.floor(Math.random() * names.length)],
              gender: Math.random() > 0.5 ? 'm' : 'f',
              age: 0,
              invested: 0,
              school: null,
              college: null
            }];
          }
          if(extra.setKidSchool) {
            updated.kids = p.kids.map((k, i) => 
              i === extra.setKidSchool.idx ? {...k, school: extra.setKidSchool.type} : k
            );
          }
          if(extra.setKidCollege) {
            updated.kids = p.kids.map((k, i) => 
              i === extra.setKidCollege.idx ? {...k, college: extra.setKidCollege.paid ? 'paid' : 'loans'} : k
            );
          }
          if(extra.investKid) {
            updated.kids = p.kids.map((k, i) => 
              i === extra.investKid.idx ? {...k, invested: k.invested + extra.investKid.amt} : k
            );
          }
          return updated;
        });
      };

      const monthly = () => {
        setSt(p => {
          const interest = p.debt * 0.015;
          const housing = char.housing === 'rent' ? (char.section8 ? 600 : 1200) : char.housing === 'own' ? 1800 : 200;
          const food = char.foodStamps ? 0 : 400;
          const kidsCost = char.kids.reduce((sum, k) => {
            if(k.age < 5) return sum + 800; // Childcare
            if(k.school === 'private') return sum + 800;
            return sum + 200; // Basic kid costs
          }, 0);
          const living = 800 + housing + food + kidsCost;
          const net = p.income - living - interest;
          
          let nc = p.cash + net;
          let nd = p.debt;
          let nv = p.invest * econ.invMult;

          if(nc < 0) { nd += Math.abs(nc); nc = 0; }
          if(char.housing === 'own') nv += 150;

          return {...p, cash: nc, debt: nd, invest: nv};
        });

        // Age everyone
        setChar(p => ({
          ...p,
          age: p.age + 1,
          kids: p.kids.map(k => ({...k, age: k.age + 1}))
        }));

        // Economy cycle
        econTimer.current++;
        if(econTimer.current > 6 + Math.random() * 10) {
          econTimer.current = 0;
          const phases = ['boom', 'stable', 'recession', 'recovery'];
          const cur = phases.indexOf(econ.id);
          setEcon(ECON_PHASES[(cur + 1) % 4]);
        }
      };

      const swipe = dir => {
        if(!card) return;
        dir === 'right' ? sfx.yes() : sfx.no();

        let imp, txt, pos, extra = {};
        if(card.ev) {
          imp = card.imp;
          txt = card.t;
          pos = card.pos;
        } else {
          const ch = dir === 'left' ? card.L : card.R;
          imp = ch.imp;
          txt = ch.t;
          pos = (imp.cash > 0 || imp.income > 0 || imp.invest > 0 || imp.credit > 0);
          Object.keys(ch).forEach(k => {
            if(k.startsWith('set') || k === 'addKid' || k === 'investKid' || k === 'serveTime' || k === 'goToJail') extra[k] = ch[k];
          });
          
          // CRIME MECHANIC
          if(ch.doCrime) {
            sfx.crime();
            const caught = Math.random() < ch.doCrime.risk;
            if(caught) {
              // CAUGHT!
              sfx.caught();
              extra.goToJail = ch.doCrime.time;
              imp = {happy: -30, credit: -50, income: -st.income * 0.3}; // Lose job partially
              txt = 'üöî CAUGHT!';
              pos = false;
              setToast({txt: `ARRESTED! ${ch.doCrime.time} years in jail`, pos: false});
              setTimeout(() => setToast(null), 1500);
            } else {
              // GOT AWAY
              sfx.money();
              if(ch.doCrime.reward) {
                imp = {cash: ch.doCrime.reward, happy: 5};
              } else if(ch.doCrime.debtClear) {
                imp = {debt: -ch.doCrime.debtClear, happy: 10};
              }
              txt = 'Got away with it!';
              pos = true;
            }
          }
          
          // BACKGROUND CHECK (for people with records)
          if(ch.bgCheck) {
            const passed = Math.random() < 0.5;
            if(passed) {
              sfx.good();
              imp = {income: 400, happy: 15};
              txt = 'They hired you anyway!';
              pos = true;
            } else {
              sfx.sad();
              imp = {happy: -15};
              txt = 'Position filled...';
              pos = false;
            }
          }
        }

        apply(imp, extra);
        
        // Special sounds
        if(extra.setRel === 'married') sfx.marry();
        else if(extra.addKid) sfx.baby();
        else if(extra.serveTime && char.jailTime <= 1) sfx.free();
        else if(imp.cash > 1000) sfx.money();
        else if(imp.debt > 0) sfx.debt();
        else if(!card.crime) pos ? sfx.good() : sfx.bad();

        if(!card.crime) {
          setToast({txt, pos});
          setTimeout(() => setToast(null), 700);
        }

        // Don't process monthly if serving jail time (already passed in jail card)
        if(!extra.serveTime) {
          monthly();
        } else {
          // Just age up when serving time
          setChar(p => ({...p, age: p.age + 1, kids: p.kids.map(k => ({...k, age: k.age + 1}))}));
        }
        
        setTimeout(() => { checkAch(st, char, gen); check(); }, 150);
      };

      const check = () => {
        if(char.age >= 65) endGame('retire');
        else if(st.health <= 0) endGame('health');
        else if(nw(st) < -150000) endGame('broke');
        else {
          draw();
          // Auto-save after each turn
          setTimeout(autoSave, 100);
        }
      };

      const endGame = cause => {
        cause === 'retire' ? sfx.lvl() : sfx.end();
        const w = nw(st);
        
        // Kids bonus - invested kids help the heir!
        const kidBonus = char.kids.reduce((sum, k) => sum + k.invested, 0);
        const familySupport = char.kids.length * 200; // Each kid = $200/mo support for heir
        
        const inh = cause === 'broke' ? Math.floor(w * 0.1) : Math.floor(w * 0.6) + Math.floor(kidBonus * 0.5);
        
        setHist(p => [...p, {
          name: char.name,
          style: char.style,
          gender: char.gender,
          age: char.age,
          worth: w,
          career: char.career,
          rel: char.rel,
          kids: char.kids.length,
          kidBonus,
          familySupport,
          cause
        }]);
        setDynW(p => p + w);
        setSt(p => ({...p, inh, kidBonus, familySupport, wb: Math.floor((p.happy + p.health) / 8)}));

        if(gen >= 99 || (cause === 'broke' && w < -100000)) {
          setScr('end');
        } else {
          setHeirN('');
          setHeirG('m');
          setHeirStyle(null);
          setHeirC(null);
          setScr('trans');
        }
      };

      const nextGen = () => {
        if(!heirN || !heirC || !heirStyle) return;
        sfx.lvl();
        
        const inh = st.inh || 0;
        const wb = st.wb || 0;
        const famSupport = st.familySupport || 0;
        const c = CAREERS.find(x => x.id === heirC);
        const style = CHAR_STYLES[heirG].find(s => s.id === heirStyle);

        const newChar = {
          name: heirN,
          gender: heirG,
          style,
          age: 18 + c.eduTime,
          career: heirC,
          rel: 'single',
          kids: [],
          housing: 'parents',
          foodStamps: false,
          section8: false,
          inJail: false,
          jailTime: 0,
          record: false,
        };
        const newSt = {
          cash: Math.max(0, inh) + 500,
          income: c.startInc + Math.floor(wb * 15) + famSupport,
          debt: c.eduCost + (inh < 0 ? Math.abs(inh) * 0.3 : 0),
          invest: 0,
          credit: 620 + Math.floor(wb / 2),
          health: 100,
          happy: 70,
        };
        
        setChar(newChar);
        setSt(newSt);
        setGen(p => p + 1);
        setScr('game');
        setTimeout(() => drawCard(newSt, newChar, econ), 200);
      };

      const payDebt = amt => {
        if(st.cash < amt) return;
        sfx.money();
        setSt(p => ({
          ...p,
          cash: p.cash - amt,
          debt: Math.max(0, p.debt - amt),
          credit: clamp(p.credit + Math.floor(amt / 150), p.credit, 850)
        }));
        setModal(null);
      };

      const ds = x => { sx.current = x; setDrag(true) };
      const dm = x => { if(drag) setOff(x - sx.current) };
      const de = () => { setDrag(false); if(Math.abs(off) > 50) swipe(off < 0 ? 'left' : 'right'); setOff(0) };
      const togM = () => { const v = !musicOn; setMusicOn(v); sfx.togM(v) };
      const togS = () => { const v = !sfxOn; setSfxOn(v); sfx.togS(v) };

      const netW = st ? nw(st) : 0;

      return (
        <div className="app">
          {ach && <div className="ach"><div className="ach-i">{ach.i}</div><div><div className="ach-t">{ach.t}</div><div className="ach-d">{ach.d}</div></div></div>}
          {toast && <div className={`toast ${toast.pos ? 'g' : 'r'}`}><div className="toast-i">{toast.pos ? '‚úì' : '‚úï'}</div><div className="toast-t">{toast.txt}</div></div>}

          {/* Modals */}
          {modal === 'settings' && (
            <div className="modal-bg" onClick={() => setModal(null)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-h"><div className="modal-t">Settings</div><button className="modal-x" onClick={() => setModal(null)}>√ó</button></div>
                <div className="set-r"><span>üéµ Music</span><div className={`tog ${musicOn ? 'on' : ''}`} onClick={togM}><div className="tog-k"/></div></div>
                <div className="set-r"><span>üîä Sound</span><div className={`tog ${sfxOn ? 'on' : ''}`} onClick={togS}><div className="tog-k"/></div></div>
                
                <div style={{marginTop:16,padding:12,background:'var(--card2)',borderRadius:8}}>
                  <div style={{fontSize:10,color:'var(--text2)',marginBottom:8,textAlign:'center'}}>üíæ YOUR SAVE CODE</div>
                  {saveCode ? (
                    <>
                      <div className="save-code">
                        <span>{saveCode}</span>
                      </div>
                      <button className="btn sm full" style={{marginTop:8}} onClick={() => {
                        navigator.clipboard.writeText(saveCode);
                        setToast({txt:'Code Copied!', pos:true});
                        setTimeout(() => setToast(null), 1000);
                      }}>üìã Copy Code</button>
                    </>
                  ) : (
                    <button className="btn full" onClick={doSave}>Generate Save Code</button>
                  )}
                  <div style={{fontSize:8,color:'var(--text2)',marginTop:8,textAlign:'center'}}>
                    ‚úÖ Game auto-saves after every turn!<br/>
                    Save code lets you play on other devices.
                  </div>
                </div>
              </div>
            </div>
          )}

          {modal === 'payoff' && st && (
            <div className="modal-bg" onClick={() => setModal(null)}>
              <div className="modal" onClick={e => e.stopPropagation()}>
                <div className="modal-h"><div className="modal-t">Pay Off Debt</div><button className="modal-x" onClick={() => setModal(null)}>√ó</button></div>
                <p style={{fontSize:11,color:'var(--text2)',marginBottom:12}}>Debt: {fmt(st.debt)} | Cash: {fmt(st.cash)}</p>
                <div className="payoff">
                  {[500, 1000, 2500, 5000, 10000].map(amt => (
                    <div key={amt} className={`payoff-opt ${st.cash < amt || st.debt < amt ? 'dis' : ''}`} 
                         onClick={() => st.cash >= amt && st.debt >= amt && payDebt(amt)}>
                      <span>Pay {fmt(amt)}</span>
                      <span style={{color:'var(--green)'}}>+{Math.floor(amt/150)} Credit</span>
                    </div>
                  ))}
                  {st.cash >= st.debt && st.debt > 0 && (
                    <div className="payoff-opt" onClick={() => payDebt(st.debt)} style={{borderColor:'var(--green)'}}>
                      <span>Pay All ({fmt(st.debt)})</span>
                      <span style={{color:'var(--green)'}}>üéâ DEBT FREE</span>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* ===== TITLE ===== */}
          {scr === 'title' && (
            <div className="title">
              <div className="t-crown">üëë</div>
              <div className="t-logo">KNIGHT TYCOON</div>
              <div className="t-sub">DYNASTY EDITION</div>
              <div className="t-tag">Build generational wealth. Start a family. Leave a legacy.</div>
              <div className="ver" style={{marginBottom:16}}>V3.2</div>
              
              {/* BIG CONTINUE BUTTON if autosave exists */}
              {hasAuto && (
                <button className="btn" onClick={() => { init(); sfx.click(); quickContinue() }} style={{marginBottom:12,width:'100%',maxWidth:300,padding:'16px 28px',fontSize:15}}>
                  ‚ñ∂Ô∏è Continue Game
                </button>
              )}
              
              <div className="howto">
                <h3>Features</h3>
                <div className="howto-i"><div className="howto-ic">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>Have kids & invest in their future</div>
                <div className="howto-i"><div className="howto-ic">üçé</div>Food stamps, Section 8, job fairs</div>
                <div className="howto-i"><div className="howto-ic">‚ö†Ô∏è</div>Crime risk - get rich or go to jail</div>
                <div className="howto-i"><div className="howto-ic">üíæ</div>Auto-saves your progress!</div>
                <div className="howto-i"><div className="howto-ic">‚ôæÔ∏è</div>Unlimited generations</div>
              </div>
              
              <button className="btn sec" onClick={() => { init(); sfx.click(); clearAutosave(); setScr('setup'); setStep(0) }} style={{marginBottom:12}}>
                {hasAuto ? 'New Game' : 'Start New Dynasty'}
              </button>
              
              <div className="login-box" style={{marginTop:8}}>
                <h3>üîë Load with Save Code</h3>
                <input className="inp" value={loadCode} onChange={e => setLoadCode(e.target.value.toUpperCase())} placeholder="Enter 8-letter code" maxLength={8} style={{textAlign:'center',letterSpacing:2}}/>
                <button className="btn sec full" style={{marginTop:8}} onClick={() => doLoad()} disabled={loadCode.length < 8}>Load Save</button>
              </div>
            </div>
          )}

          {/* ===== SETUP ===== */}
          {scr === 'setup' && (
            <>
              <div className="hdr">
                <div className="logo">Create Character</div>
                <button className="ibtn" onClick={() => step > 0 ? setStep(step - 1) : setScr('title')}>‚Üê</button>
              </div>
              <div className="scroll">
                {step === 0 && (
                  <>
                    <div className="fgrp"><label className="flbl">First Name</label><input className="inp" value={firstName} onChange={e => setFirstName(e.target.value)} placeholder="Your name" maxLength={12}/></div>
                    <div className="fgrp"><label className="flbl">Family Name</label><input className="inp" value={famName} onChange={e => setFamName(e.target.value)} placeholder="Dynasty name" maxLength={12}/></div>
                    <div className="fgrp"><label className="flbl">Gender</label>
                      <div className="opts g2">
                        <div className={`opt ${gender==='m'?'sel':''}`} onClick={() => { sfx.click(); setGender('m'); setCharStyle(null) }}><div className="opt-i">üë®</div><div className="opt-t">Male</div></div>
                        <div className={`opt ${gender==='f'?'sel':''}`} onClick={() => { sfx.click(); setGender('f'); setCharStyle(null) }}><div className="opt-i">üë©</div><div className="opt-t">Female</div></div>
                      </div>
                    </div>
                    <div className="fgrp"><label className="flbl">Choose Character</label>
                      <div className="char-select">
                        {CHAR_STYLES[gender].map(s => (
                          <div key={s.id} className={`char-opt ${charStyle === s.id ? 'sel' : ''}`} onClick={() => { sfx.pop(); setCharStyle(s.id) }}>
                            <PixelChar style={s} gender={gender} size="md"/>
                            <div style={{fontSize:8,marginTop:4,color:'var(--text2)'}}>{s.name}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                    <button className="btn full" onClick={() => { sfx.click(); setStep(1) }} disabled={!firstName || !famName || !charStyle}>Next ‚Üí</button>
                  </>
                )}
                {step === 1 && (
                  <>
                    <div className="fgrp"><label className="flbl">Career Path</label>
                      <div className="opts g2">
                        {CAREERS.map(c => (
                          <div key={c.id} className={`opt ${career===c.id?'sel':''}`} onClick={() => { sfx.click(); setCareer(c.id) }}>
                            <div className="opt-i">{c.i}</div>
                            <div className="opt-t">{c.n}</div>
                            <div className="opt-d">{c.d}</div>
                            <div style={{fontSize:8,marginTop:4,color:'var(--gold)'}}>${c.startInc.toLocaleString()}/mo</div>
                            <div style={{fontSize:7,color:'var(--text2)'}}>{c.eduTime}yr ‚Ä¢ {fmt(c.eduCost)} debt</div>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="preview">
                      <PixelChar style={CHAR_STYLES[gender].find(s => s.id === charStyle)} gender={gender} size="lg"/>
                      <div className="prev-n">{firstName} {famName}</div>
                      <div className="prev-s">{career ? CAREERS.find(c=>c.id===career)?.n : 'Choose career'}</div>
                    </div>
                    <button className="btn full" onClick={startGame} disabled={!career}>Start Journey ‚Üí</button>
                  </>
                )}
              </div>
            </>
          )}

          {/* ===== GAME ===== */}
          {scr === 'game' && char && st && (
            <>
              <div className="hdr">
                <div className="logo">Knight Tycoon</div>
                <div className="hdr-r">
                  <span style={{fontSize:8,color:'var(--green)',marginRight:4}}>‚úì Saved</span>
                  <button className={`ibtn ${musicOn?'on':''}`} onClick={togM}>{musicOn?'üéµ':'üîá'}</button>
                  <button className="ibtn" onClick={() => setModal('settings')}>‚öôÔ∏è</button>
                </div>
              </div>

              <div className="cbar">
                <PixelChar style={char.style} gender={char.gender} size="sm"/>
                <div className="cinfo">
                  <div className="cname">{char.name} {famName}</div>
                  <div className="cmeta">
                    <span>Age {char.age}</span>
                    <span>{char.rel === 'married' ? 'üíç' : char.rel === 'engaged' ? 'üíï' : ''}</span>
                    <span>{CAREERS.find(c=>c.id===char.career)?.i}</span>
                  </div>
                </div>
                <div className="gbadge">Gen {gen}</div>
              </div>

              {/* Benefits */}
              {(char.foodStamps || char.section8 || char.rel === 'married' || char.kids.length > 0 || char.record) && (
                <div className="benefits">
                  {char.foodStamps && <div className="benefit food">üçé SNAP</div>}
                  {char.section8 && <div className="benefit s8">üè† Section 8</div>}
                  {char.rel === 'married' && <div className="benefit married">üíç Married</div>}
                  {char.kids.length > 0 && <div className="benefit kids">üë∂ {char.kids.length} Kid{char.kids.length>1?'s':''}</div>}
                  {char.record && !char.inJail && <div className="benefit" style={{background:'rgba(100,100,100,0.15)',color:'#888',border:'1px solid rgba(100,100,100,0.3)'}}>üìã Record</div>}
                </div>
              )}

              {/* Jail Status */}
              {char.inJail && (
                <div className="jail-bar">
                  <div className="jail-icon">‚õìÔ∏è</div>
                  <div className="jail-info">Currently Incarcerated</div>
                  <div className="jail-time">{char.jailTime} yr{char.jailTime>1?'s':''} left</div>
                </div>
              )}

              {/* Kids Bar */}
              {char.kids.length > 0 && (
                <div className="fambar">
                  <div className="fambar-h">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</div>
                  <div className="fambar-kids">
                    {char.kids.map((k, i) => (
                      <div key={i} className="kid-chip">
                        <PixelKid gender={k.gender} age={k.age}/>
                        <span>{k.name}, {k.age}</span>
                        <span className="kid-invested">${Math.floor(k.invested/1000)}K inv</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div className="econ">
                <div className="econ-phase"><div className={`econ-dot ${econ.col}`}/><span>{econ.n}</span></div>
                <span style={{color:'var(--gold)',fontWeight:600}}>${st.income.toLocaleString()}/mo</span>
              </div>

              <div className="stats">
                <div className="stat"><div className="stat-i">üíµ</div><div className={`stat-v ${st.cash>=0?'':'r'}`}>{fmt(st.cash)}</div><div className="stat-l">Cash</div></div>
                <div className="stat"><div className="stat-i">üìà</div><div className="stat-v g">{fmt(st.invest)}</div><div className="stat-l">Invested</div></div>
                <div className="stat" onClick={() => st.debt > 0 && setModal('payoff')}>
                  <div className="stat-i">üí≥</div><div className={`stat-v ${st.debt>0?'r':''}`}>{fmt(st.debt)}</div>
                  <div className="stat-l">{st.debt > 0 ? '‚Üì Tap to Pay' : 'Debt'}</div>
                </div>
              </div>
              <div className="stats">
                <div className="stat">
                  <div className="stat-i">üìä</div><div className="stat-v">{st.credit}</div><div className="stat-l">Credit</div>
                  <div className="stat-bar"><div className="stat-fill" style={{width:`${((st.credit-300)/550)*100}%`,background:'linear-gradient(90deg,#EF4444,#D4AF37,#22C55E)'}}/></div>
                </div>
                <div className="stat"><div className="stat-i">‚ù§Ô∏è</div><div className={`stat-v ${st.health<30?'r':''}`}>{st.health}%</div><div className="stat-l">Health</div></div>
                <div className="stat"><div className="stat-i">üòä</div><div className="stat-v">{st.happy}%</div><div className="stat-l">Happy</div></div>
              </div>

              {hist.length > 0 && (
                <div className="tree">
                  <div className="tree-h"><span>Dynasty</span><span className="tree-v">{fmt(dynW)}</span></div>
                  <div className="tree-r">
                    {hist.slice(-3).map((m, i) => (
                      <React.Fragment key={i}>
                        <div className="tree-m"><PixelChar style={m.style} gender={m.gender} size="sm"/></div>
                        <div className="tree-ln"/>
                      </React.Fragment>
                    ))}
                    <div className="tree-m now"><PixelChar style={char.style} gender={char.gender} size="sm"/></div>
                  </div>
                </div>
              )}

              <div className="card-area">
                {card && (
                  <div className={`scard ${card.ev?'evt':''} ${card.kid?'kid':''} ${card.pov?'pov':''} ${card.crime?'crime':''} ${card.jail?'jail':''} ${off<-15?'sl':''} ${off>15?'sr':''}`}
                    style={{transform:`translateX(${off}px) rotate(${off*0.02}deg)`,transition:drag?'none':'transform 0.2s'}}
                    onMouseDown={e => ds(e.clientX)} onMouseMove={e => dm(e.clientX)} onMouseUp={de} onMouseLeave={() => drag && de()}
                    onTouchStart={e => ds(e.touches[0].clientX)} onTouchMove={e => dm(e.touches[0].clientX)} onTouchEnd={de}
                  >
                    {card.cat && <div className="card-cat">{card.cat}</div>}
                    <div className="card-icon">{card.i}</div>
                    <div className="card-title">{card.t}</div>
                    <div className="card-desc">{card.d}</div>
                    {card.ev ? (
                      <div className="evt-fx">
                        {Object.entries(card.imp).map(([k,v]) => (
                          <span key={k} className={`fx ${v>0?'g':'r'}`}>
                            {k==='cash' && `${v>0?'+':''}${fmt(v)}`}
                            {k==='invest' && `${v>0?'+':''}${fmt(v)} inv`}
                            {k==='income' && `${v>0?'+':''}$${v}/mo`}
                            {k==='credit' && `${v>0?'+':''}${v} cr`}
                            {k==='health' && `${v>0?'+':''}${v} hp`}
                            {k==='happy' && `${v>0?'+':''}${v} üòä`}
                          </span>
                        ))}
                      </div>
                    ) : (
                      <div className="choices">
                        <div className="choice l"><span className="ch-arr">‚Üê</span>{card.L.t}<div className="ch-fx">{card.L.f}</div></div>
                        <div className="choice r"><span className="ch-arr">‚Üí</span>{card.R.t}<div className="ch-fx">{card.R.f}</div></div>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {card && !card.ev && !card.jail && <div className="acts"><button className="abtn no" onClick={() => swipe('left')}>‚úï</button><button className="abtn yes" onClick={() => swipe('right')}>‚úì</button></div>}
              {card?.ev && <div className="acts"><button className="btn" onClick={() => swipe('right')}>Continue</button></div>}
              {card?.jail && <div className="acts"><button className="btn" onClick={() => swipe('right')} style={{background:'#666'}}>Serve Time</button></div>}
            </>
          )}

          {/* ===== TRANSITION ===== */}
          {scr === 'trans' && char && (
            <div className="scr">
              <div className="scr-i">{char.age >= 65 ? 'üåÖ' : 'üí´'}</div>
              <div className="scr-t">{char.age >= 65 ? 'Retirement' : 'End of Era'}</div>
              <div className="scr-s">{char.name} {famName} ‚Ä¢ Age {char.age}</div>
              <PixelChar style={char.style} gender={char.gender} size="lg"/>

              <div className="box">
                <div className="box-t">Estate</div>
                <div className="box-r"><span>Net Worth</span><span style={{color:netW>=0?'var(--green)':'var(--red)'}}>{fmt(netW)}</span></div>
                <div className="box-r"><span>Kids Raised</span><span>{char.kids.length}</span></div>
                <div className="box-r"><span>Kid Investments</span><span style={{color:'var(--purple)'}}>{fmt(st.kidBonus || 0)}</span></div>
                <div className="box-r"><span>Family Support</span><span style={{color:'var(--green)'}}>+${st.familySupport || 0}/mo</span></div>
                <div className="box-r hl"><span>Inheritance</span><span>{fmt(st.inh || 0)}</span></div>
              </div>

              <div className="fgrp"><label className="flbl">Heir's Name</label><input className="inp" value={heirN} onChange={e => setHeirN(e.target.value)} placeholder="Next generation" maxLength={12}/></div>
              
              <div className="fgrp"><label className="flbl">Heir's Gender</label>
                <div className="opts g2">
                  <div className={`opt ${heirG==='m'?'sel':''}`} onClick={() => { sfx.click(); setHeirG('m'); setHeirStyle(null) }}><div className="opt-i">üë®</div><div className="opt-t">Male</div></div>
                  <div className={`opt ${heirG==='f'?'sel':''}`} onClick={() => { sfx.click(); setHeirG('f'); setHeirStyle(null) }}><div className="opt-i">üë©</div><div className="opt-t">Female</div></div>
                </div>
              </div>

              <div className="fgrp"><label className="flbl">Heir's Look</label>
                <div className="char-select">
                  {CHAR_STYLES[heirG].map(s => (
                    <div key={s.id} className={`char-opt ${heirStyle === s.id ? 'sel' : ''}`} onClick={() => { sfx.pop(); setHeirStyle(s.id) }}>
                      <PixelChar style={s} gender={heirG} size="sm"/>
                    </div>
                  ))}
                </div>
              </div>

              <div className="fgrp"><label className="flbl">Heir's Career</label>
                <div className="opts g3">
                  {CAREERS.map(c => (
                    <div key={c.id} className={`opt ${heirC===c.id?'sel':''}`} onClick={() => { sfx.click(); setHeirC(c.id) }}>
                      <div className="opt-i">{c.i}</div>
                      <div className="opt-t">{c.n}</div>
                    </div>
                  ))}
                </div>
              </div>

              <button className="btn" onClick={nextGen} disabled={!heirN || !heirC || !heirStyle}>Continue as {heirN || 'Heir'} ‚Üí</button>
            </div>
          )}

          {/* ===== END ===== */}
          {scr === 'end' && (
            <div className="scr">
              <div className="scr-i">üëë</div>
              <div className="scr-t">The {famName} Dynasty</div>
              <div className="scr-s">{gen} Generations</div>
              
              <div className="dsum">
                {hist.map((m, i) => (
                  <div key={i} className="dmem">
                    <PixelChar style={m.style} gender={m.gender} size="sm"/>
                    <div className="dmem-i">
                      <div className="dmem-n">{m.name}</div>
                      <div className="dmem-m">Gen {i+1} ‚Ä¢ {m.kids} kids ‚Ä¢ {CAREERS.find(c=>c.id===m.career)?.i}</div>
                    </div>
                    <div className="dmem-w" style={{color:m.worth>=0?'var(--green)':'var(--red)'}}>{fmt(m.worth)}</div>
                  </div>
                ))}
                <div className="dtot"><span className="dtot-l">Legacy</span><span className="dtot-v">{fmt(dynW)}</span></div>
              </div>

              <div style={{display:'flex',gap:8,marginTop:14}}>
                <button className="btn sec" onClick={() => { sfx.click(); setScr('title') }}>New Game</button>
                <button className="btn" onClick={() => {
                  const t = `üëë ${famName} Dynasty\n${gen} generations\nüí∞ ${fmt(dynW)} legacy\n\nKnight Tycoon 3.2`;
                  navigator.share ? navigator.share({text:t}) : (navigator.clipboard.writeText(t), alert('Copied!'));
                }}>Share üì§</button>
              </div>

              <div className="promo">
                <div className="promo-b">BUILD REAL WEALTH</div>
                <div className="promo-t">Knight Financial</div>
                <div className="promo-d">Master your credit & finances IRL</div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<Game/>, document.getElementById('root'));
  </script>
</body>
</html>
