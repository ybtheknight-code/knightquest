<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Knight Tycoon V5.0 ‚Äî Ultimate Edition</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ============================================
   KNIGHT TYCOON V5.0 - ULTIMATE EDITION
   Beautiful, Addictive, Bulletproof
============================================ */

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { height:100%; overflow:hidden; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, #0a0a12 0%, #1a1a2e 50%, #0a0a12 100%);
  color: #fff;
  line-height: 1.4;
}
#root { height: 100%; }

:root {
  --gold: #F6C343;
  --gold-dark: #D4A030;
  --gold-light: #FFD970;
  --bg: #0a0a12;
  --card: #16162a;
  --card-hover: #1e1e3a;
  --card-border: rgba(246, 195, 67, 0.15);
  --text: #FFFFFF;
  --text-muted: rgba(255,255,255,0.7);
  --text-dim: rgba(255,255,255,0.4);
  --green: #10B981;
  --green-bg: rgba(16,185,129,0.15);
  --red: #EF4444;
  --red-bg: rgba(239,68,68,0.15);
  --blue: #3B82F6;
  --blue-bg: rgba(59,130,246,0.15);
  --purple: #8B5CF6;
  --purple-bg: rgba(139,92,246,0.15);
  --pink: #EC4899;
  --yellow: #FBBF24;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-gold: 0 4px 24px rgba(246,195,67,0.2);
  --radius: 16px;
  --radius-sm: 10px;
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 4px; }

/* App Container */
.app {
  max-width: 440px;
  margin: 0 auto;
  height: 100%;
  display: flex;
  flex-direction: column;
  padding: 12px;
  gap: 10px;
  position: relative;
  overflow: hidden;
}

.scroll {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding-bottom: 20px;
  -webkit-overflow-scrolling: touch;
}

/* ============ HEADER ============ */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid var(--card-border);
}
.logo {
  font-size: 18px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--gold-light), var(--gold-dark));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
}
.header-actions {
  display: flex;
  gap: 6px;
}
.icon-btn {
  width: 38px;
  height: 38px;
  border-radius: var(--radius-sm);
  background: var(--card);
  border: 1px solid var(--card-border);
  color: var(--text-muted);
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.icon-btn:hover, .icon-btn:active {
  background: var(--card-hover);
  color: var(--gold);
  border-color: var(--gold);
}
.icon-btn.active {
  background: var(--gold);
  color: var(--bg);
  border-color: var(--gold);
}
.version {
  font-size: 9px;
  color: var(--text-dim);
  background: var(--card);
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 600;
}

/* ============ BUTTONS ============ */
.btn {
  padding: 14px 24px;
  border-radius: var(--radius);
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.btn-primary {
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  color: #000;
  box-shadow: var(--shadow-gold);
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(246,195,67,0.35); }
.btn-primary:active { transform: translateY(0); }

.btn-secondary {
  background: transparent;
  border: 2px solid var(--gold);
  color: var(--gold);
}
.btn-secondary:hover { background: rgba(246,195,67,0.1); }

.btn-ghost {
  background: var(--card);
  border: 1px solid var(--card-border);
  color: var(--text-muted);
}
.btn-ghost:hover { background: var(--card-hover); color: var(--text); }

.btn-danger {
  background: var(--red-bg);
  border: 1px solid var(--red);
  color: var(--red);
}

.btn-sm { padding: 10px 16px; font-size: 12px; }
.btn-full { width: 100%; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* ============ CARDS ============ */
.card {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
}
.card-glow {
  background: linear-gradient(135deg, var(--card) 0%, rgba(246,195,67,0.05) 100%);
  border-color: rgba(246,195,67,0.25);
}

/* ============ TITLE SCREEN ============ */
.title-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  text-align: center;
  gap: 20px;
  padding: 20px;
}
.title-crown {
  font-size: 64px;
  animation: float 3s ease-in-out infinite;
}
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
.title-main {
  font-size: 32px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--gold-light), var(--gold), var(--gold-dark));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -1px;
}
.title-sub {
  font-size: 14px;
  color: var(--text-muted);
  font-weight: 500;
  letter-spacing: 2px;
  text-transform: uppercase;
}
.title-features {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin: 16px 0;
}
.title-feature {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--text-muted);
}
.title-feature-icon {
  width: 32px;
  height: 32px;
  background: var(--card);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}
.title-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 100%;
  max-width: 280px;
}

/* ============ SETUP SCREEN ============ */
.setup-step {
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.setup-title {
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 4px;
}
.setup-subtitle {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 16px;
}
.form-group {
  margin-bottom: 16px;
}
.form-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
  display: block;
}
.form-input {
  width: 100%;
  padding: 14px 16px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--card-border);
  background: rgba(255,255,255,0.05);
  color: var(--text);
  font-size: 15px;
  font-weight: 500;
  outline: none;
  transition: all 0.2s;
}
.form-input:focus {
  border-color: var(--gold);
  background: rgba(246,195,67,0.05);
}
.form-input::placeholder { color: var(--text-dim); }

/* Option Grid */
.option-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}
.option-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
.option-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }

.option {
  background: var(--card);
  border: 2px solid transparent;
  border-radius: var(--radius-sm);
  padding: 14px 10px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}
.option:hover { background: var(--card-hover); }
.option.selected {
  border-color: var(--gold);
  background: rgba(246,195,67,0.1);
}
.option-icon { font-size: 24px; margin-bottom: 6px; }
.option-title { font-size: 13px; font-weight: 700; }
.option-desc { font-size: 10px; color: var(--text-dim); margin-top: 4px; }

/* Character Grid */
.char-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}
.char-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px 6px;
  background: var(--card);
  border: 2px solid transparent;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s;
}
.char-option:hover { background: var(--card-hover); }
.char-option.selected {
  border-color: var(--gold);
  background: rgba(246,195,67,0.1);
}
.char-name { font-size: 9px; color: var(--text-muted); margin-top: 6px; }

/* ============ PIXEL CHARACTER ============ */
.pixel-char {
  image-rendering: pixelated;
  border-radius: 6px;
  background: rgba(0,0,0,0.3);
  border: 2px solid var(--gold-dark);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
.pixel-char.sm { width: 32px; height: 42px; border-width: 1px; }
.pixel-char.md { width: 48px; height: 64px; }
.pixel-char.lg { width: 72px; height: 96px; border-width: 3px; }
.pixel-char.xl { width: 96px; height: 128px; border-width: 3px; }

/* ============ GAME SCREEN ============ */
.player-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--card);
  border-radius: var(--radius);
  border: 1px solid var(--card-border);
}
.player-info { flex: 1; min-width: 0; }
.player-name {
  font-size: 16px;
  font-weight: 800;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.player-meta {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 4px;
}
.player-meta-item {
  font-size: 11px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 4px;
}
.gen-badge {
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  color: #000;
  font-size: 11px;
  font-weight: 800;
  padding: 6px 12px;
  border-radius: 8px;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}
.stat-card {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-sm);
  padding: 10px 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}
.stat-card:hover { background: var(--card-hover); }
.stat-card.clickable { cursor: pointer; }
.stat-icon { font-size: 14px; margin-bottom: 2px; }
.stat-value { font-size: 15px; font-weight: 800; }
.stat-value.positive { color: var(--green); }
.stat-value.negative { color: var(--red); }
.stat-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; margin-top: 2px; }
.stat-bar {
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  margin-top: 6px;
  overflow: hidden;
}
.stat-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.3s ease;
}

/* Badges Row */
.badges-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.badge {
  font-size: 10px;
  font-weight: 600;
  padding: 5px 10px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.badge-green { background: var(--green-bg); color: var(--green); border: 1px solid rgba(16,185,129,0.3); }
.badge-red { background: var(--red-bg); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }
.badge-blue { background: var(--blue-bg); color: var(--blue); border: 1px solid rgba(59,130,246,0.3); }
.badge-purple { background: var(--purple-bg); color: var(--purple); border: 1px solid rgba(139,92,246,0.3); }
.badge-yellow { background: rgba(251,191,36,0.15); color: var(--yellow); border: 1px solid rgba(251,191,36,0.3); }

/* Economy Bar */
.economy-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  background: var(--card);
  border-radius: var(--radius-sm);
  border: 1px solid var(--card-border);
}
.economy-phase {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}
.economy-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}
.economy-dot.boom { background: var(--green); box-shadow: 0 0 8px var(--green); }
.economy-dot.stable { background: var(--blue); box-shadow: 0 0 8px var(--blue); }
.economy-dot.recession { background: var(--red); box-shadow: 0 0 8px var(--red); }
.economy-dot.recovery { background: var(--yellow); box-shadow: 0 0 8px var(--yellow); }
.economy-income {
  font-size: 14px;
  font-weight: 800;
  color: var(--gold);
}

/* Family Bar */
.family-bar {
  background: var(--card);
  border-radius: var(--radius-sm);
  border: 1px solid var(--card-border);
  padding: 10px 12px;
}
.family-header {
  font-size: 10px;
  font-weight: 700;
  color: var(--text-dim);
  text-transform: uppercase;
  margin-bottom: 8px;
}
.family-kids {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.kid-chip {
  display: flex;
  align-items: center;
  gap: 6px;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--card-border);
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 11px;
}
.kid-invested {
  color: var(--gold);
  font-weight: 600;
}

/* Jail Bar */
.jail-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05));
  border: 1px solid var(--red);
  border-radius: var(--radius-sm);
}
.jail-icon { font-size: 24px; }
.jail-info { flex: 1; font-size: 13px; font-weight: 600; }
.jail-time { font-size: 14px; font-weight: 800; color: var(--red); }

/* ============ SWIPE CARD ============ */
.card-area {
  position: relative;
  height: 280px;
  margin: 8px 0;
  perspective: 1000px;
}
.swipe-card {
  position: absolute;
  inset: 0;
  background: linear-gradient(145deg, var(--card) 0%, #1a1a35 100%);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  cursor: grab;
  touch-action: none;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}
.swipe-card:active { cursor: grabbing; }
.swipe-card.swipe-left {
  border-color: var(--red);
  box-shadow: -4px 0 20px rgba(239,68,68,0.3);
}
.swipe-card.swipe-right {
  border-color: var(--green);
  box-shadow: 4px 0 20px rgba(16,185,129,0.3);
}

/* Card Types */
.swipe-card.event { border-left: 4px solid var(--blue); }
.swipe-card.poverty { border-left: 4px solid var(--yellow); }
.swipe-card.crime { border-left: 4px solid var(--red); background: linear-gradient(145deg, #2a1515 0%, #1a1a25 100%); }
.swipe-card.jail { border-left: 4px solid #666; background: linear-gradient(145deg, #1a1a1a 0%, #0a0a0a 100%); }
.swipe-card.business { border-left: 4px solid var(--purple); }

.card-category {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}
.card-icon {
  font-size: 36px;
  line-height: 1;
}
.card-title {
  font-size: 20px;
  font-weight: 900;
  margin-top: 4px;
  line-height: 1.2;
}
.card-desc {
  font-size: 13px;
  color: var(--text-muted);
  line-height: 1.5;
  flex: 1;
  margin-top: 8px;
}

.card-choices {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: auto;
}
.card-choice {
  padding: 12px;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-sm);
}
.card-choice.left { border-top: 3px solid var(--red); }
.card-choice.right { border-top: 3px solid var(--green); }
.choice-label {
  font-size: 12px;
  font-weight: 800;
  display: flex;
  align-items: center;
  gap: 6px;
}
.choice-effect {
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 4px;
  line-height: 1.3;
}

/* Event Card Effects */
.event-effects {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: auto;
  padding-top: 12px;
}
.effect-tag {
  font-size: 12px;
  font-weight: 700;
  padding: 6px 12px;
  border-radius: 6px;
}
.effect-tag.positive { background: var(--green-bg); color: var(--green); }
.effect-tag.negative { background: var(--red-bg); color: var(--red); }

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
  padding: 8px 0;
}
.action-btn {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  border: none;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.action-btn.no {
  background: linear-gradient(135deg, #3a1515, #2a0f0f);
  border: 2px solid var(--red);
  color: var(--red);
}
.action-btn.yes {
  background: linear-gradient(135deg, #153a1a, #0f2a12);
  border: 2px solid var(--green);
  color: var(--green);
}
.action-btn:hover { transform: scale(1.1); }
.action-btn:active { transform: scale(0.95); }

/* ============ MODALS ============ */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding: 12px;
  z-index: 100;
  animation: fadeIn 0.2s ease;
}
.modal {
  width: 100%;
  max-width: 440px;
  max-height: 85vh;
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius) var(--radius) 0 0;
  padding: 20px;
  overflow-y: auto;
  animation: slideUp 0.3s ease;
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.modal-title {
  font-size: 18px;
  font-weight: 800;
}
.modal-close {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  border: none;
  color: var(--text-muted);
  font-size: 18px;
  cursor: pointer;
}
.modal-divider {
  height: 1px;
  background: var(--card-border);
  margin: 16px 0;
}

/* Settings Modal */
.setting-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
}
.toggle {
  width: 48px;
  height: 28px;
  border-radius: 14px;
  background: rgba(255,255,255,0.15);
  border: none;
  cursor: pointer;
  position: relative;
  transition: all 0.2s;
}
.toggle.on { background: var(--gold); }
.toggle-knob {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: #fff;
  position: absolute;
  top: 3px;
  left: 3px;
  transition: all 0.2s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.toggle.on .toggle-knob { left: 23px; }

/* Debt Modal */
.debt-amounts {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}

/* ============ TOAST ============ */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--card);
  border: 1px solid var(--card-border);
  padding: 12px 20px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  box-shadow: var(--shadow);
  z-index: 200;
  animation: toastIn 0.3s ease;
}
.toast.positive { border-color: var(--green); color: var(--green); }
.toast.negative { border-color: var(--red); color: var(--red); }
@keyframes toastIn {
  from { opacity: 0; transform: translateX(-50%) translateY(20px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

/* Achievement Popup */
.achievement-popup {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, var(--gold), var(--gold-dark));
  color: #000;
  padding: 14px 24px;
  border-radius: var(--radius-sm);
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: var(--shadow-gold);
  z-index: 200;
  animation: achievementIn 0.5s ease;
}
@keyframes achievementIn {
  0% { opacity: 0; transform: translateX(-50%) translateY(-50px) scale(0.8); }
  50% { transform: translateX(-50%) translateY(0) scale(1.1); }
  100% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
}
.achievement-icon { font-size: 24px; }

/* ============ DYNASTY SCREEN ============ */
.dynasty-tree {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.dynasty-member {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: var(--radius-sm);
  padding: 12px;
}
.dynasty-member.current {
  border-color: var(--gold);
  background: rgba(246,195,67,0.05);
}

/* ============ END SCREEN ============ */
.end-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  text-align: center;
  gap: 16px;
  padding: 20px;
}
.end-icon { font-size: 72px; }
.end-title {
  font-size: 28px;
  font-weight: 900;
  background: linear-gradient(135deg, var(--gold-light), var(--gold));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.end-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  width: 100%;
  max-width: 300px;
}
.end-stat {
  background: var(--card);
  padding: 12px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--card-border);
}
.end-stat-value { font-size: 18px; font-weight: 800; }
.end-stat-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }

/* Animations */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-8px); }
  75% { transform: translateX(8px); }
}
.shake { animation: shake 0.3s ease; }

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}
.pulse { animation: pulse 1.5s ease infinite; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

// ============================================
// SOUND SYSTEM
// ============================================
class SFX {
  constructor() {
    this.ctx = null;
    this.on = true;
    this.musicOn = true;
    this.loop = null;
  }
  
  init() {
    if (!this.ctx) {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }
  
  tone(freq, dur = 0.1, type = 'sine', vol = 0.08, delay = 0) {
    if (!this.ctx || !this.on) return;
    const o = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    o.type = type;
    o.frequency.value = freq;
    const t = this.ctx.currentTime + delay;
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(vol, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, t + dur);
    o.connect(g);
    g.connect(this.ctx.destination);
    o.start(t);
    o.stop(t + dur);
  }
  
  click() { this.tone(600, 0.03, 'sine', 0.06); }
  yes() { this.tone(523, 0.08); this.tone(659, 0.08, 'sine', 0.08, 0.06); this.tone(784, 0.1, 'sine', 0.07, 0.12); }
  no() { this.tone(330, 0.08); this.tone(294, 0.1, 'sine', 0.08, 0.06); }
  draw() { this.tone(880, 0.03, 'sine', 0.05); }
  good() { [523, 659, 784, 1047].forEach((f, i) => this.tone(f, 0.1, 'sine', 0.07, i * 0.04)); }
  bad() { this.tone(220, 0.15, 'triangle', 0.08); this.tone(196, 0.2, 'triangle', 0.06, 0.1); }
  money() { this.tone(1047, 0.06); this.tone(1318, 0.08, 'sine', 0.07, 0.04); }
  debt() { this.tone(175, 0.2, 'triangle', 0.08); }
  ach() { [523, 659, 784, 1047, 1318].forEach((f, i) => this.tone(f, 0.12, 'sine', 0.08, i * 0.06)); }
  lvl() { this.tone(392, 0.15); this.tone(523, 0.15, 'sine', 0.1, 0.12); this.tone(659, 0.2, 'sine', 0.1, 0.24); }
  marry() { [523, 659, 784, 1047].forEach((f, i) => this.tone(f, 0.15, 'sine', 0.08, i * 0.1)); }
  baby() { this.tone(880, 0.08); this.tone(1047, 0.08, 'sine', 0.08, 0.06); this.tone(1318, 0.1, 'sine', 0.07, 0.12); }
  crime() { this.tone(196, 0.12, 'sawtooth', 0.06); this.tone(175, 0.15, 'sawtooth', 0.05, 0.1); }
  caught() { this.tone(150, 0.25, 'square', 0.1); this.tone(110, 0.3, 'square', 0.08, 0.2); }
  free() { this.tone(392, 0.12); this.tone(523, 0.12, 'sine', 0.1, 0.1); this.tone(659, 0.15, 'sine', 0.1, 0.2); }
  
  startMusic() {
    if (!this.ctx || !this.musicOn || this.loop) return;
    const chords = [[262, 330, 392], [294, 370, 440], [330, 415, 494], [294, 370, 440]];
    const bass = [65, 73, 82, 73];
    let i = 0;
    this.loop = setInterval(() => {
      if (!this.musicOn) return;
      this.tone(bass[i % bass.length], 0.25, 'triangle', 0.03);
      chords[i % chords.length].forEach((f, ix) => this.tone(f, 0.2, 'sine', 0.02, ix * 0.02));
      i++;
    }, 500);
  }
  
  stopMusic() {
    if (this.loop) { clearInterval(this.loop); this.loop = null; }
  }
  
  toggleMusic(v) { this.musicOn = v; v ? this.startMusic() : this.stopMusic(); }
  toggleSFX(v) { this.on = v; }
}

const sfx = new SFX();

// ============================================
// UTILITIES
// ============================================
const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const pick = arr => arr[Math.floor(Math.random() * arr.length)];
const uid = () => Math.random().toString(36).slice(2, 10);

const fmt = n => {
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  if (abs >= 1e6) return `${sign}$${(abs / 1e6).toFixed(1)}M`;
  if (abs >= 1e3) return `${sign}$${(abs / 1e3).toFixed(1)}K`;
  return `${sign}$${Math.round(abs)}`;
};

const netWorth = st => st.cash + st.invest + st.equity - st.debt - st.mortgage;

// ============================================
// GAME DATA
// ============================================
const CHAR_STYLES = {
  m: [
    { id: 'm1', name: 'Classic', hair: '#3d2314', skin: '#f5d0c5', shirt: '#3B82F6', pants: '#1e3a5f' },
    { id: 'm2', name: 'Cool', hair: '#1a1a1a', skin: '#e8beac', shirt: '#22C55E', pants: '#1a1a1a' },
    { id: 'm3', name: 'Blonde', hair: '#f4d03f', skin: '#f5d0c5', shirt: '#EF4444', pants: '#2d3748' },
    { id: 'm4', name: 'Red', hair: '#c0392b', skin: '#dbb89a', shirt: '#8B5CF6', pants: '#1e3a5f' },
    { id: 'm5', name: 'Silver', hair: '#95a5a6', skin: '#f5d0c5', shirt: '#F6C343', pants: '#2d3748' },
    { id: 'm6', name: 'Brown', hair: '#5d4037', skin: '#c68642', shirt: '#14B8A6', pants: '#1a1a1a' },
    { id: 'm7', name: 'Dark', hair: '#2c1810', skin: '#8d5524', shirt: '#0EA5E9', pants: '#2d3748' },
    { id: 'm8', name: 'Fade', hair: '#1a1a1a', skin: '#a67c52', shirt: '#F97316', pants: '#1e3a5f' },
  ],
  f: [
    { id: 'f1', name: 'Classic', hair: '#3d2314', skin: '#f5d0c5', shirt: '#EC4899', pants: '#1e3a5f' },
    { id: 'f2', name: 'Blonde', hair: '#f4d03f', skin: '#f5d0c5', shirt: '#8B5CF6', pants: '#2d3748' },
    { id: 'f3', name: 'Red', hair: '#c0392b', skin: '#e8beac', shirt: '#22C55E', pants: '#1a1a1a' },
    { id: 'f4', name: 'Dark', hair: '#1a1a1a', skin: '#dbb89a', shirt: '#3B82F6', pants: '#1e3a5f' },
    { id: 'f5', name: 'Brown', hair: '#5d4037', skin: '#c68642', shirt: '#F6C343', pants: '#2d3748' },
    { id: 'f6', name: 'Curly', hair: '#2c1810', skin: '#8d5524', shirt: '#EF4444', pants: '#1a1a1a' },
    { id: 'f7', name: 'Silver', hair: '#95a5a6', skin: '#f5d0c5', shirt: '#14B8A6', pants: '#1e3a5f' },
    { id: 'f8', name: 'Long', hair: '#1a1a1a', skin: '#a67c52', shirt: '#F97316', pants: '#2d3748' },
  ],
};

const CAREERS = [
  { id: 'trades', icon: 'üîß', name: 'Trades', desc: 'Electrician, Plumber', start: 3200, cap: 7500, edu: 12000, time: 2 },
  { id: 'business', icon: 'üíº', name: 'Business', desc: 'Sales, Management', start: 3000, cap: 12000, edu: 50000, time: 4 },
  { id: 'tech', icon: 'üíª', name: 'Tech', desc: 'Software, IT', start: 4500, cap: 15000, edu: 60000, time: 4 },
  { id: 'healthcare', icon: 'üè•', name: 'Healthcare', desc: 'Nursing, Therapy', start: 3800, cap: 9000, edu: 45000, time: 4 },
  { id: 'creative', icon: 'üé®', name: 'Creative', desc: 'Design, Media', start: 2500, cap: 20000, edu: 40000, time: 4 },
  { id: 'finance', icon: 'üìä', name: 'Finance', desc: 'Banking, Investing', start: 4000, cap: 18000, edu: 70000, time: 4 },
];

const ECONOMY = [
  { id: 'boom', name: 'Bull Market', color: 'boom', invMult: 1.015, jobRisk: 0.02 },
  { id: 'stable', name: 'Stable', color: 'stable', invMult: 1.005, jobRisk: 0.05 },
  { id: 'recession', name: 'Recession', color: 'recession', invMult: 0.985, jobRisk: 0.12 },
  { id: 'recovery', name: 'Recovery', color: 'recovery', invMult: 1.008, jobRisk: 0.07 },
];

const ACHIEVEMENTS = [
  { id: '10k', icon: 'üíµ', title: '$10K Saved', check: st => st.cash >= 10000 },
  { id: '100k', icon: 'üí∞', title: '$100K Club', check: st => netWorth(st) >= 100000 },
  { id: '1m', icon: 'üëë', title: 'Millionaire', check: st => netWorth(st) >= 1000000 },
  { id: 'credit750', icon: 'üìä', title: 'Great Credit', check: st => st.credit >= 750 },
  { id: 'debtfree', icon: 'üéâ', title: 'Debt Free', check: st => st.debt === 0 && netWorth(st) > 0 },
  { id: 'married', icon: 'üíí', title: 'Married', check: (st, ch) => ch.rel === 'married' },
  { id: 'parent', icon: 'üë∂', title: 'Parent', check: (st, ch) => ch.kids.length >= 1 },
  { id: 'bigfam', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', title: 'Big Family', check: (st, ch) => ch.kids.length >= 3 },
  { id: 'home', icon: 'üè†', title: 'Homeowner', check: (st, ch) => ch.housing === 'own' },
  { id: 'dynasty', icon: 'üè∞', title: 'Dynasty', check: (st, ch, gen) => gen >= 3 },
];

const KID_NAMES = {
  m: ['Marcus', 'Eli', 'Noah', 'Isaiah', 'David', 'Caleb', 'Jordan', 'Samuel'],
  f: ['Mia', 'Ava', 'Naomi', 'Zoe', 'Leah', 'Sarah', 'Hannah', 'Faith'],
};

// ============================================
// CARD GENERATOR
// ============================================
const generateCard = (st, ch, econ, hidden) => {
  const cards = [];
  const poor = st.cash < 500 && st.income < 2500;
  const veryPoor = st.cash < 100 && st.income < 2000;
  const careerData = CAREERS.find(c => c.id === ch.career) || CAREERS[0];
  
  // JAIL - Override everything
  if (ch.inJail && ch.jailTime > 0) {
    return {
      key: 'jail_serve',
      cat: '‚õìÔ∏è Jail',
      icon: 'üîí',
      title: 'Behind Bars',
      desc: `${ch.jailTime} year${ch.jailTime > 1 ? 's' : ''} remaining. Serve your time.`,
      type: 'jail',
      isEvent: false,
      left: { label: 'Serve Time', effect: '-1 Year, -10 Happy', imp: { happy: -10 }, serveTime: true },
      right: { label: 'Serve Time', effect: '-1 Year, -10 Happy', imp: { happy: -10 }, serveTime: true },
    };
  }
  
  // POVERTY BENEFITS
  if (veryPoor && !ch.foodStamps) {
    cards.push({
      key: 'benefit_snap',
      cat: 'üèõÔ∏è Benefits',
      icon: 'üçé',
      title: 'SNAP Benefits',
      desc: 'You qualify for food assistance. It can help stabilize your situation.',
      type: 'poverty',
      left: { label: 'Decline', effect: '-10 Happy, keep pride', imp: { happy: -10 } },
      right: { label: 'Apply', effect: '+$300/mo saved', imp: { income: 300, happy: 5 }, setFoodStamps: true },
    });
  }
  
  if (poor && ch.housing === 'rent' && !ch.section8) {
    cards.push({
      key: 'benefit_section8',
      cat: 'üèõÔ∏è Benefits',
      icon: 'üè†',
      title: 'Section 8 Housing',
      desc: 'Housing assistance can significantly reduce your monthly burden.',
      type: 'poverty',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Apply', effect: '+$600/mo saved', imp: { income: 600, happy: 8 }, setSection8: true },
    });
  }
  
  // POVERTY JOBS
  if (poor && st.income < 3000) {
    cards.push({
      key: 'work_jobfair',
      cat: 'üíº Work',
      icon: 'üé™',
      title: 'Job Fair',
      desc: 'Community job fair with multiple employers looking to hire.',
      type: 'poverty',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Attend', effect: '+$300/mo, +8 Happy', imp: { income: 300, happy: 8 } },
    });
  }
  
  if (poor) {
    cards.push({
      key: 'work_temp',
      cat: 'üíº Work',
      icon: 'üè≠',
      title: 'Temp Staffing',
      desc: 'Temp agency has immediate work. Long hours but steady income.',
      type: 'poverty',
      left: { label: 'Pass', effect: 'Rest', imp: { health: 3 } },
      right: { label: 'Work', effect: '+$200/mo, -5 Health', imp: { income: 200, health: -5 } },
    });
  }
  
  if (veryPoor) {
    cards.push({
      key: 'work_daylabor',
      cat: 'üíº Work',
      icon: 'üì¶',
      title: 'Day Labor',
      desc: 'Moving company needs help today. Cash under table.',
      type: 'poverty',
      left: { label: 'Pass', effect: 'No change', imp: {} },
      right: { label: 'Work', effect: '+$150 cash, -8 Health', imp: { cash: 150, health: -8 } },
    });
  }
  
  // CRIME (Only when desperate)
  if (poor && hidden.stress > 40) {
    cards.push({
      key: 'crime_quick',
      cat: '‚ö†Ô∏è Risk',
      icon: 'üí∞',
      title: 'Quick Money',
      desc: 'Friend offers easy cash. Selling "stuff". Risky but tempting...',
      type: 'crime',
      left: { label: 'Walk Away', effect: '+5 Discipline', imp: { happy: 2 }, addDiscipline: 5 },
      right: { label: 'Do It', effect: '+$800 (25% caught)', crime: { reward: 800, risk: 0.25, jail: 2 } },
    });
    
    cards.push({
      key: 'crime_register',
      cat: '‚ö†Ô∏è Risk',
      icon: 'üè™',
      title: 'Desperate Times',
      desc: 'You could take from the register... No one would know.',
      type: 'crime',
      left: { label: 'Stay Honest', effect: '+3 Happy', imp: { happy: 3 }, addDiscipline: 3 },
      right: { label: 'Take It', effect: '+$300 (35% caught)', crime: { reward: 300, risk: 0.35, jail: 1 } },
    });
  }
  
  if (poor && st.debt > 10000) {
    cards.push({
      key: 'crime_fraud',
      cat: '‚ö†Ô∏è Risk',
      icon: 'üí≥',
      title: 'Fraud Scheme',
      desc: 'Someone offers to "clear" your debt illegally.',
      type: 'crime',
      left: { label: 'Refuse', effect: '+5 Discipline', imp: {}, addDiscipline: 5 },
      right: { label: 'Do It', effect: 'Clear $15K debt (40% caught)', crime: { debtClear: 15000, risk: 0.40, jail: 3 } },
    });
  }
  
  // CAREER
  if (!ch.record && st.income < careerData.cap && Math.random() < 0.3) {
    const raise = rand(300, 600);
    cards.push({
      key: 'career_promo',
      cat: 'üíº Career',
      icon: 'üìà',
      title: 'Promotion',
      desc: 'Management recognizes your work. Better title, better pay.',
      left: { label: 'Decline', effect: '+5 Happy', imp: { happy: 5 } },
      right: { label: 'Accept', effect: `+$${raise}/mo, +10 Happy`, imp: { income: raise, happy: 10 } },
    });
  }
  
  if (ch.record && Math.random() < 0.4) {
    cards.push({
      key: 'career_bgcheck',
      cat: 'üíº Career',
      icon: 'üìã',
      title: 'Background Check',
      desc: 'New opportunity requires background check. Your record...',
      left: { label: 'Skip It', effect: '-10 Happy', imp: { happy: -10 } },
      right: { label: 'Try Anyway', effect: '50% chance hired', bgCheck: true },
    });
  }
  
  // SIDE HUSTLE
  if (Math.random() < 0.25) {
    const earn = rand(100, 300);
    cards.push({
      key: 'work_sidehustle',
      cat: 'üíº Work',
      icon: 'üåô',
      title: 'Side Hustle',
      desc: 'Extra work opportunity on weekends.',
      left: { label: 'Rest', effect: '+5 Health', imp: { health: 5 } },
      right: { label: 'Hustle', effect: `+$${earn}, -3 Health`, imp: { cash: earn, health: -3 } },
    });
  }
  
  // CREDIT
  if (st.credit < 650 && Math.random() < 0.3) {
    cards.push({
      key: 'credit_secured',
      cat: 'üìä Credit',
      icon: 'üí≥',
      title: 'Secured Card',
      desc: 'Build credit with a secured card. Requires deposit.',
      left: { label: 'Skip', effect: 'No change', imp: {} },
      right: { label: 'Apply', effect: '-$500, +25 Credit', imp: { cash: -500, credit: 25 } },
    });
  }
  
  if (Math.random() < 0.2) {
    cards.push({
      key: 'credit_error',
      cat: 'üìä Credit',
      icon: '‚ö†Ô∏è',
      title: 'Credit Error',
      desc: 'You found an error on your credit report.',
      left: { label: 'Ignore', effect: 'No change', imp: {} },
      right: { label: 'Dispute', effect: '+15 Credit', imp: { credit: 15 } },
    });
  }
  
  // INVESTMENTS
  if (st.cash > 1000 && st.credit >= 640 && Math.random() < 0.3) {
    const amt = pick([500, 1000, 2000, 3000]);
    cards.push({
      key: 'invest_index',
      cat: 'üìà Invest',
      icon: 'üìä',
      title: 'Index Funds',
      desc: 'Diversified investment opportunity.',
      left: { label: 'Skip', effect: 'Keep cash', imp: {} },
      right: { label: 'Invest', effect: `-$${amt} ‚Üí investments`, imp: { cash: -amt, invest: amt } },
    });
  }
  
  if (econ.id === 'recession' && st.cash > 1500 && Math.random() < 0.35) {
    const amt = pick([1000, 2000, 3000]);
    cards.push({
      key: 'invest_dip',
      cat: 'üìà Invest',
      icon: 'üìâ',
      title: 'Buy The Dip',
      desc: 'Market is down. History says this is opportunity.',
      left: { label: 'Hold Cash', effect: 'Safety', imp: {} },
      right: { label: 'Buy', effect: `Invest $${amt}`, imp: { cash: -amt, invest: amt } },
    });
  }
  
  // HEALTH
  if (st.health < 60 && Math.random() < 0.4) {
    cards.push({
      key: 'health_doctor',
      cat: '‚ù§Ô∏è Health',
      icon: 'üè•',
      title: 'Doctor Visit',
      desc: 'Your health is suffering. Time to see someone.',
      left: { label: 'Skip', effect: '-10 Health', imp: { health: -10 } },
      right: { label: 'Go', effect: '-$300, +15 Health', imp: { cash: -300, health: 15 } },
    });
  }
  
  if (st.happy < 45 && Math.random() < 0.35) {
    cards.push({
      key: 'health_therapy',
      cat: '‚ù§Ô∏è Health',
      icon: 'üß†',
      title: 'Therapy',
      desc: 'Mental health affects everything. Support is available.',
      left: { label: 'Not Now', effect: '-5 Happy', imp: { happy: -5 } },
      right: { label: 'Try It', effect: '-$200, +12 Happy', imp: { cash: -200, happy: 12, health: 5 } },
    });
  }
  
  // RELATIONSHIPS
  if (ch.rel === 'single' && ch.age >= 20 && ch.age <= 45 && st.happy > 40 && Math.random() < 0.25) {
    cards.push({
      key: 'rel_meet',
      cat: 'üíï Love',
      icon: 'üíç',
      title: 'Someone Special',
      desc: "You've met someone amazing. Could this be love?",
      left: { label: 'Not Ready', effect: '+3 Happy', imp: { happy: 3 } },
      right: { label: 'Get Engaged', effect: '-$500, engaged', imp: { cash: -500, happy: 15 }, setRel: 'engaged' },
    });
  }
  
  if (ch.rel === 'engaged' && Math.random() < 0.35) {
    const spouse = rand(800, 1500);
    cards.push({
      key: 'rel_wedding',
      cat: 'üíï Love',
      icon: 'üíí',
      title: 'Wedding Day',
      desc: 'Time to tie the knot!',
      left: { label: 'Delay', effect: '-5 Happy', imp: { happy: -5 } },
      right: { label: 'Marry', effect: `-$8K, spouse +$${spouse}/mo`, imp: { cash: -8000, income: spouse, happy: 20 }, setRel: 'married' },
    });
  }
  
  if (ch.rel === 'married' && st.happy < 40 && Math.random() < 0.3) {
    cards.push({
      key: 'rel_counsel',
      cat: 'üíï Love',
      icon: 'üíî',
      title: 'Marriage Trouble',
      desc: 'Things are rocky. Counseling might help.',
      left: { label: 'Ignore', effect: 'Divorce risk up', imp: { happy: -8 }, addDivorceRisk: true },
      right: { label: 'Counseling', effect: '-$1500, +15 Happy', imp: { cash: -1500, happy: 15 } },
    });
  }
  
  // KIDS
  if (ch.rel === 'married' && ch.age >= 23 && ch.age <= 42 && Math.random() < 0.25) {
    cards.push({
      key: 'family_baby',
      cat: 'üë∂ Family',
      icon: 'üë∂',
      title: 'Have a Baby?',
      desc: 'Your family could grow. Kids are expensive but rewarding.',
      left: { label: 'Not Now', effect: '+3 Happy', imp: { happy: 3 } },
      right: { label: 'Yes!', effect: '+baby, +$1500/mo costs, +20 Happy', imp: { income: -1500, happy: 20 }, spawnKid: true },
    });
  }
  
  // KID EVENTS
  if (ch.kids.length > 0 && Math.random() < 0.4) {
    const kid = pick(ch.kids);
    const events = [
      { key: 'kid_school', icon: 'üéí', title: `School Choice (${kid.name})`, desc: 'Public is free. Private costs more but may help.',
        left: { label: 'Public', effect: 'Free', imp: {} },
        right: { label: 'Private', effect: '-$800/mo, invest in future', imp: { income: -800 }, kidInvest: { id: kid.id, amt: 3000 } }
      },
      { key: 'kid_activity', icon: '‚öΩ', title: `Activities (${kid.name})`, desc: 'Sports, music, or clubs?',
        left: { label: 'Skip', effect: '-2 Happy', imp: { happy: -2 } },
        right: { label: 'Enroll', effect: '-$200, invest in future', imp: { cash: -200, happy: 3 }, kidInvest: { id: kid.id, amt: 1000 } }
      },
      { key: 'kid_tutor', icon: 'üìö', title: `Tutoring (${kid.name})`, desc: 'Extra academic support available.',
        left: { label: 'No', effect: 'No change', imp: {} },
        right: { label: 'Yes', effect: '-$400, invest', imp: { cash: -400 }, kidInvest: { id: kid.id, amt: 2000 } }
      },
    ];
    const evt = pick(events);
    cards.push({ ...evt, cat: 'üë∂ Family', type: 'kid' });
  }
  
  // HOUSING
  if (ch.housing === 'parents' && st.cash > 500 && Math.random() < 0.25) {
    cards.push({
      key: 'house_moveout',
      cat: 'üè† Housing',
      icon: 'üè¢',
      title: 'Move Out?',
      desc: 'Independence awaits. But rent adds up.',
      left: { label: 'Stay', effect: 'Save money', imp: {} },
      right: { label: 'Rent', effect: 'Expenses up, +freedom', imp: { income: -1400, happy: 8 }, setHousing: 'rent' },
    });
  }
  
  if (ch.housing !== 'own' && st.credit >= 680 && st.cash >= 25000 && Math.random() < 0.2) {
    cards.push({
      key: 'house_buy',
      cat: 'üè† Housing',
      icon: 'üè†',
      title: 'Buy a Home?',
      desc: 'Build equity instead of paying rent.',
      left: { label: 'Not Yet', effect: 'Keep flexibility', imp: {} },
      right: { label: 'Buy', effect: '-$25K down, mortgage', imp: { cash: -25000, mortgage: 200000, equity: 25000, happy: 15 }, setHousing: 'own' },
    });
  }
  
  // BUSINESS (Millionaire path)
  if (!ch.biz && st.cash >= 5000 && st.credit >= 650 && hidden.discipline >= 45 && Math.random() < 0.2) {
    cards.push({
      key: 'biz_start',
      cat: 'üè¢ Business',
      icon: 'üöÄ',
      title: 'Start a Business',
      desc: 'Jobs are capped. Business can scale. Risk and reward.',
      type: 'business',
      left: { label: 'Not Ready', effect: '+3 Discipline', imp: {}, addDiscipline: 3 },
      right: { label: 'Start', effect: '-$5K, start business', imp: { cash: -5000 }, startBiz: true },
    });
  }
  
  if (ch.biz && Math.random() < 0.4) {
    const bizEvents = [
      { key: 'biz_reinvest', icon: 'üíπ', title: 'Reinvest Profits', desc: 'Put money back in or take it out?',
        left: { label: 'Take Profit', effect: '+$2K cash', imp: { cash: 2000 }, bizDecision: 'profit' },
        right: { label: 'Reinvest', effect: 'Grow business', imp: {}, bizDecision: 'reinvest' }
      },
      { key: 'biz_hire', icon: 'üë•', title: 'Hire Help', desc: 'More employees, more capacity, more costs.',
        left: { label: 'Stay Lean', effect: '+stress', imp: { happy: -3 } },
        right: { label: 'Hire', effect: '-$1K/mo, grow capacity', imp: { income: -1000 }, bizDecision: 'hire' }
      },
    ];
    const evt = pick(bizEvents);
    cards.push({ ...evt, cat: 'üè¢ Business', type: 'business' });
  }
  
  // RANDOM EVENTS
  if (Math.random() < 0.15) {
    const events = [
      { icon: 'üéâ', title: 'Work Bonus!', desc: 'Great performance recognized!', imp: { cash: 2000 }, positive: true },
      { icon: 'üìà', title: 'Market Surge', desc: 'Your investments grew!', imp: { invest: 1500 }, positive: true },
      { icon: 'üí≥', title: 'Cashback Rewards', desc: 'Credit card rewards payout.', imp: { cash: 250 }, positive: true },
      { icon: 'üçÄ', title: 'Lucky Find', desc: 'Found money in old jacket!', imp: { cash: 100 }, positive: true },
      { icon: 'ü§í', title: 'Got Sick', desc: 'Unexpected illness.', imp: { cash: -500, health: -15 }, positive: false },
      { icon: 'üöó', title: 'Car Trouble', desc: 'Repairs needed.', imp: { cash: -800 }, positive: false },
      { icon: 'üìâ', title: 'Market Dip', desc: 'Investments dropped.', imp: { invest: -2000 }, positive: false },
      { icon: 'üîß', title: 'Appliance Broke', desc: 'Fridge died.', imp: { cash: -600 }, positive: false },
    ];
    const evt = pick(events);
    return {
      key: 'event_' + uid(),
      cat: 'üåü Life Event',
      icon: evt.icon,
      title: evt.title,
      desc: evt.desc,
      isEvent: true,
      imp: evt.imp,
      positive: evt.positive,
    };
  }
  
  // DEFAULT
  if (cards.length === 0) {
    cards.push({
      key: 'life_normal',
      cat: 'üåü Life',
      icon: '‚òÄÔ∏è',
      title: 'Normal Day',
      desc: 'Nothing special today. Small choices compound.',
      left: { label: 'Relax', effect: '+3 Happy', imp: { happy: 3 } },
      right: { label: 'Work Extra', effect: '+$100', imp: { cash: 100 } },
    });
  }
  
  return pick(cards);
};

// ============================================
// PIXEL CHARACTER COMPONENT
// ============================================
const PixelChar = ({ style, gender, size = 'md' }) => {
  const s = style || (CHAR_STYLES[gender] || CHAR_STYLES.m)[0];
  const scale = size === 'sm' ? 2 : size === 'md' ? 3 : size === 'lg' ? 4 : 6;
  const isMale = gender === 'm';
  
  return (
    <div className={`pixel-char ${size}`}>
      <svg width={scale * 10} height={scale * 14} viewBox="0 0 10 14" style={{ imageRendering: 'pixelated' }}>
        {/* Hair */}
        <rect x="2" y="0" width="6" height="3" fill={s.hair} />
        <rect x="1" y="1" width="1" height="2" fill={s.hair} />
        <rect x="8" y="1" width="1" height="2" fill={s.hair} />
        {!isMale && <>
          <rect x="0" y="2" width="1" height="4" fill={s.hair} />
          <rect x="9" y="2" width="1" height="4" fill={s.hair} />
        </>}
        {/* Face */}
        <rect x="2" y="2" width="6" height="5" fill={s.skin} />
        {/* Eyes */}
        <rect x="3" y="4" width="1" height="1" fill="#1a1a1a" />
        <rect x="6" y="4" width="1" height="1" fill="#1a1a1a" />
        {/* Shirt */}
        <rect x="2" y="7" width="6" height="4" fill={s.shirt} />
        <rect x="1" y="8" width="1" height="2" fill={s.shirt} />
        <rect x="8" y="8" width="1" height="2" fill={s.shirt} />
        {/* Pants */}
        <rect x="2" y="11" width="3" height="3" fill={s.pants} />
        <rect x="5" y="11" width="3" height="3" fill={s.pants} />
      </svg>
    </div>
  );
};

// ============================================
// SAVE SYSTEM
// ============================================
const SAVE_KEY = 'kt_v5_save';

const saveGame = (state) => {
  try {
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    return true;
  } catch { return false; }
};

const loadGame = () => {
  try {
    const data = localStorage.getItem(SAVE_KEY);
    return data ? JSON.parse(data) : null;
  } catch { return null; }
};

const clearSave = () => {
  try { localStorage.removeItem(SAVE_KEY); } catch {}
};

// ============================================
// MAIN GAME COMPONENT
// ============================================
function Game() {
  // Screen state
  const [screen, setScreen] = useState('title');
  const [modal, setModal] = useState(null);
  const [toast, setToast] = useState(null);
  const [achievement, setAchievement] = useState(null);
  
  // Setup state
  const [setupStep, setSetupStep] = useState(0);
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');
  const [gender, setGender] = useState('m');
  const [charStyle, setCharStyle] = useState(null);
  const [career, setCareer] = useState(null);
  
  // Game state
  const [char, setChar] = useState(null);
  const [st, setSt] = useState(null);
  const [hidden, setHidden] = useState({ discipline: 50, reputation: 50, stress: 30, heat: 0 });
  const [econ, setEcon] = useState(ECONOMY[1]);
  const [econTimer, setEconTimer] = useState(0);
  const [gen, setGen] = useState(1);
  const [hist, setHist] = useState([]);
  const [dynWealth, setDynWealth] = useState(0);
  const [achs, setAchs] = useState([]);
  
  // Card state
  const [card, setCard] = useState(null);
  const [cardOffset, setCardOffset] = useState(0);
  const [dragging, setDragging] = useState(false);
  
  // Settings
  const [musicOn, setMusicOn] = useState(true);
  const [sfxOn, setSfxOn] = useState(true);
  
  // Heir setup
  const [heirName, setHeirName] = useState('');
  const [heirGender, setHeirGender] = useState('m');
  const [heirStyle, setHeirStyle] = useState(null);
  const [heirCareer, setHeirCareer] = useState(null);
  
  // Refs
  const startX = useRef(0);
  
  // Check for saved game
  useEffect(() => {
    const saved = loadGame();
    if (saved && saved.char && saved.st) {
      // Don't auto-load, just mark that save exists
    }
  }, []);
  
  // Initialize audio
  useEffect(() => {
    sfx.init();
    if (musicOn) sfx.startMusic();
    return () => sfx.stopMusic();
  }, []);
  
  // Music toggle
  useEffect(() => {
    sfx.toggleMusic(musicOn);
  }, [musicOn]);
  
  // SFX toggle
  useEffect(() => {
    sfx.toggleSFX(sfxOn);
  }, [sfxOn]);
  
  // Auto-save
  useEffect(() => {
    if (screen === 'game' && char && st) {
      saveGame({ char, st, hidden, econ, econTimer, gen, hist, dynWealth, achs, lastName });
    }
  }, [char, st, hidden, econ, gen, hist, achs]);
  
  // Toast timeout
  useEffect(() => {
    if (toast) {
      const t = setTimeout(() => setToast(null), 2000);
      return () => clearTimeout(t);
    }
  }, [toast]);
  
  // Achievement timeout
  useEffect(() => {
    if (achievement) {
      const t = setTimeout(() => setAchievement(null), 3000);
      return () => clearTimeout(t);
    }
  }, [achievement]);
  
  // Check achievements
  const checkAchievements = useCallback((newSt, newChar, newGen) => {
    ACHIEVEMENTS.forEach(a => {
      if (!achs.includes(a.id) && a.check(newSt, newChar, newGen)) {
        setAchs(prev => [...prev, a.id]);
        setAchievement(a);
        sfx.ach();
      }
    });
  }, [achs]);
  
  // Draw new card
  const drawCard = useCallback((currentSt, currentChar, currentHidden, currentEcon) => {
    sfx.draw();
    const newCard = generateCard(currentSt, currentChar, currentEcon, currentHidden);
    setCard(newCard);
    setCardOffset(0);
  }, []);
  
  // Start new game
  const startGame = () => {
    if (!firstName || !lastName || !career || !charStyle) return;
    
    sfx.click();
    sfx.init();
    
    const careerData = CAREERS.find(c => c.id === career);
    const style = CHAR_STYLES[gender].find(s => s.id === charStyle);
    
    const newChar = {
      name: firstName,
      gender,
      style,
      age: 18 + careerData.time,
      career,
      rel: 'single',
      kids: [],
      housing: 'parents',
      foodStamps: false,
      section8: false,
      inJail: false,
      jailTime: 0,
      record: false,
      biz: null,
    };
    
    const newSt = {
      cash: 500,
      income: careerData.start,
      debt: careerData.edu,
      invest: 0,
      credit: 620,
      health: 100,
      happy: 70,
      equity: 0,
      mortgage: 0,
    };
    
    const newHidden = { discipline: 50, reputation: 50, stress: 30, heat: 0 };
    
    setChar(newChar);
    setSt(newSt);
    setHidden(newHidden);
    setGen(1);
    setHist([]);
    setDynWealth(0);
    setAchs([]);
    setEcon(ECONOMY[1]);
    setEconTimer(0);
    setScreen('game');
    
    setTimeout(() => drawCard(newSt, newChar, newHidden, ECONOMY[1]), 200);
  };
  
  // Continue saved game
  const continueGame = () => {
    const saved = loadGame();
    if (saved) {
      setChar(saved.char);
      setSt(saved.st);
      setHidden(saved.hidden || { discipline: 50, reputation: 50, stress: 30, heat: 0 });
      setEcon(saved.econ || ECONOMY[1]);
      setEconTimer(saved.econTimer || 0);
      setGen(saved.gen || 1);
      setHist(saved.hist || []);
      setDynWealth(saved.dynWealth || 0);
      setAchs(saved.achs || []);
      setLastName(saved.lastName || '');
      setScreen('game');
      sfx.init();
      setTimeout(() => drawCard(saved.st, saved.char, saved.hidden || { discipline: 50, reputation: 50, stress: 30, heat: 0 }, saved.econ || ECONOMY[1]), 200);
    }
  };
  
  // Process monthly
  const processMonth = (currentSt, currentChar, currentHidden, currentEcon) => {
    let newSt = { ...currentSt };
    let newChar = { ...currentChar };
    let newHidden = { ...currentHidden };
    
    // Skip if in jail
    if (newChar.inJail) {
      newChar.age += 1;
      newChar.kids = newChar.kids.map(k => ({ ...k, age: k.age + 1 }));
      return { st: newSt, char: newChar, hidden: newHidden };
    }
    
    // Income
    let monthlyIncome = newSt.income;
    
    // Business income
    if (newChar.biz) {
      const bizProfit = rand(500, 2000);
      monthlyIncome += bizProfit;
    }
    
    // Expenses
    let expenses = 0;
    if (newChar.housing === 'rent') expenses += 1400;
    else if (newChar.housing === 'own') expenses += 2000;
    else expenses += 300;
    
    // Debt payments
    const debtPayment = Math.min(newSt.debt, Math.max(100, newSt.debt * 0.02));
    expenses += debtPayment;
    newSt.debt = Math.max(0, newSt.debt - debtPayment);
    
    // Mortgage
    if (newSt.mortgage > 0) {
      const mortPay = Math.min(1500, newSt.mortgage * 0.005);
      expenses += mortPay;
      newSt.mortgage = Math.max(0, newSt.mortgage - mortPay * 0.3);
      newSt.equity += mortPay * 0.3;
    }
    
    // Apply cashflow
    newSt.cash += (monthlyIncome - expenses);
    
    // Negative cash becomes debt
    if (newSt.cash < 0) {
      newSt.debt += Math.abs(newSt.cash);
      newSt.cash = 0;
    }
    
    // Investments grow
    newSt.invest = Math.round(newSt.invest * currentEcon.invMult);
    
    // Home equity appreciation
    if (newChar.housing === 'own') {
      const appreciation = currentEcon.id === 'boom' ? 0.003 : currentEcon.id === 'recession' ? -0.001 : 0.002;
      newSt.equity = Math.round(newSt.equity * (1 + appreciation));
    }
    
    // Credit score adjustments
    if (newSt.debt > 50000) newSt.credit = clamp(newSt.credit - 2, 300, 850);
    else if (newSt.debt < 5000) newSt.credit = clamp(newSt.credit + 1, 300, 850);
    
    // Age
    newChar.age += 1;
    newChar.kids = newChar.kids.map(k => ({ ...k, age: k.age + 1 }));
    
    // Hidden score drift
    if (newSt.cash > 10000) newHidden.stress = clamp(newHidden.stress - 2, 0, 100);
    if (newSt.debt > 30000) newHidden.stress = clamp(newHidden.stress + 1, 0, 100);
    newHidden.heat = clamp(newHidden.heat - 1, 0, 100);
    
    return { st: newSt, char: newChar, hidden: newHidden };
  };
  
  // Handle swipe
  const swipe = (dir) => {
    if (!card) return;
    
    const choice = dir === 'right' ? card.right : card.left;
    
    // Play sound
    if (dir === 'right') sfx.yes();
    else sfx.no();
    
    let newSt = { ...st };
    let newChar = { ...char };
    let newHidden = { ...hidden };
    let newEcon = econ;
    let newEconTimer = econTimer + 1;
    
    // Event cards
    if (card.isEvent) {
      if (card.imp) {
        Object.entries(card.imp).forEach(([k, v]) => {
          if (k in newSt) newSt[k] = Math.max(k === 'credit' ? 300 : 0, newSt[k] + v);
        });
      }
      if (card.positive) sfx.good();
      else sfx.bad();
    } else if (choice) {
      // Apply impacts
      if (choice.imp) {
        Object.entries(choice.imp).forEach(([k, v]) => {
          if (k in newSt) newSt[k] = Math.max(k === 'credit' ? 300 : 0, newSt[k] + v);
        });
      }
      
      // Relationship
      if (choice.setRel) {
        newChar.rel = choice.setRel;
        if (choice.setRel === 'married') sfx.marry();
      }
      
      // Housing
      if (choice.setHousing) newChar.housing = choice.setHousing;
      
      // Benefits
      if (choice.setFoodStamps) newChar.foodStamps = true;
      if (choice.setSection8) newChar.section8 = true;
      
      // Spawn kid
      if (choice.spawnKid) {
        const kidGender = Math.random() < 0.5 ? 'm' : 'f';
        const kidName = pick(KID_NAMES[kidGender]);
        newChar.kids = [...newChar.kids, { id: uid(), name: kidName, gender: kidGender, age: 0, invested: 0 }];
        sfx.baby();
      }
      
      // Kid investment
      if (choice.kidInvest) {
        newChar.kids = newChar.kids.map(k => 
          k.id === choice.kidInvest.id ? { ...k, invested: (k.invested || 0) + choice.kidInvest.amt } : k
        );
      }
      
      // Discipline
      if (choice.addDiscipline) newHidden.discipline = clamp(newHidden.discipline + choice.addDiscipline, 0, 100);
      
      // Crime
      if (choice.crime) {
        sfx.crime();
        const { reward, debtClear, risk, jail } = choice.crime;
        const caught = Math.random() < risk;
        
        if (caught) {
          sfx.caught();
          newChar.inJail = true;
          newChar.jailTime = jail;
          newChar.record = true;
          newSt.happy = clamp(newSt.happy - 30, 0, 100);
          newSt.credit = clamp(newSt.credit - 50, 300, 850);
          newSt.income = Math.round(newSt.income * 0.7);
          newHidden.heat = clamp(newHidden.heat + 30, 0, 100);
          newHidden.reputation = clamp(newHidden.reputation - 20, 0, 100);
          setToast({ text: 'üöî CAUGHT! Going to jail...', type: 'negative' });
        } else {
          if (reward) newSt.cash += reward;
          if (debtClear) newSt.debt = Math.max(0, newSt.debt - debtClear);
          newHidden.heat = clamp(newHidden.heat + 15, 0, 100);
          newHidden.stress = clamp(newHidden.stress + 10, 0, 100);
          newHidden.discipline = clamp(newHidden.discipline - 5, 0, 100);
          sfx.money();
        }
      }
      
      // Jail serve time
      if (choice.serveTime && newChar.inJail) {
        newChar.jailTime -= 1;
        if (newChar.jailTime <= 0) {
          newChar.inJail = false;
          newChar.jailTime = 0;
          sfx.free();
          setToast({ text: 'üéâ Released from jail!', type: 'positive' });
        }
      }
      
      // Background check
      if (choice.bgCheck) {
        if (Math.random() < 0.5) {
          newSt.income += 400;
          newSt.happy += 15;
          sfx.good();
          setToast({ text: '‚úÖ Hired despite record!', type: 'positive' });
        } else {
          newSt.happy -= 15;
          sfx.bad();
          setToast({ text: '‚ùå Rejected due to record', type: 'negative' });
        }
      }
      
      // Business
      if (choice.startBiz) {
        newChar.biz = { stage: 'starter', revenue: rand(15000, 25000), employees: 0 };
        newHidden.discipline = clamp(newHidden.discipline + 5, 0, 100);
        sfx.good();
      }
      
      if (choice.bizDecision) {
        if (choice.bizDecision === 'reinvest' && newChar.biz) {
          newChar.biz.revenue = Math.round(newChar.biz.revenue * 1.15);
        }
        if (choice.bizDecision === 'hire' && newChar.biz) {
          newChar.biz.employees = (newChar.biz.employees || 0) + 1;
        }
      }
    }
    
    // Process monthly
    if (!newChar.inJail || (card.left && card.left.serveTime)) {
      const processed = processMonth(newSt, newChar, newHidden, newEcon);
      newSt = processed.st;
      newChar = processed.char;
      newHidden = processed.hidden;
    }
    
    // Economy cycle
    if (newEconTimer >= rand(8, 15)) {
      const idx = ECONOMY.findIndex(e => e.id === newEcon.id);
      newEcon = ECONOMY[(idx + 1) % ECONOMY.length];
      newEconTimer = 0;
    }
    
    // Update state
    setSt(newSt);
    setChar(newChar);
    setHidden(newHidden);
    setEcon(newEcon);
    setEconTimer(newEconTimer);
    
    // Check achievements
    checkAchievements(newSt, newChar, gen);
    
    // Check end conditions
    if (newChar.age >= 65) {
      endGame('retire');
    } else if (newSt.health <= 0) {
      endGame('health');
    } else if (netWorth(newSt) < -150000) {
      endGame('bankrupt');
    } else {
      // Draw next card
      setTimeout(() => drawCard(newSt, newChar, newHidden, newEcon), 300);
    }
  };
  
  // End game
  const endGame = (reason) => {
    const nw = netWorth(st);
    const kidInvest = char.kids.reduce((a, k) => a + (k.invested || 0), 0);
    
    setHist(prev => [...prev, {
      gen,
      name: char.name,
      age: char.age,
      reason,
      netWorth: nw,
      kids: char.kids.length,
      kidInvest,
      record: char.record,
    }]);
    
    setDynWealth(prev => prev + Math.max(0, nw));
    
    if (reason === 'retire') {
      sfx.lvl();
    } else {
      sfx.bad();
    }
    
    setScreen('transition');
  };
  
  // Start next generation
  const nextGen = () => {
    if (!heirName || !heirCareer || !heirStyle) return;
    
    sfx.lvl();
    
    const nw = netWorth(st);
    const kidInvest = char.kids.reduce((a, k) => a + (k.invested || 0), 0);
    const inheritance = Math.round(nw * 0.6) + Math.round(kidInvest * 0.5);
    const familySupport = char.kids.length * 200;
    const wisdom = Math.round((st.health + st.happy) / 4);
    
    const careerData = CAREERS.find(c => c.id === heirCareer);
    const style = CHAR_STYLES[heirGender].find(s => s.id === heirStyle);
    
    const newChar = {
      name: heirName,
      gender: heirGender,
      style,
      age: 18 + careerData.time,
      career: heirCareer,
      rel: 'single',
      kids: [],
      housing: 'parents',
      foodStamps: false,
      section8: false,
      inJail: false,
      jailTime: 0,
      record: false,
      biz: null,
    };
    
    const newSt = {
      cash: Math.max(0, inheritance) + 500,
      income: careerData.start + familySupport + Math.round(wisdom * 10),
      debt: careerData.edu + (inheritance < 0 ? Math.abs(inheritance) * 0.3 : 0),
      invest: 0,
      credit: clamp(620 + Math.round(wisdom / 2), 300, 850),
      health: 100,
      happy: 70,
      equity: 0,
      mortgage: 0,
    };
    
    const newHidden = { discipline: 50, reputation: 50, stress: 30, heat: 0 };
    
    setChar(newChar);
    setSt(newSt);
    setHidden(newHidden);
    setGen(prev => prev + 1);
    setEcon(ECONOMY[1]);
    setEconTimer(0);
    setHeirName('');
    setHeirGender('m');
    setHeirStyle(null);
    setHeirCareer(null);
    setScreen('game');
    
    setTimeout(() => drawCard(newSt, newChar, newHidden, ECONOMY[1]), 200);
  };
  
  // Drag handlers
  const handleDragStart = (clientX) => {
    startX.current = clientX;
    setDragging(true);
  };
  
  const handleDragMove = (clientX) => {
    if (!dragging) return;
    const diff = clientX - startX.current;
    setCardOffset(diff);
  };
  
  const handleDragEnd = () => {
    setDragging(false);
    if (Math.abs(cardOffset) > 80) {
      swipe(cardOffset > 0 ? 'right' : 'left');
    }
    setCardOffset(0);
  };
  
  // Pay debt
  const payDebt = (amount) => {
    if (st.cash < amount || st.debt <= 0) return;
    const payment = Math.min(amount, st.debt);
    setSt(prev => ({
      ...prev,
      cash: prev.cash - payment,
      debt: Math.max(0, prev.debt - payment),
      credit: clamp(prev.credit + Math.floor(payment / 200), prev.credit, 850),
    }));
    sfx.money();
    setToast({ text: `Paid ${fmt(payment)} toward debt!`, type: 'positive' });
  };
  
  // Render helpers
  const hasSave = loadGame() !== null;
  
  // ============================================
  // RENDER
  // ============================================
  return (
    <div className="app">
      {/* ===== TITLE SCREEN ===== */}
      {screen === 'title' && (
        <div className="title-screen">
          <div className="title-crown">üëë</div>
          <div className="title-main">KNIGHT TYCOON</div>
          <div className="title-sub">Ultimate Edition</div>
          <div className="version">V5.0</div>
          
          <div className="title-features">
            <div className="title-feature">
              <div className="title-feature-icon">üí∞</div>
              <span>Build generational wealth</span>
            </div>
            <div className="title-feature">
              <div className="title-feature-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
              <span>Start a family, invest in kids</span>
            </div>
            <div className="title-feature">
              <div className="title-feature-icon">üè¢</div>
              <span>Start a business, become a millionaire</span>
            </div>
            <div className="title-feature">
              <div className="title-feature-icon">‚öñÔ∏è</div>
              <span>Crime is tempting but risky</span>
            </div>
          </div>
          
          <div className="title-buttons">
            {hasSave && (
              <button className="btn btn-primary btn-full" onClick={continueGame}>
                ‚ñ∂Ô∏è Continue Game
              </button>
            )}
            <button className={`btn ${hasSave ? 'btn-secondary' : 'btn-primary'} btn-full`} onClick={() => { sfx.click(); setScreen('setup'); setSetupStep(0); }}>
              {hasSave ? 'New Game' : 'Start New Dynasty'}
            </button>
          </div>
        </div>
      )}
      
      {/* ===== SETUP SCREEN ===== */}
      {screen === 'setup' && (
        <div className="scroll">
          <div className="header">
            <button className="icon-btn" onClick={() => setupStep > 0 ? setSetupStep(setupStep - 1) : setScreen('title')}>‚Üê</button>
            <div className="logo">Create Character</div>
            <div className="version">Step {setupStep + 1}/2</div>
          </div>
          
          {setupStep === 0 && (
            <div className="setup-step">
              <div className="card" style={{ marginTop: 12 }}>
                <div className="setup-title">Who are you?</div>
                <div className="setup-subtitle">Create your character</div>
                
                <div className="form-group">
                  <label className="form-label">First Name</label>
                  <input className="form-input" value={firstName} onChange={e => setFirstName(e.target.value)} placeholder="Enter name" maxLength={12} />
                </div>
                
                <div className="form-group">
                  <label className="form-label">Family Name</label>
                  <input className="form-input" value={lastName} onChange={e => setLastName(e.target.value)} placeholder="Dynasty name" maxLength={12} />
                </div>
                
                <div className="form-group">
                  <label className="form-label">Gender</label>
                  <div className="option-grid">
                    <div className={`option ${gender === 'm' ? 'selected' : ''}`} onClick={() => { sfx.click(); setGender('m'); setCharStyle(null); }}>
                      <div className="option-icon">üë®</div>
                      <div className="option-title">Male</div>
                    </div>
                    <div className={`option ${gender === 'f' ? 'selected' : ''}`} onClick={() => { sfx.click(); setGender('f'); setCharStyle(null); }}>
                      <div className="option-icon">üë©</div>
                      <div className="option-title">Female</div>
                    </div>
                  </div>
                </div>
                
                <div className="form-group">
                  <label className="form-label">Character Style</label>
                  <div className="char-grid">
                    {CHAR_STYLES[gender].map(s => (
                      <div key={s.id} className={`char-option ${charStyle === s.id ? 'selected' : ''}`} onClick={() => { sfx.click(); setCharStyle(s.id); }}>
                        <PixelChar style={s} gender={gender} size="sm" />
                        <div className="char-name">{s.name}</div>
                      </div>
                    ))}
                  </div>
                </div>
                
                <button className="btn btn-primary btn-full" onClick={() => { sfx.click(); setSetupStep(1); }} disabled={!firstName || !lastName || !charStyle}>
                  Next ‚Üí
                </button>
              </div>
            </div>
          )}
          
          {setupStep === 1 && (
            <div className="setup-step">
              <div className="card" style={{ marginTop: 12 }}>
                <div className="setup-title">Choose Your Path</div>
                <div className="setup-subtitle">Select a career to start</div>
                
                <div className="form-group">
                  <label className="form-label">Career Path</label>
                  <div className="option-grid">
                    {CAREERS.map(c => (
                      <div key={c.id} className={`option ${career === c.id ? 'selected' : ''}`} onClick={() => { sfx.click(); setCareer(c.id); }}>
                        <div className="option-icon">{c.icon}</div>
                        <div className="option-title">{c.name}</div>
                        <div className="option-desc">{c.desc}</div>
                        <div style={{ fontSize: 10, color: 'var(--gold)', marginTop: 6 }}>${c.start.toLocaleString()}/mo</div>
                        <div style={{ fontSize: 9, color: 'var(--text-dim)' }}>{c.time}yr ‚Ä¢ {fmt(c.edu)} debt</div>
                      </div>
                    ))}
                  </div>
                </div>
                
                <div style={{ display: 'flex', alignItems: 'center', gap: 16, padding: 16, background: 'rgba(255,255,255,0.03)', borderRadius: 12, marginBottom: 16 }}>
                  <PixelChar style={CHAR_STYLES[gender].find(s => s.id === charStyle)} gender={gender} size="lg" />
                  <div>
                    <div style={{ fontSize: 18, fontWeight: 800 }}>{firstName} {lastName}</div>
                    <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>{career ? CAREERS.find(c => c.id === career)?.name : 'Choose career'}</div>
                  </div>
                </div>
                
                <button className="btn btn-primary btn-full" onClick={startGame} disabled={!career}>
                  Start Journey ‚Üí
                </button>
              </div>
            </div>
          )}
        </div>
      )}
      
      {/* ===== GAME SCREEN ===== */}
      {screen === 'game' && char && st && (
        <>
          <div className="header">
            <div className="logo">Knight Tycoon</div>
            <div className="header-actions">
              <span style={{ fontSize: 10, color: 'var(--green)', marginRight: 4 }}>‚úì Saved</span>
              <button className={`icon-btn ${musicOn ? 'active' : ''}`} onClick={() => setMusicOn(!musicOn)}>
                {musicOn ? 'üéµ' : 'üîá'}
              </button>
              <button className="icon-btn" onClick={() => setModal('settings')}>‚öôÔ∏è</button>
            </div>
          </div>
          
          <div className="scroll">
            {/* Player Bar */}
            <div className="player-bar">
              <PixelChar style={char.style} gender={char.gender} size="sm" />
              <div className="player-info">
                <div className="player-name">{char.name} {lastName}</div>
                <div className="player-meta">
                  <span className="player-meta-item">Age {char.age}</span>
                  <span className="player-meta-item">{char.rel === 'married' ? 'üíç' : char.rel === 'engaged' ? 'üíï' : ''}</span>
                  <span className="player-meta-item">{CAREERS.find(c => c.id === char.career)?.icon}</span>
                </div>
              </div>
              <div className="gen-badge">Gen {gen}</div>
            </div>
            
            {/* Badges */}
            {(char.foodStamps || char.section8 || char.rel === 'married' || char.kids.length > 0 || char.record || char.biz) && (
              <div className="badges-row" style={{ marginTop: 8 }}>
                {char.foodStamps && <span className="badge badge-yellow">üçé SNAP</span>}
                {char.section8 && <span className="badge badge-blue">üè† Section 8</span>}
                {char.rel === 'married' && <span className="badge badge-purple">üíç Married</span>}
                {char.kids.length > 0 && <span className="badge badge-blue">üë∂ {char.kids.length} Kid{char.kids.length > 1 ? 's' : ''}</span>}
                {char.record && !char.inJail && <span className="badge badge-red">üìã Record</span>}
                {char.biz && <span className="badge badge-green">üè¢ Business</span>}
              </div>
            )}
            
            {/* Jail Bar */}
            {char.inJail && (
              <div className="jail-bar" style={{ marginTop: 8 }}>
                <div className="jail-icon">‚õìÔ∏è</div>
                <div className="jail-info">Currently Incarcerated</div>
                <div className="jail-time">{char.jailTime} yr{char.jailTime > 1 ? 's' : ''} left</div>
              </div>
            )}
            
            {/* Family Bar */}
            {char.kids.length > 0 && (
              <div className="family-bar" style={{ marginTop: 8 }}>
                <div className="family-header">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</div>
                <div className="family-kids">
                  {char.kids.map(k => (
                    <div key={k.id} className="kid-chip">
                      <span>{k.name}, {k.age}</span>
                      <span className="kid-invested">{fmt(k.invested || 0)} inv</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {/* Economy Bar */}
            <div className="economy-bar" style={{ marginTop: 8 }}>
              <div className="economy-phase">
                <div className={`economy-dot ${econ.color}`}></div>
                <span>{econ.name}</span>
              </div>
              <div className="economy-income">${st.income.toLocaleString()}/mo</div>
            </div>
            
            {/* Stats Grid */}
            <div className="stats-grid" style={{ marginTop: 8 }}>
              <div className="stat-card">
                <div className="stat-icon">üíµ</div>
                <div className={`stat-value ${st.cash >= 0 ? '' : 'negative'}`}>{fmt(st.cash)}</div>
                <div className="stat-label">Cash</div>
              </div>
              <div className="stat-card">
                <div className="stat-icon">üìà</div>
                <div className="stat-value positive">{fmt(st.invest)}</div>
                <div className="stat-label">Invested</div>
              </div>
              <div className="stat-card clickable" onClick={() => st.debt > 0 && setModal('debt')}>
                <div className="stat-icon">üí≥</div>
                <div className={`stat-value ${st.debt > 0 ? 'negative' : ''}`}>{fmt(st.debt)}</div>
                <div className="stat-label">{st.debt > 0 ? '‚Üì Tap to Pay' : 'Debt'}</div>
              </div>
            </div>
            
            <div className="stats-grid" style={{ marginTop: 8 }}>
              <div className="stat-card">
                <div className="stat-icon">üìä</div>
                <div className="stat-value">{st.credit}</div>
                <div className="stat-label">Credit</div>
                <div className="stat-bar">
                  <div className="stat-bar-fill" style={{ width: `${((st.credit - 300) / 550) * 100}%`, background: 'linear-gradient(90deg, var(--red), var(--gold), var(--green))' }}></div>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon">‚ù§Ô∏è</div>
                <div className={`stat-value ${st.health < 30 ? 'negative' : ''}`}>{st.health}%</div>
                <div className="stat-label">Health</div>
                <div className="stat-bar">
                  <div className="stat-bar-fill" style={{ width: `${st.health}%`, background: st.health > 50 ? 'var(--green)' : 'var(--red)' }}></div>
                </div>
              </div>
              <div className="stat-card">
                <div className="stat-icon">üòä</div>
                <div className="stat-value">{st.happy}%</div>
                <div className="stat-label">Happy</div>
                <div className="stat-bar">
                  <div className="stat-bar-fill" style={{ width: `${st.happy}%`, background: st.happy > 50 ? 'var(--blue)' : 'var(--red)' }}></div>
                </div>
              </div>
            </div>
            
            {/* Swipe Card */}
            <div className="card-area">
              {card && (
                <div
                  className={`swipe-card ${card.type || ''} ${cardOffset < -20 ? 'swipe-left' : ''} ${cardOffset > 20 ? 'swipe-right' : ''}`}
                  style={{
                    transform: `translateX(${cardOffset}px) rotate(${cardOffset * 0.03}deg)`,
                    transition: dragging ? 'none' : 'transform 0.2s ease',
                  }}
                  onMouseDown={e => handleDragStart(e.clientX)}
                  onMouseMove={e => handleDragMove(e.clientX)}
                  onMouseUp={handleDragEnd}
                  onMouseLeave={() => dragging && handleDragEnd()}
                  onTouchStart={e => handleDragStart(e.touches[0].clientX)}
                  onTouchMove={e => handleDragMove(e.touches[0].clientX)}
                  onTouchEnd={handleDragEnd}
                >
                  <div className="card-header">
                    <div>
                      <div className="card-category">{card.cat}</div>
                      <div className="card-title">{card.title}</div>
                    </div>
                    <div className="card-icon">{card.icon}</div>
                  </div>
                  
                  <div className="card-desc">{card.desc}</div>
                  
                  {card.isEvent ? (
                    <div className="event-effects">
                      {Object.entries(card.imp).map(([k, v]) => (
                        <span key={k} className={`effect-tag ${v > 0 ? 'positive' : 'negative'}`}>
                          {k === 'cash' && `${v > 0 ? '+' : ''}${fmt(v)}`}
                          {k === 'invest' && `${v > 0 ? '+' : ''}${fmt(v)} inv`}
                          {k === 'income' && `${v > 0 ? '+' : ''}$${v}/mo`}
                          {k === 'credit' && `${v > 0 ? '+' : ''}${v} cr`}
                          {k === 'health' && `${v > 0 ? '+' : ''}${v} hp`}
                          {k === 'happy' && `${v > 0 ? '+' : ''}${v} üòä`}
                        </span>
                      ))}
                    </div>
                  ) : (
                    <div className="card-choices">
                      <div className="card-choice left">
                        <div className="choice-label">‚Üê {card.left?.label}</div>
                        <div className="choice-effect">{card.left?.effect}</div>
                      </div>
                      <div className="card-choice right">
                        <div className="choice-label">{card.right?.label} ‚Üí</div>
                        <div className="choice-effect">{card.right?.effect}</div>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
            
            {/* Action Buttons */}
            {card && !card.isEvent && card.type !== 'jail' && (
              <div className="action-buttons">
                <button className="action-btn no" onClick={() => swipe('left')}>‚úï</button>
                <button className="action-btn yes" onClick={() => swipe('right')}>‚úì</button>
              </div>
            )}
            
            {card?.isEvent && (
              <div style={{ display: 'flex', justifyContent: 'center', padding: '8px 0' }}>
                <button className="btn btn-primary" onClick={() => swipe('right')}>Continue</button>
              </div>
            )}
            
            {card?.type === 'jail' && (
              <div style={{ display: 'flex', justifyContent: 'center', padding: '8px 0' }}>
                <button className="btn btn-ghost" onClick={() => swipe('right')}>Serve Time</button>
              </div>
            )}
          </div>
        </>
      )}
      
      {/* ===== TRANSITION SCREEN ===== */}
      {screen === 'transition' && char && (
        <div className="scroll">
          <div className="end-screen" style={{ height: 'auto', paddingTop: 40 }}>
            <div className="end-icon">{char.age >= 65 ? 'üåÖ' : 'üí´'}</div>
            <div className="end-title">{char.age >= 65 ? 'Retirement' : 'End of Era'}</div>
            <div style={{ fontSize: 14, color: 'var(--text-muted)' }}>{char.name} {lastName} ‚Ä¢ Age {char.age}</div>
            
            <PixelChar style={char.style} gender={char.gender} size="lg" />
            
            <div className="end-stats">
              <div className="end-stat">
                <div className="end-stat-value">{fmt(netWorth(st))}</div>
                <div className="end-stat-label">Net Worth</div>
              </div>
              <div className="end-stat">
                <div className="end-stat-value">{char.kids.length}</div>
                <div className="end-stat-label">Children</div>
              </div>
              <div className="end-stat">
                <div className="end-stat-value">{fmt(char.kids.reduce((a, k) => a + (k.invested || 0), 0))}</div>
                <div className="end-stat-label">Kid Investments</div>
              </div>
              <div className="end-stat">
                <div className="end-stat-value">{st.credit}</div>
                <div className="end-stat-label">Credit Score</div>
              </div>
            </div>
          </div>
          
          <div className="card" style={{ margin: 16 }}>
            <div className="setup-title">Create Your Heir</div>
            <div className="setup-subtitle">Continue your dynasty</div>
            
            <div className="form-group">
              <label className="form-label">Heir Name</label>
              <input className="form-input" value={heirName} onChange={e => setHeirName(e.target.value)} placeholder="Enter name" maxLength={12} />
            </div>
            
            <div className="form-group">
              <label className="form-label">Gender</label>
              <div className="option-grid">
                <div className={`option ${heirGender === 'm' ? 'selected' : ''}`} onClick={() => { sfx.click(); setHeirGender('m'); setHeirStyle(null); }}>
                  <div className="option-icon">üë®</div>
                  <div className="option-title">Male</div>
                </div>
                <div className={`option ${heirGender === 'f' ? 'selected' : ''}`} onClick={() => { sfx.click(); setHeirGender('f'); setHeirStyle(null); }}>
                  <div className="option-icon">üë©</div>
                  <div className="option-title">Female</div>
                </div>
              </div>
            </div>
            
            <div className="form-group">
              <label className="form-label">Character Style</label>
              <div className="char-grid">
                {CHAR_STYLES[heirGender].map(s => (
                  <div key={s.id} className={`char-option ${heirStyle === s.id ? 'selected' : ''}`} onClick={() => { sfx.click(); setHeirStyle(s.id); }}>
                    <PixelChar style={s} gender={heirGender} size="sm" />
                    <div className="char-name">{s.name}</div>
                  </div>
                ))}
              </div>
            </div>
            
            <div className="form-group">
              <label className="form-label">Career Path</label>
              <div className="option-grid">
                {CAREERS.map(c => (
                  <div key={c.id} className={`option ${heirCareer === c.id ? 'selected' : ''}`} onClick={() => { sfx.click(); setHeirCareer(c.id); }}>
                    <div className="option-icon">{c.icon}</div>
                    <div className="option-title">{c.name}</div>
                  </div>
                ))}
              </div>
            </div>
            
            <button className="btn btn-primary btn-full" onClick={nextGen} disabled={!heirName || !heirStyle || !heirCareer}>
              Start Next Generation ‚Üí
            </button>
          </div>
        </div>
      )}
      
      {/* ===== MODALS ===== */}
      {modal === 'settings' && (
        <div className="modal-backdrop" onClick={() => setModal(null)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <div className="modal-title">Settings</div>
              <button className="modal-close" onClick={() => setModal(null)}>√ó</button>
            </div>
            
            <div className="setting-row">
              <span>üéµ Music</span>
              <button className={`toggle ${musicOn ? 'on' : ''}`} onClick={() => setMusicOn(!musicOn)}>
                <div className="toggle-knob"></div>
              </button>
            </div>
            
            <div className="setting-row">
              <span>üîä Sound Effects</span>
              <button className={`toggle ${sfxOn ? 'on' : ''}`} onClick={() => setSfxOn(!sfxOn)}>
                <div className="toggle-knob"></div>
              </button>
            </div>
            
            <div className="modal-divider"></div>
            
            <div style={{ fontSize: 12, color: 'var(--text-muted)', textAlign: 'center', marginBottom: 12 }}>
              Game auto-saves after every turn
            </div>
            
            <button className="btn btn-danger btn-full" onClick={() => { clearSave(); setModal(null); setScreen('title'); }}>
              Reset Game
            </button>
          </div>
        </div>
      )}
      
      {modal === 'debt' && st && (
        <div className="modal-backdrop" onClick={() => setModal(null)}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <div className="modal-title">Pay Off Debt</div>
              <button className="modal-close" onClick={() => setModal(null)}>√ó</button>
            </div>
            
            <div style={{ textAlign: 'center', marginBottom: 16 }}>
              <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>Current Debt</div>
              <div style={{ fontSize: 28, fontWeight: 800, color: 'var(--red)' }}>{fmt(st.debt)}</div>
              <div style={{ fontSize: 12, color: 'var(--text-dim)' }}>Available: {fmt(st.cash)}</div>
            </div>
            
            <div className="debt-amounts">
              {[500, 1000, 2500, 5000, 10000].map(amt => (
                <button key={amt} className="btn btn-ghost btn-sm" onClick={() => { payDebt(amt); setModal(null); }} disabled={st.cash < amt || st.debt <= 0}>
                  {fmt(amt)}
                </button>
              ))}
              <button className="btn btn-primary btn-sm" onClick={() => { payDebt(Math.min(st.cash, st.debt)); setModal(null); }} disabled={st.cash <= 0 || st.debt <= 0}>
                Pay All
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Toast */}
      {toast && (
        <div className={`toast ${toast.type || ''}`}>{toast.text}</div>
      )}
      
      {/* Achievement Popup */}
      {achievement && (
        <div className="achievement-popup">
          <div className="achievement-icon">{achievement.icon}</div>
          <div>{achievement.title}</div>
        </div>
      )}
    </div>
  );
}

// ============================================
// RENDER
// ============================================
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<Game />);
</script>
</body>
</html>
