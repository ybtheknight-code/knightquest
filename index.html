<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Knight Tycoon V4</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--gold:#D4AF37;--bg:#0A0A0A;--card:#131313;--text:#FFF;--text2:#888;--green:#22C55E;--red:#EF4444}
    html,body{height:100%;overflow:hidden}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text)}
    #root{height:100%}
    .app{max-width:420px;margin:0 auto;padding:10px 14px;height:100%;display:flex;flex-direction:column}
    
    .header{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(212,175,55,0.15);margin-bottom:8px}
    .logo{font-family:'Playfair Display',serif;font-size:18px;color:var(--gold)}
    .version{font-size:9px;color:var(--text2);background:var(--card);padding:4px 8px;border-radius:4px}
    .hdr-btns{display:flex;gap:6px}
    .icon-btn{width:34px;height:34px;border-radius:50%;background:var(--card);border:1px solid rgba(255,255,255,0.08);color:var(--text2);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .icon-btn.on{background:var(--gold);color:var(--bg)}

    /* HUMANOID AVATAR */
    .avatar{position:relative;border-radius:50%;border:2px solid var(--gold);overflow:hidden;background:#1a1a1a}
    .avatar.lg{width:80px;height:80px}
    .avatar.md{width:44px;height:44px}
    .avatar.sm{width:32px;height:32px}
    .avatar.xs{width:24px;height:24px;border-width:1px}
    .human{width:100%;height:100%;position:relative}
    .human-head{position:absolute;width:36%;height:36%;border-radius:50%;top:12%;left:32%}
    .human-shoulders{position:absolute;width:70%;height:18%;border-radius:50%;bottom:28%;left:15%}
    .human-body{position:absolute;width:55%;height:45%;border-radius:45% 45% 5% 5%;bottom:0;left:22.5%}

    /* CHARACTER BAR */
    .char-bar{display:flex;align-items:center;gap:10px;background:var(--card);padding:10px 12px;border-radius:12px;margin-bottom:8px}
    .char-info{flex:1;min-width:0}
    .char-name{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .char-meta{font-size:11px;color:var(--text2)}
    .gen-badge{background:var(--gold);color:var(--bg);font-size:10px;font-weight:700;padding:5px 10px;border-radius:6px}

    /* STATS */
    .stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:6px}
    .stat{background:var(--card);padding:8px;border-radius:8px;text-align:center}
    .stat-icon{font-size:14px}
    .stat-val{font-size:15px;font-weight:700}
    .stat-val.pos{color:var(--green)}
    .stat-val.neg{color:var(--red)}
    .stat-lbl{font-size:8px;color:var(--text2);text-transform:uppercase}
    .stat-bar{height:3px;background:rgba(255,255,255,0.1);border-radius:2px;margin-top:3px}
    .stat-fill{height:100%;border-radius:2px}

    /* CARD */
    .card-area{flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-height:160px;overflow:hidden}
    .swipe-card{position:absolute;width:calc(100% - 10px);max-width:350px;background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:16px;cursor:grab;user-select:none}
    .swipe-card:active{cursor:grabbing}
    .swipe-card.left{border-color:var(--red);box-shadow:-8px 0 20px rgba(239,68,68,0.2)}
    .swipe-card.right{border-color:var(--green);box-shadow:8px 0 20px rgba(34,197,94,0.2)}
    .swipe-card.event{border-color:rgba(212,175,55,0.3);background:linear-gradient(145deg,#1a1610,#131313)}
    .card-cat{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--text2);text-align:center;margin-bottom:6px}
    .card-icon{font-size:42px;text-align:center;margin-bottom:8px}
    .card-title{font-family:'Playfair Display',serif;font-size:20px;text-align:center;margin-bottom:6px}
    .card-desc{font-size:12px;color:var(--text2);text-align:center;line-height:1.4;margin-bottom:14px}
    
    .choices{display:flex;gap:8px}
    .choice{flex:1;padding:10px 8px;border-radius:10px;text-align:center;font-size:11px;font-weight:500}
    .choice.l{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);color:var(--red)}
    .choice.r{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);color:var(--green)}
    .choice-arrow{display:block;font-size:14px;margin-bottom:3px}
    .choice-fx{font-size:9px;margin-top:5px;opacity:0.85;line-height:1.3}

    .event-fx{display:flex;justify-content:center;gap:8px;flex-wrap:wrap}
    .fx-tag{font-size:10px;padding:5px 10px;border-radius:12px}
    .fx-tag.pos{background:rgba(34,197,94,0.12);color:var(--green)}
    .fx-tag.neg{background:rgba(239,68,68,0.12);color:var(--red)}

    /* ACTIONS */
    .actions{display:flex;justify-content:center;gap:16px;padding:10px 0}
    .act-btn{width:56px;height:56px;border-radius:50%;border:2px solid;background:transparent;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
    .act-btn.no{border-color:var(--red);color:var(--red)}
    .act-btn.no:active{background:var(--red);color:#fff;transform:scale(1.1)}
    .act-btn.yes{border-color:var(--green);color:var(--green)}
    .act-btn.yes:active{background:var(--green);color:#fff;transform:scale(1.1)}

    /* DYNASTY TREE */
    .tree{background:var(--card);border-radius:8px;padding:8px 10px;margin-bottom:6px}
    .tree-hdr{display:flex;justify-content:space-between;font-size:9px;color:var(--text2);text-transform:uppercase;margin-bottom:5px}
    .tree-val{color:var(--gold);font-weight:600}
    .tree-row{display:flex;align-items:center;gap:3px}
    .tree-line{width:8px;height:2px;background:rgba(212,175,55,0.25)}
    .tree-item{opacity:0.4}
    .tree-item.now{opacity:1}

    /* SCREENS */
    .scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:20px}
    .screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;padding:20px;z-index:100;overflow-y:auto}
    .screen-icon{font-size:56px;margin:20px 0 14px;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
    .screen-title{font-family:'Playfair Display',serif;font-size:28px;color:var(--gold);margin-bottom:8px;text-align:center}
    .screen-sub{font-size:13px;color:var(--text2);margin-bottom:18px;text-align:center}

    /* FORMS */
    .form-grp{margin-bottom:14px;width:100%;max-width:300px}
    .form-lbl{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;display:block}
    .input{width:100%;background:var(--card);border:1px solid rgba(212,175,55,0.2);padding:12px 14px;font-size:15px;color:var(--text);border-radius:10px;font-family:'Inter',sans-serif}
    .input:focus{outline:none;border-color:var(--gold)}
    .input::placeholder{color:#555}

    .gender-row{display:flex;gap:8px}
    .gender-opt{flex:1;padding:12px 8px;background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:10px;text-align:center;cursor:pointer}
    .gender-opt.sel{border-color:var(--gold);background:rgba(212,175,55,0.1)}
    .gender-icon{font-size:22px}
    .gender-lbl{font-size:10px;color:var(--text2);margin-top:2px}

    .color-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .color-opt{width:48px;height:48px;border-radius:50%;cursor:pointer;border:3px solid transparent;display:flex;align-items:center;justify-content:center;transition:all 0.15s}
    .color-opt:hover{transform:scale(1.08)}
    .color-opt.sel{border-color:#fff;box-shadow:0 0 12px rgba(255,255,255,0.3);transform:scale(1.08)}

    .preview{background:var(--card);border-radius:14px;padding:20px;text-align:center;border:1px solid rgba(212,175,55,0.15);margin:16px 0;width:100%;max-width:300px}
    .preview-name{font-family:'Playfair Display',serif;font-size:17px;color:var(--gold);margin-top:10px}
    .preview-sub{font-size:11px;color:var(--text2)}

    /* BUTTONS */
    .btn{background:linear-gradient(135deg,var(--gold),#A68B28);color:var(--bg);border:none;padding:14px 32px;font-size:14px;font-weight:600;border-radius:10px;cursor:pointer;font-family:'Inter',sans-serif;transition:all 0.15s}
    .btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(212,175,55,0.35)}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .btn-sec{background:transparent;border:1px solid var(--gold);color:var(--gold)}
    .btn-full{width:100%;max-width:300px}

    /* TITLE */
    .title-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;flex:1;padding:20px}
    .title-crown{font-size:56px;margin-bottom:12px;animation:float 3s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .title-logo{font-family:'Playfair Display',serif;font-size:34px;color:var(--gold)}
    .title-tag{color:var(--text2);margin-bottom:24px;font-size:13px}
    .howto{background:var(--card);border-radius:14px;padding:16px;margin-bottom:24px;text-align:left;max-width:300px}
    .howto h3{font-size:11px;color:var(--gold);margin-bottom:10px;text-transform:uppercase}
    .howto-item{display:flex;gap:10px;margin-bottom:8px;font-size:12px;color:var(--text2)}
    .howto-icon{font-size:16px;width:24px}

    /* INHERITANCE */
    .inh-box{background:var(--card);border-radius:12px;padding:14px;width:100%;max-width:300px;margin-bottom:16px}
    .inh-title{font-size:10px;text-transform:uppercase;color:var(--text2);margin-bottom:10px;text-align:center}
    .inh-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:12px}
    .inh-row:last-child{border:none}
    .inh-row.hl{color:var(--gold);font-weight:600}

    /* DYNASTY SUMMARY */
    .dyn-sum{background:var(--card);border-radius:12px;padding:14px;width:100%;max-width:320px}
    .dyn-mem{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
    .dyn-mem:last-child{border:none}
    .dyn-info{flex:1}
    .dyn-name{font-size:12px;font-weight:500}
    .dyn-meta{font-size:10px;color:var(--text2)}
    .dyn-worth{font-size:13px;font-weight:600}
    .dyn-total{display:flex;justify-content:space-between;padding:12px 0 0;margin-top:8px;border-top:2px solid var(--gold)}
    .dyn-total-lbl{font-size:12px;color:var(--gold);font-weight:600}
    .dyn-total-val{font-size:16px;color:var(--gold);font-weight:700}

    .promo{background:linear-gradient(135deg,#1a1510,#0f0f0f);border:1px solid rgba(212,175,55,0.2);border-radius:12px;padding:14px;margin-top:14px;text-align:center;max-width:300px}
    .promo-badge{background:var(--gold);color:var(--bg);font-size:8px;font-weight:700;padding:4px 10px;border-radius:12px;display:inline-block;margin-bottom:6px}
    .promo-title{font-family:'Playfair Display',serif;font-size:15px;margin-bottom:4px}
    .promo-desc{font-size:10px;color:var(--text2)}

    /* TOAST */
    .toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);border-radius:12px;padding:18px 28px;text-align:center;z-index:150;border:2px solid;animation:pop 0.2s}
    .toast.pos{border-color:var(--green)}
    .toast.neg{border-color:var(--red)}
    .toast-icon{font-size:26px;margin-bottom:6px}
    .toast-txt{font-size:13px;font-weight:500}
    @keyframes pop{from{opacity:0;transform:translate(-50%,-50%) scale(0.85)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}

    /* ACHIEVEMENT */
    .ach{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid var(--gold);border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:10px;z-index:200;animation:slideD 0.3s,fadeO 0.3s 2.7s forwards}
    @keyframes slideD{from{transform:translateX(-50%) translateY(-60px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
    @keyframes fadeO{to{opacity:0}}
    .ach-icon{font-size:24px}
    .ach-txt{font-size:12px;font-weight:600;color:var(--gold)}
    .ach-desc{font-size:10px;color:var(--text2)}

    /* MODAL */
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:300}
    .modal{background:var(--card);border-radius:14px;padding:18px;max-width:300px;width:100%}
    .modal-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .modal-title{font-family:'Playfair Display',serif;font-size:17px;color:var(--gold)}
    .modal-close{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,0.08);border:none;color:var(--text2);font-size:14px;cursor:pointer}
    .set-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px}
    .toggle{width:42px;height:24px;background:rgba(255,255,255,0.1);border-radius:12px;cursor:pointer;position:relative}
    .toggle.on{background:var(--green)}
    .toggle-knob{width:18px;height:18px;background:#fff;border-radius:50%;position:absolute;top:3px;left:3px;transition:transform 0.2s}
    .toggle.on .toggle-knob{transform:translateX(18px)}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const {useState,useRef,useCallback} = React;

    // SOUND
    class SFX {
      constructor(){this.ctx=null;this.on=true;this.music=true;this.loop=null}
      init(){if(!this.ctx)this.ctx=new(window.AudioContext||window.webkitAudioContext)()}
      tone(f,d,t='sine',g=0.2,dl=0){
        if(!this.ctx||!this.on)return;
        const o=this.ctx.createOscillator(),gn=this.ctx.createGain();
        o.type=t;o.frequency.value=f;
        const st=this.ctx.currentTime+dl;
        gn.gain.setValueAtTime(0,st);
        gn.gain.linearRampToValueAtTime(g,st+0.01);
        gn.gain.exponentialRampToValueAtTime(0.001,st+d);
        o.connect(gn);gn.connect(this.ctx.destination);
        o.start(st);o.stop(st+d);
      }
      right(){this.tone(349,0.08);this.tone(440,0.08,'sine',0.2,0.04);this.tone(523,0.12,'sine',0.2,0.08)}
      left(){this.tone(392,0.08);this.tone(349,0.08,'sine',0.2,0.04);this.tone(294,0.12,'sine',0.15,0.08)}
      draw(){this.tone(800,0.03,'sine',0.1)}
      good(){[262,330,392,523].forEach((n,i)=>this.tone(n,0.1,'sine',0.18,i*0.04))}
      bad(){this.tone(330,0.1,'triangle',0.12);this.tone(294,0.12,'triangle',0.12,0.08)}
      ach(){[262,330,392,523,659].forEach((n,i)=>this.tone(n,0.12,'sine',0.15,i*0.05))}
      lvl(){this.tone(262,0.2);this.tone(330,0.2,'sine',0.2,0.15);this.tone(392,0.25,'sine',0.2,0.3)}
      end(){this.tone(392,0.25);this.tone(349,0.25,'sine',0.15,0.2);this.tone(294,0.3,'sine',0.12,0.4)}
      click(){this.tone(600,0.02,'sine',0.08)}
      startMusic(){
        if(!this.ctx||!this.music||this.loop)return;
        const ch=[[131,165,196,247],[147,185,220,277],[165,208,247,311],[175,220,262,330]];
        const bass=[65,73,82,87,98,110];
        let ci=0,b=0;
        const tick=()=>{
          if(!this.music)return;
          this.tone(bass[(b+ci)%bass.length],0.3,'triangle',0.06);
          if(b%2===1)ch[ci%ch.length].forEach(f=>this.tone(f,0.2,'sine',0.03));
          b++;if(b>=8){b=0;ci=(ci+1)%ch.length}
        };
        tick();this.loop=setInterval(tick,240);
      }
      stopMusic(){if(this.loop){clearInterval(this.loop);this.loop=null}}
      toggleMusic(v){this.music=v;v?this.startMusic():this.stopMusic()}
      toggleSfx(v){this.on=v}
    }
    const sfx=new SFX();

    // DATA
    const COLORS=['#D4AF37','#3B82F6','#22C55E','#EF4444','#A855F7','#F97316','#14B8A6','#EC4899','#EAB308','#64748B','#8B5CF6','#06B6D4'];
    const GENDERS=[{id:'m',icon:'üëî',lbl:'Male'},{id:'f',icon:'üëó',lbl:'Female'},{id:'n',icon:'‚ú®',lbl:'Neutral'}];

    // DECISIONS - LOGICAL IMPACTS
    const CARDS=[
      // CAREER - Income changes
      {cat:'üíº Career',icon:'‚è∞',title:'Overtime',desc:'Boss offers extra weekend hours.',
        L:{txt:'Decline',fx:'+5 Health',imp:{health:5}},
        R:{txt:'Work Extra',fx:'+$500 Cash, -5 Health',imp:{cash:500,health:-5}}},
      {cat:'üíº Career',icon:'üìà',title:'Promotion',desc:'Management role open. More pay, more stress.',
        L:{txt:'Stay Put',fx:'+5 Happy',imp:{happy:5}},
        R:{txt:'Take It',fx:'+$600/mo, -5 Health',imp:{income:600,health:-5}}},
      {cat:'üíº Career',icon:'ü§ù',title:'Ask for Raise',desc:'Performance review time.',
        L:{txt:'Stay Quiet',fx:'-5 Happy',imp:{happy:-5}},
        R:{txt:'Negotiate',fx:'+$400/mo',imp:{income:400}}},
      {cat:'üíº Career',icon:'üåô',title:'Side Gig',desc:'Friend offers weekend freelance.',
        L:{txt:'Rest',fx:'+5 Health',imp:{health:5}},
        R:{txt:'Hustle',fx:'+$400/mo, -8 Health',imp:{income:400,health:-8}}},

      // CREDIT - Score changes
      {cat:'üìä Credit',icon:'üí≥',title:'Credit Card Offer',desc:'Pre-approved for $5K limit. Builds history.',
        L:{txt:'Decline',fx:'No change',imp:{}},
        R:{txt:'Accept',fx:'+25 Credit Score',imp:{credit:25}}},
      {cat:'üìä Credit',icon:'‚ö†Ô∏è',title:'Credit Report Error',desc:'Found a mistake. Wrong account listed.',
        L:{txt:'Ignore',fx:'-20 Credit Score',imp:{credit:-20}},
        R:{txt:'Dispute',fx:'+40 Credit Score',imp:{credit:40}}},
      {cat:'üìä Credit',icon:'üìâ',title:'High Utilization',desc:'Card 80% used. Hurts your score.',
        L:{txt:'Pay Minimum',fx:'-15 Credit Score',imp:{credit:-15}},
        R:{txt:'Pay In Full',fx:'-$1,500 Cash, +25 Credit',imp:{cash:-1500,credit:25}}},

      // INVESTMENTS - Move cash to investments
      {cat:'üìà Invest',icon:'üìä',title:'Index Funds',desc:'Advisor recommends low-cost funds.',
        L:{txt:'Keep Cash',fx:'No change',imp:{}},
        R:{txt:'Invest $1K',fx:'-$1K Cash, +$1K Invested',imp:{cash:-1000,invest:1000}}},
      {cat:'üìà Invest',icon:'üè¶',title:'401k Match',desc:'Employer matches 4%. Free money!',
        L:{txt:'Skip',fx:'-5 Happy',imp:{happy:-5}},
        R:{txt:'Max Match',fx:'-$200/mo, +$400 Invested',imp:{income:-200,invest:400}}},
      {cat:'üìà Invest',icon:'üíπ',title:'Dividend Stocks',desc:'Build passive income.',
        L:{txt:'Pass',fx:'No change',imp:{}},
        R:{txt:'Invest $1.5K',fx:'-$1.5K Cash, +$1.5K Invested, +$50/mo',imp:{cash:-1500,invest:1500,income:50}}},

      // DEBT - Take on or pay off debt
      {cat:'üí≥ Debt',icon:'üìâ',title:'Pay Down Debt',desc:'Use savings to reduce what you owe.',
        L:{txt:'Keep Savings',fx:'No change',imp:{}},
        R:{txt:'Pay $2K',fx:'-$2K Cash, -$2K Debt, +20 Credit',imp:{cash:-2000,debt:-2000,credit:20}}},
      {cat:'üí≥ Debt',icon:'üè¶',title:'Personal Loan',desc:'Bank offers $10K at 12% APR.',
        L:{txt:'Decline',fx:'No change',imp:{}},
        R:{txt:'Take Loan',fx:'+$10K Cash, +$10K Debt',imp:{cash:10000,debt:10000}}},

      // HEALTH - Affects health stat
      {cat:'‚ù§Ô∏è Health',icon:'üè•',title:'Doctor Visit',desc:'Annual checkup catches problems early.',
        L:{txt:'Skip',fx:'-12 Health',imp:{health:-12}},
        R:{txt:'Go',fx:'-$200 Cash, +15 Health',imp:{cash:-200,health:15}}},
      {cat:'‚ù§Ô∏è Health',icon:'üí™',title:'Gym Membership',desc:'$50/month for fitness.',
        L:{txt:'Exercise Free',fx:'+3 Health',imp:{health:3}},
        R:{txt:'Join Gym',fx:'-$50 Cash, +12 Health, +5 Happy',imp:{cash:-50,health:12,happy:5}}},
      {cat:'‚ù§Ô∏è Health',icon:'üò¥',title:'Sleep Schedule',desc:'Been staying up too late.',
        L:{txt:'Night Owl',fx:'-10 Health, +3 Happy',imp:{health:-10,happy:3}},
        R:{txt:'Fix Sleep',fx:'+15 Health',imp:{health:15}}},
      {cat:'‚ù§Ô∏è Health',icon:'üß†',title:'Therapy',desc:'Stress is high. Talk to someone?',
        L:{txt:'Handle Alone',fx:'-10 Happy',imp:{happy:-10}},
        R:{txt:'Start Therapy',fx:'-$200 Cash, +25 Happy, +5 Health',imp:{cash:-200,happy:25,health:5}}},

      // LIFESTYLE - Cash and happiness
      {cat:'üåü Life',icon:'‚úàÔ∏è',title:'Vacation',desc:'You need a break from work.',
        L:{txt:'Staycation',fx:'+8 Happy, +5 Health',imp:{happy:8,health:5}},
        R:{txt:'Travel',fx:'-$1,500 Cash, +25 Happy, +10 Health',imp:{cash:-1500,happy:25,health:10}}},
      {cat:'üåü Life',icon:'üöó',title:'Car Repair',desc:'Car needs $800 in repairs.',
        L:{txt:'Use Transit',fx:'-$100/mo, -10 Happy',imp:{income:-100,happy:-10}},
        R:{txt:'Fix It',fx:'-$800 Cash',imp:{cash:-800}}},
      {cat:'üåü Life',icon:'üé®',title:'New Hobby',desc:'Want to start something new.',
        L:{txt:'No Time',fx:'-5 Happy',imp:{happy:-5}},
        R:{txt:'Start Hobby',fx:'-$200 Cash, +18 Happy',imp:{cash:-200,happy:18}}},

      // EDUCATION - Income boost
      {cat:'üìö Learn',icon:'üìú',title:'Certification',desc:'Professional cert boosts career.',
        L:{txt:'Self-Learn',fx:'+$75/mo',imp:{income:75}},
        R:{txt:'Get Cert',fx:'-$1,500 Cash, +$400/mo',imp:{cash:-1500,income:400}}},
      {cat:'üìö Learn',icon:'üéì',title:'Mentorship',desc:'Successful person offers guidance.',
        L:{txt:'Decline',fx:'No change',imp:{}},
        R:{txt:'Accept',fx:'+$200/mo, +10 Happy',imp:{income:200,happy:10}}},

      // PROPERTY
      {cat:'üè† Property',icon:'üè†',title:'Buy Home',desc:'Qualified for mortgage. Build equity.',
        L:{txt:'Keep Renting',fx:'-5 Happy',imp:{happy:-5}},
        R:{txt:'Buy',fx:'-$25K Cash, +$150K Debt, +$30K Invested, +15 Happy',imp:{cash:-25000,debt:150000,invest:30000,happy:15}}},
    ];

    // EVENTS
    const EVENTS=[
      {icon:'üéâ',title:'Work Bonus!',desc:'Great work rewarded!',imp:{cash:2500},pos:true},
      {icon:'üíî',title:'Breakup',desc:'Relationship ended.',imp:{happy:-25},pos:false},
      {icon:'üèÜ',title:'Award',desc:'Recognized at work!',imp:{income:200,happy:10},pos:true},
      {icon:'üò∑',title:'Got Sick',desc:'Down for a week.',imp:{health:-20,cash:-400},pos:false},
      {icon:'üìâ',title:'Market Crash',desc:'Investments dropped.',imp:{invest:-1000},pos:false},
      {icon:'üìà',title:'Market Boom',desc:'Investments grew!',imp:{invest:1500},pos:true},
      {icon:'üöó',title:'Car Accident',desc:'Fender bender.',imp:{cash:-700},pos:false},
      {icon:'üí≥',title:'Cash Back',desc:'Credit rewards!',imp:{cash:300},pos:true},
      {icon:'üéÅ',title:'Inheritance',desc:'Relative left money.',imp:{cash:5000},pos:true},
      {icon:'‚ö°',title:'Appliance Broke',desc:'Need replacement.',imp:{cash:-600},pos:false},
      {icon:'üìû',title:'Debt Collector',desc:'Stressful call about debt.',imp:{happy:-15,credit:-10},pos:false},
      {icon:'üè•',title:'Medical Bill',desc:'Unexpected medical expense.',imp:{cash:-1200},pos:false},
      {icon:'üíº',title:'Layoff Scare',desc:'Company downsizing. Stressful.',imp:{happy:-20},pos:false},
      {icon:'üé∞',title:'Lucky Day',desc:'Found money in old jacket!',imp:{cash:200,happy:5},pos:true},
      {icon:'üì±',title:'Phone Died',desc:'Need a new phone.',imp:{cash:-800},pos:false},
      {icon:'üè†',title:'Rent Went Up',desc:'Landlord raised rent.',imp:{income:-150},pos:false},
    ];

    const ACHS=[
      {id:'100k',icon:'üí∞',t:'Six Figures',d:'$100K net worth',ck:s=>nw(s)>=100000},
      {id:'cr750',icon:'üìä',t:'Credit Elite',d:'750 credit',ck:s=>s.credit>=750},
      {id:'df',icon:'üéâ',t:'Debt Free',d:'Zero debt',ck:s=>s.debt===0&&s.cash>0},
      {id:'inv50',icon:'üìà',t:'Investor',d:'$50K invested',ck:s=>s.invest>=50000},
      {id:'mil',icon:'üëë',t:'Millionaire',d:'$1M net worth',ck:s=>nw(s)>=1000000},
      {id:'g3',icon:'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',t:'Dynasty',d:'Gen 3',ck:(s,g)=>g>=3},
    ];

    const fmt=n=>{const a=Math.abs(n),s=n<0?'-':'';return a>=1e6?`${s}$${(a/1e6).toFixed(1)}M`:a>=1e3?`${s}$${(a/1e3).toFixed(1)}K`:`${s}$${Math.round(a)}`};
    const nw=s=>s.cash+s.invest-s.debt;
    const clamp=(v,mn,mx)=>Math.min(mx,Math.max(mn,v));

    // HUMANOID AVATAR
    const Avatar=({color,size='md'})=>(
      <div className={`avatar ${size}`}>
        <div className="human">
          <div className="human-head" style={{background:color}}/>
          <div className="human-shoulders" style={{background:color}}/>
          <div className="human-body" style={{background:color}}/>
        </div>
      </div>
    );

    // MAIN
    function Game(){
      const[scr,setScr]=useState('title');
      const[famName,setFamName]=useState('');
      const[firstName,setFirstName]=useState('');
      const[gender,setGender]=useState('n');
      const[color,setColor]=useState(0);
      const[musicOn,setMusicOn]=useState(true);
      const[sfxOn,setSfxOn]=useState(true);
      const[modal,setModal]=useState(false);
      const[gen,setGen]=useState(1);
      const[hist,setHist]=useState([]);
      const[dynW,setDynW]=useState(0);
      const[achs,setAchs]=useState([]);
      const[char,setChar]=useState(null);
      const[st,setSt]=useState(null);
      const[card,setCard]=useState(null);
      const[off,setOff]=useState(0);
      const[drag,setDrag]=useState(false);
      const[toast,setToast]=useState(null);
      const[used,setUsed]=useState([]);
      const[ach,setAch]=useState(null);
      const[heirN,setHeirN]=useState('');
      const[heirG,setHeirG]=useState('n');
      const sx=useRef(0);

      const init=useCallback(()=>{sfx.init();if(musicOn)sfx.startMusic()},[musicOn]);

      const checkAch=useCallback((state,g)=>{
        ACHS.forEach(a=>{
          if(!achs.includes(a.id)&&a.ck(state,g)){
            setAchs(p=>[...p,a.id]);
            setAch(a);sfx.ach();
            setTimeout(()=>setAch(null),3000);
          }
        });
      },[achs]);

      const start=()=>{
        if(!famName||!firstName)return;
        init();sfx.click();
        setChar({name:firstName,gender,color:COLORS[color],age:18});
        setSt({cash:500,income:2200,debt:0,invest:0,credit:620,health:100,happy:70});
        setGen(1);setHist([]);setDynW(0);setUsed([]);setAchs([]);
        setScr('game');
        setTimeout(draw,200);
      };

      const draw=()=>{
        sfx.draw();
        if(Math.random()<0.12){
          setCard({...EVENTS[Math.floor(Math.random()*EVENTS.length)],ev:true});
        }else{
          let av=CARDS.filter((_,i)=>!used.includes(i));
          if(av.length<3){setUsed([]);av=CARDS}
          const idx=Math.floor(Math.random()*av.length);
          const realIdx=CARDS.indexOf(av[idx]);
          setCard({...av[idx],idx:realIdx});
          setUsed(p=>[...p,realIdx]);
        }
        setOff(0);
      };

      const apply=imp=>{
        setSt(p=>{
          let newCash = p.cash + (imp.cash||0);
          let newDebt = Math.max(0, p.debt + (imp.debt||0));
          let newCredit = p.credit + (imp.credit||0);
          let newHappy = p.happy + (imp.happy||0);
          
          // NEGATIVE CASH ‚Üí CONVERTS TO DEBT
          if(newCash < 0) {
            newDebt += Math.abs(newCash);
            newCash = 0;
          }
          
          // DEBT PENALTIES
          // High debt hurts credit score monthly
          if(newDebt > 10000) newCredit -= 2;
          if(newDebt > 50000) newCredit -= 3;
          if(newDebt > 100000) newCredit -= 5;
          
          // Debt stress reduces happiness
          if(newDebt > p.income * 12) newHappy -= 2; // Debt > 1 year income
          if(newDebt > p.income * 24) newHappy -= 3; // Debt > 2 years income
          
          return {
            ...p,
            cash: newCash,
            income: p.income + (imp.income||0),
            debt: newDebt,
            invest: Math.max(0, p.invest + (imp.invest||0)),
            credit: clamp(newCredit, 300, 850),
            health: clamp(p.health + (imp.health||0), 0, 100),
            happy: clamp(newHappy, 0, 100),
          };
        });
      };

      const swipe=dir=>{
        if(!card)return;
        dir==='right'?sfx.right():sfx.left();
        let imp,txt,pos;
        if(card.ev){
          imp=card.imp;txt=card.title;pos=card.pos;
        }else{
          const ch=dir==='left'?card.L:card.R;
          imp=ch.imp;txt=ch.txt;pos=(imp.cash>0||imp.income>0||imp.invest>0||imp.credit>0);
        }
        apply(imp);
        setToast({txt,pos});pos?sfx.good():sfx.bad();
        setTimeout(()=>setToast(null),900);
        setChar(p=>({...p,age:p.age+1}));
        
        // MONTHLY PROCESSING
        setSt(p=>{
          const debtInterest = p.debt * 0.02; // 2% monthly interest on debt (24% APR)
          const livingCost = 2000;
          const monthlyNet = p.income - livingCost - debtInterest;
          let newCash = p.cash + monthlyNet;
          let newDebt = p.debt;
          let newInvest = p.invest + p.invest * 0.005; // 0.5% monthly growth
          
          // If can't afford monthly costs, add to debt
          if(newCash < 0) {
            newDebt += Math.abs(newCash);
            newCash = 0;
          }
          
          return {...p, cash: newCash, debt: newDebt, invest: newInvest};
        });
        
        setTimeout(()=>{checkAch(st,gen);check()},250);
      };

      const check=()=>{
        if(char.age>=65)endGame('retire');
        else if(st.health<=0)endGame('health');
        else if(nw(st)<-100000)endGame('broke');
        else draw();
      };

      const endGame=cause=>{
        cause==='retire'?sfx.lvl():sfx.end();
        const w=nw(st);
        const inh=cause==='broke'?Math.floor(w*0.2):Math.floor(w*0.7);
        setHist(p=>[...p,{name:char.name,color:char.color,age:char.age,worth:w,cause}]);
        setDynW(p=>p+w);
        setSt(p=>({...p,inh,wb:Math.floor((p.happy+p.health)/10)}));
        if(gen>=5||(cause==='broke'&&w<-50000))setScr('end');
        else{setHeirN('');setHeirG('n');setScr('trans')}
      };

      const nextGen=()=>{
        if(!heirN)return;
        sfx.lvl();
        const inh=st.inh||0,wb=st.wb||0;
        setChar({name:heirN,gender:heirG,color:COLORS[(color+gen)%COLORS.length],age:18});
        setSt({
          cash:Math.max(0,inh)+500,
          income:2200+wb*15,
          debt:inh<0?Math.abs(inh)*0.4:0,
          invest:0,
          credit:620+Math.floor(wb/2),
          health:100,happy:70,
        });
        setGen(p=>p+1);setUsed([]);setScr('game');
        setTimeout(draw,200);
      };

      const ds=x=>{sx.current=x;setDrag(true)};
      const dm=x=>{if(drag)setOff(x-sx.current)};
      const de=()=>{setDrag(false);if(Math.abs(off)>60)swipe(off<0?'left':'right');setOff(0)};
      const togM=()=>{const v=!musicOn;setMusicOn(v);sfx.toggleMusic(v)};
      const togS=()=>{const v=!sfxOn;setSfxOn(v);sfx.toggleSfx(v)};

      const netW=st?nw(st):0;

      return(
        <div className="app">
          {ach&&<div className="ach"><div className="ach-icon">{ach.icon}</div><div><div className="ach-txt">{ach.t}</div><div className="ach-desc">{ach.d}</div></div></div>}

          {modal&&(
            <div className="modal-bg" onClick={()=>setModal(false)}>
              <div className="modal" onClick={e=>e.stopPropagation()}>
                <div className="modal-hdr"><div className="modal-title">Settings</div><button className="modal-close" onClick={()=>setModal(false)}>√ó</button></div>
                <div className="set-row"><span>üéµ Music</span><div className={`toggle ${musicOn?'on':''}`} onClick={togM}><div className="toggle-knob"/></div></div>
                <div className="set-row"><span>üîä Sound</span><div className={`toggle ${sfxOn?'on':''}`} onClick={togS}><div className="toggle-knob"/></div></div>
              </div>
            </div>
          )}

          {scr==='title'&&(
            <div className="title-screen">
              <div className="title-crown">üëë</div>
              <div className="title-logo">Knight Tycoon</div>
              <div className="title-tag">Build a dynasty. Leave a legacy.</div>
              <div className="version">VERSION 4.1</div>
              <div className="howto">
                <h3>How to Play</h3>
                <div className="howto-item"><div className="howto-icon">üëàüëâ</div>Swipe to make choices</div>
                <div className="howto-item"><div className="howto-icon">üíµ</div>Manage Cash, Credit, Investments, Debt</div>
                <div className="howto-item"><div className="howto-icon">‚ù§Ô∏è</div>Keep Health & Happiness up</div>
                <div className="howto-item"><div className="howto-icon">üë∂</div>Pass wealth to heir at 65</div>
              </div>
              <button className="btn" onClick={()=>{init();sfx.click();setScr('setup')}}>Start Dynasty</button>
            </div>
          )}

          {scr==='setup'&&(
            <>
              <div className="header"><div className="logo">Knight Tycoon</div><div className="version">V4</div><button className="icon-btn" onClick={()=>setScr('title')}>‚Üê</button></div>
              <div className="scroll">
                <div className="form-grp"><label className="form-lbl">First Name</label><input className="input" value={firstName} onChange={e=>setFirstName(e.target.value)} placeholder="Your name" maxLength={12}/></div>
                <div className="form-grp"><label className="form-lbl">Family Name</label><input className="input" value={famName} onChange={e=>setFamName(e.target.value)} placeholder="Family name" maxLength={12}/></div>
                <div className="form-grp"><label className="form-lbl">Gender</label>
                  <div className="gender-row">
                    {GENDERS.map(g=><div key={g.id} className={`gender-opt ${gender===g.id?'sel':''}`} onClick={()=>{sfx.click();setGender(g.id)}}><div className="gender-icon">{g.icon}</div><div className="gender-lbl">{g.lbl}</div></div>)}
                  </div>
                </div>
                <div className="form-grp"><label className="form-lbl">Pick Your Color</label>
                  <div className="color-row">
                    {COLORS.map((c,i)=><div key={i} className={`color-opt ${color===i?'sel':''}`} onClick={()=>{sfx.click();setColor(i)}}><Avatar color={c} size="sm"/></div>)}
                  </div>
                </div>
                <div className="preview">
                  <Avatar color={COLORS[color]} size="lg"/>
                  <div className="preview-name">{firstName||'???'} {famName||'???'}</div>
                  <div className="preview-sub">Founder of the {famName||'???'} Dynasty</div>
                </div>
                <button className="btn btn-full" onClick={start} disabled={!famName||!firstName}>Begin Legacy</button>
              </div>
            </>
          )}

          {scr==='game'&&char&&st&&(
            <>
              <div className="header">
                <div className="logo">Knight Tycoon</div>
                <div className="hdr-btns">
                  <button className={`icon-btn ${musicOn?'on':''}`} onClick={togM}>{musicOn?'üéµ':'üîá'}</button>
                  <button className="icon-btn" onClick={()=>setModal(true)}>‚öôÔ∏è</button>
                </div>
              </div>

              <div className="char-bar">
                <Avatar color={char.color} size="md"/>
                <div className="char-info">
                  <div className="char-name">{char.name} {famName}</div>
                  <div className="char-meta">Age {char.age} ‚Ä¢ ${st.income.toLocaleString()}/mo</div>
                </div>
                <div className="gen-badge">Gen {gen}</div>
              </div>

              <div className="stats-row">
                <div className="stat"><div className="stat-icon">üíµ</div><div className={`stat-val ${st.cash>=0?'':'neg'}`}>{fmt(st.cash)}</div><div className="stat-lbl">Cash</div></div>
                <div className="stat"><div className="stat-icon">üìà</div><div className="stat-val pos">{fmt(st.invest)}</div><div className="stat-lbl">Invested</div></div>
                <div className="stat"><div className="stat-icon">üí≥</div><div className={`stat-val ${st.debt>0?'neg':''}`}>{fmt(st.debt)}</div><div className="stat-lbl">Debt</div></div>
              </div>
              <div className="stats-row">
                <div className="stat"><div className="stat-icon">üìä</div><div className="stat-val">{st.credit}</div><div className="stat-lbl">Credit</div><div className="stat-bar"><div className="stat-fill" style={{width:`${((st.credit-300)/550)*100}%`,background:'linear-gradient(90deg,#EF4444,#D4AF37,#22C55E)'}}/></div></div>
                <div className="stat"><div className="stat-icon">‚ù§Ô∏è</div><div className={`stat-val ${st.health<30?'neg':''}`}>{st.health}%</div><div className="stat-lbl">Health</div></div>
                <div className="stat"><div className="stat-icon">üòä</div><div className="stat-val">{st.happy}%</div><div className="stat-lbl">Happy</div></div>
              </div>

              {hist.length>0&&(
                <div className="tree">
                  <div className="tree-hdr"><span>Dynasty</span><span className="tree-val">{fmt(dynW)}</span></div>
                  <div className="tree-row">
                    {hist.slice(-3).map((m,i)=><React.Fragment key={i}><div className="tree-item"><Avatar color={m.color} size="xs"/></div><div className="tree-line"/></React.Fragment>)}
                    <div className="tree-item now"><Avatar color={char.color} size="xs"/></div>
                  </div>
                </div>
              )}

              <div className="card-area">
                {card&&(
                  <div className={`swipe-card ${card.ev?'event':''} ${off<-20?'left':''} ${off>20?'right':''}`}
                    style={{transform:`translateX(${off}px) rotate(${off*0.025}deg)`,transition:drag?'none':'transform 0.2s'}}
                    onMouseDown={e=>ds(e.clientX)} onMouseMove={e=>dm(e.clientX)} onMouseUp={de} onMouseLeave={()=>drag&&de()}
                    onTouchStart={e=>ds(e.touches[0].clientX)} onTouchMove={e=>dm(e.touches[0].clientX)} onTouchEnd={de}
                  >
                    {card.cat&&<div className="card-cat">{card.cat}</div>}
                    <div className="card-icon">{card.icon}</div>
                    <div className="card-title">{card.title}</div>
                    <div className="card-desc">{card.desc}</div>
                    {card.ev?(
                      <div className="event-fx">
                        {Object.entries(card.imp).map(([k,v])=>(
                          <span key={k} className={`fx-tag ${v>0?'pos':'neg'}`}>
                            {k==='cash'&&`${v>0?'+':''}${fmt(v)} Cash`}
                            {k==='invest'&&`${v>0?'+':''}${fmt(v)} Invested`}
                            {k==='income'&&`${v>0?'+':''}$${v}/mo`}
                            {k==='debt'&&`${v>0?'+':''}${fmt(v)} Debt`}
                            {k==='credit'&&`${v>0?'+':''}${v} Credit`}
                            {k==='health'&&`${v>0?'+':''}${v} Health`}
                            {k==='happy'&&`${v>0?'+':''}${v} Happy`}
                          </span>
                        ))}
                      </div>
                    ):(
                      <div className="choices">
                        <div className="choice l"><span className="choice-arrow">‚Üê</span>{card.L.txt}<div className="choice-fx">{card.L.fx}</div></div>
                        <div className="choice r"><span className="choice-arrow">‚Üí</span>{card.R.txt}<div className="choice-fx">{card.R.fx}</div></div>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {card&&!card.ev&&<div className="actions"><button className="act-btn no" onClick={()=>swipe('left')}>‚úï</button><button className="act-btn yes" onClick={()=>swipe('right')}>‚úì</button></div>}
              {card?.ev&&<div className="actions"><button className="btn" onClick={()=>swipe('right')}>Continue</button></div>}

              {toast&&<div className={`toast ${toast.pos?'pos':'neg'}`}><div className="toast-icon">{toast.pos?'‚úì':'‚úï'}</div><div className="toast-txt">{toast.txt}</div></div>}
            </>
          )}

          {scr==='trans'&&char&&(
            <div className="screen">
              <div className="screen-icon">{char.age>=65?'üåÖ':'üí´'}</div>
              <div className="screen-title">{char.age>=65?'Retirement':'End of Era'}</div>
              <div className="screen-sub">{char.name} {famName} ‚Ä¢ Age {char.age}</div>
              <Avatar color={char.color} size="lg"/>
              <div className="inh-box">
                <div className="inh-title">Estate</div>
                <div className="inh-row"><span>Net Worth</span><span style={{color:netW>=0?'var(--green)':'var(--red)'}}>{fmt(netW)}</span></div>
                <div className="inh-row"><span>Inheritance</span><span>{fmt(st.inh||0)}</span></div>
                <div className="inh-row hl"><span>Dynasty Total</span><span>{fmt(dynW)}</span></div>
              </div>
              <div className="form-grp"><label className="form-lbl">Heir's Name</label><input className="input" value={heirN} onChange={e=>setHeirN(e.target.value)} placeholder="Name" maxLength={12}/></div>
              <div className="form-grp"><label className="form-lbl">Heir's Gender</label>
                <div className="gender-row">{GENDERS.map(g=><div key={g.id} className={`gender-opt ${heirG===g.id?'sel':''}`} onClick={()=>{sfx.click();setHeirG(g.id)}}><div className="gender-icon">{g.icon}</div><div className="gender-lbl">{g.lbl}</div></div>)}</div>
              </div>
              <button className="btn" onClick={nextGen} disabled={!heirN}>Continue as {heirN||'Heir'} ‚Üí</button>
            </div>
          )}

          {scr==='end'&&(
            <div className="screen">
              <div className="screen-icon">üëë</div>
              <div className="screen-title">The {famName} Dynasty</div>
              <div className="screen-sub">{gen} generations</div>
              <div className="dyn-sum">
                {hist.map((m,i)=>(
                  <div key={i} className="dyn-mem">
                    <Avatar color={m.color} size="xs"/>
                    <div className="dyn-info"><div className="dyn-name">{m.name} {famName}</div><div className="dyn-meta">Gen {i+1} ‚Ä¢ Age {m.age}</div></div>
                    <div className="dyn-worth" style={{color:m.worth>=0?'var(--green)':'var(--red)'}}>{fmt(m.worth)}</div>
                  </div>
                ))}
                <div className="dyn-total"><span className="dyn-total-lbl">Legacy</span><span className="dyn-total-val">{fmt(dynW)}</span></div>
              </div>
              <div style={{display:'flex',gap:10,marginTop:14}}>
                <button className="btn btn-sec" onClick={()=>{sfx.click();setScr('title')}}>New Game</button>
                <button className="btn" onClick={()=>{const t=`üëë ${famName} Dynasty\n${gen} gens ‚Ä¢ ${fmt(dynW)}\nKnight Tycoon V4`;navigator.share?navigator.share({text:t}):(navigator.clipboard.writeText(t),alert('Copied!'))}}>Share üì§</button>
              </div>
              <div className="promo">
                <div className="promo-badge">LEVEL UP IRL</div>
                <div className="promo-title">Build Real Wealth</div>
                <div className="promo-desc">Knight Financial ‚Ä¢ Credit & Finance Mastery</div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<Game/>,document.getElementById('root'));
  </script>
</body>
</html>
