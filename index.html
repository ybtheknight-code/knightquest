<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Knight Tycoon - Build Your Dynasty</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --gold: #D4AF37;
      --gold-light: #F4E4BC;
      --gold-dark: #A68B28;
      --bg-dark: #0D0D0D;
      --bg-card: #1A1A1A;
      --bg-card-hover: #242424;
      --text-primary: #FFFFFF;
      --text-secondary: #A0A0A0;
      --green: #4ADE80;
      --red: #F87171;
      --blue: #60A5FA;
      --purple: #A78BFA;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      overflow: hidden;
      touch-action: pan-y;
    }

    .game-container {
      max-width: 420px;
      margin: 0 auto;
      padding: 16px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      text-align: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
      margin-bottom: 12px;
      flex-shrink: 0;
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 2px;
    }

    .logo span {
      color: var(--text-primary);
    }

    /* Abstract Avatar System */
    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      margin: 0 auto 12px;
      position: relative;
      border: 3px solid var(--gold);
    }

    .avatar-small {
      width: 40px;
      height: 40px;
      font-size: 18px;
      border-width: 2px;
    }

    .avatar-tiny {
      width: 28px;
      height: 28px;
      font-size: 12px;
      border-width: 1px;
    }

    /* Character Info Bar */
    .character-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bg-card);
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 12px;
      flex-shrink: 0;
    }

    .character-info {
      flex: 1;
    }

    .character-name {
      font-weight: 600;
      font-size: 14px;
    }

    .character-age {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .generation-badge {
      background: var(--gold);
      color: var(--bg-dark);
      font-size: 10px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 12px;
    }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 12px;
      flex-shrink: 0;
    }

    .stat-box {
      background: var(--bg-card);
      padding: 10px 6px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-icon {
      font-size: 16px;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--gold);
    }

    .stat-value.positive { color: var(--green); }
    .stat-value.negative { color: var(--red); }

    .stat-label {
      font-size: 9px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Swipe Card Area */
    .card-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      min-height: 280px;
    }

    .swipe-card {
      position: absolute;
      width: 100%;
      max-width: 340px;
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 24px;
      cursor: grab;
      user-select: none;
      transition: box-shadow 0.2s;
    }

    .swipe-card:active {
      cursor: grabbing;
    }

    .swipe-card.swiping-left {
      border-color: var(--red);
      box-shadow: -8px 0 24px rgba(248, 113, 113, 0.3);
    }

    .swipe-card.swiping-right {
      border-color: var(--green);
      box-shadow: 8px 0 24px rgba(74, 222, 128, 0.3);
    }

    .card-icon {
      font-size: 48px;
      text-align: center;
      margin-bottom: 16px;
    }

    .card-title {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      text-align: center;
      margin-bottom: 8px;
    }

    .card-desc {
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    .card-choices {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .choice-hint {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 12px;
    }

    .choice-hint.left {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      color: var(--red);
    }

    .choice-hint.right {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: var(--green);
    }

    .swipe-indicators {
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      margin-bottom: 8px;
    }

    .swipe-indicator {
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Action Buttons (for non-touch) */
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 24px;
      padding: 16px 0;
      flex-shrink: 0;
    }

    .action-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2px solid;
      background: transparent;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn.decline {
      border-color: var(--red);
      color: var(--red);
    }

    .action-btn.decline:hover {
      background: var(--red);
      color: var(--bg-dark);
    }

    .action-btn.accept {
      border-color: var(--green);
      color: var(--green);
    }

    .action-btn.accept:hover {
      background: var(--green);
      color: var(--bg-dark);
    }

    /* Family Tree */
    .family-tree {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .tree-title {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      text-align: center;
    }

    .tree-members {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tree-member {
      text-align: center;
      opacity: 0.5;
    }

    .tree-member.current {
      opacity: 1;
    }

    .tree-member-name {
      font-size: 9px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Transition Screens */
    .transition-screen {
      position: fixed;
      inset: 0;
      background: var(--bg-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 100;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .transition-icon {
      font-size: 64px;
      margin-bottom: 24px;
    }

    .transition-title {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      color: var(--gold);
      margin-bottom: 12px;
      text-align: center;
    }

    .transition-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      text-align: center;
    }

    .inheritance-box {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      width: 100%;
      max-width: 320px;
      margin-bottom: 24px;
    }

    .inheritance-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .inheritance-row:last-child {
      border-bottom: none;
    }

    .btn {
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      color: var(--bg-dark);
      border: none;
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--gold);
      color: var(--gold);
    }

    /* Title Screen */
    .title-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 24px;
    }

    .title-logo {
      font-family: 'Playfair Display', serif;
      font-size: 42px;
      color: var(--gold);
      margin-bottom: 8px;
    }

    .title-tagline {
      color: var(--text-secondary);
      margin-bottom: 32px;
      font-size: 14px;
    }

    .title-avatars {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
    }

    .how-to-play {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
      text-align: left;
      max-width: 320px;
    }

    .how-to-play h3 {
      font-size: 14px;
      color: var(--gold);
      margin-bottom: 12px;
    }

    .how-to-play p {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* Setup Screen */
    .setup-screen {
      padding: 20px 0;
      overflow-y: auto;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .input-group input {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid rgba(212, 175, 55, 0.2);
      padding: 14px 16px;
      font-size: 16px;
      color: var(--text-primary);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--gold);
    }

    .avatar-picker {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .avatar-option {
      aspect-ratio: 1;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .avatar-option:hover {
      transform: scale(1.1);
    }

    .avatar-option.selected {
      border-color: var(--gold);
      box-shadow: 0 0 16px rgba(212, 175, 55, 0.4);
    }

    .color-picker {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 24px;
    }

    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected {
      border-color: white;
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.3);
    }

    /* Game Over */
    .dynasty-summary {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      max-width: 340px;
    }

    .dynasty-stat {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .dynasty-stat:last-child {
      border-bottom: none;
    }

    /* Premium Banner */
    .premium-banner {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      text-align: center;
    }

    .premium-badge {
      background: var(--gold);
      color: var(--bg-dark);
      font-size: 9px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 12px;
      display: inline-block;
      margin-bottom: 8px;
    }

    .premium-title {
      font-family: 'Playfair Display', serif;
      font-size: 16px;
      margin-bottom: 6px;
    }

    .premium-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .result-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px 32px;
      text-align: center;
      z-index: 50;
      animation: popIn 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .result-toast.positive {
      border-color: var(--green);
    }

    .result-toast.negative {
      border-color: var(--red);
    }

    @keyframes popIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .wisdom-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(167, 139, 250, 0.2);
      color: var(--purple);
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Avatar symbols - abstract, non-racial
    const AVATAR_SYMBOLS = ['‚óÜ', '‚óè', '‚ñ≤', '‚òÖ', '‚óà', '‚ú¶', '‚¨°', '‚óâ', '‚úß', '‚¨¢'];
    
    const AVATAR_COLORS = [
      '#D4AF37', // Gold
      '#60A5FA', // Blue
      '#4ADE80', // Green  
      '#F87171', // Red
      '#A78BFA', // Purple
      '#FB923C', // Orange
      '#2DD4BF', // Teal
      '#F472B6', // Pink
      '#FBBF24', // Yellow
      '#94A3B8', // Gray
    ];

    // Game decisions with swipe choices
    const DECISIONS = [
      {
        id: 'overtime',
        icon: 'üíº',
        title: 'Extra Hours',
        desc: 'Your boss offers overtime this weekend. More money, less rest.',
        left: { text: 'Decline - Rest up', impact: { health: 5, happiness: 5 } },
        right: { text: 'Accept - Get paid', impact: { wealth: 300, health: -5 } }
      },
      {
        id: 'investment',
        icon: 'üìà',
        title: 'Investment Tip',
        desc: 'A friend recommends putting money in index funds.',
        left: { text: 'Keep cash safe', impact: { wisdom: 2 } },
        right: { text: 'Invest $500', impact: { wealth: -500, investments: 500 } }
      },
      {
        id: 'credit_card',
        icon: 'üí≥',
        title: 'Credit Card Offer',
        desc: 'Pre-approved for a $5,000 limit card. Could help or hurt.',
        left: { text: 'Decline it', impact: { wisdom: 3 } },
        right: { text: 'Accept wisely', impact: { credit: 15 } }
      },
      {
        id: 'side_hustle',
        icon: 'üöÄ',
        title: 'Side Business',
        desc: 'You have an idea for a small business. Takes time and money to start.',
        left: { text: 'Not now', impact: { happiness: -5 } },
        right: { text: 'Go for it', impact: { wealth: -1000, income: 200 } }
      },
      {
        id: 'education',
        icon: 'üìö',
        title: 'Online Course',
        desc: 'A certification could boost your career. Costs $800.',
        left: { text: 'Self-teach free', impact: { income: 50, wisdom: 3 } },
        right: { text: 'Get certified', impact: { wealth: -800, income: 150 } }
      },
      {
        id: 'car_trouble',
        icon: 'üöó',
        title: 'Car Problems',
        desc: 'Your car needs $600 in repairs. Public transit is an option.',
        left: { text: 'Take the bus', impact: { happiness: -10, income: -100 } },
        right: { text: 'Fix the car', impact: { wealth: -600 } }
      },
      {
        id: 'medical',
        icon: 'üè•',
        title: 'Health Checkup',
        desc: "You've been putting off a doctor visit. Insurance covers most.",
        left: { text: "I feel fine", impact: { health: -10 } },
        right: { text: 'Get checked', impact: { wealth: -150, health: 15 } }
      },
      {
        id: 'rent_vs_buy',
        icon: 'üè†',
        title: 'Housing Decision',
        desc: 'You could keep renting or save harder for a down payment.',
        left: { text: 'Keep renting', impact: { happiness: 5 } },
        right: { text: 'Save for home', impact: { wealth: -300, wisdom: 5 } }
      },
      {
        id: 'family_loan',
        icon: 'üë®‚Äçüë©‚Äçüëß',
        title: 'Family Asks',
        desc: 'A relative needs $500 for an emergency. They might pay back.',
        left: { text: 'Decline kindly', impact: { happiness: -10, wisdom: 2 } },
        right: { text: 'Help them out', impact: { wealth: -500, happiness: 10 } }
      },
      {
        id: 'negotiate',
        icon: 'ü§ù',
        title: 'Salary Review',
        desc: "It's time to ask for a raise. Risky but could pay off.",
        left: { text: 'Stay quiet', impact: { happiness: -5 } },
        right: { text: 'Ask for more', impact: { income: 200, wisdom: 5 } }
      },
      {
        id: 'debt_payoff',
        icon: 'üìã',
        title: 'Debt Strategy',
        desc: 'Use your bonus to pay debt or invest for growth?',
        left: { text: 'Pay down debt', impact: { debt: -1000, credit: 20 } },
        right: { text: 'Invest it', impact: { investments: 1000 } }
      },
      {
        id: 'insurance',
        icon: 'üõ°Ô∏è',
        title: 'Life Insurance',
        desc: 'An agent offers a policy. Good for family, costs monthly.',
        left: { text: 'Not yet', impact: {} },
        right: { text: 'Protect family', impact: { wealth: -50, wisdom: 10 } }
      },
      {
        id: 'charity',
        icon: '‚ù§Ô∏è',
        title: 'Give Back',
        desc: 'A cause you believe in is fundraising. Every bit helps.',
        left: { text: 'Not this time', impact: { happiness: -3 } },
        right: { text: 'Donate $100', impact: { wealth: -100, happiness: 15 } }
      },
      {
        id: 'vacation',
        icon: '‚úàÔ∏è',
        title: 'Time Off',
        desc: "You need a break. Vacation costs but you'll feel refreshed.",
        left: { text: 'Staycation', impact: { happiness: 5, health: 5 } },
        right: { text: 'Take the trip', impact: { wealth: -800, happiness: 25, health: 10 } }
      },
      {
        id: 'credit_error',
        icon: 'üìä',
        title: 'Credit Report Error',
        desc: 'You spot a mistake on your credit report. Worth disputing?',
        left: { text: 'Ignore it', impact: { credit: -15 } },
        right: { text: 'Dispute it', impact: { credit: 30, wisdom: 10 } }
      },
      {
        id: 'emergency_fund',
        icon: 'üè¶',
        title: 'Emergency Savings',
        desc: 'Financial advisors say save 6 months expenses.',
        left: { text: 'Live for today', impact: { happiness: 5 } },
        right: { text: 'Build the fund', impact: { wealth: -200, wisdom: 8 } }
      },
      {
        id: 'mentor',
        icon: 'üéì',
        title: 'Mentorship',
        desc: 'Someone successful offers to mentor you. Takes time.',
        left: { text: 'Too busy', impact: {} },
        right: { text: 'Learn from them', impact: { wisdom: 20, income: 100 } }
      },
      {
        id: 'budget',
        icon: 'üìù',
        title: 'Budgeting',
        desc: 'Time to track every dollar or keep things flexible?',
        left: { text: 'Stay flexible', impact: { happiness: 3 } },
        right: { text: 'Strict budget', impact: { wealth: 200, wisdom: 5 } }
      }
    ];

    // Life events that just happen
    const LIFE_EVENTS = [
      { icon: 'üéâ', title: 'Bonus!', desc: 'Your hard work paid off.', impact: { wealth: 1500 }, positive: true },
      { icon: 'üíî', title: 'Heartbreak', desc: 'A relationship ended.', impact: { happiness: -20 }, positive: false },
      { icon: 'üéÇ', title: 'Birthday', desc: 'Another year wiser.', impact: { wisdom: 5, happiness: 5 }, positive: true },
      { icon: 'üèÜ', title: 'Recognition', desc: 'You won an award at work.', impact: { income: 100, happiness: 15 }, positive: true },
      { icon: 'üò∑', title: 'Got Sick', desc: 'Down for a week.', impact: { health: -15, wealth: -200 }, positive: false },
      { icon: 'üé∞', title: 'Lucky Day', desc: 'Found money on the street!', impact: { wealth: 50, happiness: 5 }, positive: true },
      { icon: 'üìâ', title: 'Market Dip', desc: 'Investments took a hit.', impact: { investments: -200 }, positive: false },
      { icon: 'üìà', title: 'Market Boom', desc: 'Your investments grew!', impact: { investments: 300 }, positive: true },
    ];

    // Utility functions
    const formatMoney = (amount) => {
      if (amount >= 1000000) return `$${(amount / 1000000).toFixed(1)}M`;
      if (amount >= 1000) return `$${(amount / 1000).toFixed(1)}K`;
      return `$${Math.round(amount).toLocaleString()}`;
    };

    const getNetWorth = (state) => {
      return state.wealth + state.investments - state.debt;
    };

    const clamp = (val, min, max) => Math.min(max, Math.max(min, val));

    // Main Game Component
    function KnightTycoon() {
      const [screen, setScreen] = useState('title');
      const [familyName, setFamilyName] = useState('');
      const [selectedSymbol, setSelectedSymbol] = useState(0);
      const [selectedColor, setSelectedColor] = useState(0);
      
      // Dynasty tracking
      const [generation, setGeneration] = useState(1);
      const [familyHistory, setFamilyHistory] = useState([]);
      const [dynastyWealth, setDynastyWealth] = useState(0);
      
      // Current character state
      const [character, setCharacter] = useState(null);
      const [gameState, setGameState] = useState(null);
      
      // Card state
      const [currentCard, setCurrentCard] = useState(null);
      const [cardOffset, setCardOffset] = useState(0);
      const [isDragging, setIsDragging] = useState(false);
      const [resultToast, setResultToast] = useState(null);
      const [usedCards, setUsedCards] = useState([]);
      
      const cardRef = useRef(null);
      const startX = useRef(0);

      const startGame = () => {
        if (!familyName) return;

        const firstName = generateFirstName();
        const newCharacter = {
          name: firstName,
          symbol: AVATAR_SYMBOLS[selectedSymbol],
          color: AVATAR_COLORS[selectedColor],
          age: 18,
        };

        const initialState = {
          wealth: 500,
          income: 2000,
          debt: 0,
          investments: 0,
          credit: 600,
          health: 100,
          happiness: 70,
          wisdom: 0,
        };

        setCharacter(newCharacter);
        setGameState(initialState);
        setGeneration(1);
        setFamilyHistory([]);
        setDynastyWealth(0);
        setUsedCards([]);
        setScreen('game');
        drawCard();
      };

      const generateFirstName = () => {
        const names = ['Alex', 'Jordan', 'Morgan', 'Casey', 'Riley', 'Quinn', 'Sage', 'Reese', 'Avery', 'Phoenix', 'River', 'Skylar', 'Dakota', 'Kai', 'Rowan'];
        return names[Math.floor(Math.random() * names.length)];
      };

      const drawCard = () => {
        // 20% chance of life event
        if (Math.random() < 0.2) {
          const event = LIFE_EVENTS[Math.floor(Math.random() * LIFE_EVENTS.length)];
          setCurrentCard({ ...event, isEvent: true });
        } else {
          let available = DECISIONS.filter(d => !usedCards.includes(d.id));
          if (available.length === 0) {
            setUsedCards([]);
            available = DECISIONS;
          }
          const decision = available[Math.floor(Math.random() * available.length)];
          setCurrentCard(decision);
          setUsedCards(prev => [...prev, decision.id]);
        }
        setCardOffset(0);
      };

      const applyImpact = (impact) => {
        setGameState(prev => {
          const newState = { ...prev };
          
          if (impact.wealth) newState.wealth += impact.wealth;
          if (impact.income) newState.income += impact.income;
          if (impact.debt) newState.debt = Math.max(0, newState.debt + impact.debt);
          if (impact.investments) newState.investments = Math.max(0, newState.investments + impact.investments);
          if (impact.credit) newState.credit = clamp(newState.credit + impact.credit, 300, 850);
          if (impact.health) newState.health = clamp(newState.health + impact.health, 0, 100);
          if (impact.happiness) newState.happiness = clamp(newState.happiness + impact.happiness, 0, 100);
          if (impact.wisdom) newState.wisdom += impact.wisdom;

          return newState;
        });
      };

      const handleSwipe = (direction) => {
        if (!currentCard) return;

        let impact, resultText;

        if (currentCard.isEvent) {
          impact = currentCard.impact;
          resultText = currentCard.title;
        } else {
          const choice = direction === 'left' ? currentCard.left : currentCard.right;
          impact = choice.impact;
          resultText = choice.text;
        }

        applyImpact(impact);

        // Show result toast
        const isPositive = (impact.wealth > 0 || impact.income > 0 || impact.investments > 0 || impact.credit > 0);
        setResultToast({ text: resultText, positive: isPositive });
        setTimeout(() => setResultToast(null), 1200);

        // Age up and check for transitions
        setCharacter(prev => ({ ...prev, age: prev.age + 1 }));

        // Monthly income/expenses
        setGameState(prev => {
          const monthlyNet = prev.income - 1800 - (prev.debt * 0.015);
          const investmentGrowth = prev.investments * 0.008;
          return {
            ...prev,
            wealth: prev.wealth + monthlyNet,
            investments: prev.investments + investmentGrowth,
          };
        });

        setTimeout(() => {
          checkGameState();
        }, 300);
      };

      const checkGameState = () => {
        // Check for death/retirement
        if (character.age >= 65) {
          handleRetirement();
        } else if (gameState.health <= 0) {
          handleDeath('health');
        } else if (getNetWorth(gameState) < -50000) {
          handleDeath('bankruptcy');
        } else {
          drawCard();
        }
      };

      const handleRetirement = () => {
        const netWorth = getNetWorth(gameState);
        const inheritance = Math.floor(netWorth * 0.7); // 70% passes down
        const wisdomBonus = Math.floor(gameState.wisdom * 0.5); // Half wisdom passes

        setFamilyHistory(prev => [...prev, {
          name: character.name,
          symbol: character.symbol,
          color: character.color,
          finalAge: character.age,
          netWorth: netWorth,
          cause: 'retirement'
        }]);

        setDynastyWealth(prev => prev + netWorth);
        
        setScreen('transition');
        
        // Store inheritance for next gen
        setGameState(prev => ({
          ...prev,
          inheritance,
          wisdomBonus
        }));
      };

      const handleDeath = (cause) => {
        const netWorth = getNetWorth(gameState);
        const inheritance = cause === 'bankruptcy' ? 0 : Math.floor(netWorth * 0.5);
        const wisdomBonus = Math.floor(gameState.wisdom * 0.3);

        setFamilyHistory(prev => [...prev, {
          name: character.name,
          symbol: character.symbol,
          color: character.color,
          finalAge: character.age,
          netWorth: netWorth,
          cause
        }]);

        setDynastyWealth(prev => prev + netWorth);

        if (generation >= 5 || (cause === 'bankruptcy' && inheritance <= 0)) {
          setScreen('gameover');
        } else {
          setScreen('transition');
          setGameState(prev => ({
            ...prev,
            inheritance,
            wisdomBonus
          }));
        }
      };

      const startNextGeneration = () => {
        const inheritance = gameState.inheritance || 0;
        const wisdomBonus = gameState.wisdomBonus || 0;

        // New character with slight variations
        const newSymbolIndex = (selectedSymbol + generation) % AVATAR_SYMBOLS.length;
        const firstName = generateFirstName();
        
        const newCharacter = {
          name: firstName,
          symbol: AVATAR_SYMBOLS[newSymbolIndex],
          color: AVATAR_COLORS[selectedColor],
          age: 18,
        };

        const newState = {
          wealth: Math.max(0, inheritance) + 500,
          income: 2000 + (wisdomBonus * 10),
          debt: inheritance < 0 ? Math.abs(inheritance) : 0,
          investments: 0,
          credit: 600 + wisdomBonus,
          health: 100,
          happiness: 70,
          wisdom: wisdomBonus,
        };

        setCharacter(newCharacter);
        setGameState(newState);
        setGeneration(prev => prev + 1);
        setUsedCards([]);
        setScreen('game');
        drawCard();
      };

      // Touch/Mouse handlers for swiping
      const handleStart = (clientX) => {
        startX.current = clientX;
        setIsDragging(true);
      };

      const handleMove = (clientX) => {
        if (!isDragging) return;
        const diff = clientX - startX.current;
        setCardOffset(diff);
      };

      const handleEnd = () => {
        setIsDragging(false);
        if (Math.abs(cardOffset) > 80) {
          handleSwipe(cardOffset < 0 ? 'left' : 'right');
        }
        setCardOffset(0);
      };

      const netWorth = gameState ? getNetWorth(gameState) : 0;

      return (
        <div className="game-container">
          {/* Title Screen */}
          {screen === 'title' && (
            <div className="title-screen">
              <div className="title-avatars">
                {AVATAR_SYMBOLS.slice(0, 5).map((s, i) => (
                  <div key={i} className="avatar avatar-small" style={{ background: AVATAR_COLORS[i], opacity: 0.7 }}>
                    {s}
                  </div>
                ))}
              </div>
              <div className="title-logo">Knight Tycoon</div>
              <div className="title-tagline">Build a dynasty. Leave a legacy.</div>
              
              <div className="how-to-play">
                <h3>How to Play</h3>
                <p>
                  Swipe RIGHT to accept, LEFT to decline.<br/><br/>
                  Make smart financial decisions through life. When you retire at 65, your heir inherits your wealth ‚Äî or your debt.<br/><br/>
                  How many generations can your family thrive?
                </p>
              </div>

              <button className="btn" onClick={() => setScreen('setup')}>
                Start Your Dynasty
              </button>
            </div>
          )}

          {/* Setup Screen */}
          {screen === 'setup' && (
            <div className="setup-screen">
              <div className="input-group">
                <label>Family Name</label>
                <input
                  type="text"
                  value={familyName}
                  onChange={(e) => setFamilyName(e.target.value)}
                  placeholder="Enter your family name"
                />
              </div>

              <div className="input-group">
                <label>Choose Your Symbol</label>
                <div className="avatar-picker">
                  {AVATAR_SYMBOLS.map((symbol, i) => (
                    <div
                      key={i}
                      className={`avatar-option ${selectedSymbol === i ? 'selected' : ''}`}
                      style={{ background: AVATAR_COLORS[selectedColor] }}
                      onClick={() => setSelectedSymbol(i)}
                    >
                      {symbol}
                    </div>
                  ))}
                </div>
              </div>

              <div className="input-group">
                <label>Choose Your Color</label>
                <div className="color-picker">
                  {AVATAR_COLORS.map((color, i) => (
                    <div
                      key={i}
                      className={`color-option ${selectedColor === i ? 'selected' : ''}`}
                      style={{ background: color }}
                      onClick={() => setSelectedColor(i)}
                    />
                  ))}
                </div>
              </div>

              <div style={{ textAlign: 'center', marginBottom: 24 }}>
                <div className="avatar" style={{ background: AVATAR_COLORS[selectedColor] }}>
                  {AVATAR_SYMBOLS[selectedSymbol]}
                </div>
                <div style={{ color: 'var(--text-secondary)', fontSize: 14 }}>
                  The {familyName || '___'} Family
                </div>
              </div>

              <button 
                className="btn" 
                onClick={startGame}
                disabled={!familyName}
                style={{ width: '100%', opacity: familyName ? 1 : 0.5 }}
              >
                Begin
              </button>
            </div>
          )}

          {/* Main Game Screen */}
          {screen === 'game' && character && gameState && (
            <>
              {/* Character Bar */}
              <div className="character-bar">
                <div className="avatar avatar-small" style={{ background: character.color }}>
                  {character.symbol}
                </div>
                <div className="character-info">
                  <div className="character-name">{character.name} {familyName}</div>
                  <div className="character-age">Age {character.age}</div>
                </div>
                <div className="generation-badge">Gen {generation}</div>
              </div>

              {/* Stats Row */}
              <div className="stats-row">
                <div className="stat-box">
                  <div className="stat-icon">üí∞</div>
                  <div className={`stat-value ${netWorth >= 0 ? 'positive' : 'negative'}`}>
                    {formatMoney(netWorth)}
                  </div>
                  <div className="stat-label">Net Worth</div>
                </div>
                <div className="stat-box">
                  <div className="stat-icon">üìä</div>
                  <div className="stat-value">{gameState.credit}</div>
                  <div className="stat-label">Credit</div>
                </div>
                <div className="stat-box">
                  <div className="stat-icon">‚ù§Ô∏è</div>
                  <div className={`stat-value ${gameState.health < 30 ? 'negative' : ''}`}>
                    {gameState.health}%
                  </div>
                  <div className="stat-label">Health</div>
                </div>
                <div className="stat-box">
                  <div className="stat-icon">üß†</div>
                  <div className="stat-value">{gameState.wisdom}</div>
                  <div className="stat-label">Wisdom</div>
                </div>
              </div>

              {/* Family Tree Mini */}
              {familyHistory.length > 0 && (
                <div className="family-tree">
                  <div className="tree-title">Family Legacy</div>
                  <div className="tree-members">
                    {familyHistory.map((member, i) => (
                      <div key={i} className="tree-member">
                        <div className="avatar avatar-tiny" style={{ background: member.color }}>
                          {member.symbol}
                        </div>
                        <div className="tree-member-name">{member.name}</div>
                      </div>
                    ))}
                    <div className="tree-member current">
                      <div className="avatar avatar-tiny" style={{ background: character.color }}>
                        {character.symbol}
                      </div>
                      <div className="tree-member-name">{character.name}</div>
                    </div>
                  </div>
                </div>
              )}

              {/* Card Area */}
              <div className="card-area">
                {currentCard && (
                  <div
                    ref={cardRef}
                    className={`swipe-card ${cardOffset < -30 ? 'swiping-left' : ''} ${cardOffset > 30 ? 'swiping-right' : ''}`}
                    style={{
                      transform: `translateX(${cardOffset}px) rotate(${cardOffset * 0.05}deg)`,
                      transition: isDragging ? 'none' : 'transform 0.3s ease'
                    }}
                    onMouseDown={(e) => handleStart(e.clientX)}
                    onMouseMove={(e) => handleMove(e.clientX)}
                    onMouseUp={handleEnd}
                    onMouseLeave={() => isDragging && handleEnd()}
                    onTouchStart={(e) => handleStart(e.touches[0].clientX)}
                    onTouchMove={(e) => handleMove(e.touches[0].clientX)}
                    onTouchEnd={handleEnd}
                  >
                    <div className="card-icon">{currentCard.icon}</div>
                    <div className="card-title">{currentCard.title}</div>
                    <div className="card-desc">{currentCard.desc}</div>
                    
                    {!currentCard.isEvent && (
                      <div className="card-choices">
                        <div className="choice-hint left">‚Üê {currentCard.left.text}</div>
                        <div className="choice-hint right">{currentCard.right.text} ‚Üí</div>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Action Buttons */}
              {!currentCard?.isEvent && (
                <div className="action-buttons">
                  <button className="action-btn decline" onClick={() => handleSwipe('left')}>‚úï</button>
                  <button className="action-btn accept" onClick={() => handleSwipe('right')}>‚úì</button>
                </div>
              )}

              {currentCard?.isEvent && (
                <div className="action-buttons">
                  <button className="btn" onClick={() => handleSwipe('right')}>Continue</button>
                </div>
              )}

              {/* Result Toast */}
              {resultToast && (
                <div className={`result-toast ${resultToast.positive ? 'positive' : 'negative'}`}>
                  {resultToast.text}
                </div>
              )}
            </>
          )}

          {/* Transition Screen */}
          {screen === 'transition' && character && (
            <div className="transition-screen">
              <div className="transition-icon">
                {character.age >= 65 ? 'üåÖ' : 'üí´'}
              </div>
              <div className="transition-title">
                {character.age >= 65 ? 'Retirement' : 'A New Chapter'}
              </div>
              <div className="transition-subtitle">
                {character.name} {familyName}'s journey ends at age {character.age}
              </div>

              <div className="inheritance-box">
                <div className="inheritance-row">
                  <span>Final Net Worth</span>
                  <span style={{ color: netWorth >= 0 ? 'var(--green)' : 'var(--red)' }}>
                    {formatMoney(netWorth)}
                  </span>
                </div>
                <div className="inheritance-row">
                  <span>Inheritance</span>
                  <span>{formatMoney(gameState.inheritance || 0)}</span>
                </div>
                <div className="inheritance-row">
                  <span>Wisdom Passed</span>
                  <span>+{gameState.wisdomBonus || 0}</span>
                </div>
              </div>

              <div className="avatar" style={{ background: character.color, marginBottom: 16 }}>
                {character.symbol}
              </div>
              <div style={{ color: 'var(--text-secondary)', marginBottom: 24 }}>
                Generation {generation} of the {familyName} dynasty
              </div>

              {generation < 5 ? (
                <button className="btn" onClick={startNextGeneration}>
                  Continue as Heir ‚Üí
                </button>
              ) : (
                <button className="btn" onClick={() => setScreen('gameover')}>
                  View Dynasty Results
                </button>
              )}
            </div>
          )}

          {/* Game Over Screen */}
          {screen === 'gameover' && (
            <div className="transition-screen">
              <div className="transition-icon">üëë</div>
              <div className="transition-title">The {familyName} Dynasty</div>
              <div className="transition-subtitle">
                {generation} generation{generation > 1 ? 's' : ''} ‚Ä¢ Est. by {familyHistory[0]?.name || character?.name}
              </div>

              <div className="dynasty-summary">
                {familyHistory.map((member, i) => (
                  <div key={i} className="dynasty-stat">
                    <span style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                      <span style={{ 
                        width: 24, 
                        height: 24, 
                        borderRadius: '50%', 
                        background: member.color,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: 12
                      }}>
                        {member.symbol}
                      </span>
                      {member.name}
                    </span>
                    <span style={{ color: member.netWorth >= 0 ? 'var(--green)' : 'var(--red)' }}>
                      {formatMoney(member.netWorth)}
                    </span>
                  </div>
                ))}
                <div className="dynasty-stat" style={{ borderTop: '1px solid var(--gold)', marginTop: 12, paddingTop: 12 }}>
                  <span style={{ color: 'var(--gold)', fontWeight: 600 }}>Total Legacy</span>
                  <span style={{ color: 'var(--gold)', fontWeight: 600 }}>{formatMoney(dynastyWealth)}</span>
                </div>
              </div>

              <button className="btn" onClick={() => {
                setScreen('title');
                setGeneration(1);
                setFamilyHistory([]);
                setDynastyWealth(0);
              }}>
                Start New Dynasty
              </button>

              <div className="premium-banner">
                <div className="premium-badge">LEVEL UP IRL</div>
                <div className="premium-title">Ready to build real wealth?</div>
                <div className="premium-desc">Knight Financial helps you master credit and finances.</div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<KnightTycoon />, document.getElementById('root'));
  </script>
</body>
</html>
